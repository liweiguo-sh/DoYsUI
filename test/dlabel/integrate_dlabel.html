<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>D-Label Example</title>

    <style type="text/css">
        #divButtons input[type='button'] {
            min-width: 80px;
            height: 32px;
            line-height: 32px;
        }

        #selPrinters {
            min-width: 80px;
            height: 32px;
            line-height: 32px;
        }

        .spanSpace {
            margin-left: 15px;
        }

        #iframeLabel {
            border: solid 1px green;
            margin-top: 10px;
            margin-bottom: 20px;
        }

        #txtJson {
            border: solid 1px red;
        }
    </style>
</head>
<body>
    <div id="divButtons">
        <input id="btnLoadExample" type="button" value="加载样例标签" onclick="btnLoadExample_click();" />
        <input id="btnSetValue" type="button" value="变量赋值(推荐)" onclick="btnSetValue_click();" />
        <input id="btnSetElementValue" type="button" value="元素赋值" onclick="btnSetElementValue_click();" />
        <input id="btnBatchPrint" type="button" value="批量打印" onclick="bntBatchPrint_click();" />
        <select id="selPrinters" onchange="printerChange()"></select>
    </div>
    <iframe id="iframeLabel"></iframe>
    <textarea id="txtJson" spellcheck="false" style="display:none;"></textarea>
</body>
</html>

<!-- formLoad -->
<script>
    var width = screen.availWidth, height = screen.availHeight;
    var ifr = window.document.getElementById("iframeLabel");
    var printers = window.document.getElementById("selPrinters");
    var txtJson = window.document.getElementById("txtJson");
    var lbl;
    var designMode = true;              // -- true: 设计模式，false: 预览模式 --
    // ------------------------------------------------------------------------
    window.addEventListener("load", function () {
        txtJson.style.width = ifr.offsetWidth / 2 + "px";
        txtJson.style.height = ifr.offsetHeight + "px";

        if (designMode) {
            ifr.style.width = 0.9 * width + "px";
            ifr.style.height = 0.8 * height + "px";
            ifr.src = "../../framework/control/DLabel/form/designer.html?v=" + Math.random();
        }
        else {
            ifr.style.width = 0.4 * width + "px";
            ifr.style.height = 0.5 * height + "px";
            ifr.src = "../../framework/control/DLabel/form/preview.html?v=" + Math.random();
        }

        ifr.addEventListener("load", function (evt) {
            // -- 获取 Label控件 实例 --
            lbl = ifr.contentWindow.getLabel();

            // -- 注册并监听标签保存事件(预览模式不需要) --
            lbl.addEventListener("on-save", onSave, { a: "123", b: "456" });

            // -- 获取打印机列表 --
            lbl.getPrinterList().then((data) => {
                for (let i = 0; i < data.length; i++) {
                    printers.add(new Option(data[i], data[i]));
                }

            });
        }, false);
    }, false);

    printerChange = function () {
        // -- 指定打印机 --
        lbl.setPrinterName(printers.value);
    }
</script>

<!-- DLabel -->
<script>
    function onSave(jsp) {
        txtJson.value = jsp.labelString;
        txtJson.style.display = "";

        console.log(jsp);

        // TODO: 此处添加代码，将标签文件字符串(jsp.labelString)发送到服务端存储。
    }

    function btnLoadExample_click() {
        let labelContent = getExampleLabelContent();

        lbl.loadLabel(labelContent, { designMode: designMode });
        lbl.compute(true);
    }
    function btnSetValue_click() {
        let price = "$" + ((100 + Math.round(Math.random() * 10000)) / 100).toFixed(2);
        let lot = "2310" + Math.floor(Math.random() * 89 + 10);
        let imgUrl = ((new Date()).getSeconds() % 2 == 0) ? "http://biosunmed.com/upload/2020/7/61552460.jpg" : "http://biosunmed.com/upload/2020/4/1410510871.jpg";

        lbl.setValue("img01", imgUrl);
        lbl.setValue("price", price);
        lbl.setValue("lot", lot);
        lbl.compute(true);
    }
    function btnSetElementValue_click() {
        try {
            let color = ["红", "橙", "黄", "绿", "蓝", "靛", "红"]
            let idx = Math.floor(Math.random() * 6);

            lbl.setElementValue("name", "多次性使用血浆胆红素吸附器(" + color[idx] + ")");
            lbl.compute(true);
        }
        catch (e) {
            alert(e.message);
        }
    }

    function bntBatchPrint_click() {
        let data = [];
        // --------------------------------------------
        lbl.setElementValue("name", "一次性使用血浆胆红素吸附器(批)");
        lbl.setValue("price", "$5,678");
        lbl.setValue("img01", "http://biosunmed.com/upload/2020/4/1410510871.jpg");

        for (let i = 0; i < 5; i++) {
            lbl.setValue("lot", "2310P" + (i + 1));
            lbl.compute(false);

            data.push(lbl.getData());
        }
        lbl.compute(true);

        // --------------------------------------------
        lbl.print({
            data: data,
            printerName: printers.value,
            copies: 2
        });
    }
</script>

<!-- sample label -->
<script>
    function getExampleLabelContent() {
        return `
{
  "head": {
    "width": "60",
    "height": "80",
    "point": 600,
    "element_id": 2
  },
  "fields": {
    "sn": "00269202653000000036",
    "snName": "(00)269202653000000036"
  },
  "elements": [
    {
      "head": {
        "elementType": "barcode",
        "barcodeType": "CODE_128",
        "name": "element_1",
        "gs1": true
      },
      "sections": [
        {
          "pos": 0,
          "type": "field",
          "value": "snName",
          "format": ""
        },
        {
          "pos": 1,
          "type": "",
          "value": "",
          "format": ""
        }
      ],
      "font": {
        "name": "宋体",
        "size": "10.5",
        "fontHeight": 3.7041666666666666,
        "lineHeight": null
      },
      "frame": {
        "type": "",
        "width": 0
      },
      "position": {
        "layer": 1,
        "width": "53.43",
        "height": "16.53",
        "textAlign": "center",
        "verticalAlign": "bottom",
        "top": "28.25",
        "left": "3.64",
        "angle": 0,
        "angleR": 0,
        "marginLeft": 0,
        "marginRight": 0,
        "marginTop": 0,
        "marginBottom": 0,
        "wC": 53.43,
        "hC": 16.53,
        "P1": {
          "x": 0,
          "y": 0
        },
        "P2": {
          "x": 53.43,
          "y": 0
        },
        "P3": {
          "x": 53.43,
          "y": 16.53
        },
        "P4": {
          "x": 0,
          "y": 16.53
        },
        "P15": {
          "x": 26.715,
          "y": 0
        },
        "P25": {
          "x": 53.43,
          "y": 8.265
        },
        "P35": {
          "x": 26.715,
          "y": 16.53
        },
        "P45": {
          "x": 0,
          "y": 8.265
        },
        "offsetX": 0,
        "offsetY": 0,
        "offsetLeft": 0,
        "offsetRight": 0,
        "offsetTop": 0,
        "offsetBottom": 0,
        "clientWidth": 53.43,
        "clientHeight": 16.53,
        "leftText": 26.715,
        "topText": 16.53,
        "heightBarcode": 12.825833333333335,
        "widthBarcode": 53.43,
        "leftBarcode": 0,
        "topBarcode": 0
      },
      "segments": [
        {
          "pos": 0,
          "type": "field",
          "value": "sn",
          "format": ""
        },
        {
          "pos": 1,
          "type": "",
          "value": "",
          "format": ""
        }
      ]
    }
  ],
  "page": {
    "width": 80,
    "height": 60,
    "marginLeft": 0,
    "marginTop": 0,
    "marginRight": 0,
    "marginBottom": 0,
    "rows": 1,
    "cols": 1,
    "horizontalSpace": 0,
    "verticalSpace": 0
  }
}
        `;
    }
</script>