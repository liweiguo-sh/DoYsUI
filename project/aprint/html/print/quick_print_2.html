<!DOCTYPE html>
<html>
<head>
    <title>集中打印(新)</title>
    <script src="../../../../framework/core/boot.js"></script>
    <script>
        importFrameworkRes("DLabelPreview");
    </script>

    <style type="text/css">
        body {
            overflow-y: scroll;
            overflow-x: hidden;
            padding-left: 5px;
            padding-right: 10px;
        }

        .el-col {
            --border: dotted 1px green;
        }

        .el-form-item {
            margin-bottom: 15px;
        }

        #divLabelContainerParent {
            --border: solid 1px red;
        }

        #divLabelContainer {
            --border: solid 1px blue;
            height: 500px;
            position: relative;
            box-shadow: 2px 2px 15px gray;
            border-radius: 5px;
        }

        .divPlaceholder {
            width: 2px;
            border: solid 1px white;
            float: right;
        }
    </style>
</head>
<body>
    <div id="app">
        <el-row>
            <el-col :span="span[1]">
                <el-tabs ref="tab" v-model="activeTabName" @tab-click="tabClick">
                    <el-tab-pane name="standard" label="常规打印"></el-tab-pane>
                    <el-tab-pane name="excel" label="Excel导入打印"></el-tab-pane>
                    <el-tab-pane name="interface" label="单据接口打印">
                        <el-form label-width="120px" label-position="left" size1="medium">
                            <el-form-item label="业务单据接口">
                                <el-select v-model="interfaceId" default-first-option filterable style="width:100%;">
                                    <el-option v-for="item in interfaces" :key="item.id" :value="item.id" :label="item.code + '    ' + item.name">
                                        <span>{{ item.code }}</span>
                                        <span style="float:right;">{{ item.name }}</span>
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="单据接口单号">
                                <el-input v-model="interfaceQueryCode" :disabled="!label.id || !interfaceId" placeholder="请输入单据接口查询单号...">
                                    <!--<el-button slot="append" icon="el-icon-search"></el-button>-->
                                </el-input>
                            </el-form-item>
                        </el-form>
                    </el-tab-pane>
                    <el-tab-pane name="labelChange" label="扫码换标">
                        <el-form label-width="135px" label-position="left" size1="medium">
                            <el-form-item label="扫码换标规则">
                                <el-select v-model="scanPrintId" @change="onScanPrintChange" default-first-option filterable clearable style="width:100%;">
                                    <el-option v-for="item in scanPrints" :value="item.id" :label="item.name"></el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item label="选项">
                                <el-checkbox v-model="autoPrint">扫码自动触发打印</el-checkbox>
                                <el-checkbox v-model="autoResetCopy">自动重置份数</el-checkbox>
                            </el-form-item>
                            <el-row v-for="item in scanItems">
                                <el-form-item :label="item.text">
                                    <el-input v-model="item.value" :key="item.name" :ref="'_scanItem_' + item.id" @keyup.enter.native="scanBarcodeEnter(item)" :disabled="!label.id"></el-input>
                                </el-form-item>
                            </el-row>
                        </el-form>
                    </el-tab-pane>
                </el-tabs>
                <el-row v-show="!activeTabName.equals('labelChange')">
                    <el-button @click="createTaskByManual" type="success" v-if="activeTabName=='standard'" :disabled="!label.id || qty.toInt()<1">生成打印数据</el-button>
                    <el-button @click="pullInterfaceData" type="success" v-if="activeTabName=='interface'" :disabled="!label.id || !interfaceId || !interfaceQueryCode">拉取接口数据</el-button>
                    <el-upload v-if="activeTabName=='excel'" :disabled="!label.id"
                               :action="actionUpload"
                               :on-success="afterUpload"
                               :headers="headers"
                               :show-file-list="false"
                               accept=".xls,.xlsx">
                        <el-button type="success" :disabled="!label.id">导入Excel数据(.xls;.xlsx)</el-button>
                    </el-upload>
                    <el-button @click="print" :disabled="!taskId" type="primary" style="float:right;">打印</el-button>
                    <div class="divPlaceholder"></div>
                    <el-dropdown @command="more" placement="bottom-start" style="float:right;">
                        <el-button type="primary" :disabled="!taskId" icon="el-icon-more" circle></el-button>
                        <el-dropdown-menu slot="dropdown">
                            <el-dropdown-item command="toSupplier" icon="el-icon-full-screen">分发任务至供应商</el-dropdown-item>
                            <el-dropdown-item command="exportData" icon="el-icon-full-screen" :disabled="true">导出数据</el-dropdown-item>
                        </el-dropdown-menu>
                    </el-dropdown>
                    <div class="divPlaceholder"></div>
                    <el-button type="warning" @click="deleteTask" :disabled="!taskId" icon="el-icon-delete" circle style="float:right" title="删除打印任务单"></el-button>
                </el-row>
                <hr />
                <!-- 标签列表 -->
                <el-row style="margin-bottom:22px;">
                    <el-select v-model="label.id" @change="onLabelChange" default-first-option filterable style="width:100%;">
                        <el-option v-for="item in labels" :key="item.id" :value="item.id" :label="item.code + '    ' + item.name">
                            <span style="float: left">{{ item.code }}</span>
                            <span style="float: right;">{{ item.name }}</span>
                        </el-option>
                    </el-select>
                </el-row>
                <el-form label-width="120px" label-position="left" :size="size">
                    <!-- 任务单号、起始行号 -->
                    <el-form-item label="任务单号">
                        <el-input v-model="taskPk" placeholder="任务单号" :disabled="true" />
                    </el-form-item>
                    <el-row :gutter="20" style="margin-top:15px;">
                        <el-col :span="12">
                            <el-form-item label="起始行">
                                <el-input v-model="rowNoFrom" />
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="到">
                                <el-input v-model="rowNoTo" />
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <!-- 打印机、打印数量、份数 -->
                    <el-form-item label="打印机">
                        <el-select v-model="printerName" @change="onPrinterChange();" default-first-option filterable clearable style="width:100%;">
                            <el-option v-for="printerName in printers" :key="printerName" :value="printerName" :label="printerName"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-row :gutter="20">
                        <el-col :span="12">
                            <el-form-item label="打印数量">
                                <el-input v-model="qty" :disabled="activeTabName.equals('excel')" />
                            </el-form-item>
                        </el-col>
                        <el-col :span="12">
                            <el-form-item label="份数">
                                <el-input v-model="copies" />
                            </el-form-item>
                        </el-col>
                    </el-row>

                    <!-- 产品、客户、供应商 -->
                    <hr v-show="hasProductRef || hasCustomerRef || hasSupplierRef" />
                    <el-form-item label="产品料号(SKU)" v-show="hasProductRef">
                        <el-select v-model="productPnId" v-if="productPnCount<=1000" @change="onProductPnChange" default-first-option filterable clearable style="width:100%;">
                            <el-option v-for="item in productPns" :key="item.id" :value="item.id" :label="item.pn + '  ' + item.product_name">
                                <span>{{ item.pn }}</span>
                                <span style="float:right">{{ item.product_name }}</span>
                            </el-option>
                        </el-select>
                        <el-input v-model="productPn" ref="productPn" v-else @change="onProductPnChange_input" placeholder="请输入产品料号/SKU"></el-input>
                    </el-form-item>
                    <el-form-item label="客户" v-show="hasCustomerRef">
                        <el-select v-model="customerId" @change="onCustomerChange" default-first-option filterable clearable style="width:100%;">
                            <el-option v-for="item in customers" :key="item.id" :value="item.id" :label="item.name"></el-option>
                        </el-select>
                    </el-form-item>
                    <el-form-item label="供应商" v-show="hasSupplierRef">
                        <el-select v-model="supplierId" @change="onSupplierChange" default-first-option filterable clearable style="width:100%;">
                            <el-option v-for="item in suppliers" :key="item.id" :value="item.id" :label="item.name"></el-option>
                        </el-select>
                    </el-form-item>

                    <!-- 变量输入区 -->
                    <hr v-show="label.id" />
                    <el-row v-for="item in variables" :key="item.name" v-show="label.id">
                        <el-form-item :label="item.name" v-if="item.type.equals('date') && !item.disabled">
                            <el-date-picker v-model="item.value" @change="onVarChange(item.name,item)" type="date" value-format="yyyy-MM-dd" :disabled="item.disabled" placeholder="打印前请选择日期..."></el-date-picker>
                        </el-form-item>
                        <el-form-item :label="item.name" v-else-if="!item.disabled">
                            <el-input v-model="item.value" @change="onVarChange(item.name,item)" :disabled="item.disabled" placeholder="打印前请赋值..." />
                        </el-form-item>
                    </el-row>
                    <el-collapse v-show="label.id">
                        <el-collapse-item title="......" name="disabled">
                            <el-row v-for="item in variables" :key="item.name">
                                <el-form-item :label="item.name" v-if="item.disabled">
                                    <el-input v-model="item.value" :disabled="item.disabled" />
                                </el-form-item>
                            </el-row>
                        </el-collapse-item>
                    </el-collapse>
                </el-form>
            </el-col>
            <!-- 标签区 -->
            <el-col :span="span[2]" style="padding:0px 0px 0px 30px;">
                <el-row v-show="label.id" style="margin-bottom:10px;">
                    <el-button type="primary" plain @click="printProof" icon="el-icon-printer"></el-button>
                    <span style="margin-left:10px;margin-right:10px;">
                        {{label.width}}×{{label.height}}
                    </span>
                    <span>{{label.remark}}</span>
                </el-row>
                <div id="divLabelContainerParent">
                    <div id="divLabelContainer"></div>
                </div>
            </el-col>
        </el-row>
        <el-collapse v-model="activeCollapses" v-show="taskId">
            <el-collapse-item name="grid">
                <template slot="title">
                    <span style="color:#409EFF">打印任务单数据列表 <i class="el-icon-coin"></i></span>
                </template>
                <sub-view id="grid" ref="grid" @oncolclick="onColClick" @onrowchange="onRowChange" style="height:500px;"></sub-view>
            </el-collapse-item>
        </el-collapse>
    </div>
</body>
</html>

<!-- vue.init -->
<script>
    var app = new Vue({
        el: '#app',
        data: {
            activeTabName: "standard",
            activeCollapses: ["grid"],
            span: [24, 8, 16],
            size: "medium",                 // -- medium/small/mini --

            actionUpload: g.prefix + "/framework/common/upload/upload_temp_file",

            scanPrints: [],                 // -- 扫码换标打印规则集合 --
            scanPrintId: null,              // -- 当前规则ID --
            scanItems: [],                  // -- 扫码项集合 --

            scanField: "pn",                // -- xxx扫码内容 --
            barcodeScan: "",                // -- xxx扫码内容 --

            autoPrint: true,                // -- 自动打印 --
            autoResetCopy: true,            // -- 自动重置份数 --

            labels: [],
            label: {                        // -- 标签对象 --
                id: null,                   // -- 标签ID --
                type: "",                   // -- 标签类型(DLabel/BarTender/NiceLabel etc.) --
                content: ""
            },

            dtbProductPn: null,             // -- 产品料号记录集 --
            productPns: [],                 // -- 产品料号集合 --
            productPnId: "",
            productPn: "",                  // -- 产品料号 --
            productPnCount: 0,              // -- 产品料号数量(数量过大时，导致渲染太慢，优化为不加载下俩列表) --
            productPnPara: {},              // -- 产品料号参数集 --
            customers: [],                  // -- 客户集合 --
            customerId: "",                 // -- 当前选中客户ID --
            customerPara: {},               // -- 当前客户参数集 --
            suppliers: [],                  // -- 供应商集合 --
            supplierId: null,
            supplierPara: {},

            variables: {},                  // -- 标签变量集合 --
            variablesUser: {},              // -- 用户修改过的标签变量集合 --
            interfaces: [],                 // -- 业务数据接口列表 --
            interfaceId: null,
            interfaceQueryCode: "",         // -- 业务接口查询单号 --

            hasProductRef: false,           // -- 有变量引用产品参数 --
            hasCustomerRef: false,          // -- 有变量引用客户参数 --
            hasSupplierRef: false,          // -- 有变量引用供应商参数 --

            qty: null,
            copies: 1,
            taskId: 0,
            taskPk: null,
            rowNoFrom: null,
            rowNoTo: null,

            printers: [],                   // -- 打印机数组 --
            printerName: "",
        },
        mounted() {
            ajax.send("/aprint/print/quick/getLabels", {}).then(res => {
                this.labels = res.labels;
            });
            ajax.send("/aprint/print/quick/getInterfaces", {}).then(res => {
                this.interfaces = res.interfaces;
                if (this.interfaces.length == 1) {
                    this.interfaceId = this.interfaces[0].id;
                }
            });

            this.initGrid();

            this.getQuoteData();
        },
        computed: {
            headers() {
                return {
                    token: getLocalItem("token")
                };
            }
        },
        methods: {
            reset() {
                this.variables = {};
                this.variablesUser = {};

                this.taskId = 0;
                this.taskPk = "";
                this.qty = 0;
                this.copies = 1;
                this.rowNoFrom = 0;
                this.rowNoTo = 0;

                this.afterCompute = null;
                this.hasProductRef = false;
                this.hasCustomerRef = false;
                this.hasSupplierRef = false;

                this.initGrid();
                this.activeCollapses = ["preview"];
            },
            tabClick(tab, event) {
                if (tab.name.equals("excel") || tab.name.equals("interface")) {
                    this.qty = 0;
                }
                else if (tab.name.equals("labelChange")) {
                    if (this.scanPrints.length == 0) {
                        ajax.send("/aprint/print/quick/getScanPrintList", {}).then(res => {
                            if (res.scanPrints.length > 0) {
                                this.scanPrints = res.scanPrints;
                            }
                            else {
                                this.scanPrints = [{ id: 0, name: "未配置" }];
                            }
                        });
                    }
                }

                setPageCookie("activeTabName", this.activeTabName);
            },

            onLabelChange() {
                this.reset();

                this.getDLabel();
            },
            getDLabel() {
                ajax.send("/aprint/print/quick/getLabelById", { labelId: this.label.id }).then(res => {
                    this.label = res.label;
                    this.variables = res.variables;

                    // -- 1. 加载标签 --
                    this.setLabelContainerSize();
                    if (!lbl) {
                        lbl = new Label({
                            container: gId("divLabelContainer"),
                            designMode: false
                        });
                    }
                    lbl.loadLabel(this.label.content, {
                        imageBaseUrl: topWin.cfg.labelVariableImageBaseUrl,
                        readonly: true
                    });

                    // -- 2. 加载标签脚本(针对BarTender等非DLabel标签) --
                    let jsAfterCompute = this.label["js_after_compute"];
                    if (jsAfterCompute) {
                        try {
                            jsAfterCompute = "this.afterCompute = function(jsp) {\n" + jsAfterCompute + "\n}";
                            eval(jsAfterCompute);
                        }
                        catch (e) {
                            alert("加载标签脚本时遇到意外错误：\n" + e.toString());
                        }
                    }

                    // -- 3. 检查是否引用客户或产品参数 --
                    for (let i = 0; i < this.variables.length; i++) {
                        let variable = this.variables[i];
                        let quoteFrom = variable["quote_from"];
                        if (quoteFrom.equals("product")) {
                            this.hasProductRef = true;
                        }
                        else if (quoteFrom.equals("customer")) {
                            this.hasCustomerRef = true;
                        }
                        else if (quoteFrom.equals("supplier")) {
                            this.hasSupplierRef = true;
                        }
                    }

                    // -- 4. 不需要的引用重置 --
                    if (!this.hasProductRef) this.productPnId = "";
                    if (!this.hasCustomerRef) this.customerId = "";
                    if (!this.hasSupplierRef) this.supplierId = "";

                    // -- 5. 更新变量集合 --
                    this.setVariables();
                });
            },
            getQuoteData() {
                if (this.productPns.length == 0) {
                    ajax.send("/aprint/print/quick/getProductPns", {}).then(res => {
                        this.dtbProductPn = res.dtbProductPn;

                        let rowCount = this.dtbProductPn.rowCount;
                        let dataRow;
                        let productPns = [];

                        if (rowCount <= 1000) {
                            for (let i = 0; i < rowCount; i++) {
                                dataRow = this.dtbProductPn.rows[i];
                                productPns.push({
                                    id: dataRow["id"].value,
                                    pn: dataRow["pn"].value,
                                    product_name: dataRow["product_name"].value
                                });
                            }
                        }
                        this.productPns = productPns;
                        this.productPnCount = rowCount;

                        this.dtbProductPn.sort("pn");
                    });
                }

                if (this.customers.length == 0) {
                    ajax.send("/aprint/print/quick/getCustomers", {}).then(res => {
                        this.customers = res.customers;
                    });
                }

                if (this.suppliers.length == 0) {
                    ajax.send("/aprint/print/quick/getSuppliers", {}).then(res => {
                        this.suppliers = res.suppliers;
                    });
                }
            },

            // -- 扫码换标 ------------------------------------
            onScanPrintChange() {
                if (!this.scanPrintId) {
                    this.scanItems = [];
                    return;
                }

                ajax.send("/aprint/print/quick/getScanPrintItemList", { scanPrintId: this.scanPrintId }).then(res => {
                    this.scanItems = res.scanPrintItems;
                    if (this.scanItems.length == 0) {
                        topWin.alert("未配置扫码项，请检查。");
                    }
                    for (let i = 0; i < this.scanItems.length; i++) {
                        let item = this.scanItems[i];
                        item.index = i;
                        if (item.js_after_scan) {
                            item.jsAfterScan = eval("(function (barcode) {" + item.js_after_scan + "})");
                        }
                    }
                });
            },
            async scanBarcodeEnter(item) {
                const waiting = this.$loading({
                    lock: true,
                    text: 'waiting ...',
                    spinner: 'el-icon-loading',
                    background: 'rgba(0, 0, 0, 0.7)'
                });
                try {
                    if (item.jsAfterScan) {
                        let jsonRet = item.jsAfterScan(item.value);
                        let fields = jsonRet.fields;
                        // -- 填充返回的变量值 --
                        debugger
                        debugger
                        if (fields) {
                            for (let key in fields) {
                                for (let i = 0; i < this.variables.length; i++) {
                                    let variable = this.variables[i];
                                    if (variable.name.equals(key)) {
                                        variable.value = fields[key];
                                        break;
                                    }
                                }
                            }
                            this.setVariables();
                        }
                        
                        // -- 执行match动作 --
                        let match = jsonRet.match || "";
                        let field = jsonRet.field || "";
                        let action = jsonRet.action || "";
                        if (match.equals("product")) {
                            if (field.equals("pn")) {
                                let pn = fields["pn"] || "";
                                let arrFind = [pn];
                                let nFind = this.dtbProductPn.find(arrFind);
                                if (nFind >= 0) {
                                    let dataRow = this.dtbProductPn.rows[8];
                                    this.productPnId = dataRow["id"].value;
                                    await this.onProductPnChange();                                    
                                }
                                else {
                                    throw ("未找到匹配的产品料号/SKU，请检查。");
                                }
                            }
                        }
                        else {
                            if (match) {
                                throw ("不支持的match项(" + match + ")，请检查。");
                            }
                        }

                        // -- 执行action动作 --
                        if (action.equals("print")) {
                            this.printProof();
                            return;
                        }
                    }

                    // -- 定位到下一个扫描项 --
                    if (item.index < this.scanItems.length - 1) {
                        let refNextItem = "_scanItem_" + this.scanItems[item.index + 1].id;
                        this.$refs[refNextItem][0].select();
                        this.$refs[refNextItem][0].focus();
                    }
                }
                catch (e) {
                    topWin.alert(e.toString(), "error", () => {
                        this.$refs["_scanItem_" + item.id][0].select();
                        this.$refs["_scanItem_" + item.id][0].focus();
                    });                    
                }
                finally {
                    waiting.close();
                }
            },
            scanBarcodeEnterNext() {
                this.print();
                if (this.autoResetCopy) {
                    this.copies = 1;
                }
            },

            // -- variable --------------------------------
            async onProductPnChange(jsp = {}) {
                if (this.productPnId) {
                    let res = await ajax.send("/aprint/print/quick/getProductPnPara", { productPnId: this.productPnId });
                    this.productPnPara = res.productPnPara;
                    this.setVariables();

                    if (jsp.scanBarcodeEnterNext) {
                        this.scanBarcodeEnterNext();
                    }
                }
                else {
                    this.productPnPara = {};
                    this.setVariables();
                }
            },
            onProductPnChange_input() {
                // -- onProductPnChange是下拉框触发的，onProductPnChange_input是文本框触发的 --
                let productPn = this.productPn.trim();
                if (productPn.equals("")) return;

                // -- 1. 查找 --
                let value, idxFind = -1;
                for (let i = this.productPns.length - 1; i >= 0; i--) {
                    value = this.productPns[i]["pn"];
                    if (productPn == value) {
                        idxFind = i;
                        break;
                    }
                }

                // -- 2. 调用下拉框change事件 --
                if (idxFind < 0) {
                    topWin.message("未找到符合条件的产品料号/SKU，请检查。", "error");
                    this.$refs["productPn"].select();
                    return;
                }

                this.productPnId = this.productPns[idxFind]["id"];
                this.onProductPnChange();
            },
            onCustomerChange() {
                if (this.customerId) {
                    ajax.send("/aprint/print/quick/getCustomerPara", { customerId: this.customerId }).then(res => {
                        this.customerPara = res.customerPara;
                        this.setVariables();
                    });
                }
                else {
                    this.customerPara = {};
                    this.setVariables();
                }
            },
            onSupplierChange() {
                if (this.supplierId) {
                    ajax.send("/aprint/print/quick/getSupplierPara", { supplierId: this.supplierId }).then(res => {
                        this.supplierPara = res.supplierPara;
                        this.setVariables();
                    });
                }
                else {
                    this.supplierPara = {};
                    this.setVariables();
                }
            },
            onVarChange(name, variable) {
                // -- 记录用户手工改动过的变量值 --
                this.variablesUser[name] = variable["value"];

                this.setVariables();
            },
            setVariables() {
                for (let i = 0; i < this.variables.length; i++) {
                    let variable = this.variables[i];
                    let name = variable["name"];
                    let value = variable["value"];
                    let type = variable["type"];
                    let quoteFrom = variable["quote_from"];

                    // -- 1. 计算变量值 --
                    variable["disabled"] = (variable["flag_manual_modify"] == 0);
                    if (!quoteFrom.equals("")) {
                        // -- 代入引用变量(产品、客户或供应商参数) --
                        let quoteName = variable["quote_name"] || name;

                        if (quoteFrom.equals("product") && this.productPnId) {
                            value = this.productPnPara[quoteName];
                            if (type.equals("image")) {
                                if (value && !value.startsWith("http")) {
                                    value = topWin.cfg.productPnParaImageBaseUrl + value;
                                }
                            }
                            if (this.productPnId) {
                                variable["disabled"] = true;
                            }
                        }
                        else if (quoteFrom.equals("customer") && this.customerId) {
                            value = this.customerPara[quoteName];
                            if (this.customerId) {
                                variable["disabled"] = true;
                            }
                        }
                        else if (quoteFrom.equals("supplier") && this.supplierId) {
                            value = this.supplierPara[quoteName];
                            if (this.supplierId) {
                                variable["disabled"] = true;
                            }
                        }

                        // -- 如果disabled == true, 则用户手工输入的值无效 --
                        if (variable["disabled"]) {
                            this.variablesUser[name] = undefined;
                        }
                    }
                    else {
                        if (type.equals("date")) {
                            let offset = variable["rule_date_offset"];
                            let offset_unit = variable["rule_date_offset_unit"];

                            if (offset && offset_unit) {
                                value = (new Date()).add(offset, offset_unit).toStr();
                                if (offset_unit.equals("YEAR") || offset_unit.equals("MONTH")) {
                                    // -- 少一天，一般用于到期日期。将来改为是否要扣减一天的选项 --
                                    value = (new Date()).add(offset, offset_unit).add(-1, "DAY").toStr();
                                }
                                else {
                                    value = (new Date()).add(offset, offset_unit).toStr();
                                }
                            }
                            else {
                                value = (new Date()).toStr();
                            }
                        }
                    }

                    // -- 2. 回写用户手工修改过的变量值(如果存在有效的用户手工输入值，则以用户值为准)/(仅限字符或日期类型的变量) --
                    if (this.variablesUser[name] != undefined) {
                        if ((variable.type.equals("string") || variable.type.equals("date")) && !variable.disabled) {
                            value = this.variablesUser[name];
                        }
                    }

                    // -- 3. 回写计算后的变量值，格式化日期变量 --
                    value = value || "";
                    variable["value"] = value;
                    variable["valueFormat"] = value;
                    if (type.equals("date")) {
                        let dateFormat = variable["rule_date_format"];
                        if (dateFormat) {
                            variable["valueFormat"] = value.toDate().toString(dateFormat);
                        }
                    }
                }

                // -- 执行脚本 --
                if (this.afterCompute) {
                    try {
                        let jspReturn = this.afterCompute({ trigger: jsp.trigger });
                        if (jspReturn) {
                            if (jspReturn.printNow) {
                                this.preview({ printNow: true });
                                return;
                            }
                        }
                    }
                    catch (e) {
                        alert("改变变量后执行脚本遇到意外错误：\n" + e.toString());
                    }
                }

                // -- 预览 --
                if (this.label.type.equals("DLabel")) {
                    this.preview_DLabel_byVariables();
                }

                // -- 回写因预览调用lbl.compute改变的变量值 --
                if (this.label.type.equals("DLabel")) {
                    let variable, name, value;
                    for (let i = 0; i < this.variables.length; i++) {
                        variable = this.variables[i];
                        name = variable["name"];
                        if (lbl.fields[name] != undefined) {
                            value = lbl.fields[name];

                            if (variable.type.equals("date")) {
                                value = value.toDate(variable.rule_date_format).toStr();    // -- 回写日期变量一定要转换成字符串，以避免el-date讨厌的日期格式问题 --
                            }
                            this.variables[i]["value"] = value;
                        }
                    }
                }
            },

            // -- preview ---------------------------------
            preview_DLabel_byVariables() {
                if (lbl == null) return;

                let variable;
                for (let i = 0; i < this.variables.length; i++) {
                    variable = this.variables[i];
                    lbl.setValue(variable.name, variable.valueFormat, true);
                }
                lbl.compute(true);
            },
            preview_DLabel_byGrid() {
                let grid = this.$refs.grid;
                let dtbViewData = grid.dtbViewData;
                let iRow = Math.max(0, grid.currentRowIdx);

                for (let iCol = 0; iCol < dtbViewData.columnCount; iCol++) {
                    let columnName = dtbViewData.columns[iCol].name;
                    let value = dtbViewData.rows[iRow][columnName].value;

                    lbl.setValue(columnName, value, true);
                }
                lbl.compute(true);
            },

            // -- print -----------------------------------
            printProof() {
                let data = [lbl.getData()];
                lbl.print({
                    data: data,
                    printerName: this.printerName,
                    copies: this.copies
                });
            },
            async print() {
                this.printData();
            },
            async printData(jsp = { preview: false }) {
                let para = {
                    labelId: this.label.id,
                    labelType: this.label.type,
                    preview: jsp.preview,
                    printerName: this.printerName,
                    copies: this.copies
                }
                if (this.label.type.equals("DLabel")) {
                    para.labelString = lbl.toJson();
                    para.dataString = await this.getPrintData();
                }
                else if (this.labelType.equals("BarTender")) {
                    para.urlLabelFile = g.path.resRun + "/" + topWin.tenantId + "/aprint/label_file/" + this.dtbLabel.rows[0]["label_file_name"].value;
                    para.urlDataFile = g.path.resRun + "/" + topWin.tenantId + "/aprint/label_file/" + this.dtbLabel.rows[0]["data_file_name"].value;

                    if (jsp.preview || !this.taskId) {
                        para.dataString = this.getPreviewData_BarTender();
                    }
                    else {
                        para.dataString = await this.getPrintData_BarTender();
                    }
                }
                top.crossLocal.printLabel(para);
            },
            async getPrintData() {
                let dataString, data = [];
                // ----------------------------------------
                if (!this.taskId) {
                    // -- 打印样张 --
                    data.push(lbl.getData());
                }
                else {
                    let postData = {
                        labelId: this.label.id,
                        taskId: this.taskId,
                        rowNoFrom: this.rowNoFrom,
                        rowNoTo: this.rowNoTo
                    };
                    let res = await ajax.send("/aprint/print/quick/getTaskData", postData);
                    let dtbTaskData = res.dtbTaskData;
                    let rowCount = dtbTaskData.rowCount;
                    let columnCount = dtbTaskData.columnCount;
                    // ------------------------------------
                    for (let i = 0; i < rowCount; i++) {
                        for (let j = 0; j < columnCount; j++) {
                            name = dtbTaskData.columns[j].name;
                            if (name.equals("task_id") || name.equals("id")
                                || name.equals("$row_no") || name.equals("$cdate")) {
                                continue;
                            }
                            value = dtbTaskData.rows[i][j].value;

                            lbl.setValue(name, value);
                        }
                        lbl.compute(i == rowCount - 1);
                        data.push(lbl.getData());
                    }
                }
                // ----------------------------------------
                dataString = JSON.stringify(data, null, " ");
                return dataString;
            },

            // -- task ------------------------------------
            createTaskByManual() {
                this.createTask();
            },
            afterUpload(res) {
                this.createTask({
                    mode: "excel",
                    pathname: res.pathname
                });
            },
            pullInterfaceData() {

                this.createTask({
                    mode: "interface",
                    interfaceId: this.interfaceId,
                    interfaceQueryCode: this.interfaceQueryCode
                });
            },

            createTask(jsp = { mode: "" }) {
                let variables = {}, variable;
                for (let key in this.variables) {
                    variable = this.variables[key];
                    variables[variable.name] = variable.value;
                }
                let post = {
                    labelId: this.label.id,
                    productPnId: this.productPnId,
                    customerId: this.customerId,
                    supplierId: this.supplierId,
                    variables: variables,
                    qty: this.qty,
                    copies: this.copies
                };
                post = g.x.extendJSON(post, jsp);
                ajax.send("/aprint/print/quick/createTask", post).then(res => {
                    this.variables = res.variables;
                    this.setVariables();

                    this.taskId = res.task.id;
                    this.taskPk = res.task.pk;
                    this.qty = res.task.qty;
                    this.copies = res.copies || 1;
                    this.initGrid();

                    this.rowNoFrom = 1;
                    this.rowNoTo = this.qty;
                    if (this.activeCollapses.indexOf("grid") < 0) {
                        this.activeCollapses.push("grid");
                    }

                    topWin.message("打印任务单数据已生成，共 " + this.qty + " 条记录。", "success");
                });
            },
            deleteTask() {
                if (!this.taskId) return;

                topWin.confirm("确定要删除当前已生成的打印数据吗？").then((ok) => {
                    if (!ok) return;
                    let postData = {
                        taskId: this.taskId
                    };
                    ajax.send("/aprint/quick_print/deleteTask", postData).then(res => {
                        this.taskId = 0;
                        this.taskPk = "";
                        this.rowNoFrom = 0;
                        this.rowNoTo = 0;

                        this.initGrid();

                        let idx = this.activeCollapses.indexOf("grid");
                        if (idx >= 0) {
                            this.activeCollapses.splice(idx, 1);
                        }
                    });
                });
            },

            // -- data grid -------------------------------
            initGrid() {
                var para = {
                    viewPk: "x_label",
                    controller: "/aprint/print/x_label_view",
                    filter: "task_id = " + this.taskId,
                    extUserDef: {
                        labelId: this.label.id
                    }
                }
                this.$refs.grid.init(para);
            },
            onRowChange(jsp) {
                if (jsp.rowData) {
                    for (let name in jsp.rowData) {
                        let value = jsp.rowData[name];
                        lbl.setValue(name, value, true);
                    }
                    lbl.compute(true);
                }
                else {
                    this.preview_DLabel_byVariables();
                }
            },
            onColClick(jsp) {
                let value;
                for (let name in jsp.rowData) {
                    value = jsp.rowData[name];
                    lbl.setValue(name, value, true);
                }
                lbl.compute(true);

                this.printProof();
            },

            // -- others ----------------------------------
            onPrinterChange() {
                setPageCookie("printerName", this.printerName);
            },
            setLabelContainerSize() {
                let elParent = divLabelContainerParent.parentElement;
                let width = elParent.clientWidth - 10 - g.x.getStyleValue(elParent, "paddingLeft") - g.x.getStyleValue(elParent, "paddingRight");
                let height = win.p.maxHeight - 50;

                let WH = width / height;
                let wh = this.label.width / this.label.height;

                if (WH > wh) {
                    width = height * wh;
                }
                else {
                    height = width / wh;
                }

                divLabelContainerParent.style.width = width + "px";
                divLabelContainerParent.style.height = height + "px";
            },
            more(command) {
                if (command.equals("toSupplier")) {
                    var prop = {
                        url: g.path.project + "/aprint/html/supplier/task_to_supplier.html",
                        parent: win,
                        modal: true
                    };
                    var para = {
                        taskId: this.taskId,
                        taskPk: this.taskPk
                    };
                    topWin.openWindow(prop, para);
                }
                else if (command.equals("exportData")) {
                    this.exportData();
                }
                else {
                    topWin.message("当前功能(" + command + ")正在开发中...");
                }
            },
            exportData() {
                topWin.message("debug here");
            }
        }
    });
</script>

<!-- winLoad -->
<script>
    let divLabelContainerParent = gId("divLabelContainerParent");
    let lbl;
    // ------------------------------------------------------------------------
    function winLoad() {
        let widthLeft = Math.round(24 * (600 / win.p.maxWidth));
        app.span[1] = widthLeft;
        app.span[2] = 24 - widthLeft;

        top.crossLocal.getPrinterList().then((res) => {
            if (res.ok) {
                app.printers = res.data.printers;
            }
        });
        app.printerName = getPageCookie("printerName");


        let activeTabName = getPageCookie("activeTabName");
        if (!activeTabName.equals("")) {
            app.activeTabName = activeTabName;
        }
    }
</script>