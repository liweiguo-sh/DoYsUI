<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
	<title>开票信息管理</title>
	<meta name="description" content="" />
	<meta name="keywords" content="" />
	<link rel="stylesheet" href="" />
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/excel.js" type="text/javascript"></script>
    <script src="../../js/resource_print.js" type="text/javascript"></script>
    <script src="../../js/select_stock.js" type="text/javascript"></script>
    <script src="../../js/select_storage.js" type="text/javascript"></script>
    <script src="../../js/barcode_parse.js" type="text/javascript"></script>
    <link href="../../../../res_plugin/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />
    <style>
    	#divDC {
    		width: 978px;
            padding: 5px 0 5px 5px;
            border: solid 1px lightgray;
            border-radius: 3px;
    	}
    	.PanelA {
            width: 963px;
            margin-left: auto;
            margin-right: auto;
        }
        .PanelA.PanelA-dtl {
        	margin-top: 10px;
        }
        #tbForm {
            width: 100%;
        }
        #tbForm thead {
            display: none;
        }
        #tbForm tbody tr {
            display: block;
            font-size: 0;
        }
        #tbForm tbody tr {
            margin-bottom: 10px;
        }
        #tbForm tbody tr:last-child {
        	margin: 0;
        }
        #tbForm tbody td {
            display: inline-block;
            padding: 0;
        }
        #tbForm tbody td:nth-child(odd) {
            width: 10%;
            line-height: 30px;
        }
        #tbForm tbody tr:first-child td:nth-child(2),
        #tbForm tbody tr:nth-child(2) td:nth-child(2),
        #tbForm tbody tr:last-child td:nth-child(2) {
        	width: 90%;
        	height: auto;
        }
        #tbForm tbody tr:nth-child(2) td:nth-child(1) {
        	height: 84px;
        }
        #tbForm tbody tr:nth-child(2) td:nth-child(2) {
        	height: auto;
        }
        #tbForm tbody tr:nth-child(3) td:nth-child(even) {
        	width: 23%;
        	line-height: 30px;
        }
        #tbForm tbody tr:nth-child(3) td:nth-child(even) input {
        	width: 96%;
        	text-indent: 15px;
        }
        #tbForm tbody tr:first-child td input {
            width: 97.6%;
            text-indent: 15px;
            border: solid 2px #519BE1;
        }
        #tbForm tbody td textarea {
        	width: 97.4%;
        	text-indent: 15px;
        	resize: none;
        }
        .mark-star {
        	color: #ff0000;
        }
        #mainDiv {
        	height: 250px;
        	overflow: scroll;
        }
    </style>
</head>
<body>
    <div id="divDC"></div>
    <div class="PanelA">
    	<form id="frm" action="" target="g_mscm.invoice.Invoice">
    		<table id="tbForm" class="tbForm">
    			<thead>
    				<tr>
    					<th></th>
    					<th></th>
    					<th></th>
    					<th></th>
    					<th></th>
    					<th></th>
    				</tr>
    			</thead>
    			<tbody>
    				<tr>
    					<td>扫描发票号<span class="mark-star">*</span></td>
    					<td colspan="5">
    						<input type="text" placeholder="在此设置光标，开始扫描发票条码" name="scan-invoice-no" id="scan-invoice-no" onkeydown="addInvoiceNo(event)" />
    					</td>
    				</tr>
    				<tr>
    					<td>发票号<span class="mark-star">*</span></td>
    					<td colspan="5">
    						<textarea name="_gInvoice_no" id="_cInvoice_no" rows="5" disabled></textarea>
    					</td>
    				</tr>
    				<tr>
    					<td>开票日期<span class="mark-star">*</span></td>
    				<td colspan="2">
    						<input type="text" id="_cInvoice_date" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})" />
    					</td>
    					<td>开票金额</td>
    				<td colspan="2">
    						<input type="text"  id="_cInvoice_amount" />
    					</td>
    				</tr>
    				<tr>
    					<td>发票摘要</td>
    					<td colspan="5">
    						<textarea name="_cInvoice_summary" id="_cInvoice_summary" rows="5"></textarea>
    					</td>
    				</tr>
    			</tbody>
    		</table>
    		<input type="hidden" id="_cInvoice_id" />
            <input type="hidden" id="_cCompany_id" />
           <input type="hidden" id="_ccompany_id_mi"  />
            
    		
    	</form>
    </div>
    <div class="PanelA PanelA-dtl">
        <div id="mainDiv"></div>
    </div>
</body>
</html>
<script>
	var gridViewDtl = null;
	function formLoad () {

	}

	/**
	 * 创建明细表单
	 * @param  {Boolean} isView     
	 * @param  {String}  value 
	 * @return {None}             
	 */
	var produceTableGrid = function (isView, value) {
		var viewFilter = "";
		if (isView) {
			viewFilter = "1 = 1";
			if (value) {
				viewFilter += " AND invoice_id = '" + value + "'";
			}
		} else {
			viewFilter = "1 = 0";
		}
		if (gridViewDtl == null) {
			var prop = {
				divContainer: gId("mainDiv"),
				viewKey: "v_invoice_bill_sp_dtl",
				viewFilter: viewFilter,
				toolbarVisible: true,
				viewForm: ""
			};
			gridViewDtl = new window.xwf_gridview(prop);
		} else {
			gridViewDtl.setViewFilter(viewFilter);
		}
	}

	/**
	 * 扫描发票号码
	 * @param {e} e 
	 */
	var addInvoiceNo = function (e) {
		var keyNum; // 键盘的 keycode
		if (window.event) {
			// IE
			keyNum = e.keyCode;
		} else {
			// Netscape/Firefox/Opera
			keyNum = e.which;
		}
		// 点击回车键，创建发票号
		if (keyNum == 13) {
			if (e.currentTarget.value.trim()) {
				var isHas = checkInvoiceNo(e.currentTarget.value.trim()); // isHas true-不存在重复发票号、false-存在重复发票号
				if (isHas) {
					var cInvoiceNo = gId("_cInvoice_no").value;
					if (cInvoiceNo) {
						gId("_cInvoice_no").value += "," + e.currentTarget.value.trim();
					} else {
						gId("_cInvoice_no").value = e.currentTarget.value.trim();
					}
				}
			} else {
				showMsg("发票号不能为空，请确认后重新录入！");
			}
			e.currentTarget.value = "";
		}
	}

	/**
	 * 检查发票号
	 * 1、扫描的发票号与数据库做比对，判断数据库中是否存在
	 * 2、扫描的发票号与页面发票号做比对，判断也买你发票号中是否存在
	 * @param  {String} invoiceNo 
	 * @return {Boolean}
	 */
	var checkInvoiceNo = function (invoiceNo) {
		var obj = {
			viewKey: "v_invoice_mscm",
			invoiceNo: invoiceNo
		};
		if (g.a.send("processType=g_mscm.invoice.Invoice&actionType=checkInvoiceNo", obj, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				var isHas = cReturn.isHas;
				if (isHas) {
					showMsg("发票号已入库，请扫描未入库的发票号！");
					return false;
				} else {
					var cInvoiceNo = gId("_cInvoice_no").value;
					if (cInvoiceNo != "") {
						if (cInvoiceNo.indexOf(invoiceNo) != -1) {
							showMsg("发票号已存在，不能重复录入！");
							return false;
						} else {
							return true;
						}
					} else {
						return true;
					}
				}
			} else {
				return false;
			}
		}
	}

	vf.afterMove = function () {
		var invoiceId = gId("_cInvoice_id").value;
		produceTableGrid(true, invoiceId);
		 if (!vf.status.equals("addnew")) {
		
		 }
	}

	vf.close = function () {
		if (win.para.callback) {
			win.para.callback();
		}
		win.close();
	}

	
</script>