<!DOCTYPE html>
<html>
<head>
    <title>开票单</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script> 
		
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zuiExt.js" type="text/javascript"></script>
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zuibtn.css" rel="stylesheet" type="text/css" />
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zuiExt.css" rel="stylesheet" type="text/css" />
    <script src="../../../../res/jscript/web_print.js?v=20191012"></script>
</head>
<body>
	<div id="divDC"></div>
	<form id="frm" action="" target="g_mscm.invoice.VIEW_invoice"> 
		<table id="tbForm" class="tbForm" style="width:955px;">
			<tr class="trH">
				<th style="width:130px;"></th>
				<th style="width:180px;"></th>
				<th style="width:130px;"></th>
				<th style="width:180px;"></th>
                <th style="width:130px;"></th>
				<th style="width:180px;"></th>
			</tr>
			<tr>				
				<td>开票单号：</td>
				<td><input type="text" id="_cInvoice_key" value="" disabled="disabled" /></td>
				<td>开票日期：</td>
				<td><input type="text" id="_cInvoice_date" class="Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" /></td>
                <td>金额：</td>
				<td><input type="text" id="_cInvoice_amount" value="" disabled="disabled" /></td>

			</tr>
			<tr>
				<td>期号：</td>
				<td><input type="text" id="_cPeriod" class="Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM' })" /></td>
				<td>发票号码：</td>
				<td colspan="5"><input type="text" id="_cInvoice_no" value="" /></td>
			</tr>           
		</table>	
		
		<input id="_cINVOICE_ID" type="hidden" value="" />
		<input id="_xPeriod" type="hidden" value="" />
		<input id="_castatus" type="hidden" value="" />
	</form>
    <div id="divGrid" style="height:330px;"></div> 
     <div id="divDeptGrid" style="height:300px;width:100%;"></div> 
     <div id="divDeptPackGrid" style="height:300px;width:100%;"></div> 
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var astatusNav = 0;

    var viewKeyDtl = "invoice_dtl";

    var nodeNav = null;
    var divGrid = gId("divGrid");
    var divDeptGrid = gId("divDeptGrid");
    var divDeptPackGrid = gId("divDeptPackGrid");

    var gridview = null,gridviewDept=null,gridviewDeptPack=null;
    // ------------------------------------------------------------------------
    function formLoad() {
        var strInvoice = "开票";
        if (topWin.serverName == "SD_ZhongLiu"){
            var strInvoice = "入库";
        }
        if (win.parentWindow.gridView.tree) {
            nodeNav = win.parentWindow.gridView.tree.selectedNode;
            astatusNav = (nodeNav.level > 1 ? nodeNav.value : 0);
        }

        vf.css(gId("tbForm"));
        formResize();

        initGridView();
        initGridViewDept();
        initGridPackViewDept();
        vf.addExtraButton({ key: "printIO", text: "打印开票单" });
    }
    function formResize() {
        var gridHeight = win.p.height - 130;
        divGrid.style.height = gridHeight*0.6 + "px";
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterAddnew = function () {
        frm._cInvoice_amount.value = "0";
        gId("_castatus").value = "0";
        frm._cInvoice_date.value = (new Date).toString();
		var date = (new Date).toString("yyyy-MM");
		var arr = date.split('-');
		var year = arr[0]; //获取当前日期的年份
		var month = arr[1]; //获取当前日期的月份
		var month2 = parseInt(month) - 1;
		if (month2 == 0) {//如果是1月份，则取上一年的12月份
			year = parseInt(year) - 1;
			month2 = 12;
		}

		var t2 = year + '-' + (month2.length ===2 ? month2: "0"+month2);
        frm._cPeriod.value = t2.toString();
    }

    vf.afterMove = function () {
        var invoiceId = frm._cINVOICE_ID.value.toInt();
        if(invoiceId<=0) invoiceId=-1;

        gridview.setViewFilter("invoice_id = " + invoiceId);
        
        gridviewDept.setViewFilter("invoice_id = " + invoiceId);
        vf.initTree();
        
         
        gridviewDeptPack.setViewFilter("invoice_id = " + invoiceId);
        vf.initTreeDeptPack();
        
        
        var astatus = gId("_castatus").value;
        if (astatus == -1) {
        	$("#divGrid *,#frm *").prop("disabled",true)
        }
		if (vf.status !== "addnew") {
			gId("_cPeriod").disabled = true;
		}
    }	
    
    vf.initTree=function(){
    	 var invoiceId = frm._cINVOICE_ID.value.toInt();
    	 var selectedNode=gridviewDept.tree.selectedNode;
    	 var filter="invoice_id = " + invoiceId;
    	 
       	if(selectedNode && selectedNode.isFirst){
	         gridviewDept.initTree(" and invoice_id = " + invoiceId );
       	}else{
       		filter+=" and dept_name ='"+selectedNode.value+"'";
       	}
   		gridviewDept.setViewFilter(filter);
    }
    
    
    vf.initTreeDeptPack=function(){
    	 var invoiceId = frm._cINVOICE_ID.value.toInt();
    	 var selectedNode=gridviewDeptPack.tree.selectedNode;
    	 var filter="invoice_id = " + invoiceId;
    	 
       	if(selectedNode && selectedNode.isFirst){
	         gridviewDeptPack.initTree(" and invoice_id = " + invoiceId );
       	}else{
       		filter+=" and dept_name ='"+selectedNode.value+"'";
       	}
       	
   		gridviewDeptPack.setViewFilter(filter);
    }
</script>

<!-- gridview -->
<script type="text/javascript">
    function initGridView() {
        var prop = {
            divContainer: divGrid,
            viewKey: viewKeyDtl,
            viewFilter: "invoice_id = 0",
            toolbarVisible: true,
            cellChange: function (para) {//单元格内容改变后,更新数据
            	var astatus = gId("_castatus").value;
		        if (astatus == -1) {
		            showErr("单据已审核，不能进行修改");
		            return;
		        }
                var dataRow = para.dataRow;
                var fieldName = para.fieldName;
                var fieldValue = para.newValue;
                var param={};
                param.viewKey=viewKeyDtl;
                param.remark=para.newValue;
                param.lot=dataRow.lot.value;
                param.invoice_id=dataRow.invoice_id.value;

                param.matr_id=dataRow.matr_id.value;
                
                if (g.a.send("processType=g_mscm.invoice.VIEW_invoice&actionType=undateBillSpDtlRemark", param, true)) {
                	var headTitle="";
                    if (g.a.OK) {
                        var cReturn = g.a.cReturn;
                        if (cReturn.OK) {
                            headTitle += "更新成功";
                        }
                    }
                    else {
                        headTitle += "更新失败";
                        return false;
                    }
                    zuiExt.msg({ msg: headTitle, type: "success" });
                    vf.initTree();
                    vf.initTreeDeptPack();
                }
                else {
                    return false;
                }
            },
            jsonToolbar: { height: "M", onclick: onToolbarClick }
        };
        gridview = new window.xwf_gridview(prop);
        if (astatusNav == 0) {
            gridview.toolbar.addBar({ type: "button", key: "addDtl", text: "<i class='fa fa-external-link'></i> 添加开票明细" });
        }
    }
    
    
    function initGridViewDept() {
    	var invoiceId = frm._cINVOICE_ID.value.toInt();
        var prop = {
            divContainer: divDeptGrid,
            viewKey: "invoice_dtl_dept",
            toolbarVisible: true,
            viewFilter: "invoice_id = "+invoiceId,
            nodeClick:function(para){	
            },
             jsonToolbar: { height: "M", onclick: onToolbarClick }
        };
        gridviewDept = new window.xwf_gridview(prop);
        
        gridviewDept.toolbar.addBar({ type: "button", key: "printDeptList", text: "<i class='fa fa-external-link'></i> 打印科室清单(一物一码)" });
    }
    
     function initGridPackViewDept() {
    	var invoiceId = frm._cINVOICE_ID.value.toInt();
        var prop = {
            divContainer: divDeptPackGrid,
            viewKey: "invoice_dtl_deptpack",
            toolbarVisible: true,
            viewFilter: "invoice_id = "+invoiceId,
            nodeClick:function(para){	
            },
             jsonToolbar: { height: "M", onclick: onToolbarClick }
        };
        gridviewDeptPack = new window.xwf_gridview(prop);
        
        gridviewDeptPack.toolbar.addBar({ type: "button", key: "printDeptPackList", text: "<i class='fa fa-external-link'></i> 打印科室清单(定数包)" });
         
    }

    function viewExtraButtonClick(para) {
    	if(para.btnKey == "removeDtl"){
    		var astatus = vf.dtbBase.rows[0]["astatus"].value;
	        var invoiceId = frm._cINVOICE_ID.value.toInt();
	
	        var dataRow = para.drViewData;
	        var matrId = dataRow["matr_id"].value;
	        var price = dataRow["price"].value;
	        var lot = dataRow["lot"].value;
	        // ------------------------------------------------
	        if (astatus == -1) {
	            showErr("单据已审核，不能移除记帐明细");
	            return false;
	        }
	        // ------------------------------------------------
	        if (g.a.send("processType=g_mscm.invoice.Common&actionType=removeBillDtlFromInvoice", { invoiceId: invoiceId, matrId: matrId, price:price,lot:lot }, true)) {
	            if (g.a.OK) {
	                var cReturn = g.a.cReturn;
	
	                gridview.refresh();
	                vf.refreshRecord();
	                //setSum();
	               vf.initTree();
	               vf.initTreeDeptPack();
	                return true;
	            }
	            else {
	                return false;
	            }
	        }
	        else {
	            return false;
	        }
    	}else if(para.btnKey == "printIO"){
    	
    	}
        
    }

    function onToolbarClick(para) {




        if (para.key.equals("addDtl")) {
            if (vf.status.equals("addnew")) {
                if (!vf.save()) {
                    return false;
                }
            }


            var prop = {
                title: "请选择待开票明细...",
                width: 0.65,
                height: 0.8,
                parent: win
            };
            var para = {
                viewKey: "bill_dtl_select",
                viewMode: "multiSelect",
				viewFilter: "period = '"+ gId("_cPeriod").value+"'",
                selectCallback: onNewDtlSelected
            };
            topWin.openSelectView(prop, para);
        }else if (para.key.equals("printDeptList")) {
        	var selectedNode=gridviewDept.tree.selectedNode;
            if (astatusNav!=-1) {
                showErr("开票单还未通过审核,无法打印");
                return false;
            }
        	if(!selectedNode || !selectedNode.value){
        		alert("请选择左侧需要打印的科室");
        		return;
        	}
             var sp_amountall = 0;
            var strInvoice = "开票";
        	if (topWin.serverName == "SD_ZhongLiu"){
                var strInvoice = "入库";
            }
            var param = {
                title:  strInvoice+"单("+gId("_cPeriod").value+")(一物一码)("+gId("_cInvoice_key").value+")("+selectedNode.value+")",
                colNumThs: 4, //表头每行多少列，默认为4
                colNumTfooters: 4, //表尾每行多少列，默认为4
                pageRowNum: 10, //每页数量
                pageSize:"b52",//无间距且自动换行
                pageFixed:"pf2",//固定位置
                form: {
                    ths: [
                        { text: "供应商", value: topWin.companyName,css:"white-space: normal;" },
                        { text: "日期", value: gId("_cInvoice_date").value },
                        { text: strInvoice+"总额", value: gId("_cInvoice_amount").value },
                        { text: "", value: "" },
                        { text: "发票号", value: gId("_cInvoice_no").value, colspan: 7,css:"white-space: normal;" }
                    ],
                    tfooters: [
                    	{ text: "SPD运营", value: "" },
                        { text: "库管", value: "" },
                        { text: "采购", value: "" },
                        { text: "科室", value: "" },
                        { text: "财务", value: ""}
                    ]
                },
                  afterInit:function(grid){ //初始化完成后调用
			    	if(grid){
			    		grid.find(".datarow").each(function(){
			    			var row=$(this);
			    			var td=row.children("td:eq(10)");
			    			
			    			//备注列可以换行
		    				td.css({"white-space":"normal"});
		    				
		    				//厂商，注册证可以编辑
		    				var tdmfg=row.children("td:eq(8)");
		    				var tdregno=row.children("td:eq(9)");
		    				tdmfg.css({"white-space":"normal"});
		    				tdregno.css({"white-space":"normal"});
		    				var mfg=tdmfg.text();
		    				var regno=tdregno.text();
		    				tdmfg.html('<input style="height: 33px;" value="'+mfg+'"/>');
		    				tdregno.html('<input  style="height: 33px;" value="'+regno+'"/>');
			    		})
			    	}
			    },
                sumTableFun:function(jqPageTable){//打印汇总函数，即每个分页最后一行汇总行的处理方法，可以不传，可以参考 balance_matr.html 用法
			    	var trRet=["<tr>"];
			    	//合计标题列和空列
			    	trRet.push("<td>合计</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	
			    	
			    	//合计列
			    	var sumqtyin=0,sumamount=0;
			    	jqPageTable.find(".datarow").each(function(){
			    		var tr=$(this);
			    		var thqtyin=parseFloat(tr.children("td:eq(5)").text());
			    		var amount=parseFloat(tr.children("td:eq(7)").text());
			    		if(!isNaN(thqtyin)) sumqtyin+=thqtyin;
			    		if(!isNaN(amount)) sumamount+=amount;
			    	});
			    	trRet.push("<td>"+parseInt(sumqtyin) +"</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td>"+sumamount.toFixed(2)+"</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	
			    	trRet.push("</tr>");
			    	return trRet.join("");
			    },
                grid: {
                    ths: ["序号", "品名", "品规","批次", "单位", "数量", "单价", "金额","厂商","注册证","备注"],
                    thwidths: ["40px", "auto", "150px", "100px",  "50px", "50px", "80px", "80px","200px","150px","100px"],
                    data: (function () {
                        var arr = [], row, sp_amount = 0, sell_amount = 0;
                        if (gridview && gridviewDept.dtbViewData.rowCount > 0) {
                            var totalprice = 0, totalPriceSell = 0, rowData;
                            for (var i in gridviewDept.dtbViewData.rows) {
                                row = gridviewDept.dtbViewData.rows[i];
                                rowData = [];
                                rowData[0] = (parseInt(i) + 1);
                                rowData[1] = row["matr_name"].value;
                                rowData[2] = row["matr_spec"].value;
                                rowData[3] = row["lot"].value;
                                rowData[4] = row["matr_unit"].value;
                                rowData[5] = row["qty"].value;
                                rowData[6] = row["price"].value;
                                rowData[7] = row["amount"].value;
                                rowData[8] = row["manufacturer"].value;
                                rowData[9] = row["register_no"].value;
                                rowData[10] = row["remark"].value;
                                arr.push(rowData);
                                sp_amountall+=row["amount"].value;
                            }
                        }
                        return arr;
                    })()
                }
            };
            param.form.ths[3]={ text: selectedNode.value, value:parseFloat(sp_amountall).toFixed(2)};
            WebPrint.goPrintFormModel(param);
        }else if (para.key.equals("printDeptPackList")) {
        	var selectedNode=gridviewDeptPack.tree.selectedNode;
            if (astatusNav!=-1) {
                showErr("开票单还未通过审核,无法打印");
                return false;
            }
        	if(!selectedNode || !selectedNode.value){
        		alert("请选择左侧需要打印的科室");
        		return;
        	}
             var sp_amountall = 0;
            var param = {
                title:  strInvoice+"单("+gId("_cPeriod").value+")(定数包)("+gId("_cInvoice_key").value+")("+selectedNode.value+")",
                colNumThs: 4, //表头每行多少列，默认为4
                colNumTfooters: 4, //表尾每行多少列，默认为4
                pageRowNum: 10, //每页数量
                pageSize:"b52",//无间距且自动换行
                pageFixed:"pf2",//固定位置
                form: {
                    ths: [
                        { text: "供应商", value: topWin.companyName,css:"white-space: normal;" },
                        { text: "日期", value: gId("_cInvoice_date").value },
                        { text: strInvoice+"总额", value: gId("_cInvoice_amount").value },
                        { text: "", value: "" },
                        { text: "发票号", value: gId("_cInvoice_no").value, colspan: 7,css:"white-space: normal;" }
                    ],
                    tfooters: [
                    	{ text: "SPD运营", value: "" },
                        { text: "库管", value: "" },
                        { text: "采购", value: "" },
                        { text: "科室", value: "" },
                        { text: "财务", value: ""}
                    ]
                },
                  afterInit:function(grid){ //初始化完成后调用
			    	if(grid){
			    		grid.find(".datarow").each(function(){
			    			var row=$(this);
			    			var td=row.children("td:eq(10)");
			    			
			    			//备注列可以换行
		    				td.css({"white-space":"normal"});
		    				
		    				//厂商，注册证可以编辑
		    				var tdmfg=row.children("td:eq(8)");
		    				var tdregno=row.children("td:eq(9)");
		    				tdmfg.css({"white-space":"normal"});
		    				tdregno.css({"white-space":"normal"});
		    				var mfg=tdmfg.text();
		    				var regno=tdregno.text();
		    				tdmfg.html('<input style="height: 33px;" value="'+mfg+'"/>');
		    				tdregno.html('<input  style="height: 33px;" value="'+regno+'"/>');
			    		})
			    	}
			    },
                sumTableFun:function(jqPageTable){//打印汇总函数，即每个分页最后一行汇总行的处理方法，可以不传，可以参考 balance_matr.html 用法
			    	var trRet=["<tr>"];
			    	//合计标题列和空列
			    	trRet.push("<td>合计</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	
			    	
			    	//合计列
			    	var sumqtyin=0,sumamount=0;
			    	jqPageTable.find(".datarow").each(function(){
			    		var tr=$(this);
			    		var thqtyin=parseFloat(tr.children("td:eq(5)").text());
			    		var amount=parseFloat(tr.children("td:eq(7)").text());
			    		if(!isNaN(thqtyin)) sumqtyin+=thqtyin;
			    		if(!isNaN(amount)) sumamount+=amount;
			    	});
			    	trRet.push("<td>"+parseInt(sumqtyin) +"</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td>"+sumamount.toFixed(2)+"</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	
			    	trRet.push("</tr>");
			    	return trRet.join("");
			    },
                grid: {
                    ths: ["序号","包名", "品名", "品规","批次", "单位", "数量", "单价", "金额","厂商","注册证","备注"],
                    thwidths: ["40px","auto", "auto", "150px", "100px",  "50px", "50px", "80px", "80px","200px","150px","100px"],
                    data: (function () {
                        var arr = [], row, sp_amount = 0, sell_amount = 0;
                        if (gridviewDeptPack && gridviewDeptPack.dtbViewData.rowCount > 0) {
                            var totalprice = 0, totalPriceSell = 0, rowData;
                            for (var i in gridviewDeptPack.dtbViewData.rows) {
                                row = gridviewDeptPack.dtbViewData.rows[i];
                                rowData = [];
                                rowData[0] = (parseInt(i) + 1);
                                rowData[1] = row["pack_name"].value;
                                rowData[2] = row["matr_name"].value;
                                rowData[3] = row["matr_spec"].value;
                                rowData[4] = row["lot"].value;
                                rowData[5] = row["matr_unit"].value;
                                rowData[6] = row["qty"].value;
                                rowData[7] = row["price"].value;
                                rowData[8] = row["amount"].value;
                                rowData[9] = row["manufacturer"].value;
                                rowData[10] = row["register_no"].value;
                                rowData[11] = row["remark"].value;
                                arr.push(rowData);
                                sp_amountall+=row["amount"].value;
                            }
                        }
                        return arr;
                    })()
                }
            };
            param.form.ths[3]={ text: selectedNode.value, value:parseFloat(sp_amountall).toFixed(2)};
            WebPrint.goPrintFormModel(param);
        }
        else {
            showWarn("未实现的扩展功能，请检查。");
            return false;
        }
    }
    function onNewDtlSelected(arrDataRow) {
        var invoiceId = frm._cINVOICE_ID.value.toInt();
        var billDtls = "";
        var arrValues, arrSelectedRows= new Array();
        // ------------------------------------------------
        for (var i = 0; i < arrDataRow.length; i++) {
            arrValues = new Array();
            arrValues.push(arrDataRow[i]["period"].value);
            arrValues.push(arrDataRow[i]["matr_id"].value);
            arrValues.push(arrDataRow[i]["price"].value);
            arrValues.push(arrDataRow[i]["lot"].value);
            arrValues.push(arrDataRow[i]["matr_spec"].value);
            arrValues.push(arrDataRow[i]["matr_name"].value);

            arrSelectedRows.push(arrValues.join(";"));
        }
        billDtls = arrSelectedRows.join(",");

        // ------------------------------------------------
        if (g.a.send("processType=g_mscm.invoice.Common&actionType=addBillDtlToInvoice", { invoiceId: invoiceId, billDtls: billDtls }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn; 

                gridview.refresh();
                vf.refreshRecord();
               	vf.initTree();
               	vf.initTreeDeptPack();
                return true;
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
    
     // 扩展按钮点击后触发
    vf.beforeClick = function (para) {

        if (para.buttonKey === "printIO") {//打印
            if (astatusNav!=-1) {
                showErr("开票单还未通过审核,无法打印")
                return false;
            }
            var sp_amountall = 0;
            var strInvoice = "开票";
            if (topWin.serverName == "SD_ZhongLiu"){
                var strInvoice = "入库";
            }
            var param = {
                title:  strInvoice+"单("+gId("_cPeriod").value+")("+gId("_cInvoice_key").value+")",
                colNumThs: 3, //表头每行多少列，默认为4
                colNumTfooters: 4, //表尾每行多少列，默认为4
                pageRowNum: 10, //每页数量
                pageSize:"b52",//无间距且自动换行
                pageFixed:"pf2",//固定位置
                form: {
                    ths: [
                        { text: "供应商", value: topWin.companyName,css:"white-space: normal;" },
                        { text: "日期", value: gId("_cInvoice_date").value },
                        { text: strInvoice+"总额", value: gId("_cInvoice_amount").value },
                        { text: "发票号", value: gId("_cInvoice_no").value, colspan: 5,css:"white-space: normal;" }
                    ],
                    tfooters: [
                    	{ text: "SPD运营", value: "" },
                        { text: "库管", value: "" },
                        { text: "采购", value: "" },
                        { text: "科室", value: "" },
                        { text: "财务", value: ""}
                    ]
                },
                  afterInit:function(grid){ //初始化完成后调用
			    	if(grid){
			    		grid.find(".datarow").each(function(){
			    			var row=$(this);
			    			var td=row.children("td:eq(10)");
			    			
			    			//备注列不换行
		    				td.css({"white-space":"normal"});
		    				
		    				//厂商，注册证可以编辑
		    				var tdmfg=row.children("td:eq(8)");
		    				var tdregno=row.children("td:eq(9)");
		    				tdmfg.css({"white-space":"normal"});
		    				tdregno.css({"white-space":"normal"});
		    				var mfg=tdmfg.text();
		    				var regno=tdregno.text();
		    				tdmfg.html('<input style="height: 33px;" value="'+mfg+'"/>');
		    				tdregno.html('<input  style="height: 33px;" value="'+regno+'"/>');
		    				
			    		})
			    	}
			    },
                sumTableFun:function(jqPageTable){//打印汇总函数，即每个分页最后一行汇总行的处理方法，可以不传，可以参考 balance_matr.html 用法
			    	var trRet=["<tr>"];
			    	//合计标题列和空列
			    	trRet.push("<td>合计</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	
			    	
			    	//合计列
			    	var sumqtyin=0,sumamount=0;
			    	jqPageTable.find(".datarow").each(function(){
			    		var tr=$(this);
			    		var thqtyin=parseFloat(tr.children("td:eq(5)").text());
			    		var amount=parseFloat(tr.children("td:eq(7)").text());
			    		if(!isNaN(thqtyin)) sumqtyin+=thqtyin;
			    		if(!isNaN(amount)) sumamount+=amount;
			    	});
			    	trRet.push("<td>"+parseInt(sumqtyin) +"</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td>"+sumamount.toFixed(2)+"</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	
			    	trRet.push("</tr>");
			    	return trRet.join("");
			    },
                grid: {
                    ths: ["序号", "品名", "品规","批次", "单位", "数量", "单价", "金额","厂商","注册证","备注"],
                    thwidths: ["40px", "auto", "auto", "100px",  "50px", "80px", "80px", "80px","200px","150px","100px"],
                    data: (function () {
                        var arr = [], row, sp_amount = 0, sell_amount = 0;
                        if (gridview && gridview.dtbViewData.rowCount > 0) {
                            var totalprice = 0, totalPriceSell = 0, rowData;
                            for (var i in gridview.dtbViewData.rows) {
                                row = gridview.dtbViewData.rows[i];
                                rowData = [];
                                rowData[0] = (parseInt(i) + 1);
                                rowData[1] = row["matr_name"].value;
                                rowData[2] = row["matr_spec"].value;
                                rowData[3] = row["lot"].value;
                                rowData[4] = row["matr_unit"].value;
                                rowData[5] = row["qty"].value;
                                rowData[6] = row["price"].value;
                                rowData[7] = row["amount"].value;
                                rowData[8] = row["manufacturer"].value;
                                rowData[9] = row["register_no"].value;
                                rowData[10] = row["remark"].value;
                                arr.push(rowData);
                            }
                        }
                        return arr;
                    })()
                }
            };
            WebPrint.goPrintFormModel(param);
	        return false;
        }
        return true;
    }
    
      //---计算总额方法--------------------
    function setSum() {
        var invoiceId = frm._cINVOICE_ID.value.toInt();
        //计算返点金额
        if (g.a.send("processType=g_mscm.invoice.Common&actionType=countSum", { settlement_id: invoiceId, viewkey: "invoice" }, true)) {
            if (g.a.OK) {
            	var sum=0;
                sum=parseFloat(g.a.cReturn.sum);
                frm._cInvoice_amount.value=sum.toFixed(2);
            }
        }
    }
    
     //流程操作前
    vf.beforeFlowClick = function (prop) {
        if (prop.fbKey == "commit" || prop.fbKey == "approve") {		//提交
            if (gridview.totalRows <= 0) {
                zuiExt.msg({ msg: "明细数据为0，请添加好明细数据再提交!", type: "warning" });
                return false;
            }
        }
        return true;
    };
</script>