<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
    <title>订单</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script> 
		
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <style type="text/css">
        #divGridDtl {
            height: 420px;
        }
    </style>
</head>
<body>
    <div id="divDC"></div>
    <div class="PanelA">
        <form id="frm" action="" target="g_mscm.advice.RepNotify">
            <table id="tbForm" class="tbForm" style="width:1000px;">
                <tr>
                    <th style="width: 12%;"></th>
                    <th style="width: 23%;"></th>
                    <th style="width: 12%;"></th>
                    <th style="width: 23%;"></th>
                    <th style="width: 12%;"></th>
                    <th style="width: 18%;"></th>
                </tr>
                <tr>
                    <td>订单号</td>
                    <td><input type="text" id="_cRn_key" disabled="disabled" /></td>
                    <td>订单日期</td>
                    <td><input type="text" id="_cRn_date" disabled="disabled" /></td>
                    <td>订单类型</td>
                    <td><input type="text" id="_cPo_type_name" disabled="disabled" /></td>                    
                </tr>
                <tr>
                    <td>需求来源</td>
                    <td><input type="text" id="_cStorage_fullname_req" disabled="disabled" /></td>
                    <td>要求送达日期</td>
                    <td><input type="text" id="_cRn_delivery_date" disabled="disabled" /></td>
                    <td>金额</td>
                    <td><input type="text" id="_cPo_amount" disabled="disabled" /></td>
                </tr>
                <tr>
                    <td>采购员</td>
                    <td><input type="text" id="_cPo_buyer" disabled="disabled" /></td>
                    <td>备注</td>
                    <td colspan="3"><input type="text" id="_cRn_remark" disabled="disabled" /></td>
                </tr>
            </table>
            <input type="hidden" id="_cREP_NOTIFY_ID" value="" />
            <input type="hidden" id="_cCOMPANY_ID" value="" />
            <input type="hidden" id="_cAStatus" value="" />
        </form>
    </div>
    <div class="PanelA bill-dtl">
        <div id="divGridDtl"></div>
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var node = null;
    var gvDtl = null;
    // ------------------------------------------------------------------------
    function formLoad() {
    var gridView = win.parentWindow.gridView;
    if(gridView.flowKey ==''){ /// 一下是针对于树所作的操作
        var node = gridView.tree.selectedNode;
        var navAStatus = (node.level > 1 ? node.Columns["astatus"] : 0);

        vf.css(gId("tbForm"));
        if (navAStatus == 0) {
            vf.addExtraButton({ key: "confirmPo", text: "确认订单" });
        }        
        if (navAStatus == 0 || navAStatus == 1) {
            vf.addExtraButton({ key: "closePo", text: "提前关闭订单", title: "订单未发货或部分发货，后续不再发货" });
        }
        if (navAStatus == -1) {
            // -- 被手工关闭，尚未全部完成发货的订单，允许恢复到待发货状态 --
            // -- vf.addExtraButton({ key: "restorePo", text: "恢复订单" }); --
        }

        var restHeight = win.p.height - gId("divGridDtl").offsetTop - 20;
        if (restHeight < 250) {
            restHeight = 250;
        }
        gId("divGridDtl").style.height = restHeight + "px";      
       }  
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterMove = function () {
        showGrid();
    }

    vf.beforeClick = function (para) {
        var btnKey = para.buttonKey;
        var repNotifyIds = frm._cREP_NOTIFY_ID.value.toInt();
        var AStatus = frm._cAStatus.value.toInt();
        // ------------------------------------------------
        if (btnKey.equals("confirmPo")) {
            if (g.a.send("processType=g_mscm.advice.RepNotify&actionType=confirmPo", { viewKey: 'rep_notify', repNotifyIds: repNotifyIds }, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;

                    showMsg("订单确认成功！");
                    vf.remove();
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }
        else if (btnKey.equals("closePo")) {
            if (!showConfirm("订单尚未配送完成，您确定要关闭当前订单吗？")) {
                return;
            }
            if (g.a.send("processType=g_mscm.advice.RepNotify&actionType=closePo", { viewKey: 'rep_notify', repNotifyIds: repNotifyIds }, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;

                    showMsg("订单关闭成功！");
                    vf.remove();
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }
        else {
            showErr("未实现的扩展按钮[" + btnKey + "]事件，请检查。");
            return false;
        }
        // ------------------------------------------------
        return false;
    }
</script>
<!-- gridview -->
<script type="text/javascript">
    function showGrid() {
        var AStatus = frm._cAStatus.value.toInt();
        var viewFilter = "rep_notify_id=" + frm._cREP_NOTIFY_ID.value.toInt();
        if (gvDtl == null) {
            var prop = {
                divContainer: gId("divGridDtl"),
                viewKey: "v_rep_notify_dtl_mscm",
                viewFilter: viewFilter,
                toolbarVisible: AStatus == 0 && false,
                viewForm: "project/g_mscm/html/rep_notify/rep_notify_dtl.html",
                jsonToolbar: { height: "M", onclick: toolbarClick }
            };
            gvDtl = new window.xwf_gridview(prop);
            if (frm._cAStatus.value.toInt() == 0) {
                gvDtl.toolbar.addBar({ type: "button", key: "btnIgnore", text: "<i class='fa fa-circle' aria-hidden='true'></i>  忽略明细", align: "left", style: "Grid", icon: null });
                gvDtl.toolbar.addBar({ type: "button", key: "btnCancelIgnore", text: "<i class='fa fa-circle-o' aria-hidden='true'></i>  取消忽略", align: "left", style: "Grid", icon: null });
            }
        }
        else {
            gvDtl.setViewFilter(viewFilter);
        }
    }

    function toolbarClick(para) {
        var astatus = frm._cAStatus.value;
        var selectedDtlArray = [];
        for (var i = 0; i < gvDtl.dtbViewData.rowCount; i++) {
            if (gvDtl.dtbViewData.rows[i].checked) {
                selectedDtlArray.push(gvDtl.dtbViewData.rows[i]["rep_notify_dtl_id"].value);
            }
        }
        if (selectedDtlArray.length == 0) {
            showMsg("请勾选需要操作得明细！");
            return false;
        }
        if (para.key.equals("btnIgnore")) {
            for (var i = 0; i < gvDtl.dtbViewData.rowCount; i++) {
                if (gvDtl.dtbViewData.rows[i].checked) {
                    if (gvDtl.dtbViewData.rows[i]['status_res'].value == '-2') {
                        showMsg("所选明细已被忽略，不能重复此操作！");
                        return;
                    }
                }
            }
            btnIgnore_click(selectedDtlArray);
        } else if (para.key.equals("btnCancelIgnore")) {
            for (var i = 0; i < gvDtl.dtbViewData.rowCount; i++) {
                if (gvDtl.dtbViewData.rows[i].checked) {
                    if (gvDtl.dtbViewData.rows[i]['status_res'].value != '-2') {
                        showMsg("所选明细已取消忽略，不能重复此操作！");
                        return;
                    }
                }
            }
            btnCancelIgnore_click(selectedDtlArray);
        } else {
            showErr("unknown button " + para.key);
        }
    }
    function btnIgnore_click(arr) {
        var isAll = 1; // 判断明细是否全部已被忽略，1-没有全部被忽略，2-全部被忽略
        if (gvDtl.dtbViewData.rowCount > 0) {
            var repNotifyId = gvDtl.dtbViewData.rows[0]['rep_notify_id'].value;
            for (var i = 0; i < gvDtl.dtbViewData.rowCount; i++) {
                if (!gvDtl.dtbViewData.rows[i].checked) {
                    if (gvDtl.dtbViewData.rows[i]["status_res"].value != '-2') {
                        isAll = 1;
                        break;
                    } else {
                        isAll = 2;
                    }
                } else {
                    isAll = 2;
                }
            }
        }
        var keys = arr.join(",");
        if (g.a.send("processType=g_mscm.advice.Replenishment&actionType=notifyIgnoreDetail", { keys: keys, "isAll": isAll, "repNotifyId": repNotifyId, viewKey: 'v_rep_notify_dtl_mscm' }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                showMsg("选中的明细已忽略！");
                // win.parentWindow.gridView.refresh();
                showGrid();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
    function btnCancelIgnore_click(arr) {
        var isAll = 1; // 判断明细是否全部已被取消忽略，1-没有全部被取消忽略，2-全部被取消忽略
        var execut = true; //是否继续执行
        var arrSelectedRows = new Array();
        if (gvDtl.dtbViewData.rowCount > 0) {
            var repNotifyId = gvDtl.dtbViewData.rows[0]['rep_notify_id'].value;
            for (var i = 0; i < gvDtl.dtbViewData.rowCount; i++) {
                if (!gvDtl.dtbViewData.rows[i].checked) {
                    if (gvDtl.dtbViewData.rows[i]["status_res"].value == '-2') {
                        isAll = 1;
                        break;
                    }
                    else {
                        isAll = 2;
                    }
                }
                else {
                    isAll = 2;
                }
            }
        }

        var keys = arr.join(",");
        if (g.a.send("processType=g_mscm.advice.Replenishment&actionType=notifyCancelIgnoreDetail", { keys: keys, "isAll": isAll, "repNotifyId": repNotifyId, viewKey: 'v_rep_notify_dtl_mscm' }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                showMsg("选中的明细已取消忽略！");
                showGrid();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>