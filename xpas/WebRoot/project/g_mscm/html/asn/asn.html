<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <title>发货单</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/excel.js" type="text/javascript"></script>
    <script src="../../js/barcode_parse.js" type="text/javascript"></script>
    <script src="../../js/resource_print.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/jquery/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/web_print.js?v=20191023" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }

        #tbLayout {
            border-collapse: collapse;
        }

        #scanBox {
            font-size: 1em;
            font-family: Arial;
            height: 26px;
            line-height: 24px;
            border: 2px solid #19A2D5;
        }

        .fa-medkit {
            font-size: 1.5em;
            color: #19A2D5;
        }

        .import-alert {
            font-weight: bolder;
        }

        .a-small {
            font-size: 0.9em;
            color: Blue;
        }

            .a-small:hover {
                cursor: pointer;
                color: #19A2D5;
            }

        #divDC {
            width: 1300px;
            background: transparent;
        }

        .PanelA {
            width: 98%;
            margin-left: auto;
            margin-right: auto;
        }

        #tbForm {
            width: 100%;
        }

        .bill-dtl {
            margin-top: 10px;
        }

        #divGridDtl {
            height: 400px;
        }

            #divGridDtl input {
                border: solid 0px;
            }
    </style>
</head>
<body>
    <div id="divDC" style="padding-left:6px;"></div>
    <div class="PanelA">
        <form id="frm" action="" target="g_mscm.asn.VIEW_asn">
            <table id="tbForm" class="tbForm">
               <tr id="trH">
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                </tr>
                <tr>
                    <td>发货单号</td>
                    <td><input type="text" id="_cAsn_key" disabled="disabled" />
                    <td>订单类型</td>
                    <td><input type="text" id="_gPo_type_name" disabled="disabled" />
                    <td>制单日期</td>
                    <td><input type="text" id="_cAsn_date" disabled="disabled"/>
                     <td>要求到货日期</td>
                    <td><input type="text" id="_cAsn_date_last" disabled="disabled"/>
                </tr>
                <tr>
                    <td>订单号</td>
                    <td class="combo">
                        <input id="_gRn_key" type="text" readonly="readonly" />
                        <div id="divSelectRepNotify" class="fa fa-search" onclick="selectRepNotify();" style="    top: 8px;right: 66px;"></div>
                    </td>
                    <td>订单日期</td>
                    <td><input type="text" id="_gRn_date" disabled="disabled" />
                    <td>采购仓库</td>
                    <td colspan="1"><input type="text" id="_gStorage_fullname" disabled="disabled" />
                    <td>需求仓库</td>
                    <td colspan=""><input type="text" id="_gStorage_fullname_req" disabled="disabled" />
                </tr>
                <tr>
                    <td>采购员</td>
                    <td><input type="text" id="_gPo_buyer" disabled="disabled" />
                    <td>采购订单金额</td>
                    <td><input type="text" id="_gPo_amount" disabled="disabled" />
                    <td>本次发货金额</td>
                    <td><input type="text" id="_cAsn_Amount" readonly="readonly" />
                </tr>
                <tr>
                    <td>制单</td>
                    <td><input type="text" id="_cCreator" readonly="readonly" />
                    <td>审核</td>
                    <td><input type="text" id="_cAuditor" readonly="readonly" />
                    <td>备注</td>
                    <td colspan="3"><input type="text" id="_cAsn_remark" />
                </tr>
            </table>
            <input type="hidden" id="_cASN_ID" />
            <input type="hidden" id="_cREP_NOTIFY_ID" />
            <input type="hidden" id="_cAStatus" />
            <input type="hidden" id="_cStatus_receive" />
        </form>
    </div>
    <div class="PanelA bill-dtl">
        <table id="tbDtl" class="tbForm" style="width: 100%;">
            <tr class="trH">
                <th style="width: 12%"></th>
                <th style="width: 12%"></th>
                <th style="width: 10%"></th>
                <th style="width: 12%"></th>
                <th style="width: 10%"></th>
                <th style="width: 17%"></th>
                <th style="width: 10%"></th>
                <th style="width: 17%"></th>
            </tr>

            <tr id="inputArea" style="display: none;">
                <td > <input type="text" id="_fmatr_name" disabled="disabled" /></td>
                   <td > <input type="text" id="_flot" disabled="disabled" /></td>
                  <td > <input type="text" id="_fexp_date" disabled="disabled" /></td>
                <td colspan="2"> <input type="text" id="_foriginal_barcode" disabled="disabled" /></td>
                <td colspan="2">
                    <input type="text" id="txtScan"  placeholder="扫描GTIN码和批次效期" style="ime-mode: disabled;" onkeydown="enterPress(event)" />

                </td>
                <td class="pageButtons" style="text-align:right;" ><input type="button" id="btnAdd" value="确定" onclick="scanclick();"  /></td>

            </tr>
        </table>
        <input type="hidden" id="_fmatr_code" />
        <input type="hidden" id="" />
        <div id="divGridDtl"></div>
    </div>
</body>
</html>
<!-- formLoad -->
<script type="text/javascript">
    var gvDtl = null; var lot = ""; var expiredDate = "";var asnDtlId="0";
    // ------------------------------------------------------------------------
    function formLoad() {
        vf.addExtraButton({ key: "printBarcode", text: "打印条码" });
        vf.addExtraButton({ key: "printASN", text: "打印送货单" });
        vf.css(gId("tbForm"));
        vf.css(gId("tbDtl"));
        var restHeight = win.p.height - gId("divGridDtl").offsetTop - 20;
        if (restHeight < 250) {
            restHeight = 250;
        }
        gId("divGridDtl").style.height = restHeight + "px";
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterAddnew = function () {
        frm._cAsn_date.value = (new Date()).toString();
        frm._cAStatus.value = "0";
        frm._cStatus_receive.value = "0";
    }
    vf.afterMove = function () {

        if (gId("_gPo_type_name").value.equals("代销")) {
            gId("tbDtl").style.display = "";
            gId("txtScan").focus();
        } else {
            gId("tbDtl").style.display = "none";
        }
        if (vf.status.equals("addnew")) {
            divSelectRepNotify.style.display = "";

        }
        else {
            divSelectRepNotify.style.display = "none";

        }
        if (frm._cStatus_receive.value.toInt() == -1) {
            vf.buttons["printASN"].style.display = "none";
        }
        if (vf.buttons["printBarcode"]) {
            if (frm._gPo_type_name.value.equals("代销")) {
                vf.buttons["printBarcode"].style.display = "";
            }
            else {
                vf.buttons["printBarcode"].style.display = "none";
            }
        }

        showGridDtl();
    } 

    vf.beforeClick = function (btn) {
        var asnId = frm._cASN_ID.value.toInt();
        // ------------------------------------------------
        if (btn.buttonKey.equals("printASN")) {
            //   printAsn(asnId);
            if(topWin.serverName.equals("spp") && topWin.companyIdMi == 9764){ //武汉六院 自动触发打印条码
            	if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=generateBarcode", { viewKey: 'asn_from_rep_notify', asnId: asnId }, false)) {
                    if (g.a.OK) {
                    	gvDtl.refresh();
                    }
            	}
            }
            //校验一物一码的是否已经进行过编码
            
            if (!gvDtl || gvDtl.dtbViewData.rowCount <= 0) {
            	alert("该发货单没有可用发货明细")
            	return;
            } 
             var isomoc, has_bcname,row,matr_name;
             for (var i in gvDtl.dtbViewData.rows) {
                 row = gvDtl.dtbViewData.rows[i];
                isomoc=row.isomoc.value;
                matr_name=row.matr_name.value;
                has_bcname=row.has_bcname.value;
                if(isomoc == "是" && has_bcname =="否"){
                	alert("第"+(parseInt(i)+1)+"条数据("+matr_name+")，没有进行编码，请点击打印条码，然后再打印送货单");
                	return;
                }
             }
            
            WebPrint.goPrintSHD(vf, gvDtl);
        }
        else if (btn.buttonKey.equals("printBarcode")) {
            if (frm._gPo_type_name.value.equals("代销")) {
                printBarcode(asnId);
            }
            else {
                showMsg("购销类订单不能打印条码。");
            }
        }
        // ------------------------------------------------
        return false;
    }
    vf.beforeFlowClick = function (para) {
        var fbKey = para.fbKey;

        var dtMfg = null, dtExp = null;
        var dtNow = (new Date()).toString().toDate();

        var dtb = gvDtl.dtbViewData;
        var dataRow = null;
        // ------------------------------------------------
        if (fbKey.equals("approve")) {
            for (var i = 0; i < dtb.rowCount; i++) {
                dataRow = dtb.rows[i];
                dtMfg = dataRow["mfg_date"].value.substring(0, 10).toDate();
                dtExp = dataRow["exp_date"].value.substring(0, 10).toDate();

                // -- 生产日期、有效日期 --
                if (dtMfg >= dtNow) {
                    showWarn("第 " + (i + 1) + " 行 [生产日期] 必需早于当前日期，请检查。");
                    return false;
                }
                if (dtExp <= dtNow) {
                    showWarn("第 " + (i + 1) + " 行 [有效日期] 必需晚于当前日期，请检查。");
                    return false;
                }
                // -- 批次号、效期 --
                if (dataRow["lot"].value.equals("")) {
                    showWarn("第 " + (i + 1) + " 行 [批次号] 不能为空，请输入。");
                    return false;
                }
                if (dataRow["register_no"].value.equals("")) {
                    showWarn("第 " + (i + 1) + " 行 [注册证号] 不能为空，请输入。");
                    return false;
                }
                if (dataRow["disinfection_lot"].value.equals("")) {
                    showWarn("第 " + (i + 1) + " 行 [灭菌批次] 不能为空；若没有请填写'无'。");
                    return false;
                }
                
            }
        }
        else {
            // -- --
        }
        return true;
    }
    
    vf.afterSetStatus = function () {
        if (gId("_cAStatus").value == "-1") {   // -- 只有已发货的才可以打印 --
            $(vf.buttons.printASN).show();
            $(vf.buttons.printBarcode).show();
        }
        else {
            $(vf.buttons.printASN).hide();
            $(vf.buttons.printBarcode).hide();
        }
        if (topWin.serverName.equals("spp") && topWin.companyIdMi == 9764) {
            vf.buttons["printBarcode"].style.display = "none";
        }
    }
</script>
<!-- gridview -->
<script type="text/javascript">
    function showGridDtl() {
        var allowModify = frm._cAStatus.value.toInt() == 0;
        var viewFilter = "asn_id = " + frm._cASN_ID.value.toInt();
        // ------------------------------------------------
        if (gvDtl == null) {
            var prop = {
                divContainer: gId("divGridDtl"),
                viewKey: "asn_dtl",
                viewFilter: viewFilter,
                showEditColumn: allowModify,
                showDeleteColumn: allowModify,
                cellBlur: grid_cellBlur,
                viewForm: "project/g_mscm/html/asn/asn_dtl.html",
                toolbarVisible: allowModify,
                cellFocus: function (para) { //单元格聚焦
                    var fieldName = para.fieldName;
                    var inpJq = $(para.control);
                    if (fieldName == "mfg_date" || fieldName == "exp_date" || fieldName == "disinfection_date") {//展示日期控件
                        inpJq.attr("onclick", "WdatePicker()");
                        inpJq.click();
                    }
                },
                afterDelete: function (para) { //删除之后
                	setTimeout(function(){
	                	gvDtl.refresh();
                	},1500);
                },
                jsonToolbar: { height: "M", onclick: toolbarClick }
            };
            gvDtl = new window.xwf_gridview(prop);
            gvDtl.toolbar.addBar({ type: "button", key: "btnAddDtlFromRep", text: "<i class='fa fa-check-square' ></i> 选择未发货订单明细 " });
            //gvDtl.toolbar.addBar({ type: "button", key: "btnAddDetail", text: "<i class='fa fa-plus-square' aria-hidden='true'></i>  添加订单外商品", align: "left", style: "Grid", icon: null });
            //gvDtl.toolbar.addBar({ type: "button", key: "btnDelete", text: "<i class='fa fa-minus-square' aria-hidden='true'></i>  清除配送明细", align: "left", style: "Grid", icon: null });
        }
        else {
            gvDtl.setViewFilter(viewFilter);
        }
    }

    function grid_cellBlur(para) {
        var astatus = gId("_cAStatus").value.toInt();
        var asnId = frm._cASN_ID.value.toInt();
        var repNotifyId = frm._cREP_NOTIFY_ID.value.toInt();

        var dataRow = para.dataRow;
        var fieldName = para.fieldName;
        var fieldValue = para.newValue;
        var fieldType = gvDtl.dtbViewData.columns[fieldName].columnType;

        var asnDtlId = dataRow["asn_dtl_id"].value;
        var matrId = dataRow["matr_id"].value;
        // ------------------------------------------------
        if (fieldType.equals("datetime")) {
            if (fieldValue) {
                fieldValue = fieldValue.toDateString();
                para.newValue = fieldValue;
            }
            if (para.oldValue.substring(0, 10).equals(para.newValue.substring(0, 10))) {
                return true;
            }
        }
        if (para.newValue.equals(para.oldValue)) {
            return true;
        }
        if (astatus != 0) {
            showWarn("只有未发货的订单才允许编辑!")
            return false;
        }

        if (fieldName.equals("qty")) {
            if (fieldValue > dataRow["qty_0"].value) {
                showWarn("送货数量不能大于应送数量，请检查。")
                return false;
            }
        }

        // ------------------------------------------------
        if (g.a.send("processType=g_mscm.asn.VIEW_asnDtl&actionType=updateDtlValue", { viewKey: "asn_dtl", asnId: asnId, asnDtlId: asnDtlId, matrId: matrId, fieldName: fieldName, fieldValue: fieldValue, repNotifyId: repNotifyId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var amount = cReturn.amount;

                if (fieldName.equals("qty")) {
                    gvDtl.setValue(para.recordRow, "amount", amount);
                }
                vf.refreshRecord();
               gvDtl.refresh();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
        return true;
    }

    function toolbarClick(para) {
        if (vf.status.equals("addnew")) {
            if (!vf.save()) {
                return;
            }
        }
        // ------------------------------------------------
        if (para.key.equals("btnAddDtlFromRep")) {
            var asnId = frm._cASN_ID.value.toInt();
            var prop = {
                title: "请选择订单明细...",
                width: 920,
                height: 450,
                parent: win
            };
            var para = {
                viewKey: "select_from_rep_notify_dtl",
                viewMode: "multiSelect",
                viewFilter: "rep_notify_id = " + frm._cREP_NOTIFY_ID.value.toInt() + " AND rep_notify_dtl_id NOT IN (SELECT rep_notify_dtl_id FROM T_ASN_DTL WHERE asn_id = " + asnId + ")",
                selectCallback: onRepNotifyDtlSelect
            };
            topWin.openSelectView(prop, para);
        }
        else if (para.key.equals("btnAddDetail")) {
            gvDtl.addnew();
        }
        else if (para.key.equals("btnDelete")) {
            toolbar_deleteDtl();
        }
        else {
            showErr("unknown button " + para.key);
        }
    }

    function onRepNotifyDtlSelect(arrRows) {
        var asnId = frm._cASN_ID.value.toInt();
        var repNotifyId = frm._cREP_NOTIFY_ID.value.toInt();
        var repNotifyDtlIds = "";
        var arrIds = new Array();
        // ------------------------------------------------
        for (var i = 0; i < arrRows.length; i++) {
            arrIds.push(arrRows[i]["rep_notify_dtl_id"].value);
        }
        repNotifyDtlIds = arrIds.join(",");

        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=impFromRepNotify", { viewKey: "asn_from_rep_notify", asnId: asnId, repNotifyId: repNotifyId, repNotifyDtlIds: repNotifyDtlIds }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                gvDtl.refresh();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
        return true;
    }

    function toolbar_deleteDtl() {
        var confirm = showConfirm("清除配送信息后无法恢复，继续清除操作吗？");
        if (confirm) {
            if (g.a.send("processType=g_mscm.advice.Shipments&actionType=clearDtl", { asnId: frm._cASN_ID.value, viewKey: 'asn_dtl' }, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;
                    vf.refreshRecord();
                    showGridDtl();
                } else {
                    return false;
                }
            }
            else {
                return false;
            }

        }
    }
</script>

<!-- 扫描条码方法 -->
<script type="text/javascript">
    //----扫描条码方法------------------
    function enterCallback(targetObj) {
        var parseContent = targetObj.value;
        if (parseContent.equals("enter")) {
            scanclick();
            gId("txtScan").value = "";
            return;
        }
        else {
            gId("_foriginal_barcode").value = gId("_foriginal_barcode").value + targetObj.value;
        }
        barcodeParseInput(parseContent);

        if (barcodeResult["gtin"].length > 0) {//gtin码
            parseContent = barcodeResult["gtin"];
            asnDtlId = "0";
            lot = ""; expiredDate = "";
            if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=getMatrByScanGTIN", { viewKey: vf.viewKey, asnId: gId("_cASN_ID").value, gtin: parseContent }, true)) {
                if (g.a.OK) {
                    var matr_code = g.a.cReturn.matr_code;
                    var matr_name = g.a.cReturn.matr_name;
                    gId("_fmatr_name").value = matr_name;
                    gId("_fmatr_code").value = matr_code;
                    if (matr_code.equals("")) {
                        alert("未找到该GTIN码！");
                        targetObj.value = "";
                        clearScan();
                    }
                    else {
                        gId("_foriginal_barcode").value = targetObj.value;

                    }

                }
            }
        }
        else if (barcodeResult["lot"].length > 0) {//批号
            if (gId("_fmatr_code").value.equals("")) {
                alert("请先扫描GTIN码！");
                resetScanResult();
                targetObj.value = "";
                return;
            }
            parseContent = barcodeResult["lot"];


            gId("_flot").value = parseContent;


        }
        else if (barcodeResult["expiredDate"].length > 0) {//效期
            if (gId("_fmatr_code").value.equals("")) {
                alert("请先扫描GTIN码！");
                resetScanResult();
                targetObj.value = "";
                return;
            }
            parseContent = barcodeResult["expiredDate"];
            gId("_fexp_date").value = parseContent;

        }
        targetObj.value = "";
        resetScanResult();
    }

    function clearScan() {
        gId("_fmatr_code").value = "";
        gId("_fmatr_name").value = "";
        gId("_foriginal_barcode").value = "";
        gId("_flot").value  = "";
        gId("_fexp_date").value= "";

    }
    function scanclick() {
        if (gId("_fmatr_code").value.equals("")) {
            alert("请先扫描GTIN码！");
            return;
        }
        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=upLotDtlByLot", { viewKey: vf.viewKey, asnId: gId("_cASN_ID").value, matr_code: gId("_fmatr_code").value, lot: gId("_flot").value, expiredDate: gId("_fexp_date").value, original_barcode: gId("_foriginal_barcode").value }, true)) {
            if (g.a.OK) {
                asnDtlId = g.a.cReturn.asn_dtl_id;
                gvDtl.refresh();
                clearScan();
            }
        }
    }
</script>

<!-- 选择订单 -->
<script type="text/javascript">
    function selectRepNotify() {
        var prop = {
            title: "请选择订单...",
            width: 0.70,
            height: 0.65,
            parent: win
        };
        var para = {
            viewKey: "g_select_po",
            viewFilter: "",
            viewMode: "singleSelect",
            selectCallback: onPoSelect
        };
        topWin.openSelectView(prop, para);
    }

    function onPoSelect(dataRow) {
        frm._cREP_NOTIFY_ID.value = dataRow["rep_notify_id"].value;
        frm._gRn_key.value = dataRow["rn_key"].value;
        if (!vf.save()) return;

        var asnId = frm._cASN_ID.value.toInt();
        var repNotifyId = frm._cREP_NOTIFY_ID.value.toInt();
        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=impFromRepNotify", { viewKey: 'asn_from_rep_notify', asnId: asnId, repNotifyId: repNotifyId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                showGridDtl();
            }
        }
        return true;
    }
</script>
<!-- 单据打印 -->
<script type="text/javascript">
    function printAsn(asnId) {
        PrintService.printASN(asnId, true);
    }

    function printBarcode(asnId) {
        var asnId = frm._cASN_ID.value.toInt();

        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=generateBarcode", { viewKey: 'asn_from_rep_notify', asnId: asnId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbLabel = cReturn.dtbLabel;
                WebPrint.goPrintBarCode(vf, dtbLabel.rows, gvDtl);
                gvDtl.refresh();
            }
        }
    }
</script>