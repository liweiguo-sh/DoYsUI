<!DOCTYPE html>
<html>

<head>
    <title>发货单明细</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zuiExt.js" type="text/javascript"></script>
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zui.css" rel="stylesheet" type="text/css" />
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zuiExt.css" rel="stylesheet" type="text/css" />
    <style>
        #divDC {
            height: 42px !important;
        }
    </style>
</head>

<body>
    <div id="divDC"></div>
    <div class="PanelA">
        <form id="frm" action="" target="g_mscm.asn.VIEW_asnDtl">
            <table id="tbForm" class="tbForm" style="width:695px;">
                <tr class="trH">
                    <th style="width:120px;"></th>
                    <th style="width:250px;"></th>
                    <th style="width:120px;"></th>
                    <th style="width:200px;"></th>
                </tr>
                <tr>
                    <td>品名</td>
                    <td colspan="3"><input type="text" id="_cMatr_name" disabled="disabled" /></td>
                </tr>
                <tr>
                    <td>品规</td>
                    <td><input type="text" id="_cMatr_spec" disabled="disabled" /></td>
                    <td>单价</td>
                    <td><input type="text" id="_cPrice" disabled="disabled" /></td>
                </tr>
                <tr>
                    <td>应送数量</td>
                    <td><input type="text" id="_cQty_0" disabled="disabled" /></td>
                    <td>已送数量(不含本次)</td>
                    <td><input type="text" id="_xQty_asn" disabled="disabled" /></td>
                </tr>
                <tr>
                    <td>实送数量</td>
                    <td><input type="text" id="_cQty" onkeyup="vf.qtyKeyup();" /></td>
                    <td>实送金额</td>
                    <td><input type="text" id="_cAmount" disabled="disabled" /></td>
                </tr>
                <tr>
                    <td>生产批次</td>
                    <td><input type="text" id="_cLot" /></td>
                    <td>生产日期</td>
                    <td><input type="text" id="_cMfg_date" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})" /></td>
                </tr>
                <tr>
                    <td>注册证号</td>
                    <td><input type="text" id="_cRegister_no" /></td>
                    <td>有效日期</td>
                    <td><input type="text" id="_cExp_date" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})" /></td>
                </tr>
                <tr>
                    <td>灭菌批次</td>
                    <td><input type="text" id="_cDisinfection_lot" /></td>
                    <td>灭菌日期</td>
                    <td><input type="text" id="_cDisinfection_date" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})" /></td>
                </tr>
                <tr>
                    <td>生产厂家</td>
                    <td colspan="3"><input type="text" id="_cManufacturer"></td>
                </tr>
            </table>
            <input type="hidden" id="_cASN_ID" />
            <input type="hidden" id="_cASN_DTL_ID" />
            <input type="hidden" id="_cMatr_id" />
            <input type="hidden" id="_cMatr_code" />
            <input type="hidden" id="_cMatr_unit" />
            <input type="hidden" id="_cPackage_unit" />
            <input type="hidden" id="_cPackage_qty" />
            <input type="hidden" id="_cRep_notify_dtl_id" />
            <input type="hidden" id="_cPo_dtl_id" />
        </form>
    </div>
</body>

</html>
<!-- formLoad -->
<script type="text/javascript">
    // ------------------------------------------------------------------------
    var selectRow;
    function formLoad() {
        frmParent = win.parentWindow.frm;
        vf.css(gId("tbForm"));
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    var qtyCopy = 0;
    vf.beforeCopy = function() {
        return true;
    }
    vf.afterCopy = function() {
        if (!g.debug) {
            frm._cLot.value = "";
            frm._cMfg_date.value = "";
            frm._cExp_date.value = "";
            frm._cDisinfection_lot.value = "";
            frm._cDisinfection_date.value = "";
        }
        frm._cLot.focus();
        
        vf.getNotifyAsnQtyByRepNotifyId();
        /**	
    		复制后实送数量=应送数量-已送数量
    		已送数量=应送数量
    	*/
        frm._cQty.value = frm._cQty_0.value.toNumber()-frm._xQty_asn.value.toNumber();
        frm._xQty_asn.value=frm._cQty_0.value.toNumber();
        if(frm._cQty.value.toNumber() <=0){
        	alert("该订单明细已经全部发货了噢");
        	win.close();
        }
    }

    vf.afterSetStatus = function() {
        vf.buttons["addnew"].style.display = "none";
        if (vf.status.equals("view")) {
            vf.buttons["copy"].style.display = "";
        }
        
        /**	
    	*/
        vf.getNotifyAsnQtyByRepNotifyId();
        
    }

    vf.beforeSave = function() {
        return vf.qtyKeyup();
    };

    vf.afterSave = function() {
        vf.updateAsnMain();
    };

    //实送数量输入改变事件
    vf.qtyKeyup = function() {
        var _xQty_asn = gId("_xQty_asn").value.toNumber(),_cQty_0 = gId("_cQty_0").value.toNumber(),_cQty=gId("_cQty").value.toNumber();
        var ret = true;
        
        //已送+本次大于应送
        if (_xQty_asn+_cQty > _cQty_0) {
            zuiExt.tip({
                id: "_cQty",
                title: "本次发货数量("+_cQty+")不能超过("+(_cQty_0-_xQty_asn)+")，请减少发货数量",
                tipClass: "tooltip-danger"
            });
            ret = false;
        }
        var _cPrice = gId("_cPrice").value;
        gId("_cAmount").value =g.x.toFixedN( _cPrice *_cQty ,2);
        return ret;
    }

    //更新主表总金额
    vf.updateAsnMain = function() {
        if (g.a.send("processType=g_mscm.asn.VIEW_asnDtl&actionType=updateAsnMain", {
                viewKey: "asn_dtl",
                asnId: gId("_cASN_ID").value
            }, true)) {
            if (g.a.OK) {
                win.parentWindow.vf.refreshRecord();
                win.parentWindow.gvDtl.refresh();
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
    
    //获取某个订单明细所有的发货单数量
    vf.getNotifyAsnQtyByRepNotifyId = function() {
    	var qtyAsn=0;
        if (g.a.send("processType=g_mscm.advice.RepNotify&actionType=getNotifyAsnQtyByRepNotifyId", {
                viewKey: "asn_dtl",
                rep_notify_id: gId("_cRep_notify_dtl_id").value,
                asn_dtl_id: gId("_cASN_DTL_ID").value
            }, true)) {
            if (g.a.OK) {
            	qtyAsn=g.a.cReturn.qtyAsn;
            } else {
                return false;
            }
        } else {
            return false;
        }
        gId("_xQty_asn").value=qtyAsn;
    }
</script>