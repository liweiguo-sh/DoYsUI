<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <title>发货单 - 药品</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <script src="../../../../res/control/upload/xwf.upload_core.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/excel.js" type="text/javascript"></script>
    <script src="../../js/barcode_parse.js" type="text/javascript"></script>
    <script src="../../js/resource_print.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/web_print.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }

        #tbLayout {
            border-collapse: collapse;
        }

        #scanBox {
            font-size: 1em;
            font-family: Arial;
            height: 26px;
            line-height: 24px;
            border: 2px solid #19A2D5;
        }

        .fa-medkit {
            font-size: 1.5em;
            color: #19A2D5;
        }

        .import-alert {
            font-weight: bolder;
        }

        .a-small {
            font-size: 0.9em;
            color: Blue;
        }

            .a-small:hover {
                cursor: pointer;
                color: #19A2D5;
            }

        #divDC {
            width: 1300px;
            background: transparent;
        }

        .PanelA {
            width: 98%;
            margin-left: auto;
            margin-right: auto;
        }

        #tbForm {
            width: 100%;
        }

        .bill-dtl {
            margin-top: 10px;
        }

        #divGridDtl {
            height: 400px;
        }

            #divGridDtl input {
                border: solid 0px;
            }
    </style>
</head>
<body>
    <div id="divDC" style="padding-left:6px;"></div>
    <div class="PanelA">
        <form id="frm" action="" target="g_mscm.asn.VIEW_asn">
            <table id="tbForm" class="tbForm">
            	<input type="hidden" id="_gasn_id"/>
                <tr id="trH">
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                    <th style="width:10%"></th>
                    <th style="width:15%"></th>
                </tr>
                <tr>
                    <td>发货单号</td>
                    <td><input type="text" id="_cAsn_key" disabled="disabled" />
                    <td>订单类型</td>
                    <td><input type="text" id="_gPo_type_name" disabled="disabled" />
                    <td>发货金额</td>
                    <td><input type="text" id="_cAsn_Amount" readonly="readonly" />
                    <td>日期</td>
                    <td><input type="text" id="_cAsn_date" readonly="readonly" />
                </tr>
                <tr>
                    <td>订单号</td>
                    <!--
                    <td><input id="_cREP_NOTIFY_ID" type="text" controlType="dropdown" fieldValue="rep_notify_id" fieldText="rn_key" fieldsVisible = "rn_key, rn_date, po_buyer, storage_fullname" fieldsSearch="rn_key, rn_date, po_buyer, storage_fullname" widthFields="150,90,90,250" widthPanel="600" /></td>
                    -->
                    <td class="combo">
                        <input id="_gRn_key" type="text" readonly="readonly" />
                        <div id="divSelectRepNotify" class="fa fa-search" onclick="selectRepNotify();"></div>
                    </td>
                    <td>订单日期</td>
                    <td><input type="text" id="_gRn_date" disabled="disabled" />
                    <td>仓库</td>
                    <td colspan="3"><input type="text" id="_gStorage_fullname" disabled="disabled" />
                </tr>
                <tr>
                    <td>采购员</td>
                    <td><input type="text" id="_gPo_buyer" disabled="disabled" />
                    <td>订单金额</td>
                    <td><input type="text" id="_gPo_amount" disabled="disabled" />
                    <td>需求来源</td>
                    <td colspan="3"><input type="text" id="_gStorage_fullname_req" disabled="disabled" />
                </tr>
                <tr>
                    <td>制单</td>
                    <td><input type="text" id="_cCreator" readonly="readonly" />
                    <td>审核</td>
                    <td><input type="text" id="_cAuditor" readonly="readonly" />
                    <td>备注</td>
                    <td colspan="3"><input type="text" id="_cAsn_remark" />
                </tr>
            </table>
            <input type="hidden" id="_cASN_ID" />
            <input type="hidden" id="_cREP_NOTIFY_ID" />
            <input type="hidden" id="_cAStatus" />
            <input type="hidden" id="_cStatus_receive" />
        </form>
    </div>
    <div class="PanelA bill-dtl">
        <table id="tbDtl" class="tbForm" style="width: 100%;">
            <tr class="trH">
                <th style="width: 12%"></th>
                <th style="width: 12%"></th>
                <th style="width: 10%"></th>
                <th style="width: 12%"></th>
                <th style="width: 10%"></th>
                <th style="width: 17%"></th>
                <th style="width: 10%"></th>
                <th style="width: 17%"></th>
            </tr>

            <tr id="inputArea">
                <td > <input type="text" id="_fmatr_name" disabled="disabled" /></td>
                   <td > <input type="text" id="_flot" disabled="disabled" /></td>
                  <td > <input type="text" id="_fexp_date" disabled="disabled" /></td>
                <td colspan="2"> <input type="text" id="_foriginal_barcode" disabled="disabled" /></td>
                <td colspan="2">
                    <input type="text" id="txtScan"  placeholder="扫描GTIN码和批次效期" style="ime-mode: disabled;" onkeydown="enterPress(event)" />

                </td>
                <td class="pageButtons" style="text-align:right;" ><input type="button" id="btnAdd" value="确定" onclick="scanclick();"  /></td>

            </tr>
        </table>
        <input type="hidden" id="_fmatr_code" />
        <input type="hidden" id="" />
        <div id="divGridDtl"></div>
    </div>
</body>
</html>
<!-- formLoad -->
<script type="text/javascript">
    var gvDtl = null; var lot = ""; var expiredDate = "";var asnDtlId="0";
    // ------------------------------------------------------------------------
    function formLoad() {
        vf.addExtraButton({ key: "print", text: "打印发货单", icon: "fa fa-print" });
        vf.addExtraButton({ key: "printBarcode", text: "打印条码" });
        vf.css(gId("tbForm"));
        vf.css(gId("tbDtl"));

        var restHeight = win.p.height - gId("divGridDtl").offsetTop - 20;
        if (restHeight < 250) {
            restHeight = 250;
        }
        gId("divGridDtl").style.height = restHeight + "px";        
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterAddnew = function () {
        frm._cAsn_date.value = (new Date()).toString();
        frm._cAStatus.value = "0";
        frm._cStatus_receive.value = "0";
    }
    vf.afterMove = function () {
        if (gId("_gPo_type_name").value.equals("代销")) {
            gId("tbDtl").style.display = "";
            gId("txtScan").focus();
        } else {
            gId("tbDtl").style.display = "none";
        }
        if (vf.status.equals("addnew")) {
            divSelectRepNotify.style.display = "";

        }
        else {
            divSelectRepNotify.style.display = "none";

        }
        if (frm._cStatus_receive.value.toInt() == -1) {
            if (vf.buttons["print"]) {
                vf.buttons["print"].style.display = "none";
            }
        }
        if (vf.buttons["printBarcode"]) {
            if (frm._gPo_type_name.value.equals("代销")) {
                vf.buttons["printBarcode"].style.display = "";
            }
            else {
                vf.buttons["printBarcode"].style.display = "none";
            }
        }

        showGridDtl();
    }
       
    vf.beforeClick = function (prop) {
        var btnKey = prop.buttonKey;
        // ------------------------------------------------
        if (btnKey.equals("print")) {
        	printQRcode();
            //var arrMenus = new Array();
           // arrMenus.push({ key: "standard", text: "条形码发货单", title: "通用格式" });
            //arrMenus.push({ key: "qr_code", text: "二维码发货单", title: "适用于内外网不能互通的情况" });
            //topWin.context.show({ arrMenus: arrMenus, menuClick: printEntry, objDom: prop.button, top: 0, left: 0 });
        }
        else if (btnKey.equals("printBarcode")) {
            //printBarcode();
        }
        else {
            showErr("未实现的扩展功能，buttonKey = " + btnKey);
        }
        return false;
    }
    vf.beforeFlowClick = function (para) {
        var fbKey = para.fbKey;

        var dtMfg = null, dtExp = null;
        var dtNow = (new Date()).toString().toDate();

        var dtb = gvDtl.dtbViewData;
        var dataRow = null;
        // ------------------------------------------------
        if (fbKey.equals("approve")) {
            for (var i = 0; i < dtb.rowCount; i++) {
                dataRow = dtb.rows[i];
                dtMfg = dataRow["mfg_date"].value.substring(0, 10).toDate();
                dtExp = dataRow["exp_date"].value.substring(0, 10).toDate();

                // -- 生产日期、有效日期 --
                if (dtMfg && dtMfg >= dtNow) {
                    showWarn("第 " + (i + 1) + " 行 [生产日期] 必需早于当前日期，请检查。");
                    return false;
                }
                if (dtExp && dtExp <= dtNow) {
                    showWarn("第 " + (i + 1) + " 行 [有效日期] 必需晚于当前日期，请检查。");
                    return false;
                }
                // -- 批次号、效期 --
                //if (dataRow["lot"].value.equals("")) {
                    //showWarn("第 " + (i + 1) + " 行 [批次号] 不能为空，请输入。");
                    //return false;
                //}
                //if (dataRow["register_no"].value.equals("")) {
                 //   showWarn("第 " + (i + 1) + " 行 [注册证号] 不能为空，请输入。");
                //    return false;
               // }
            }
        }
        else {
            // -- --
        }
        return true;
    }
</script>
<!-- gridview -->
<script type="text/javascript">
    function showGridDtl() {
        var allowModify = frm._cAStatus.value.toInt() == 0;
        var viewFilter = "asn_id = " + frm._cASN_ID.value.toInt();
        // ------------------------------------------------
        if (gvDtl == null) {
            var prop = {
                divContainer: gId("divGridDtl"),
                viewKey: "asn_dtl_drug",
                viewFilter: viewFilter,
                showEditColumn: allowModify,
                showDeleteColumn: allowModify,
                afterDelete: grid_rowDelete,
                cellBlur: grid_cellBlur,
                cellChange: grid_cellChange,
                viewForm: "project/g_mscm/html/asn/asn_dtl_drug.html",
                toolbarVisible: allowModify,
                jsonToolbar: { height: "M", onclick: toolbarClick }
            };
            gvDtl = new window.xwf_gridview(prop);
            gvDtl.toolbar.addBar({ type: "button", key: "btnAddDtlFromRep", text: "<i class='fa fa-check-square' ></i> 选择未发货订单明细 " });
            gvDtl.toolbar.addBar({ type: "button", key: "dtlExport", text: "导出明细 " });
            gvDtl.toolbar.addBar({ type: "button", key: "dtlUpdateByImport", text: "导入更新明细(xls) " });
            
            //gvDtl.toolbar.addBar({ type: "button", key: "btnImportDtl", text: "<i class='fa fa-file-excel-o' ></i> 模板导入发货单明细 " });
            //gvDtl.toolbar.addBar({ type: "label", key: "lblTemplet", text: "<a href='templet_asn.xls' target='_blank'> 模板下载 </a>" });
            //gvDtl.toolbar.addBar({ type: "button", key: "btnAddDetail", text: "<i class='fa fa-plus-square' aria-hidden='true'></i>  添加订单外商品", align: "left", style: "Grid", icon: null });
            //gvDtl.toolbar.addBar({ type: "button", key: "btnDelete", text: "<i class='fa fa-minus-square' aria-hidden='true'></i>  清除配送明细", align: "left", style: "Grid", icon: null });

            //initBtnImportDtl();
        }
        else {
            gvDtl.setViewFilter(viewFilter);
        }
    }

    function grid_cellBlur(para) {
        var dataRow = para.dataRow;
        var fieldName = para.fieldName;
        var fieldValue = para.newValue;
        // ------------------------------------------------
        if (fieldName.equals("qty")) {
            fieldValue = parseInt(fieldValue);
            if (fieldValue > dataRow["qty_0"].value) {
                showWarn("送货数量不能大于应送数量，请检查。")
                return false;
            }
        }
        else if (fieldName.equals("mfg_date") || fieldName.equals("exp_date") || fieldName.equals("disinfection_date")) {
            fieldValue = fieldValue.toDateString();
            para.newValue = fieldValue;
        }
        else if (fieldName.equals("lot")) {

        }
        else if (fieldName.equals("register_no")) {

        }
        return true;
    }
    function grid_cellChange(para) {
        var dataRow = para.dataRow;
        var fieldName = para.fieldName;
        var fieldValue = para.newValue;
        var asnId = frm._cASN_ID.value.toInt();
        var asnDtlId = dataRow["asn_dtl_id"].value;
        var repNotifyId = frm._cREP_NOTIFY_ID.value.toInt();
        // ------------------------------------------------
        if (g.a.send("processType=g_mscm.asn.VIEW_asnDtl&actionType=updateDtlValue", { viewKey: "asn_dtl", asnId: asnId, asnDtlId: asnDtlId, fieldName: fieldName, fieldValue: fieldValue, repNotifyId: repNotifyId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var amount = cReturn.amount;

                if (fieldName.equals("qty")) {
                    gvDtl.setValue(para.recordRow, "amount", amount);
                }
                vf.refreshRecord();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
    function grid_rowDelete(para) {
        vf.refreshRecord();
    }

    function toolbarClick(para) {
        if (vf.status.equals("addnew")) {
            if (!vf.save()) {
                return;
            }
        }
        // ------------------------------------------------
        if (para.key.equals("btnAddDtlFromRep")) {
            var asnId = frm._cASN_ID.value.toInt();
            var prop = {
                title: "请选择订单明细...",
                width: 920,
                height: 450,
                parent: win
            };
            var para = {
                viewKey: "select_from_rep_notify_dtl",
                viewMode: "multiSelect",
                viewFilter: "rep_notify_id = " + frm._cREP_NOTIFY_ID.value.toInt() + " AND rep_notify_dtl_id NOT IN (SELECT rep_notify_dtl_id FROM T_ASN_DTL WHERE asn_id = " + asnId + ")",
                selectCallback: onRepNotifyDtlSelect
            };
            topWin.openSelectView(prop, para);
        }
        else if (para.key.equals("btnImportDtl")) {
            btnImportDtl();
        }
        else if (para.key.equals("btnAddDetail")) {
            gvDtl.addnew();
        }
        else if (para.key.equals("btnDelete")) {
            toolbar_deleteDtl();
        }
        else if (para.key.equals("dtlExport")) {//导出明细cvs
        	if(frm._gasn_id.value.equals("")){
        		alert("请选择已有发货单");;
        		return;
        	}
        	if(!gvDtl || gvDtl.totalRows <1){
	        	alert("当前订单没有可用明细");
        		return;
        	}
        	g.a.exportCsvByGrid(gvDtl);
        }
        else if (para.key.equals("dtlUpdateByImport")) {//导入更新明细
        	if(frm._gasn_id.value.equals("")){
        		alert("请选择已有发货单");;
        		return;
        	}
        	if(!gvDtl || gvDtl.totalRows <1){
	        	alert("当前订单没有可用明细，无法进行更新操作");
        		return;
        	}
        	onpenfile();
        }
        else {
            showErr("unknown button " + para.key);
        }
    }
    
    function onpenfile() {
        var prop = {
            parent: win
        };
        var para = {
            target: "com.xznext.util.UploadFileBaseCos",
            callback: uploadCallback,
            beforeUpload:function(param){//上传前文件校验
				if(param && param.extName && !param.extName.equals("xls")){
					showWarn("请选择xls格式的数据文件");
					return false;
				}
				return true;
			}
        };
        topWin.uploadFile(prop, para);
        return false;
    }

    function uploadCallback(para) {
        var fileServer = para.filePath + para.fileName;
        if (g.a.send("processType=g_mscm.asn.VIEW_asnDtl&actionType=updateDtlByXls", {viewKey:"asn_from_rep_notify_drug", filePath: fileServer,asn_id:frm._gasn_id.value }, false)) {
            var cReturn=g.a.cReturn;
            if (g.a.OK) {
           	 	alert(cReturn.errorInfos);
           	 	gvDtl.refresh();
            }
            else {
            }
        }
    }

    function onRepNotifyDtlSelect(arrRows) {
        var asnId = frm._cASN_ID.value.toInt();
        var repNotifyId = frm._cREP_NOTIFY_ID.value.toInt();
        var repNotifyDtlIds = "";
        var arrIds = new Array();
        // ------------------------------------------------
        for (var i = 0; i < arrRows.length; i++) {
            arrIds.push(arrRows[i]["rep_notify_dtl_id"].value);
        }
        repNotifyDtlIds = arrIds.join(",");

        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=impFromRepNotify", { viewKey: "asn_from_rep_notify", asnId: asnId, repNotifyId: repNotifyId, repNotifyDtlIds: repNotifyDtlIds }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                gvDtl.refresh();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
        return true;
    }

    function toolbar_deleteDtl() {
        var confirm = showConfirm("清除配送信息后无法恢复，继续清除操作吗？");
        if (confirm) {
            if (g.a.send("processType=g_mscm.advice.Shipments&actionType=clearDtl", { asnId: frm._cASN_ID.value, viewKey: 'asn_dtl' }, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;
                    vf.refreshRecord();
                    showGridDtl();
                } else {
                    return false;
                }
            }
            else {
                return false;
            }

        }
    }
</script>

<!-- 选择订单 -->
<script type="text/javascript">
    function selectRepNotify() {
        var prop = {
            title: "请选择订单...",
            width: 0.70,
            height: 0.65,
            parent: win
        };
        var para = {
            viewKey: "g_select_po",
            viewFilter: "",
            viewMode: "singleSelect",
            selectCallback: onPoSelect
        };
        topWin.openSelectView(prop, para);
    }

    function onPoSelect(dataRow) {
        frm._cREP_NOTIFY_ID.value = dataRow["rep_notify_id"].value;
        frm._gRn_key.value = dataRow["rn_key"].value;
        if (!vf.save()) return;

        var asnId = frm._cASN_ID.value.toInt();
        var repNotifyId = frm._cREP_NOTIFY_ID.value.toInt();
        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=impFromRepNotify", { viewKey: 'asn_from_rep_notify', asnId: asnId, repNotifyId: repNotifyId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                showGridDtl();
            }
        }
        return true;
    }
</script>
<!-- 扫描条码方法 -->
<script type="text/javascript">
    //----扫描条码方法------------------
    function enterCallback(targetObj) {
        var parseContent = targetObj.value;


        if (parseContent.equals("enter")) {
            scanclick();
            gId("txtScan").value = "";
            return;
        } else {
            gId("_foriginal_barcode").value = gId("_foriginal_barcode").value + targetObj.value;
        }
        barcodeParseInput(parseContent);

        if (barcodeResult["gtin"].length > 0) {//gtin码
            parseContent = barcodeResult["gtin"];
            asnDtlId = "0";
            lot = ""; expiredDate = "";
            if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=getMatrByScanGTIN", { viewKey: vf.viewKey, asnId: gId("_cASN_ID").value, gtin: parseContent }, true)) {
                if (g.a.OK) {
                    var matr_code = g.a.cReturn.matr_code;
                    var matr_name = g.a.cReturn.matr_name;
                    gId("_fmatr_name").value = matr_name;
                    gId("_fmatr_code").value = matr_code;
                    if (matr_code.equals("")) {
                        alert("未找到该GTIN码！");
                        targetObj.value = "";
                        clearScan();
                    }
                    else {
                        gId("_foriginal_barcode").value = targetObj.value;

                    }

                }
            }
        }
        else if (barcodeResult["lot"].length > 0) {//批号
            if (gId("_fmatr_code").value.equals("")) {
                alert("请先扫描GTIN码！");
                resetScanResult();
                targetObj.value = "";
                return;
            }
            parseContent = barcodeResult["lot"];
         

            gId("_flot").value = parseContent;

           
        } else if (barcodeResult["expiredDate"].length > 0) {//效期
            if (gId("_fmatr_code").value.equals("")) {
                alert("请先扫描GTIN码！");
                resetScanResult();
                targetObj.value = "";
                return;
            }
            parseContent = barcodeResult["expiredDate"];
            gId("_fexp_date").value = parseContent;
           
        }
        targetObj.value = "";
        resetScanResult();
    }

    function clearScan() {
        gId("_fmatr_code").value = "";
        gId("_fmatr_name").value = "";
        gId("_foriginal_barcode").value = "";
        gId("_flot").value  = "";
        gId("_fexp_date").value= "";

    }
    function scanclick() {
        if (gId("_fmatr_code").value.equals("")) {
            alert("请先扫描GTIN码！");
            return;
        }
        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=upLotDtlByLot", { viewKey: vf.viewKey, asnId: gId("_cASN_ID").value, matr_code: gId("_fmatr_code").value, lot: gId("_flot").value, expiredDate: gId("_fexp_date").value, original_barcode: gId("_foriginal_barcode").value }, true)) {
            if (g.a.OK) {
                asnDtlId = g.a.cReturn.asn_dtl_id;
                gvDtl.refresh();
                clearScan();

            }
        }
    }

</script>
<!-- 导入明细 -->
<script type="text/javascript">
    function btnImportDtl() {
        showErr("文件上传组件尚未正确初始化，请检查。");
    }
    function initBtnImportDtl() {
        var jsonProp = {
            domAdd: gvDtl.toolbar.Bars["btnImportDtl"].dom,
            action: g.httpServer + g.appPath + "filter.do?processType=g_mscm.common.UploadFile",
            filename: frm._cASN_ID.value + "_" + (new Date()).getTime(),
            beforeUpload: beforeUpload_xls_dtl,
            callback: afterUpload_xls_dtl
        };

        uploadCore1 = new window.xwf_upload_core(jsonProp);
    }

    function beforeUpload_xls_dtl(jsonPara) {
        var AStatus = frm._cAStatus.value.toInt();
        if (AStatus != 0) {
            return false;
        }
        if (gvDtl.dtbViewData.rowCount > 0) {
            if (!showConfirm("明细记录已存在，重新导入将清除当前明细记录，确定要重新导入吗？")) {
                return false;
            }
        }
        return true;
    }
    function afterUpload_xls_dtl(jsonPara) {
        if (jsonPara.OK) {
            var fileXls = jsonPara.filePath + jsonPara.fileName;

            if (g.a.send("processType=g_mscm.asn.VIEW_asnDtl&actionType=importDtlByXls", { viewKey: "asn_dtl", asnId: frm._cASN_ID.value.toInt(), fileXls: fileXls }, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;

                    vf.refreshRecord();
                    gvDtl.refresh();
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }
        else {
            showErr(jsonPara.errMessage);
        }
    }
</script>

<!-- 打印 -->
<script type="text/javascript">
    function printEntry(liMenu) {
        var menuKey = liMenu.key;

        if (menuKey.equals("standard")) {
            vf.printqrCode="";
            WebPrint.goPrintSHD(vf, gvDtl);
        }
        else if (liMenu.key.equals("qr_code")) {
            printQRcode();
        }
        else {
            showErr("暂未实现的打印类型。");
        }
    }
    
    function printQRcode() {
        var asnId = frm._cASN_ID.value.toInt();
        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=getAsnDataByQR", { viewKey: "asn_from_rep_notify_drug", asnId: asnId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbAsn = cReturn.dtbAsn;
                var dtbAsnDtl = cReturn.dtbAsnDtl;
                var urlPath = g.httpServer + g.appPath + "res_run/mscm/asn/";

                // -- 预处理 -------------------------------
                dtbAsn.rows[0]["url_qr"].value = urlPath + dtbAsn.rows[0]["url_qr"].value;
                for (var i = 0; i < dtbAsnDtl.rowCount; i++) {
                    dtbAsnDtl.rows[0]["url_qr"].value = urlPath + dtbAsnDtl.rows[i]["url_qr"].value;
                }

                // -- 单据打印 ------------------------------
                console.log(dtbAsn)
                console.log(dtbAsnDtl)
                // 字段名：data_qr，压缩后的json字符串, url_qr: 后台生成好的二维码图片链接 
                //alert("订单单号：" + dtbAsn.rows[0]["po_key"].value + ", 发货单明细记录条数：" + dtbAsnDtl.rowCount + "\n 数据已取到，请实现后续打印功能。");
                vf.printqrCode="4";
				WebPrint.goPrintSHD(vf,{main:dtbAsn,dtls:dtbAsnDtl});
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }

    function printBarcode() {
        var asnId = frm._cASN_ID.value.toInt();

        if (g.a.send("processType=g_mscm.asn.VIEW_asn&actionType=generateBarcode", { viewKey: 'asn_from_rep_notify', asnId: asnId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbLabel = cReturn.dtbLabel;
                WebPrint.goPrintBarCode(vf, dtbLabel.rows);
                // -- matr_code, matr_name, matr_spec, lot, mfg_date, exp_date, barcode --
            }
        }
    }
</script>