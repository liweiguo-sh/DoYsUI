<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <title>补货通知明细</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/jscript_mobile/xmf.wx_css.js"></script>
    <link rel="stylesheet" href="../../css/common.css">
    <script src="../../js/g_mscm_wechat.js"></script>
    <style>
        #tab {
            box-shadow: 0px 1px 4px 0px #e6e6e6;
        }
        .tab-items {
            position: absolute;
            top: 52px;
            left: 0;
            z-index: 4;
            width: 100%;
            height: 52px;
            display: flex;
            background: #fff;
        }
        .tab-items .tab-item {
            flex: 1;
            line-height: 52px;
            text-align: center;
            font-size: 18px;
            color: #646464;
        }
        .tab-item span {
            display: inline-block;
            height: inherit;
        }
        .tab-item.active {
            color: #0db3ed;
        }
        .tab-item.active span {
            box-shadow: 0px -2px 0px 0px #0db3ed inset;
        }
        .container {
            top: 104px;
            height: calc(100% - 172px);
            padding: 0 16px;
            box-sizing: border-box;
        }
        .list {
            position: relative;
            border-bottom: solid 1px #d7d7d7;
            margin-left: 18px;
            padding: 12px 32px 12px 0;
            box-sizing: border-box;
        }
        .list.list-ignore .list-head-item:first-child {
            color: #b9bdc0;
        }
        .list:last-child {
            border-bottom: solid 0px #d7d7d7;
        }
        .list-head {
            position: relative;
        }
        .list-body {
            display: none;
        }
        .item-rt {
            font-size: 14px;
            color: #383838;
        }
        .list.active .list-body {
            display: block;
        }
        .more {
            position: absolute;
            top: 50%;
            right: -24px;
            display: inline-block;
            width: 18px;
            height: 18px;
            background: url("../../images/weixin/next_down.png") no-repeat;
            background-size: cover;
            margin-top: -9px;
        }
        .more.more-up {
            background: url("../../images/weixin/next_up.png") no-repeat;
            background-size: cover;
        }
        .list-head-item,
        .list-body-item {
            display: flex;
            justify-content: space-between;
            font-size: 16px;
            color: #b9bdc0;
            padding-top: 4px;
            box-sizing: border-box;
        }
        .list-head-item:first-child {
            font-size: 18px;
            color: #0a0a0a;
            padding: 0;
        }
        .icon-select {
            position: absolute;
            top: 0;
            left: -34px;
            width: 34px;
            height: 74px;
        }
        .list.success .icon-select::after {
            background: url("../../images/weixin/icon_success.png") no-repeat;
            background-size: cover;
        }
        .list.ignoreNeed .icon-select::after {
            background: url("../../images/weixin/icon_ignore.png") no-repeat;
            background-size: cover;
        }
        .list.selected .icon-select::after,
        .icon-select-all.selected::before {
            background: url("../../images/weixin/icon_checked.png") no-repeat;
            background-size: cover;
        }
        .icon-select::after,
        .icon-select-all::before {
            position: absolute;
            top: 50%;
            left: 7px;
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            margin-top: -10px;
            background: url("../../images/weixin/icon_unchecked.png") no-repeat;
            background-size: cover;
        }
        .icon-select-all {
                position: absolute;
                top: 0;
                left: 0;
                font-size: 16px;
                font-style: normal;
                width: 77px;
                height: 49px;
                line-height: 49px;
                text-indent: 32px;
                text-align: center;
                color: #696d6e;
        }
        #operate {
            position: absolute;
            bottom: 0;
            left: 0;
            z-index: 2;
            width: 100%;
            height: 48px;
            background: #fff;
            border-top: solid 1px #f4f4f4
            ;
        }
        .ope-item {
            height: inherit;
            text-align: center;
        }
        .ope-item .btn {
            float: right;
            width: 80px;
            height: 48px;
            line-height: 48px;
            font-size: 16px;
            text-align: center;
        }
        .ope-item .btn:last-child {
            margin: 0;
        }
        .btn.btn-lightBlue {
            background: #00a3ac;
            color: #fff;
        }
        .btn.btn-gray {
            background: #f4f4f4;
            color: #696d6e;
        }
        .btn.btn-dullRed {
            background: #C9302C;
            color: #fff;
        }
    </style>
</head>
<body>
    <nav id="tab">
        <span class="back"></span>
        <div class="tab-title">补货通知明细</div>
    </nav>
    <ul class="tab-items">
        <li class="tab-item active"><span>新需求</span></li>
        <li class="tab-item"><span>已加入</span></li>
        <li class="tab-item"><span>已忽略</span></li>
    </ul>
    <div id="main">
        <div class="container" id="container"></div>
    </div>
    <div id="operate">
        <div class="ope-item new-need">
            <div class="btn btn-lightBlue btn-add">确定</div>
            <div class="btn btn-dullRed btn-ignore">忽略</div>
            <div class="btn btn-gray btn-waiting">待定</div>
        </div>
        <i class="icon-select-all">全选</i>
    </div>
    <div id="empty-data">
        <div class="empty-assist"></div>
        <div class="empty-content">暂无数据</div>
    </div>
    <div class="toast toast-loading">
        <div class="spinner">
            <div class="spinner-container container1">
                <div class="circle1"></div>
                <div class="circle2"></div>
                <div class="circle3"></div>
                <div class="circle4"></div>
            </div>
            <div class="spinner-container container2">
                <div class="circle1"></div>
                <div class="circle2"></div>
                <div class="circle3"></div>
                <div class="circle4"></div>
            </div>
            <div class="spinner-container container3">
                <div class="circle1"></div>
                <div class="circle2"></div>
                <div class="circle3"></div>
                <div class="circle4"></div>
            </div>
        </div>
        <div class="toast-content">加载中...</div>
    </div>
    <div class="toast toast-error">
        <div class="icon-error"></div>
        <div class="toast-content">请求失败</div>
    </div>
    <div class="toast toast-warning">
        <div class="icon-warning"></div>
        <div class="toast-content">选项不能为空</div>
    </div>
    <div class="toast toast-success">
        <div class="icon-success"></div>
        <div class="toast-content">操作成功</div>
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var notity = {};
    notity.dataArray = [];
    notity.repNotifyId = 0;
    notity.init = function (win) {
        notity.repNotifyId = win.para;
        let statusRes = 0;
        let obj = {
            repNotifyId: notity.repNotifyId,
            statusRes: statusRes    
        }
        notity.getNotifyDtl(obj);
    }

    // 补货通知明细
    notity.getNotifyDtl = function (obj) {
        // 加载中...
        $('.toast-loading').show();
        if (g.a.send("processType=g_mscm.weixin.BillSp&actionType=getNotifyDtl", obj, true)) {
            if (g.a.OK) {
                var notifyDtl = g.a.cReturn.notifyDtl;
                // loading 加载隐藏
                $('.toast-loading').hide();
                if (notifyDtl.rowCount) {
                    $('#empty-data').hide().siblings('#main').find('.container').html('').show();
                    var array = getArray(notifyDtl);
                    notity.dataArray = array;
                    var listDom = "";
                    var conDom = document.getElementById('container');
                    conDom.innerHTML = "";
                    for(var j in array) {
                        listDom += '<div class="list">'
                                        +'<div class="list-head">'
                                            +'<div class="list-head-item">'
                                                +'<div class="item-lt">品名</div>'
                                                +'<div class="item-rt">'+ array[j]["matr_name"] +'</div>'
                                            +'</div>'
                                            +'<div class="list-head-item">'
                                                +'<div class="item-lt">品规</div>'
                                                +'<div class="item-rt">'+ array[j]["matr_spec"] +'</div>'
                                            +'</div>'
                                            +'<span class="more"></span>'
                                        +'</div>'
                                        +'<div class="list-body">'
                                            +'<div class="list-body-item">'
                                                +'<div class="item-lt">补货数量</div>'
                                                +'<div class="item-rt">'+ array[j]["package_qty"] +''+ array[j]["package_unit"] +'</div>'
                                            +'</div>'
                                            +'<div class="list-body-item">'
                                                +'<div class="item-lt">单品数量</div>'
                                                +'<div class="item-rt">'+ array[j]["matr_qty"] +''+ array[j]["matr_unit"] +'</div>'
                                            +'</div>'
                                        +'</div>'
                                        +'<i class="icon-select"></i>'
                                    +'</div>';
                    }
                    conDom.innerHTML = listDom;
                    // list 手风琴效果
                    $('.list').on('click', function() {
                        $(this)
                            .find('.list-body').slideToggle()
                            .siblings('.list-head').find('.more').toggleClass('more-up')
                            .parents('.list').siblings('.list').find('.list-body').slideUp()
                            .siblings('.list-head').find('.more').removeClass('more-up'); 
                    });
                    // 单选按钮事件
                    $('.icon-select').on('click', function(event) {
                        event.stopPropagation();
                        var listArray = $('.list');
                        $(this).parent().toggleClass('selected');
                        // 如果全选按钮被选中，点击单个按钮时，取消全选状态
                        if ($('.icon-select-all').hasClass('selected')) {
                            $('.icon-select-all').removeClass('selected');
                        }
                        // 如果单选按钮全部被选中时，则将全选按钮也选中
                        if (listArray.length == 1) {
                            $('.icon-select-all').toggleClass('selected');
                        } else {
                            for(var i = 0; i < listArray.length; i++) {
                                if (listArray[i].className.search('selected') == -1) {
                                    return false;
                                }
                            }
                            $('.icon-select-all').addClass('selected');
                        }
                    })
                } else {
                    // 暂无数据
                    $('#empty-data').show().siblings('#main').find('.container').html('').hide();
                }
            } else {
                // loading 加载隐藏
                $('.toast-loading').hide();
                $('.toast-error').show();
                // 请求失败
                setTimeout(function () {
                    $('.toast-error').hide();
                    // 暂无数据
                    $('#empty-data').show().siblings('#main').find('.container').html('').hide();
                }, 2000);
                return false;
            }
        }
    }

    // tab click
    let $itemDom = $('.tab-item');
    $itemDom.on('click', function() {
        let index = $(this).index();
        let statusRes = 0;
        $(this).addClass('active').siblings('li').removeClass('active');
        if(index == 0) {
            statusRes = index;
            let obj = {
                repNotifyId: notity.repNotifyId,
                statusRes: statusRes
            };
            notity.getNotifyDtl(obj);
        } else {
            statusRes = -index;
            let obj = {
                repNotifyId: notity.repNotifyId,
                statusRes: statusRes
            };
            notity.getNotifyDtl(obj);
        }
    });

    // 全选事件
    $('.icon-select-all').on('click', function() {
        $(this).toggleClass('selected');
        // 如果全选按钮被选中，则单选按钮全部被选中；否则亦然
        if ($(this).hasClass('selected')) {
            $('.list').addClass('selected');
        } else {
            $('.list').removeClass('selected');
        }
    });

    // 忽略需求事件
    $('.btn-ignore').on('click', function() {
        let statusRes = 1;
        notity.editNotify(statusRes);
    });

    // 加入需求池事件
    $('.btn-add').on('click', function() {
        let statusRes = 0;
        notity.editNotify(statusRes);
    });

    // 待定处理事件
    $('.btn-waiting').on('click', function() {
        let statusRes = -2;
        notity.editNotify(statusRes);
    });

    /**
     * 创建一个比较函数，使得 sort() 方法可以执行其他标准排序 
     * 若 a 小于 b，在排序后的数组中 a 应该出现在 b 之前，则返回一个小于 0 的值
     * 若 a 等于 b，则返回 0
     * 若 a 大于 b，则返回一个大于 0 的值
     * @param  Number a 
     * @param  Number b 
     * @return Number   
     */
    notity.sortNumber = function (a, b) {
        return a - b;
    }

    /**
     * 对“补货通知”的新需求、加入需求池和忽略需求操作处理
     * @param  {Number} statusRes 0-待定；1-确定；-1-忽略
     * @return {None}           
     */
    notity.editNotify = function (statusRes) {
        // let repNotifyId = win.para;
        let astatus = 0;
        let dtlArray = [];
        let indexArray = []; // 记录勾选明细得 ID
        let lengthArray = []; // 记录未勾选明细 className 得长度
        let selArray = $('.list');
        for (let i = 0; i < selArray.length; i++) {
            if (selArray[i].className.search('selected') == -1) {
                lengthArray.push(selArray[i].className.length);
            } else {
                indexArray.push(i);
            }
        }
        if (indexArray.length == 0) {
            $('.toast-warning').show();
            setTimeout(function() {
                $('.toast-warning').hide();
            }, 2000);
        } else {
            for (let i in indexArray) {
                let repNotifyDtlId = notity.dataArray[indexArray[i]]["rep_notify_dtl_id"];
                let packageQty = notity.dataArray[indexArray[i]]["package_qty"];
                let obj = repNotifyDtlId + "-" + packageQty;
                dtlArray.push(obj);
            }
            lengthArray = lengthArray.sort(notity.sortNumber);
            if (statusRes == -2) {
                // 点击“待定”按钮时，始终为待定状态
                astatus = 0;
            } else {
                // 点击“忽略”或者“确定”按钮时，判断 astatus 的值
                if (lengthArray.length) {
                    for (let i in lengthArray) {
                        if (lengthArray[i] == 4) {
                            // 待定状态
                            astatus = 0;
                            break;
                        } else {
                            if (lengthArray[i] == 12) {
                                // 加入需求池状态
                                astatus = 1;
                                break;
                            } else {
                                if (statusRes == 1) {
                                    // 加入需求池状态
                                    astatus = statusRes; 
                                } else {
                                    // 忽略需求状态
                                    astatus = -1;
                                }
                            }
                        }
                    }
                } else {
                    if (statusRes == 1) {
                        astatus = statusRes;
                    } else if (statusRes == -1) {
                        astatus = statusRes;
                    }   
                }
            }
            let obj = {
                repNotifyId: notity.repNotifyId,
                statusRes: statusRes,
                astatus: astatus,
                dtlArray: dtlArray
            };
            if (g.a.send("processType=g_mscm.weixin.BillSp&actionType=setNotify", obj, true)) {
                if (g.a.OK) {
                    let result = g.a.cReturn.result;
                    if (result >= 0) {
                        $('.list.selected').remove();
                        $('.icon-select-all').removeClass('selected');
                        $('.toast-success').show();
                        setTimeout(function() {
                            $('.toast-success').hide();
                        }, 2000);
                    }
                } else {
                    // 请求失败
                    $('.toast-error').show();
                    setTimeout(function() {
                        $('.toast-error').hide();
                    }, 2000);
                    return false;
                }
            }
        }
    }

    // 关闭明细页面，返回列表页面
    $('.back').on('click', function() {
        win.close();
        var prop = {
            url: "notify/notify_list.html"
        };
        var para = "";
        topWin.openFullWindow(prop, para);
    });

    function formLoad() {
        notity.init(win);
    }
</script>
