<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>商品订单详情</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <!-- zui -->
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zui.min.css" rel="stylesheet">
    <!-- jQuery (ZUI中的Javascript组件依赖于jQuery) -->
    <script src="../../../../res_plugin/jquery/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.min.js" type="text/javascript"></script>
    <script src="../assets/js/landscape.js?v=1"></script>
    <script src="../../js/flexible.js"></script>
    <script src="../assets/js/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
    <link rel="stylesheet" href="../assets/css/matrDetails.css?v=1" />
  </head>
  <body>
    <div id="app">
      <header class="matrDetails-head">
        <div class="head-title">
          <div class="head-title-name"></div>
          <div class="head-title-btn">
            <button class="btn btn-primary" type="button" onclick="matrDetails.confirm();">确认</button>
            <button class="btn btn-success disabled" type="button">已确认</button>
          </div>
        </div>
        <div class="head-content">
          <div class="head-content-head">
            <div class="content-item">
              <div class="content-item-label">订单号：</div>
              <div class="content-item-value order-number"></div>
              <i class="icon icon-chevron-up more" onclick="matrDetails.toggleMore();"></i>
            </div>
            <div class="content-item">
              <div class="content-item-label">制单日期：</div>
              <div class="content-item-value order-date"></div>
            </div>
          </div>
          <div class="head-content-body">
            <div class="content-item item-more notify-type">
              <div class="content-item-label">采购类型：</div>
              <div class="content-item-value order-type"></div>
            </div>
            <div class="content-item item-more notify-type">
              <div class="content-item-label">采购人：</div>
              <div class="content-item-value order-creator"></div>
            </div>
            <div class="content-item item-more notify-type">
              <div class="content-item-label">仓库：</div>
              <div class="content-item-value order-address"></div>
            </div>
            <div class="content-item item-more notify-type">
              <div class="content-item-label">需求来源：</div>
              <div class="content-item-value order-storage"></div>
            </div>
            <div class="content-item item-more">
              <div class="content-item-label">备注：</div>
              <div class="content-item-value order-remark"></div>
            </div>
          </div>
        </div>
      </header>
      <section class="matrDetails-main">
        <div class="main-box">
          <div class="main-title"><i class="icon icon-list-alt"></i>商品详情</div>
          <div class="main-container"></div>
        </div>
      </section>
      <footer class="matrDetails-foot">
        <div class="foot-number">共<span class="number">0</span>件</div>
        <div class="foot-price">￥<span class="price">0</span></div>
      </footer>
    </div>
    <script>
      var matrDetails = {};
      
      // 提示用户竖屏浏览
      matrDetails.landscape = new landscape({
        pic: '../assets/images/landscape.png', // 图片地址
        picZoom: 1, // 图片缩放比例
        mode: 'portrait', // 页面模式 portrait,landscape
        bgcolor: '#000', // 背景颜色
        txt: '为了更好的体验，请将手机竖过来', // 文字提示
        txtColor: '#fff', // 提示文字的颜色
        prefix: 'Shine' // 前缀
      });

      matrDetails.init = function () {
        matrDetails.tbName = matrDetails.getUrlParam('tbName');
        matrDetails.foreignKey = matrDetails.getUrlParam('foreignKey');
        matrDetails.params = {
          tbName: matrDetails.tbName,
          foreignKey: matrDetails.foreignKey
        };

        matrDetails.getMatr(matrDetails.params);
        matrDetails.getMatrDetails(matrDetails.params);
      }

      matrDetails.getMatr = function (params) {
        if (g.a.send("processType=g_mscm.weixin.BillSp&actionType=getMatr", params, true)) {
          if (g.a.OK) {
            var rows = g.a.cReturn.data.rows;
            if (rows.length > 0 && rows[0] != '') {
              var array = matrDetails.formatObjectData(rows);
              // 订单状态：0-未确认，1-已确认
              if (array[0].astatus != 0) {
                $('.btn-primary').hide().siblings().show();
              } else {
                $('.btn-primary').show().siblings().hide();
              }
              var typeName = array[0].po_type_name ? array[0].po_type_name : '';
              var buyer = array[0].po_buyer ? array[0].po_buyer : '';
              var storageName = array[0].storage_fullname ? array[0].storage_fullname : '';
              var storageReqName = array[0].storage_fullname_req ? array[0].storage_fullname_req : '';
              $('.head-title-name').text(array[0].company_name_mi)
              $('.order-number').text(array[0].ordernumber);
              $('.order-date').text(array[0].orderdate.substring(0, 10));
              $('.order-type').text(typeName);
              $('.order-creator').text(buyer);
              $('.order-address').text(storageName);
              $('.order-storage').text(storageReqName);
              $('.order-remark').text(array[0].orderremark);
            } else {
              new $.zui.Messager('暂无商品订单', {
                type: 'warning'
              }).show();
              return false;
            }
          } else {
            new $.zui.Messager('获取商品订单失败', {
              type: 'danger'
            }).show();
            return false;
          }
        }
      }

      matrDetails.getMatrDetails = function (params) {
        if (g.a.send("processType=g_mscm.weixin.BillSp&actionType=getMatrDetails", params, true)) {
          if (g.a.OK) {
            var rows = g.a.cReturn.data.rows;
            if (rows.length > 0 && rows[0] != '') { 
              var array = matrDetails.formatObjectData(rows);
              
              // 商品详情信息填充
              var type = array[0].type ? array[0].type : '';
              var mainItems = "", totalPrice = 0, totalNumber = 0;
              totalPrice = array[0].amount ? array[0].amount : 0;
              $('.main-container').html('');
              for (var obj of array) {
                var end_date = obj.end_date ? obj.end_date.substring(0, 10) : '';
                totalNumber += obj.matr_qty;
                // totalPrice += itemPrice;
                mainItems += `<div class="main-item">
                                <div class="main-item-title">
                                  <div class="main-item-title-name">${obj.matr_name}</div>
                                  <div class="main-item-title-price">￥ ${obj.matr_amount || 0}.00</div>
                                </div>
                                <div class="main-item-list">
                                  <label class="main-item-list-label">品规：</label>
                                  <span class="main-item-list-value">${obj.matr_spec}</span>
                                </div>
                                <div class="main-item-list">
                                  <label class="main-item-list-label">数量：</label>
                                  <span class="main-item-list-value">${obj.matr_qty}</span>
                                </div>
                                <div class="main-item-list">
                                  <label class="main-item-list-label">单价：</label>
                                  <span class="main-item-list-value">${obj.price}元</span>
                                </div>
                                <div class="main-item-list">
                                  <label class="main-item-list-label">单位：</label>
                                  <span class="main-item-list-value">${obj.matr_unit}</span>
                                </div>
                                <div class="main-item-list notify-type">
                                  <label class="main-item-list-label">计划到货日期：</label>
                                  <span class="main-item-list-value">${end_date}</span>
                                </div>
                              </div>`;
              }
              $('.main-container').html(mainItems);
              $('.number').text(totalNumber);
              totalPrice = totalPrice.toFixed(2);
              $('.price').text(totalPrice);
              // 采购类型、仓库、需求来源以及计划到货日期
              if (type) {
                $('.notify-type').show();
              } else {
                $('.notify-type').hide();
              }
              
            } else {
              new $.zui.Messager('暂无商品订单详情', {
                type: 'warning'
              }).show();
              return false;
            }
          } else {
            new $.zui.Messager('获取商品订单详情失败', {
              type: 'danger'
            }).show();
            return false;
          }
        }
      }
      
      matrDetails.confirm = function () {
      	if (JSON.stringify(matrDetails.params) == '{}') {
      		return false;
      	}
      	if (g.a.send("processType=g_mscm.weixin.BillSp&actionType=getWechatConfirm", matrDetails.params, true)) {
      		if (g.a.OK) {
      			var result = g.a.cReturn.result;
      			if (result){
      				new $.zui.Messager('确认成功', {
		              type: 'success'
		            }).show();
		            $('.btn-primary').hide().siblings().show();
      			} else {
      				new $.zui.Messager('确认失败', {
		              type: 'danger'
		            }).show();
      			}
      		} else {
      			new $.zui.Messager('请求失败', {
	              type: 'danger'
	            }).show();
	            return false;
      		}
      	}
      }

      matrDetails.toggleMore = function () {
        var flag = $('.more').hasClass('icon-chevron-up');
        if (flag) {
          $('.more')
            .addClass('icon-chevron-down').removeClass('icon-chevron-up');
          $('.head-content-body').stop().slideDown();
        } else {
          $('.more')
            .addClass('icon-chevron-up').removeClass('icon-chevron-down');
          $('.head-content-body').stop().slideUp();
        }
      }
      
      matrDetails.getUrlParam = function (name) {
      	var param = {};
      	var search = window.location.search;
      	if (search === "" || search === null) {
      		return "";
      	}
      	var groups = search.substring(search.indexOf('?')+1).split('&');
      	for (var i = 0, len = groups.length; i < len; i++) {
      		var params = groups[i].split('=');
      		param[params[0]] = params[1];
      	}
      	return param[name] ? unescape(param[name]) : "";
      }

      matrDetails.formatObjectData = function (arr) {
        var array = [], len = arr.length;
        for (var i = 0; i < len; i++) {
          var obj = {};
          Object.keys(arr[i]).forEach(function (key) {
            if (isNaN(key) && key !== '$') {
              obj[key] = arr[i][key].value;
            }
          });
          array.push(obj);
        }
        return array;
      }

      matrDetails.init();
    </script>
  </body>
</html>
