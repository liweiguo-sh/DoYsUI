<!DOCTYPE html>
<html>
<head>
    <title>SPD2 APP 主界面</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    <script type="text/javascript">
        var cssStyle = "style2";
    </script>
    <link href="../../../res/control/window/style2/xwf.window.css" rel="stylesheet" type="text/css" />
    <link href="../../../res/control_mobile/menu/style2/xmf.menu.css" rel="stylesheet" type="text/css" />
    <link href="../../../res/control_mobile/context/style2/xmf.context.css" rel="stylesheet" type="text/css" />

    <!-- 基础类 -->
    <script type="text/javascript">window.offline = true;</script>
    <script src="../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../res/jscript/xwf.const.js" type="text/javascript"></script>
    <script src="../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>

    <script src="../../../res_plugin/app/WebView.js" type="text/javascript"></script>
    <script src="../../../res/jscript_mobile/xmf.app.js" type="text/javascript"></script>
    <script src="../../../res/jscript_mobile/xmf.sqlite.js" type="text/javascript"></script>
    <!-- UI控件类 -->
    <script src="../../../res/control/window/xwf.window.js" type="text/javascript"></script>
    <script src="../../../res/control_mobile/menu/xmf.menu.js" type="text/javascript"></script>
    <script src="../../../res/control_mobile/context/xmf.context.js" type="text/javascript"></script>
    <!-- 主界面js -->
    <script src="../../../res/jscript_mobile/xmf.app_main.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            margin: 0px 0px 0px 0px;
        }
    </style>
</head>
<body onload="formLoad();">
    <div style="text-align:center;">
        <img id="imgTop" src="../images/app/main_top.jpg" alt="" style="width:100%;" />
    </div>
    <div id="divMenu">menu loading...</div>
</body>
</html>

<!-- formLoad() -->
<script type="text/javascript">
    var dbPath = "E:\\AndroidApp\\SPD2_RES\\AppSQLite\\";	// -- 用于PC端模拟调试 --
    var appKey = "g_spd"; 									// -- App标识, 本地SQLite数据库名称与appKey同名 --
    var nTimes = 0;

    var dtbMenu = new window.xwf_datatable();
    var menu = new window.xmf_menu();
    //---------------------------------------------------------------------------
    function formLoad() {
        // -- app环境预处理--------------------------------
        topWin.offline = true;
        if (App.os.equals("")) {
            if (nTimes++ > 10) {
                alert("App无响应，请尝试强制关闭后再重新打开。");
            }
            else {
                setTimeout("formLoad()", 100);
            }
            return;
        }
        else {
            topWin.os = App.os;
        }
        // ------------------------------------------------
        if (!db.openDatabase(appKey, dbPath)) {
            showErr("打开本地SQLite数据库遇到意外错误，请重试。");
            return;
        }
        if (urlPara.loginUrl) {
            // -- 从登录页面成功登录，处于联机状态 --
            syncServer("PG1");
        }
        // ------------------------------------------------
        g.systemPath = g.appPath + "project/g_spd/";

        initTopWin();
        loadMenu();
    }
</script>

<!-- 菜单 -->
<script type="text/javascript">
    function loadMenu() {
        var num1 = 0;
        var sql = "";
        // ------------------------------------------------
        try {
            // -- 1. 判断本地菜单表是否存在 ---------------
            sql = "SELECT COUNT(*) num1 FROM sqlite_master WHERE type = 'table' AND name = 'ST_MENU'";
            num1 = db.getInt(sql);
            if (num1 != 1) {
                App.debug("本地菜单表不存在，请先联机登录系统。");
                window.location = "app_login.html?urlMain=app_main.html";
                return;
            }

            // -- 2. 添加菜单 -----------------------------
            sql = "SELECT * FROM ST_MENU ORDER BY menu_sorts";
            dtbMenu = db.getDataTable(sql);
            if (dtbMenu.rowCount == 0) {
                App.showMsg("没有分配可访问的权限，请与系统管理员联系。");
                return;
            }

            menu = new window.xmf_menu({
                divContainer: divMenu,
                click: menuClick,
                anchorClick: showAnchorMenu,
                imagePathP: "../images/menu_mobile/" + top.cssStyle + "/",
                imagePathC: "../../../res/control_mobile/menu/" + top.cssStyle + "/"
            });
            for (var iRow = 0; iRow < dtbMenu.rowCount; iRow++) {
                menu.addMenu({
                    menuKey: dtbMenu.rows[iRow]["menu_key"].value,
                    menuText: dtbMenu.rows[iRow]["menu_text"].value,
                    menuIcon: dtbMenu.rows[iRow]["menu_icon"].value,
                    drRow: dtbMenu.rows[iRow]
                });
            }
            // --------------------------------------------
        }
        catch (e) {
            App.showErr(e);
            return;
        }
    }
    function menuClick(jsonMenu) {
        var drMenu = jsonMenu.drRow;
        var menuKey = drMenu["menu_key"].value;
        var menuText = drMenu["menu_text"].value;
        var menuType = drMenu["menu_type"].value;
        // ------------------------------------------------
        if (menuType.equals("uview")) {
            var prop = {
                text: menuText,
                title: "视图窗口：" + menuText
            };
            var para = {
                viewKey: drMenu["menu_type_value"].value,
                viewForm: g.appPath + "project/" + drMenu["menu_url"].value,
                viewFormTarget: drMenu["view_form_target"].value,
                viewFilter: drMenu.menu_parameter.value,
                flowId: drMenu["flow_id"].value
            };
            topWin.openTopView(prop, para);
        }
        else if (menuType.equals("window")) {
            var prop = {
                text: drMenu["menu_text"].value,
                title: "视图窗口：" + drMenu["menu_text"].value,
                // url: g.httpServer + g.appPath + "project/" + drMenu["menu_url"].value	// -- 联机模式 --
                url: drMenu["menu_url"].value												// -- 脱机模式 --
            };
            topWin.openFullWindow(prop, {});
        }
        else if (menuType.equals("single")) {
            window.open(g.appPath + "project/" + drMenu["menu_url"].value);
        }
        else if (menuType.equals("click")) {
            App.debug(menuKey + "    " + menuText);
        }
        else {
            alert("unknown menu type [" + menuType + "].");
        }
        return true;
    }
</script>
<!-- 锚点菜单 -->
<script type="text/javascript">
    function showAnchorMenu() {
        var arrMenus = new Array();
        // ------------------------------------------------
        arrMenus.push({ key: "login", text: "联机登录", image: "", title: "" });
        arrMenus.push({ key: "upgrade", text: "软件更新", image: "", title: "" });
        arrMenus.push({ key: "help", text: "帮助", image: "", title: "" });

        // ------------------------------------------------
        topWin.context.show({
            arrMenus: arrMenus,
            objDom: menu.tbM1,
            top: 14,
            left: 0,
            menuClick: function (jsonPara) {
                anchorMenuClick(jsonPara);
            }
        });
    }
    function anchorMenuClick(jsonPara) {
        var menuKey = jsonPara.key;
        // ------------------------------------------------
        if (menuKey.equals("login")) {
            window.location = "app_login.html?urlMain=app_main.html&rnd=" + Math.random();
        }
        else {
            App.debug("当前菜单（" + menuKey + "）功能正在拼命开发中...");
        }
    }
</script>