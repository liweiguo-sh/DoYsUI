<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>xpas Mobile tree control</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="../../../../res/css_mobile/style1/xwf.common.css" rel="stylesheet" type="text/css" />
	<link href="../../../../res/control_mobile/tree/style1/xwf.tree.css" rel="stylesheet" type="text/css" />
	
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript_mobile/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>

	<script src="../../../../res/control_mobile/tree/xwf.tree.js" type="text/javascript"></script>

	<style type="text/css">
		#divTree {
			border: dashed 0px Olive;
		}
	</style>
</head>
<body onload="formLoad()">
	<table class="tbButtons">
		<tr>
			<td style="display:none;"><div id="btnReload" onclick="btnReload_click();">重新加载</div></td>
			<td><div id="btnClose" onclick="btnClose_click();" >关闭</div></td>
		</tr>
	</table>
	<div id="divTree"></div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var rootOfficeId = 0;
	var rootNodeKey = "";

	var divTree = gId("divTree");
	var tree = new window.xwf_tree();
	// ------------------------------------------------------------------------
	function formLoad() {
		initTree();
	}

	function btnReload_click() {
		divTree.innerHTML = "";
		initTree();
	}
	function btnClose_click() {
		if (window.win) {
			win.close();
		}
		else {
			// -- 改为微信js实现关闭窗口 --
			window.close();
		}
	}
</script>

<!-- initTree -->
<script type="text/javascript">
	function initTree() {
		var rootNodeKey = "";
		var jsonPara = {
			divContainer: gId("divTree"),
			imgPath: "../../../../res/control_mobile/tree/style1/",
			title: "请选择机构",
			levelCols: {
				L2: 3,
				L3: 2
			},
			beforeExpand: beforeNodeExpand,
			nodeClick: onNodeClick
		};
		tree = new window.xwf_tree(jsonPara);

		rootNodeKey = "0" + tree.sd + rootOfficeId;
		tree.addNode({ key: rootNodeKey, text: "机构列表", officeId: rootOfficeId, nodeKey: rootNodeKey });
		tree.addNode({ key: rootNodeKey + tree.sd + "loading", text: "loading..." });

		tree.expand(rootNodeKey);
	}
	function beforeNodeExpand(node, firstExpand) {
		var officeId = node.officeId;
		if (officeId) {
			loadUser(node);
		}

		if (!firstExpand) return;
		tree.removeNode(node.key + tree.sd + "loading");
		loadOfficeNodes(node.key, node.officeId, node.level);
	}
	function loadOfficeNodes(pNodeKey, officeId, officeLevel) {
		if (g.a.send("processType=example.training4_wx.OfficeTree&actionType=getOfficeNodeData", { officeId: officeId, officeLevel: officeLevel }, true)) {
			if (g.a.OK) {
				var c = g.a.cReturn;
				var dtb = c.dtbOfficeNodeData;
				for (var i = 0; i < dtb.rowCount; i++) {
					var nodeText = dtb.rows[i]["office_shortname"].value;
					var officeId = dtb.rows[i]["office_id"].value;
					if (officeId == 1) continue;

					tree.addNode({ key: pNodeKey + tree.sd + officeId, text: nodeText, officeId: officeId });
					// -- 加载虚拟子节点 ------------------
					if (dtb.rows[i]["children"].value > 0) {
                        tree.addNode({ key: pNodeKey + tree.sd + officeId + tree.sd + "loading", text: "loading..." + dtb.rows[i]["children"].value });
					}
				}
			}
			else {
				return;
			}
		}
		else {
			return;
		}
	}

	function onNodeClick(node) {
		var officeId = node.officeId;
		loadUser(node);
	}
	function loadUser(node) {
		var officeId = node.officeId;
		var officeName = node.text;
		debug("officeId = " + officeId + ", " + officeName);
	}
</script>