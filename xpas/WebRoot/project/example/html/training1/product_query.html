<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>产品查询(多标签样例)</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
		
	<script src="../../../../res/control/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
	<script src="../../../../res/control/tab/xwf.tab.js" type="text/javascript"></script>
	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
</head>
<body>
	<div id="divDC"></div>
	<form id="frm" action="" target="">
		<table id="tbForm" class="tbForm" style="width:705px;">
			<tr class="trH">
				<th style="width:150px;"></th>
				<th style="width:200px;"></th>
				<th style="width:150px;"></th>
				<th style="width:200px;"></th>
			</tr>
			<tr>				
				<td>产品分类：</td>
				<td><input type="text" id="_gCatalog_name" value="" /></td>
				<td>产品名称：</td>
				<td><input type="text" id="_cProduct_name" value="" /></td>
			</tr>
			<tr>
				<td>备注：</td>
				<td colspan="3"><textarea id="_cProduct_remark" rows="3" cols="0"></textarea></td>
			</tr>
		</table>
		<div id="divTab" class="xwf_tab_divContainer" style="width:695px;height:300px;">
			<div id="divTabA">
				<img id="_cProduct_img_url" alt="" src="" style="width:150px;height:150px;" />
			</div>						
			<div id="divGridB" style="display:none"></div>
			<div id="divGridC" style="display:none"></div>
			<div id="divTabD" style="display:none">
				<object id="canvas" classid="CLSID:827DF6D2-DD6F-4d97-8C7F-5C19E15CE30D" width="695px" height="300px" disabled="disabled">
        			未安装标签预览控件，请到登录页面下载并安装标签控件。
				</object>
			</div>
		</div>
		<input id="_cPRODUCT_ID" type="hidden" value="" />
	</form>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var tabs = null;
	var gridviewB = null, gridviewC = null;
	var cvs = gId("canvas");
	// ------------------------------------------------------------------------
	function formLoad() {
		vf.css(gId("tbForm"));
		vf.addExtraButton({ key: "printBarcode", text: "打印产品标签", title: "通过码尚控件打印产品标签" });

		tabs = new window.xwf_tab({ divContainer: gId("divTab"), tabClick: tab_click });
		tabs.addTab({ key: "tabA", text: "产品图片", control: gId("divTabA") });
		tabs.addTab({ key: "tabB", text: "历史入库单", title: "产品入库历史记录列表", control: gId("divGridB") });
		tabs.addTab({ key: "tabC", text: "历史出库单", title: "产品出库历史记录列表", control: gId("divGridC") });
		tabs.addTab({ key: "tabD", text: "产品标签", control: gId("divTabD") });
	}

	function tab_click(tab) {
		var productId = frm._cPRODUCT_ID.value.toInt();
		if (tab.key == "tabB") {
			if (gridviewB == null) {
				var prop = {
					divContainer: gId("divGridB"),
					viewKey: "ex_in",
					viewFilter: "in_id IN (SELECT in_id FROM T_IN_DTL WHERE product_id = " + productId + ")",
					viewForm: "project/example/html/training2_uview/in.html",
					allowAdd: false
				};
				gridviewB = new window.xwf_gridview(prop);
				gridviewB.beforeAddnew = function () {
					if (!vf.status.equals("view")) {
						showWarn("当前状态不允许添加明细记录。");
						return false;
					}
					return true;
				}
			}
			else {
				gridviewB.setViewFilter("in_id IN (SELECT in_id FROM T_IN_DTL WHERE product_id = " + productId + ")");
			}
		}
		else if (tab.key == "tabC") {
			if (gridviewC == null) {
				var prop = {
					divContainer: gId("divGridC"),
					viewKey: "ex_out",
					viewFilter: "out_id IN (SELECT out_id FROM T_OUT_DTL WHERE product_id = " + productId + ")",
					viewForm: "project/example/html/training2_uview/out.html",
					allowAdd: false
				};
				gridviewC = new window.xwf_gridview(prop);
				gridviewC.beforeAddnew = function () {
					if (!vf.status.equals("view")) {
						showWarn("当前状态不允许添加明细记录。");
						return false;
					}
					return true;
				}
			}
			else {
				gridviewC.setViewFilter("out_id IN (SELECT out_id FROM T_OUT_DTL WHERE product_id = " + productId + ")");
			}
		}
		else if (tab.key.equals("tabD")) {
			getLabelByProductId(frm._cPRODUCT_ID.value.toInt());
		}
		return true;
	}
</script>
<!-- vf.events -->
<script type="text/javascript">
	vf.afterMove = function () {
		tab_click(tabs.tabSelected);
	}
	vf.beforeClick = function (prop) {
		var buttonKey = prop.buttonKey;
		if (buttonKey.equals("printBarcode")) {
			printBarcode();
		}
		else {
			showWarn("未知的功能扩展：" + buttonKey + "，请检查。");
			return false;
		}
		// ------------------------------------------------
		return false;
	}
</script>

<!-- 打印产品标签 -->
<script type="text/javascript">
	function getLabelByProductId(productId) {
		if (g.a.send("processType=example.training1.Common&actionType=getLabelByProductId", { productId: productId }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				var labelFile = cReturn.labelFile;

				// -- 初始化标签 --------------------------
				cvs.OpenXML(labelFile);
				cvs.SetNoResize();
				cvs.ZoomToFit();
				cvs.ZoomToFit();

				// -- 标签内容赋值 ------------------------
				cvs.setShareValue("ProductId", frm._cPRODUCT_ID.value)
				cvs.SetVarValue("ProductName", frm._cProduct_name.value);
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}

	function printBarcode() {
		cvs.PrintOut();
	}
</script>