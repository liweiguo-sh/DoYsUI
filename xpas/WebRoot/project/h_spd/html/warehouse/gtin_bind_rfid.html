<!DOCTYPE html>
<html>
<head>
    <title>红会码绑定RFID</title>
	<script>
        var css_xwf_uvform = true;
	</script>
	<script src="../../../../res/jscript/xwf.js"></script>
	<script src="../../../../res/jscript/xwf.ajax.js"></script>	
	<script src="../../../../res/jscript/xwf.const.js"></script>
	<script src="../../../../res/jscript/xwf.datatable.js"></script>
    <script src="../../../../res/jscript/xwf.css.js"></script>
	
	<style type="text/css">
		body {
			overflow: hidden;
		}
		#snScanBox, #rfScanBox{
			font-size:1em;font-family:Arial;height:26px;line-height:24px;border:2px solid #19A2D5;
		}
		.PanelA{
			width:980px;
			margin-left:auto;
			margin-right:auto;
		}
	    .tdTip {
			text-align: center;
			height: 60px;
			line-height: 60px;
		}
	    .tips-ok {
	        font-size: 1.3em;
	        font-family: 微软雅黑;
	        color: DarkGreen;
	    }
		.tips-err{
			font-size:1.3em;font-family:微软雅黑;color:Red;
		}
	</style>
</head>
<body>
	<div class="PanelA" style="margin-top:5px;">
		<table id="tbStockInfo" class="tbForm" style="width:100%;">
			<tr class="trH">
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
			</tr>			
			<tr>
				<td>品名</td>
				<td colspan="3"><input type="text" id="_fMaterial_name" disabled="disabled" /></td>
				<td>品规</td>
				<td colspan="3"><input type="text" id="_fMaterial_spec" disabled="disabled" /></td>
			</tr>
			<tr>				
				<td>批次</td>
				<td><input type="text" id="_fLot" disabled="disabled" /></td>
				<td>出厂日期</td>
				<td><input type="text" id="_fManufacture_date" disabled="disabled" /></td>
				<td>效期</td>
				<td><input type="text" id="_fExp_date" disabled="disabled" /></td>
				<td>售价</td>
				<td><input type="text" id="_fPrice_sp" /></td>	
				<td><input type="button" id="updateprice" onclick="UpdatePrice()" value="确认修改" /></td>			
			</tr>
			<tr>				
				<td>RFID</td>
				<td colspan="3"><input type="text" id="_fRfid" disabled="disabled"/></td>	
			</tr>
		</table>
	</div>
	<div class="PanelA" style="margin-top:5px;">
		<table id="tbScan" class="tbForm" style="width:100%;">
			<tr class="trH">
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
				<th style="width: 10%"></th>
				<th style="width: 15%"></th>
			</tr>
			<tr>
				<td>出厂主码</td>
				<td colspan="3"><input type="text" id="txtGtin"   autocomplete="off" style="ime-mode:disabled" /></td>
				<td>RFID</td>
				<td colspan="3"><input type="text" id="txtRfid" autocomplete="off" style="ime-mode:disabled" /></td>				
			</tr>
			<tr>
				<td>出厂副码</td>
				<td colspan="3"><input type="text" id="txtHibc"   autocomplete="off" style="ime-mode:disabled" /></td>			
			</tr>
			<tr>
				<td colspan="5" class="tdTip"><span id="spanTip">&nbsp;</span></td>
				<td colspan="3" class="pageButtons">
					<input type="button" id="btnBind" value="绑定RFID" onclick="btnBind_click();" />
					<input type="button" id="btnUnbind" value="解绑RFID" onclick="btnUnbind_click();" />
				</td>
			</tr>
		</table>
		<input type="hidden" id="_fSTOCK_ID" value="0" />
		<audio id="audio">
			<source src="/xpas/res/sound/mp3/msg1.mp3"  />
		</audio>
	</div>	
</body>
</html>

<!-- formLoad -->
<script>
    var txtGtin = gId("txtGtin");
    var txtRfid = gId("txtRfid");
    var txtHibc = gId("txtHibc");
	// ----------------------------------------------------
	function formLoad() {
        cssFormat(gId("tbStockInfo"));
        cssFormat(gId("tbScan"));

        clearForm();

        g.x.bindEnterEvent(txtGtin, onTxtGtinEnter);
        g.x.bindEnterEvent(txtRfid, onTxtRfidEnter);
	}
</script>

<!-- buttons event -->
<script>
    function onTxtGtinEnter() {
        var code1 = gId("txtGtin").value.trim();
        var code2 = gId("txtHibc").value.trim();
		// ------------------------------------------------------
        if (code1.equals("")) return;
        if (g.a.send("processType=h_spd.warehouse.GtinBindRfid&actionType=getStockByGtin", { code1: code1,code2:code2 }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbStock = cReturn.dtbStock;
                fillForm(dtbStock.rows[0]);
				
                txtRfid.disabled = false;
                txtRfid.value = "";
                txtRfid.focus();
                return true;
            }
            else {
                clearForm();
                txtGtin.value = gtin;
                txtGtin.select();
                txtGtin.focus();
                return false;
            }
        }
        else {
            return false;
        }
    }
    function onTxtRfidEnter() {
        bindRfid();
    }

    function btnBind_click() {
        bindRfid();
    }
    function btnUnbind_click() {
        unbindRfid();
    }

</script>
<!-- bind/unbind -->
<script>
    function clearForm() {
        gId("_fSTOCK_ID").value = "";

        gId("_fMaterial_name").value = "";
        gId("_fMaterial_spec").value = "";
        gId("_fLot").value = "";
        gId("_fExp_date").value = "";
        //gId("_fGtin").value = "";
        gId("_fRfid").value = "";
		//gId("_fHibc").value = "";
		gId("_fPrice_sp").value="";
		gId("_fManufacture_date").value="";

        txtGtin.disabled = false;
        txtGtin.value = "";
        txtHibc.disabled = false;
        txtHibc.value = "";
        txtHibc.focus();

        txtRfid.disabled = true;
        txtRfid.value = "";
    }
    function fillForm(dataRow) {
        gId("_fSTOCK_ID").value = dataRow["stock_id"].value;

        gId("_fMaterial_name").value = dataRow["material_name"].value;
        gId("_fMaterial_spec").value = dataRow["material_spec"].value;
        gId("_fLot").value = dataRow["lot"].value;
        gId("_fExp_date").value = dataRow["expired_date"].value.substring(0,10);
        gId("_fRfid").value = dataRow["rfid"].value;
        gId("_fPrice_sp").value = dataRow["price_sp"].value;
        gId("_fManufacture_date").value = dataRow["manufacture_date"].value;
    }

    function bindRfid() {
        var code1 = gId("txtGtin").value.trim();
        var rfid = gId("txtRfid").value.trim();
        var code2 = gId("txtHibc").value.trim();
        // ------------------------------------------------------
        if (code1.equals("") || rfid.equals("")) return;

        if (g.a.send("processType=h_spd.warehouse.GtinBindRfid&actionType=bindRfid", { code1: code1, rfid: rfid,code2:code2 }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbStock = cReturn.dtbStock;
                fillForm(dtbStock.rows[0]);

                clearForm();
                win.flashTitle("RFID绑定成功.");
                return true;
            }
            else {
                txtRfid.value = "";
                return false;
            }
        }
        else {
            return false;
        }
    }
    function unbindRfid() {
        var code1 = gId("txtGtin").value.trim();
        var code2 = gId("txtHibc").value.trim();
        
        // ------------------------------------------------------
        if (code1.equals("") ) return;
        if (!showConfirm("您确定要解除当前RFID绑定关系吗？")) return;
		console.log(code1);
		console.log(code2);
        if (g.a.send("processType=h_spd.warehouse.GtinBindRfid&actionType=unbindRfid", { code1: code1,code2:code2 }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                clearForm();
                win.flashTitle("RFID解除绑定成功.");
                return true;
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
    function UpdatePrice(){
    	var price= gId("_fPrice_sp").value;
    	console.log(price);
    	var code1 = gId("txtGtin").value.trim();
        var code2 = gId("txtHibc").value.trim();
    	if (!showConfirm("您确定要修改耗材价格吗？")) return;
    	
    	if (g.a.send("processType=h_spd.warehouse.GtinBindRfid&actionType=updatePrice", { code1: code1,code2:code2,price:price }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                win.flashTitle("修改耗材价格成功.");
                return true;
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>
