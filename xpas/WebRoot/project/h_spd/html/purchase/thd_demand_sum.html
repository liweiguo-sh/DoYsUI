<!DOCTYPE html>
<html>
<head>
    <title>需求汇总单</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
		
	<script src="../../../../res/control/tab/xwf.tab.js" type="text/javascript"></script>
	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
   	<script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/web_print.js"></script>
	
    
    <style type="text/css">
        body {
            overflow: hidden;
        }
    </style>
</head>
<body>
	<div id="divDC"></div> 
        <div id="divTab" class="xwf_tab_divContainer" style="width:805px;">
            <div id="divMain">
                <form id="frm" action="" target="h_spd.purchase.VIEW_thdDemandSum">		    
			        <table id="tbForm" class="tbForm" style="width:805px;">
				        <tr class="trH">
					        <th style="width:150px;"></th>
					        <th style="width:250px;"></th>
					        <th style="width:150px;"></th>
					        <th style="width:250px;"></th>
				        </tr>
				        <tr>				
					        <td>单号：</td>
					        <td><input type="text" id="_cDemand_sum_key" value="" disabled="disabled" /></td>
					        <td>日期：</td>
					        <td><input type="text" id="_cDemand_sum_date" class="Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" /></td>
				        </tr>
				        <tr>				
					        <td>采购科室：</td>
					        <td><input type="text" id="_cDept_name" value="" disabled="disabled" /></td>
                            <td>金额：</td>
					        <td><input type="text" id="_cAmount" value="" disabled="disabled" /></td>
				        </tr>
				        <tr>
					        <td>备注：</td>
					        <td colspan="3"><textarea id="_cRemark" rows="3" cols="0"></textarea></td>
				        </tr>
			        </table>
		            <input id="_cDEMAND_SUM_ID" type="hidden" value="" />
                    <input id="_cDEPT_ID" type="hidden" value="" />
	            </form>
                <div id="divGridDtl"></div>
            </div>
			<div id="divMatr" style="display:none;">
                <div id="divGridMatr"></div>
			</div>
        </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var astatusNav = 0;

    var tbForm = gId("tbForm");
    var divGridDtl = gId("divGridDtl");

	var tabs = null;
	var gvDtl = null, gvMatr = null;	
	// ------------------------------------------------------------------------
    function formLoad() {
        var gvParent = win.parentWindow.gridView;
        if (gvParent.viewKey.equals("thd_demand_sum")) {   // -- 标准入口 --
            var nodeNav = gvParent.tree.selectedNode;
            astatusNav = (nodeNav.level > 1 ? nodeNav.value : 0);
        }

        vf.css(gId("tbForm"));
        formResize();

        tabs = new window.xwf_tab({ divContainer: gId("divTab"), tabClick: tab_click });
        tabs.addTab({ key: "tabMain", text: "基本信息", title: "单据基本信息", control: gId("divMain") });
        tabs.addTab({ key: "tabMatr", text: "请购汇总", title: "请购商品汇总", control: gId("divMatr") });

        initGridDtl();
    }
    function formResize() {
        divMain.style.height = (win.p.maxHeight - divMain.offsetTop - 80) + "px";
        divGridDtl.style.height = (divMain.clientHeight - tbForm.offsetHeight) + "px";  

        divGridDtl.style.width = (tbForm.offsetWidth) + "px";
        divGridMatr.style.width = tbForm.offsetWidth + "px";

        divGridMatr.style.height = (divMain.clientHeight) + "px";
    }

    function tab_click(tab) {
        var demandSumId = frm._cDEMAND_SUM_ID.value.toInt();
        if (tab.key == "tabMain") {
            gvDtl.setViewFilter("demand_sum_id = " + demandSumId);
        }
        else if (tab.key == "tabMatr") {
            initGridMatr();
            gvMatr.setViewFilter("demand_sum_id = " + demandSumId);
		}
		return true;
	}
</script>

<!-- vf.events -->
<script type="text/javascript">
	vf.afterAddnew = function () {
        frm._cDemand_sum_date.value = (new Date).toString();
        frm._cDEPT_ID.value = topWin.officeId;
        frm._cDept_name.value = topWin.officeName;
	}

	vf.afterMove = function () {
		tab_click(tabs.tabSelected);
	}	
</script>

<!-- gridview -->
<script type="text/javascript">
    function initGridDtl() { 
        var prop = {
            divContainer: divGridDtl,
            viewKey: "thd_demand_sum_dtl",
            viewFilter: "1 = 0", 
            toolbarVisible: true,
            jsonToolbar: { height: "M", onclick: onToolbarClick_Dtl }
        };
        gvDtl = new window.xwf_gridview(prop);
        if (astatusNav == 0 || astatusNav == 2) {
            gvDtl.toolbar.addBar({ type: "button", key: "addFromDemand", text: "<i class='fa fa-external-link'></i> 选择科室需求" });
        }
    }
    function viewExtraButtonClick(para) {
        var btnKey = para.btnKey;
        var astatus = vf.dtbBase.rows[0]["astatus"].value;
        var demandSumId = frm._cDEMAND_SUM_ID.value.toInt();

        var dataRow = para.drViewData;
        var demandId = dataRow["demand_id"].value;
        var demandSumDtlId = dataRow["demand_sum_dtl_id"].value;
        // ------------------------------------------------
        if (btnKey.equals("removeDemand")) {
            if (astatus != 0 && astatus != 2) {
                showErr("非制单状态，不能移除需求明细");
                return false;
            }
            // ------------------------------------------------
            if (g.a.send("processType=h_spd.purchase.VIEW_thdDemandSumDtl&actionType=removeDemandFromDtl", { viewKey: "thd_demand_sum_dtl", demandSumId: demandSumId, demandSumDtlId: demandSumDtlId, demandId: demandId }, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;

                    vf.refreshRecord();
                    gvDtl.refresh();
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }
        else if (btnKey.equals("showDemand")) {
            var prop = {
                width: 900,
                height: 500, 
                parent: win,
                modal: true
            };
            var para = {
                viewKey: "thd_demand_dtl_info",
                viewFilter: "demand_id = " + demandId
            };
            topWin.openView(prop, para);
        }
        else {
        }
        return true;
    }

    function onToolbarClick_Dtl(para) {
        if (para.key.equals("addFromDemand")) {
            if (vf.status.equals("addnew")) {
                if (!vf.save()) {
                    return false;
                }
            }
            var prop = {
                title: "请选择需求...",
                width: 1000,
                height: 0.8,
                parent: win
            };
            var para = {
                viewKey: "thd_demand_select",
                viewMode: "multiSelect",
                viewForm: "project/h_spd/html/purchase/thd_demand.html",
                selectCallback: onDemandSelect
            };
            topWin.openSelectView(prop, para);
        }
        else if (para.key.equals("printIO")) {
            var param = {
                title: "需求计划汇总("+ gId("_cDemand_sum_key").value  +")",
                colNumThs: 3, //表头每行多少列，默认为4
                colNumTfooters: 4, //表尾每行多少列，默认为4
                form: {
                    ths: [
                        { text: "日期", value: gId("_cDemand_sum_date").value },
                        { text: "采购科室", value: gId("_cDept_name").value },
                        { text: "金额", value: gId("_cAmount").value },
                        { text: "备注", value: gId("_cRemark").value,colspan: 5 }
                    ],
                    tfooters: [
                    ]
                },
                 sumTableFun:function(jqPageTable){//打印汇总函数，即每个分页最后一行汇总行的处理方法，可以不传，可以参考 balance_matr.html 用法
			    	var trRet=["<tr>"];
			    	
			    	//合计标题列和空列
			    	trRet.push("<td>合计</td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	trRet.push("<td></td>");
			    	
			    	
			    	//合计列
			    	var sumqtyin=0;
			    	jqPageTable.find(".datarow").each(function(){
			    		var tr=$(this);
			    		var thqtyin=parseFloat(tr.children("td:eq(5)").text());
			    		if(!isNaN(thqtyin)) sumqtyin+=thqtyin;
			    	});
			    	trRet.push("<td>"+g.x.toFixedN(sumqtyin,4)+"</td>");
			    	
			    	trRet.push("</tr>");
			    	return trRet.join("");
			    },
                grid: {
                    ths: ["序号", "品名", "品规", "数量","单价","金额"],
                    thwidths: ["66px", "auto", "150px", "100px", "100px", "100px"],
                    data: (function () {
                        var arr = [], row, sp_amount = 0, sell_amount = 0;
                        if (gvMatr && gvMatr.dtbViewData.rowCount > 0) {
                            var totalprice = 0, totalPriceSell = 0, rowData;
                            for (var i in gvMatr.dtbViewData.rows) {
                                row = gvMatr.dtbViewData.rows[i];
                                rowData = [];
                                rowData[0] = (parseInt(i) + 1);
                                rowData[1] = row["matr_name"].value;
                                rowData[2] = row["matr_spec"].value;
                                rowData[3] = row["qty"].value;
                                rowData[4] = row["price"].value;
                                rowData[5] = row["amount"].value;
                                arr.push(rowData);
                            }
                        }
                        return arr;
                    })()
                }
            };
            WebPrint.goPrintFormModel(param);
        }
    }
    function onDemandSelect(arrRows) {
        var demandSumId = frm._cDEMAND_SUM_ID.value.toInt();
        var demandIds = "";
        var arrDemand = new Array();

        for (var i = 0; i < arrRows.length; i++) {
            arrDemand.push(arrRows[i]["demand_id"].value);
        }
        demandIds = arrDemand.join(",");

        if (g.a.send("processType=h_spd.purchase.VIEW_thdDemandSumDtl&actionType=addFromDemand", { viewKey: "thd_demand_sum_dtl", demandSumId: demandSumId, demandIds: demandIds }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                gvDtl.refresh();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
        return true;
    }

    // ------------------------------------------------------------------------
    function initGridMatr() {
        if (gvMatr == null) {
            var prop = {
                divContainer: divGridMatr,
                viewKey: "thd_demand_sum_matr",
                viewFilter: "1 = 0",
                toolbarVisible: true,
            	jsonToolbar: { height: "M", onclick: onToolbarClick_Dtl }
            };
            gvMatr = new window.xwf_gridview(prop);
            gvMatr.toolbar.addBar({ type: "button", key: "printIO", text: "打印请领汇总" });
        }
    }
</script>