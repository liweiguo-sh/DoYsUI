<!DOCTYPE html>
<html>
<head>
    <title>科室请领单</title>
    <script src="../../../../res/jscript/xwf.js?v=20191009" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
     <script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zuiExt.js" type="text/javascript"></script>
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zui.css" rel="stylesheet" type="text/css" />
    <script src="../../js/select_storage.js"></script>
     <script src="../../js/background.js"></script>
     <style type="text/css">
     	.nav2 button,.nav1 button{
     		margin-right: 5px;
     	}
     	
     	#noticebox{
     		height: 200px;
     	}
     	
     	#box-cards{
     		    max-height: 300px;
    			overflow-y: auto;
     	}
     	
     	
     	.article .content{
     		height: 100px !important;
     	}
     	.box-nav{
     		    margin: 0px;
    			padding-bottom: 40px;
     	}
     	
     	.btn-category:HOVER, .active{
     		    color: #fff  !important;
			    background-color: #3280fc !important;
			    border-color: #1970fc  !important;
     	}
     	
     	.btn-category{
     		margin-right: 5px;
     	}
     	
     	#panelshopcart{
     		    max-height: 240px;
    			overflow: auto;
     	}
     	
     	.card:HOVER {
			border-color: #0a67fb;
			    border-width: 3px;
		}
		.card{
			border-width: 3px;
			border-color:#fff;
		}
		
		#box-toolbar{
			    background-color: #f5f5f5;
		}
		
		.pager{
			margin: 0px 27px 0px 0px;
		}
		
		.card *{
			    cursor: pointer !important;
		}
		
				 
		 .static-text{
		 	box-shadow: none  !important;
		    outline: 0px  !important;
		    background: none  !important;
		    border: 0px  !important;
		   }
		   
		   
		   .card-shop-item{
		       border: 1px solid rgba(0,0,0,.2);
		    border-radius: 4px;
		    -webkit-box-shadow: 0 5px 10px rgba(0,0,0,.2);
		    box-shadow: 0 5px 10px rgba(0,0,0,.2);
		   }
		
     </style>
</head>
<body>

<form id="frm" action="" target="h_spd.dept.VIEW_thdApply">
	<input id="_cAPPLY_ID" type="hidden" value="" />
    <input id="_cAStatus" type="hidden" value="" />

    <input id="_cDept_id" type="hidden" value="" />
    <input id="_cStorage_id_dept" type="hidden" value="" />
    <input id="_cStorage_id_res" type="hidden" value="" />
    <input id="_cStorage_name_res" type="hidden" value="" />
</form>
<div class="container-fluid">
	<div class="row">
		<div class="col-xs-2">
			<div class="row" id="box-user">
				<div class="col-xs-12">
					<div class="panel">
					  <div class="panel-heading text-center">
					  </div>
					  <div class="panel-body">
					   	<div class="row  with-padding">
							<label class="col-xs-4">当前库房
							</label>
							<div class="col-xs-8" ">
								<div class="input-control search-box has-icon-left has-icon-right" id="searchboxExample">
								  <input onclick="vf.selectStationStorage();" style="cursor: pointer;" id="_xStationStorage" type="search" class="form-control search-input" placeholder="请选择" readonly="readonly" >
								  <label for="inputSearchExample1" class="input-control-icon-left search-icon"><i class="icon icon-search"></i></label>
								</div>
							</div>
						</div>
					  </div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12">
					<div class="panel">
					  <div class="panel-heading text-center">
						购物车
						<i class="icon  icon-refresh pull-right" style="cursor: pointer;" title="刷新购物车" onclick="vf.loadShopCart();"></i>
					  </div>
					  <div class="panel-body">
					  	<div class="row"  id="panelshopcart" >
							<div class="col-xs-12" >
						  		<table class="table table-hover table-striped table-condensed">
								  <thead>
								    <tr style="display: none;" >
								      <th class="text-center">耗材</th>
								      <th class="text-center">数量</th>
								      <th class="text-center">操作</th>
								    </tr>
								  </thead>
								  <tbody id="boxshopCart">
								    <tr>
								      <td colspan="3" class="text-center">暂无数据</td>
								    </tr>
								  </tbody>
								</table>
							</div>
						</div>
						<div class="row">
					  		<div class="col-xs-4" ">
								<button class="btn btn-block  btn-primary " id="btn-submit" type="button" onclick="vf.submit();" style="display: none;">提交</button>
							</div>
					  		<div class="col-xs-4" ">
								<button class="btn btn-block  btn-primary " type="button" onclick="vf.openApplyList();">查看</button>
							</div>
							<div class="col-xs-4" ">
								<button class="btn btn-block  " type="button" onclick="win.close();">关闭窗口</button>
							</div>
						
						</div>
					  </div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-xs-10">
			<div class="row" id="box-toolbar" >
				<div class="col-xs-12" id="box-toolbar-btn" >
				</div>
				<div class="col-xs-12" >
					<div class="form-group"  style="    padding-top: 5px;">
						<div class="col-xs-2">
							<div class="input-group">
							  <div class="input-control search-box search-box-circle has-icon-left has-icon-right search-example" id="searchboxExample">
							    <input id="keyword" type="search" class="form-control search-input" placeholder="搜索" autofocus="autofocus" onkeyup="if(event.keyCode==13)vf.getStockList()">
							    <label for="keyword" class="input-control-icon-left search-icon"><i class="icon icon-search"></i></label>
							  </div>
							  <span class="input-group-btn">
							    <button class="btn btn-primary" type="button" onclick="vf.getStockList();" >搜索</button>
							  </span>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-xs-12">
					<div class="row">
						<div class="col-xs-12">
							<div class="cards" id="box-cards">
								
						   </div>
						</div>
						<div class="col-xl-12 text-right">
							<ul class="pager"  id="myPager"  data-elements="first,prev,pages,next,last"  data-max-nav-count="6" ></ul>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
</body>
</html>


<!-- formLoad -->
<script type="text/javascript">
   var boxcards,boxtoolbar,timeoutload=300,boxshopCart,myPager,panelshopcart,boxuser,btnSubmit;
    //窗口加载后调用
    function formLoad() {
    	//设置工位
    	initStation();
    	if(getLocalItem("stationStorageId").toInt() <1){
    		//alert(1111);
    		//win.close();
    		//return;
    	}
    	
        boxcards=$("#box-cards");
        boxtoolbar=$("#box-toolbar");
        boxshopCart=$("#boxshopCart");
        panelshopcart=$("#panelshopcart");
        boxuser=$("#box-user");
        btnSubmit=$("#btn-submit");
        
      
	    
	    gId("_xStationStorage").value = getLocalItem("stationStorageName");
	    
	    //品类列表
        vf.getCategoryList(null,0,1);
	    //库存列表列表
        vf.getStockList();
        
        $('#myPager').on('onPageChange', function(e, state, oldState) {
		    if (state.recTotal>0 &&   state.page !== oldState.page) {
		    	vf.getStockList(state.page);
		    }
		});
		vf.resetBoxH();
		
		$("#keyword").focus();
    }
    
    
    vf.resetBoxH=function(){
    	  //列表区域高度
        var boxcardH= window.innerHeight;
	    boxcardH = boxcardH - boxtoolbar.outerHeight() - $("#myPager").outerHeight()-10;
	    boxcards.css({"max-height":boxcardH+"px"})
	    
	    var pannelH= window.innerHeight;
	   	pannelH=pannelH-boxuser.outerHeight()-94;
	    panelshopcart.css({"max-height":pannelH+"px"})
    }
    
    
    /**
    	初始化商品分类列表
    	btn
    	pcategoryId		上级分类id
    	level			需要加载的分类级别,1...
    */
    vf.getCategoryList=function(btn,pcategoryId,level){
    	if(level == 4) return;
    	if(btn){
    		var isActive=btn.hasClass("active");
    		var btnChild=$("[pcategory_id='"+pcategoryId+"']");
    		
    		if(btnChild.length>0){
	    		if(isActive){ //需要隐藏对应下级
	    			btnChild.hide();
	    			btnChild.removeClass("active");
	    			
	    			btnChild.each(function(){
	    				var btn2=$(this);
	    				var pcategoryId2=btn2.attr("category_id");
			    		var btnChild2=$("[pcategory_id='"+pcategoryId2+"']");
		    			btnChild2.hide();
		    			btnChild2.removeClass("active");
	    			
	    			})
	    		}else{ //需要显示下级
	    			btnChild.show();
	    			btnChild2.show();
	    		}
	    		vf.resetBoxH();
	    		return;
    		}
    		
    	}
    	
    	if (g.a.send("processType=g_spd.base.Category&actionType=getCategoryNodeData", { categoryId: pcategoryId, viewKey: "category_def" }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbCategoryNodeData = cReturn.dtbCategoryNodeData;
                var btnBoxId="btns-level-"+level;
                var btnsBox=$("#"+btnBoxId);
                var leveltxt="一级分类",btnClass="";
                if(level == 2){
                	leveltxt="二级分类";
                	btnClass="btn-sm";
                } 
                if(level == 3){
                	leveltxt="三级分类";
                	btnClass="btn-mini";
                }
                
                if(dtbCategoryNodeData.rowCount>0 && btnsBox.length <1){
                	var levelHtml=[];
                	levelHtml.push('<div class="form-group box-nav">');
                	levelHtml.push('	<label class="col-xs-1 form-control-static">'+leveltxt);
                	levelHtml.push('	</label>');
                	levelHtml.push('	<div class="col-xs-11 ">');
                	levelHtml.push('		<div class="btn-group btn-nav"  id="'+btnBoxId+'"> </div> ');
                	levelHtml.push('	</div>');
                	levelHtml.push('</div>');
                	$("#box-toolbar-btn").append(levelHtml.join(''));
                	btnsBox=$("#btns-level-"+level);
                }
                
                //
                //btnsBox.html("");
                if(dtbCategoryNodeData.rowCount>0){
					var row,html=[];
					for(var i=0;i<dtbCategoryNodeData.rowCount;i++){
						row=dtbCategoryNodeData.rows[i];
						var btnattr=' level='+level+' node_key="'+row.node_key.value+'" category_id='+row.category_id.value+' plevel='+(level-1)+' pcategory_id='+pcategoryId;
						btnsBox.append('<button '+btnattr+'   data-toggle="button" type="button" class="btn btn-category '+btnClass+'" onclick="vf.getCategoryList($(this),'+row.category_id.value+','+(level+1)+');">'+row.category_name.value+'</button>');
					}
				}
				
				vf.resetBoxH();
            }
            else {
                return;
            }
        }
        else {
            return;
        }
    }
    
    //获取列表查询sql
    vf.getStockListFilter=function(){
    	var keyword=$.trim($("#keyword").val());
    	var filterSql=[];
    	
    	//关键字检索
    	var filterSqlLike=[];
    	if(keyword.length>0){
    		filterSqlLike.push(" material_name like '%"+keyword+"%' ")
    		filterSqlLike.push(" material_spec like '%"+keyword+"%' ")
    		filterSqlLike.push(" m.manufacturer_name like '%"+keyword+"%' ")
    		filterSqlLike.push(" sp_name like '%"+keyword+"%' ");
    	}
    	if(filterSqlLike.length >0) filterSql.push("  ("+filterSqlLike.join(" or ")+" )");
    	
    	
    	//品类筛选
    	filterSqlLike=[];
    	var boxnavid=$(".btn-category.active:last").closest(".box-nav").find(".btn-category.active").each(function(){
    		var node_key=$(this).attr("node_key");
    		filterSqlLike.push(" left(cat.node_key,len('"+node_key+"'))='"+node_key+"' ");
    	});
    	if(filterSqlLike.length >0) filterSql.push("  ("+filterSqlLike.join(" or ")+" )");
    	
    	if(filterSql.length>0) return "and ("+ filterSql.join(" and ")+")";
    	return "";
    	
    }
    //初始化商品列表
    vf.getStockList=function(pageload){
    	showWait();
	    setTimeout(function(){
	    	vf.getStockListExec(pageload);
	    	vf.resetBoxH();
	    	hideWait();
	    },timeoutload);
    }
    
    //初始化商品列表--执行查询
    vf.getStockListExec=function(pageload){
    	 var pageloadQ=1;
    	 
    	 if(myPager && myPager.state)  pageloadQ=myPager.state.page;
    	 if(pageloadQ<1) pageloadQ=1;
    	 
    	 if (g.a.send("processType=h_spd.dept.ThdApplyShopAux&actionType=getThdApplyInitData", {filterSql: vf.getStockListFilter(),pageload:pageloadQ,storageId:topWin.stationStorageId}, false)) {
			boxcards.html("");
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbStock = cReturn.dtbStock;
               	frm._cStorage_id_res.value=cReturn["storageIdRes"];
               	frm._cStorage_name_res.value=cReturn["storageNameRes"];
				
				var page=parseInt(cReturn["page"]);
				var recTotal=parseInt(cReturn["recTotal"]);
				var totalPage=parseInt(cReturn["totalPage"]);
				//分页
				var status={
					 page: page,  //当前页码；
				    recTotal: recTotal,  //记录总数；
				    recPerPage: 20,  //每页记录数目；
				    totalPage: totalPage  //总页数；
				};
				
				if(!myPager){
					$('#myPager').pager(status);
					myPager = $('#myPager').data('zui.pager');
				}else{
					// 设置当前页码为 4，并同时设置记录总数为 100， 每页记录数目为 30
					myPager.set(status);
				}
				
				var row,html=[],inpId="";
				if(dtbStock.rowCount>0){
					for(var i=0;i<dtbStock.rowCount;i++){
						row=dtbStock.rows[i];
						var filePath=row.filepath?row.filepath.value:null;
						
						if(filePath){
							filePath=g.httpServer+filePath;
						}else{
							filePath=g.httpServer+g.appPath+"res/images/empty.png";
						}
						html=[];
						inpId="inp_"+i;
						
						html.push('<div class="col-md-3 ">');
						html.push('		<a class="card " href="###"  material_id='+row.material_id.value+'>');
						html.push('		 	<img  title="点击预览图片"   onclick="showImage(\''+filePath+'\')"  style="height: 200px;    margin: auto auto;" class="img-rounded img-thumbnail" src="'+filePath+'"  > ');
						//html.push('		 	<div class="caption">'+row.material_name.value+'</div> ');
						
						
						var material_spec=row.material_spec.value;
						if(material_spec.length<1){
							material_spec=row.material_unit.value;
						}else{
							material_spec+='/'+row.material_unit.value;
						} 
						//html.push('		 	<div class="card-heading" style="font-size: 18px;font-weight: bold;">'+row.material_name.value+'</div> ');
						html.push('		 	<div class="card-content text-muted form-horizontal form-condensed"> ');
						
						
						html.push('		 		 <div class="row  with-padding" onclick="showImage(\''+filePath+'\')" > ');
						html.push('					<div class="col-xs-6">');
						html.push('						<input type="text" class="form-control static-text " style="font-size: 18px;color: red;" value="￥'+row.price_sp.value+'"  readonly="readonly"> ');
						html.push('					</div>');
						html.push('					<div class="col-xs-6 text-right">本月已领:20盒');
						html.push('					</div>');
						html.push('				 </div>');
						html.push('		 		 <div class="row  with-padding" onclick="showImage(\''+filePath+'\')" > ');
						html.push('					<div class="col-xs-12" >');
						html.push('						<input type="text" style="font-size: 18px;" class="form-control static-text "   value="'+row.material_name.value+'"  readonly="readonly"> ');
						html.push('					</div>');
						html.push('				 </div>');
						
						
						html.push('		 		 <div class="row" onclick="showImage(\''+filePath+'\')" > ');
						html.push('					<div class="col-xs-12 help-block" style="    padding-left: 44px;">【'+material_spec+'】');
						html.push('					</div>');
						html.push('				 </div>');
						html.push('		 		 <div class="row with-padding" onclick="showImage(\''+filePath+'\')" > ');
						html.push('					<div class="col-xs-12" >');
						html.push('						<div class="input-control has-icon-left">');
						html.push('							<input  style="font-size:18px;"   type="text" class="form-control static-text"  value="'+row.manufacturer_name.value+'">');
						html.push('							<label   class="input-control-icon-left"><i class="icon icon-bars " style="font-size:18px;"></i></label>');
						html.push('						</div>');
						
						html.push('					</div>');
						html.push('				 </div>');
						
						//html.push('		 		 <div class="row" onclick="showImage(\''+filePath+'\')" > ');
						//html.push('					<label  class="col-xs-3">单位</label>');
						//html.push('					<div class="col-xs-3">');
						//html.push('						<input type="text" class="form-control static-text " value="'+row.material_unit.value+'"  readonly="readonly"> ');
						//html.push('					</div>');
						//html.push('					<label  class="col-xs-3">单价</label>');
						//html.push('					<div class="col-xs-3">');
						//html.push('						<input type="text" class="form-control static-text " value="'+row.price_sp.value+'"  readonly="readonly"> ');
						//html.push('					</div>');
						//html.push('				</div>');
						
						//html.push('		 		 <div class="row" onclick="showImage(\''+filePath+'\')" > ');
						//html.push('					<label  class="col-xs-3">包装信息</label>');
						//html.push('					<div class="col-xs-3">');
						//html.push('						<input type="text" class="form-control static-text " value="'+row.material_package1_unit.value+'"  readonly="readonly"> ');
						//html.push('					</div>');
						//html.push('					<label  class="col-xs-3">库存</label>');
						//html.push('					<div class="col-xs-3">');
						//html.push('						<input type="text" class="form-control static-text " value="'+row.qty_stock.value+'"  readonly="readonly"> ');
						//html.push('					</div>');
						//html.push('				</div>');
						
						//html.push('		 		 <div class="row" onclick="showImage(\''+filePath+'\')" > ');
						//html.push('					<label  class="col-xs-3">供货单位</label>');
						//html.push('					<div class="col-xs-9">');
						//html.push('						<input type="text" class="form-control static-text " value="'+row.sp_name.value+'"  readonly="readonly"> ');
						//html.push('					</div>');
						//html.push('				</div>');
						
						//html.push('		 		 <div class="row" onclick="showImage(\''+filePath+'\')" > ');
						//html.push('					<label  class="col-xs-3">生产厂家</label>');
						//html.push('					<div class="col-xs-9">');
						//html.push('						<input type="text" class="form-control static-text " value="'+row.manufacturer_name.value+'"  readonly="readonly"> ');
						//html.push('					</div>');
						//html.push('				</div>');
						
						html.push('		 		 <div class="row"> ');
						html.push('					<div class="col-xs-8 pull-right">');
						html.push('						<div class="input-group ">');
						html.push('							<span class="input-group-addon" style="cursor: text !important;">申请数量</span>');
						html.push('							<input type="text" style="cursor: text !important;"  onkeyup="if(event.keyCode==13) vf.addDtl('+row.material_id.value+',\''+inpId+'\','+row.qty_stock.value+');"  class="form-control" placeholder="" value="1" id="'+inpId+'">');
						html.push('							<span class="input-group-btn"> <button class="btn btn-primary btn-sm" type="button" onclick="vf.addDtl('+row.material_id.value+',\''+inpId+'\','+row.qty_stock.value+')">立刻申请</button> </span>');
						html.push('						</div>');
						html.push('					</div>');
						html.push('				</div>');
						
						
						html.push('			</div>');
						html.push('		 </a>');
						html.push('</div>');
						
						boxcards.append(html.join(""));
					}
				}else{
					html=[];
					html.push('<div class="col-md-12 ">');
					html.push('		<div class="alert  with-icon">');
					html.push('			 <i class="icon-frown"></i>');
					html.push('			<div class="content"><strong>哎呀</strong> 没查到相关数据。</div> ');
					html.push('		</div>');
					html.push('</div>');
					boxcards.append(html.join(""));
				}
				
            } else {
            	var html=[];
				html.push('<div class="col-md-12 ">');
				html.push('		<div class="alert  with-icon">');
				html.push('			 <i class="icon-frown"></i>');
				html.push('			<div class="content"><strong>哎呀</strong> 没查到相关数据。</div> ');
				html.push('		</div>');
				html.push('</div>');
				boxcards.append(html.join(""));
				//分页
				var status={
					 page: 0,  //当前页码；
				    recTotal: 0,  //记录总数；
				    recPerPage: 20,  //每页记录数目；
				    totalPage: 0  //总页数；
				};
				
				$('#myPager').pager(status);
				myPager = $('#myPager').data('zui.pager');
				
				zuiExt.msg({msg:"数据加载失败，原因:"+g.a.ErrMessage,type:"danger"});
                return false;
            }
        } else {
            return false;
        }
    }
    
    
    //选择库存地
    vf.selectStationStorage=function(){
    	 jsoStorage.selectStorage({}, { selectPhysicalStorage: true, selectFilter: "storage_id != 0 AND storage_device_type_id IN (0,1)", callback: function(para) {
	        var drRow = para.node.drRow;
	
			var storageId = drRow["storage_id"].value;
			var storageName = drRow["storage_name"].value;
			var nodeKey = drRow["node_key"].value;
			
			var isChangeStorage=topWin.stationStorageId == storageId;
			topWin.stationStorageId = storageId;
			topWin.stationStorageName = storageName;
			topWin.stationStorageNodeKey = nodeKey;
	
			gId("_xStationStorage").value = topWin.stationStorageName;
	
			setLocalItem("stationStorageId", storageId);
			setLocalItem("stationStorageName", storageName);
			setLocalItem("stationStorageNodeKey", nodeKey);
			
			initStation();
			
			//
			if(!isChangeStorage){
				alert("您已切换工位，即将刷新浏览器");
				topWin.win.location.reload();
			}
			
		} });
    }
    
    
    //添加明细，如果主表不存在，则后台会先添加子表
    vf.addDtl=function(materialId,inpId,qtyStock,e) {
		var param={};
		var qtyInp=$("#"+inpId),qty=parseInt($.trim(qtyInp.val()));
		qtyStock=parseInt(qtyStock);
		if(isNaN(qty)){
			zuiExt.tip({id:qtyInp.attr("id"),title:"申请数量为大于0的整数",autoFocus:true});
			return;
		}
		if(qty <=0){
			zuiExt.tip({id:qtyInp.attr("id"),title:"申请数量应该大于1",autoFocus:true});
			return;
		}
		if(qty > qtyStock){
			zuiExt.tip({id:qtyInp.attr("id"),title:"申请数量应该小于可用库存"+qtyStock,autoFocus:true});
			return;
		}
		
		param.applyId=frm._cAPPLY_ID.value.toInt();
		param.matrId=materialId;
		param.qty=qty;
		param.rate=1;
		param.storageIdRes=frm._cStorage_id_res.value;
		param.storage_name_res=frm._cStorage_name_res.value;
		param.allowApplyZeroStock=0;
		param.userKey=topWin.userKey;
		param.userName=topWin.userName;
		param.dept_id=topWin.stationDeptId;
		param.dept_name=topWin.stationDeptName;
		param.storage_id_dept=topWin.stationStorageId;
		param.storage_name_dept=topWin.stationStorageName;
        if (g.a.send("processType=h_spd.dept.ThdApplyShopAux&actionType=addApplyDtl", param, false)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                frm._cAPPLY_ID.value=cReturn.applyId;
                zuiExt.msg({msg:"添加成功",type:"success",time:10000000});
                vf.loadShopCart();
                vf.getStockList();
            } else {
            	vf.errorAfter(g.a.cReturn);
                return false;
            }
        } else {
            return false;
        }
    }
    
    
    
    //加载购物车
    vf.loadShopCart=function(){
    	 var param={applyId:frm._cAPPLY_ID.value.toInt()};
    	 if (g.a.send("processType=h_spd.dept.ThdApplyShopAux&actionType=getApplyDtls", param, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var rsdtls = cReturn.rsdtls;
				frm._cAPPLY_ID.value=cReturn.applyId;
				if(rsdtls.rowCount>0){
					var row,tdHtml="";
					boxshopCart.html('');
					for(var i=0;i<rsdtls.rowCount;i++){
						row=rsdtls.rows[i];
						tdHtml="<tr>";
						tdHtml+='	<td>'+row.matr_name.value+'</td>';
						tdHtml+='	<td>'+row.qty.value+'</td>';
						tdHtml+='	<td class="text-center"><button class="btn btn-sm btn-danger" type="button" onclick="vf.deleteDtl('+row.apply_id.value+','+row.apply_dtl_id.value+','+row.stock_id.value+')">删除</button></td>';
						tdHtml+='</tr>';
						boxshopCart.append(tdHtml);
					}
					btnSubmit.show();
				}else{
					boxshopCart.html('<tr>  <td colspan="3" class="text-center">暂无数据</td>  </tr>');
					btnSubmit.hide();
				}
				zuiExt.msg({msg:"购物车刷新成功",type:"success"});
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
    
    
    //删除明细 
    vf.deleteDtl=function(apply_id,apply_dtl_id,stock_id) {
		var param={};
		
		param.apply_id=apply_id;
		param.apply_dtl_id=apply_dtl_id;
		param.stock_id=stock_id;
        if (g.a.send("processType=h_spd.dept.ThdApplyShopAux&actionType=deleteApplyDtl", param, false)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                zuiExt.msg({msg:"删除成功",type:"success"});
                vf.loadShopCart();
                vf.getStockList();
            } else {
                vf.errorAfter(g.a.cReturn);
                return false;
            }
        } else {
            return false;
        }
    }
    
    //打开申请列表
    vf.openApplyList=function() {
		 topWin.openMenu({ menuKey: "PG1010001001" });
    }
    
    //提交
    vf.submit=function() {
    	var param={};
		param.apply_id=frm._cAPPLY_ID.value;
		param.userKey=topWin.userKey;
        if (g.a.send("processType=h_spd.dept.ThdApplyShopAux&actionType=applyAudit", param, false)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                zuiExt.msg({msg:"提交成功",type:"success"});
                frm._cAPPLY_ID.value=0;
                vf.loadShopCart();
            } else {
               vf.errorAfter(g.a.cReturn);
                return false;
            }
        } else {
            return false;
        }
    }
    
     
    //操作失败后执行某种动作
    vf.errorAfter=function(ret) {
    	frm._cAPPLY_ID.value=0;
    	zuiExt.msg({msg:ret.ErrMessage,type:"danger"});
    	if(ret.code == -1){ //已被处理
    		 vf.loadShopCart();
    	}else if(ret.code == -99){//已被删除
    		vf.loadShopCart();
    	}
    }
    
    
</script>
 