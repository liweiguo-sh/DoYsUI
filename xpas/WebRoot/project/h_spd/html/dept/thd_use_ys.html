<!DOCTYPE html>
<html>
<head>
    <title>科室手工消耗单(YS)</title>
	<script src="../../../../res/jscript/xwf.js"></script>
	<script src="../../../../res/jscript/xwf.ajax.js"></script>	
	<script src="../../../../res/jscript/xwf.const.js"></script> 
		
	<script src="../../../../res/control/grid/xwf.grid.js"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js"></script>
	
	<script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js"></script>
	<script src="../../../../res/jscript/web_print.js"></script>
    <style type="text/css">
        body {
            overflow: hidden;
        }

        #txtScan {
             font-size: 1em;
            font-family: Arial;
            height: 26px;
            line-height: 24px;
            border: 2px solid #19A2D5;
        }
    </style>
</head>
<body>
	<div id="divDC"></div>
	<form id="frm" target="h_spd.dept.VIEW_thdUse">
        <div class="PanelA">
		    <table id="tbForm1" class="tbForm" style="width:1080px;">
			    <tr class="trH">
				    <th style="width:12%;"></th>
				    <th style="width:23%;"></th>
				    <th style="width:12%;"></th>
				    <th style="width:18%;"></th>
                    <th style="width:12%;"></th>
				    <th style="width:18%;"></th>
			    </tr>
			    <tr>				
				    <td>单号</td>
				    <td><input type="text" id="_cUse_key" value="" disabled="disabled" /></td>
				    <td>日期</td>
				    <td><input type="text" id="_cUse_Date" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})" /></td>
                    <td>金额</td>
                    <td><input type="text" id="_cAmount" value="" disabled="disabled" /></td>
			    </tr>
                <tr>				
				    <td>科室</td>
				    <td><input type="text" id="_cDept_name" value="" disabled="disabled" /></td>
				    <td>库存地</td>
				    <td><input type="text" id="_cStorage_name" value="" disabled="disabled" /></td>
				    <td>备注</td>
                    <td><input type="text" id="_cRemark" /></td>
			    </tr>
		    </table>
        </div>
        <div id="divPatient" class="PanelA" style="margin-top:10px;margin-bottom:5px;display:none;">
		    <table id="tbForm2" class="tbForm" style="width:1080px;">
			    <tr class="trH">
				    <th style="width:12%;"></th>
				    <th style="width:23%;"></th>
				    <th style="width:12%;"></th>
				    <th style="width:18%;"></th>
                    <th style="width:12%;"></th>
				    <th style="width:18%;"></th>
			    </tr>
			    <tr>
			    	<td>住院号</td>
				    <td class="combo">
				    	<input type="text" id="_cPatient_in_no" onkeydown="enterPress(event)"/><div id="btnSelectPatient" class="fa fa-search" onclick="btnSelectPatient_click();"></div>
				    </td>
				    <td>患者姓名</td>
				    <td><input type="text" id="_cPatient_name" value="" /></td>
				    <td>性别</td>
                    <td><input id="_cPatient_gender" type="text" controlType="dropdown" fieldValue="b" fieldText="a" dataSource="[['a','b'],['',''],['男','男'],['女','女']]" visibleSearch="false" /></td>
			    </tr>
                <tr>
                	<td>年龄</td>
                    <td><input type="text" id="_cPatient_age" value="" /></td>
				    <td>门诊号</td>
				    <td><input type="text" id="_cPatient_out_no" value="" /></td>
				    <td>床位号</td>
                    <td><input type="text" id="_cPatient_bed" value="" /></td>
			    </tr>
			    <tr>
                	<td>RFID</td>
                	<td><input type = "text" id = "rfid" placeholder="RFID扫码区"></td>
			    </tr>
                <tr>
				    <td>手术单号</td>
                    <td class="combo">
                        <input type="text" id="_cOprt_code" onkeydown="enterPress(event)"/><div id="btnSelectOprt" class="fa fa-search" onclick="btnSelectOprt_click();"></div>
                    </td>
                    <td>手术日期</td>
                    <td><input type="text" id="_cOprt_date" class="Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" /></td>
				    <td>手术医生</td>
				    <td><input type="text" id="_cOprt_doctor" value="" /></td>				    
			    </tr>
               <!--  <tr>
                    <td>手术名称</td>
                    <td colspan="1"><input type="text" id="_cOprt_name" value="" /></td>
                </tr> -->
                <tr>
                	<td></td>
                    <td id="tdScan"><input type="text" id="txtScan" placeholder="RFID扫码确认，添加明细区" disabled="disabled"/></td>
                </tr>
		    </table>
        </div>
		<input id="_cUSE_ID" type="hidden" value="" />

        <input id="_cDEPT_ID" type="hidden" value="" />
        <input id="_cSTORAGE_ID" type="hidden" value="" />
        <input id="_cOPRT_ID" type="hidden" value="" />

        <input id="_cRef_type" type="hidden" value="" />
	</form>
    <div id="divGrid" style="height:300px;"></div> 
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var showPatientInfo = (urlPara["showPatientInfo"] ? true : false);
    var astatusNav = -1;

    var txtScan = gId("txtScan");
    var divGrid = gId("divGrid");

    var nodeNav = null;
    var gridview = null;
    var winOprt = null;
    var winPatient = null;
    // ------------------------------------------------------------------------
    function formLoad() {
        if (win.parentWindow && win.parentWindow.gridView.tree) {
            nodeNav = win.parentWindow.gridView.tree.selectedNode;
            astatusNav = (nodeNav.level > 1 ? nodeNav.value : 0);
        }

        gId("divPatient").style.display = (showPatientInfo ? "" : "none");
        vf.css(gId("tbForm1"));
        vf.css(gId("tbForm2"));
        txtScan.style.width = (gId("tdScan").clientWidth - 24) + "px";
        txtScan.style.height = "30px";
        g.x.bindEnterEvent(txtScan, onTxtScanEnter);

        initGridview();
        
        vf.addExtraButton({ key: "printuse", text: "打印消耗单" });
        vf.addExtraButton({ key: "printusewi", text: "打印消耗入库单" });
        gId("_cPatient_in_no").focus();  
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
	vf.afterAddnew = function () {
        frm._cUse_Date.value = (new Date).toString();
        frm._cAmount.value = "0";
        frm._cRef_type.value = "MANUAL";

        txtScan.value = "";
        txtScan.focus();
	}

    vf.afterMove = function () {
        var useId = frm._cUSE_ID.value.toInt();
        var astatus = vf.getStatus();

        if (astatus != 0 && astatus != 2) {
            txtScan.style.display = "none";
        }
        else {
            txtScan.style.display = "";
        }

        gridview.setViewFilter("use_id = " + useId);
    }
    
    vf.beforeClick = function (prop) {
    	if (prop.buttonKey.equals("printuse")) {
        	var param={};
			param.data=gridview.dtbViewData.rows;
			param.printsettype="printset_usesql";
			WebPrint.goPrintFormModelBySet(param);
			//return;
			
        }
        if (prop.buttonKey.equals("printusewi")) {
			var paramPrint={}; 
			paramPrint.dataSql="select convert(varchar(10),wi_date,120)wi_date,wi_key,material_name,material_spec from THD_USE_DTL a left join T_STOCK b on a.stock_id = b.stock_id left join T_WI c on b.wi_id = c.wi_id  where use_id = "+gId("_cUSE_ID").value+"";
			paramPrint.printsettype="printset_usewisql";
			WebPrint.goPrintFormModelBySet(paramPrint); 
        }
    }
</script>
<!-- gridview -->
<script type="text/javascript">
    function initGridview() {
        var allowDelete = (astatusNav == 0 || astatusNav == 2);
        var prop = {
            divContainer: divGrid,
            viewKey: "thd_use_dtl",
            viewFilter: "1 = 0",
            allowDelete: allowDelete,
            beforeDelete: gridBeforeDelete,
            afterDelete: gridAfterDelete
        };
        gridview = new window.xwf_gridview(prop);
    }
    function gridBeforeDelete() {
        var astatus = vf.getStatus();
        if (astatus != 0 && astatus != 2) {
            showWarn("当前单据状态下不允许删除明细记录，请检查。");
            return false;
        }
        return true;
    }
    function gridAfterDelete() {
        vf.refreshRecord();
    }
</script>

<!-- txtScan -->
<script type="text/javascript">
    function onTxtScanEnter() {
        var rfid = txtScan.value.trim();

        if (rfid.equals("")) return;
        if (gridview.dtbViewData.rowCount == 0) {
            queryRfid(rfid);
            return;
        }

        addRfidToDtl();
    }

    function queryRfid(rfid) {
        if (g.a.send("processType=h_spd.dept.VIEW_thdUse&actionType=queryRfid", { viewKey: "thd_use", rfid: rfid }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                
                frm._cDEPT_ID.value = cReturn.deptId;
                frm._cDept_name.value = cReturn.deptName;
                frm._cSTORAGE_ID.value = cReturn.storageId;
                frm._cStorage_name.value = cReturn.storageName;

                if (vf.save()) {
                    txtScan.value = rfid;
                    addRfidToDtl();
                }
                else {
                    txtScan.select();
                    txtScan.focus();
                }
            }
            else {
                txtScan.select();
                txtScan.focus();
                return false;
            }
        }
        else {
            return false;
        }
    }
    function addRfidToDtl() {
        var rfid = txtScan.value.trim();
        var useId = frm._cUSE_ID.value.toInt();
        var storageId = frm._cSTORAGE_ID.value.toInt();
        //var operName = frm._cOprt_name.value.trim();

        // ------------------------------------------------
        if (g.a.send("processType=h_spd.dept.VIEW_thdUse&actionType=addUseDtlByScan", { viewKey: "thd_use", useId: useId, storageId: storageId, rfid: rfid }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                gridview.refresh();

                txtScan.value = "";
                txtScan.focus();
            }
            else {
                txtScan.select();
                txtScan.focus();
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>
<!-- select oprt -->
<script>  
    function btnSelectOprt_click() {
     	 var rfid = gId("rfid").value.trim();
    	 var viewFilter = null;
    	 if (g.a.send("processType=h_spd.dept.VIEW_thdUse&actionType=checkProj", { viewKey: "thd_use", rfid: rfid }, true)) {
            if (g.a.OK) {
            		var cReturn = g.a.cReturn;
            		var names = cReturn.names;
            		viewFilter = "patient_no ='"+_cPatient_in_no.value+"' and oprt_name in ('"+names+"')";
            	}
            }
       // viewFilter = "patient_no ='"+_cPatient_in_no.value+"'", onceFilter = "";
        onceFilter = "";
        console.log(viewFilter);
        // ------------------------------------------------

        if (winOprt == null) {
            var prop = {
                title: "请选择手术...",
                width: 0.7,
                height: 0.75,
                parent: win,
                closeMode: "hide"
            };
            var para = {
                viewKey: "oprt_for_use",
                viewFilter: viewFilter,
                onceFilter: onceFilter,
                viewMode: "singleSelect",
                selectCallback: onOprtSelect
            };
            winOprt = topWin.openSelectView(prop, para);
        }
        else {
            winOprt.show();
        }
    }
    function onOprtSelect(dataRow) {
        frm._cOPRT_ID.value = dataRow["oprt_id"].value;
        frm._cOprt_code.value = dataRow["oprt_code"].value;
        frm._cOprt_date.value = dataRow["oprt_date"].value.substring(0,10);
        //frm._cOprt_name.value = dataRow["oprt_name"].value;
        frm._cOprt_doctor.value = dataRow["doctor_name"].value;
        txtScan.disabled = false;
        return true;
    }
</script>
<script>
	function btnSelectPatient_click() {
        var viewFilter = "", onceFilter = "";
        // ------------------------------------------------
        if (winPatient == null) {
            var prop = {
                title: "请选择患者...",
                width: 0.7,
                height: 0.75,
                parent: win,
                closeMode: "hide"
            };
            var para = {
                viewKey: "patientinfo",
                viewFilter: viewFilter,
                onceFilter: onceFilter,
                viewMode: "singleSelect",
                selectCallback: onPatientSelect
            };
            winPatient = topWin.openSelectView(prop, para);
        }
        else {
            winPatient.show();
        }
    }  
        function onPatientSelect(dataRow) {
        	frm._cPatient_name.value = dataRow["patient_name"].value;
        	frm._cPatient_gender.setValue(dataRow["patient_gender"].value);
        	frm._cPatient_age.value = dataRow["patient_age"].value;
        	frm._cPatient_in_no.value = dataRow["inpatient_no"].value;    
        	gId("rfid").focus();  
        	return true;
    	}
</script>