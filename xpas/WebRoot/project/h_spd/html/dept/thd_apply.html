<!DOCTYPE html>
<html>
<head>
    <title>科室请领单</title>
    <script src="../../../../res/jscript/xwf.js"></script>
    <script src="../../../../res/jscript/xwf.ajax.js"></script>
    <script src="../../../../res/jscript/xwf.const.js"></script>

    <script src="../../../../res/control/grid/xwf.grid.js"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js"></script>

    <script src="../../../../res/jscript/xwf.css.js"></script>
    <script src="../../../../res/jscript/web_print.js"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }
        
        .tbLayout {
            --table-layout: fixed;
            border-collapse: collapse;
        }
        
        .tdLayout {
            padding: 0px;
            overflow: hidden;
            vertical-align: top;
        }
        
        .divTip {
            font-size: 14pt;
            padding: 8px 0px 8px 5px;
            background-color: #d0d0d0;
            width: 486px;
            margin-bottom: 8px;
            border-radius: 4px 4px 0px 0px;
        }
        
        .btnCommand {
            border: 0px;
            height: 36px;
            background-color: #3280FA;
            color: white;
            border-radius: 4px;
        }
        
        .btnCommand:hover {
            color: yellow;
        }
        
        .btnCommand:disabled {
            color: gray;
        }
        
        .cellZeroStock {
            color: red;
        }
    </style>
</head>
<body>
    <div id="divDC"></div>
    <table class="tbLayout">
        <tr>
            <td id="tdLayoutLeft" class="tdLayout">
                <div id="divBillTitle" class="divTip">请领单信息</div>
                <form id="frm" action="" target="h_spd.dept.VIEW_thdApply">
                    <table id="tbForm" class="tbForm" style="width:500px;">
                        <tr class="trH">
                            <th style="width:20%;"></th>
                            <th style="width:30%;"></th>
                            <th style="width:20%;"></th>
                            <th style="width:30%;"></th>
                        </tr>
                        <tr>
                            <td>请领单号</td>
                            <td colspan="3"><input type="text" id="_cApply_key" value="" disabled="disabled" /></td>
                        </tr>
                        <tr>
                            <td>请领人</td>
                            <td><input type="text" id="_cApply_username" value="" disabled="disabled" /></td>
                            <td>请领日期</td>
                            <td><input type="text" id="_cApply_date" disabled="disabled" /></td>
                        </tr>
                        <tr>
                            <td>请领科室</td>
                            <td><input type="text" id="_cDept_name" value="" disabled="disabled" /></td>
                            <td>科室库存地</td>
                            <td><input type="text" id="_cStorage_name_dept" disabled="disabled" /></td>
                        </tr>
                        <tr>
                            <td>金额</td>
                            <td><input type="text" id="_cAmount" value="" disabled="disabled" /></td>
                            <td>请领仓库</td>
                            <td><input type="text" id="_cStorage_name_res" value="" disabled="disabled" /></td>
                        </tr>
                        <tr>
                            <td>备注</td>
                            <td colspan="3"><textarea id="_cRemark" rows="3" cols="0"></textarea></td>
                        </tr>
                    </table>
                    <input id="_cAPPLY_ID" type="hidden" value="" />
                    <input id="_cAStatus" type="hidden" value="" />

                    <input id="_cDept_id" type="hidden" value="" />
                    <input id="_cStorage_id_dept" type="hidden" value="" />
                    <input id="_cStorage_id_res" type="hidden" value="" />
                </form>

                <div id="divMatrTitle" class="divTip" style="margin-top:20px;">商品信息</div>
                <table id="tbForm2" class="tbForm" style="width:500px;">
                    <tr class="trH">
                        <th style="width:20%;"></th>
                        <th style="width:30%;"></th>
                        <th style="width:20%;"></th>
                        <th style="width:30%;"></th>
                    </tr>
                    <tr>
                        <td>品名</td>
                        <td colspan="3"><input id="_fMatr_name" type="text" disabled="disabled" controlType="dropdown" fieldValue="material_id" fieldText="material_name" fieldsVisible="material_name, material_spec, qty_stock, price_sp, manufacturer_name, sp_name" fieldsSearch="material_name, material_name_py, material_spec, manufacturer_name, sp_name"
                                widthPanel="1000" thNames="序号, 品名, 品规, 库存, 价格, 厂商, 供应商" thWidths="40px,200px,150px,60px,60px,100px,100px" /></td>
                    </tr>
                    <tr>
                        <td>品规</td>
                        <td colspan="3"><input type="text" id="_fMatr_spec" disabled="disabled" /></td>
                    </tr>
                    <tr>
                        <td>包装单位</td>
                        <td><input type="text" id="_fPackage_unit" /></td>
                        <td>申请数量</td>
                        <td><input type="text" id="_fPackage_qty" value="" onblur="_fPackage_qty_onblur();" /></td>
                    </tr>
                    <tr>
                        <td>单价</td>
                        <td><input type="text" id="_fMatr_price" disabled="disabled" /></td>
                        <td>数量</td>
                        <td><input type="text" id="_fMatr_qty" disabled="disabled" /></td>
                    </tr>
                    <tr id="trRemarkDtl">
                        <td>备注</td>
                        <td colspan="3"><textarea id="_fRemark" rows="2" cols="0"></textarea></td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <input type="button" id="btnFromTemplet" class="btnCommand" onclick="btnFromTemplet_click();" value="选择模板批量申请" />
                        </td>
                        <td colspan="2">
                            <input type="button" id="btnAddDtl" class="btnCommand" onclick="btnAddDtl_click();" value="添加到明细" />
                        </td>
                    </tr>
                </table>
                <div id="tbForm3" class="divTip" style="margin-top:5px;">限额信息</div>
                <div id="info" style="font-size:18px;color:green">
                    <span>限额：</span><span id="limit">0</span>&nbsp&nbsp&nbsp&nbsp&nbsp&nbsp
                    <span>耗材消耗总额：</span><span id="cost">0</span>
                </div>
            </td>
            <td id="tdLayoutRight" class="tdLayout">
                <div class="PanelA">
                    <div id="divGrid"></div>
                </div>
            </td>
        </tr>
    </table>
</body>
</html>

<!-- formLoad -->
<script>
    var astatusNav = 0;
    var applyType = urlPara["apply_type"].toInt();
    var storageIdRes = 0;

    var viewKey = "thd_apply";
    var viewKeyDtl = "thd_apply_dtl";
    var storageNameRes = "";
    var allowApplyZeroStock = false;

    var txtMatr = gId("_fMatr_name");
    var txtPackageQty = gId("_fPackage_qty");
    var divGrid = gId("divGrid");

    var nodeNav = null;
    var gridview = null;
    var dataRowStock = null, dataRowUnit = null; // -- 当前选中的库存明细记录行，当前选中的包装记录行 --
    // ------------------------------------------------------------------------
    function formLoad() {
        nodeNav = win.parentWindow.gridView.tree.selectedNode;
        astatusNav = (nodeNav.level > 1 ? nodeNav.value : 0);

        formResize();
        vf.css(gId("tbForm"));
        vf.css(gId("tbForm2"));
        vf.addExtraButton({
            key: "printIO",
            text: "打印请领单"
        });

        initData();
        initGridView();
        initDeptKpi();

        g.x.bindEnterEvent(txtPackageQty, function() {
            btnAddDtl_click();
        });
    }

    function formResize() {
        var widthRight = 0;

        if (screen.width <= 1366) {
            gId("divBillTitle").style.display = "none";
            gId("divMatrTitle").style.display = "none";
            //gId("trRemarkDtl").style.display = "none";

            gId("tbForm").style.width = "400px";
            gId("tbForm2").style.width = "400px";
        }

        widthRight = win.p.width - gId("tbForm").offsetWidth - 30;

        divGrid.style.width = widthRight + "px";
        divGrid.style.height = (win.p.height - 80) + "px";
    }
</script>
<!-- 初始化 -->
<script>
    function initData() {
        var allowAddDtl = (astatusNav == 0 || astatusNav == 2);

        if (!allowAddDtl) {
            gId("tdLayoutLeft").disabled = "disabled";
            gId("btnFromTemplet").disabled = "disabled";
            gId("btnAddDtl").disabled = "disabled";
            gId("btnFromTemplet").disabled = "disabled";
            return;
        }
        if (g.a.send("processType=h_spd.dept.ThdApplyAux&actionType=getThdApplyInitData", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbStock = cReturn.dtbStock;

                storageIdRes = cReturn["storageIdRes"];
                storageNameRes = cReturn["storageNameRes"];
                allowApplyZeroStock = (cReturn["allowApplyZeroStock"] == 1);

                if (topWin.serverName == 'SPD_BJTT') {
                    var jsonProp = {
                        txtHost: txtMatr,
                        dtbSource: dtbStock,
                        visibleSN: true,
                        rowClick: onRowClick_stock,
                        pageMaxRows: (topWin.win.innerHeight < 1000 ? 4 : 10)
                    };
                } else {
                    var jsonProp = {
                        txtHost: txtMatr,
                        dtbSource: dtbStock,
                        visibleSN: true,
                        rowClick: onRowClick_stock,
                        pageMaxRows: (screen.height <= 800 ? 8 : 10)
                    };
                }
                txtMatr.dropdown = new window.xwf_dropdown(jsonProp);
            } else {
                return false;
            }
        } else {
            return false;
        }
    }

    function onRowClick_stock(para) {
        dataRowStock = para.dataRow;
        var materialUnit = dataRowStock["material_unit"].value;

        gId("_fMatr_price").value = dataRowStock["price_sp"].value;
        gId("_fMatr_spec").value = dataRowStock["material_spec"].value;
        txtPackageQty.focus();

        var pkgUnitX = "";
        var pkgQtyX = 0;

        var dtbSource = new window.xwf_datatable();
        dtbSource.addColumn({
            name: "package",
            dataType: "varchar",
            columnType: "string"
        });
        dtbSource.addColumn({
            name: "unit",
            dataType: "varchar",
            columnType: "string"
        });
        dtbSource.addColumn({
            name: "rate",
            dataType: "int",
            columnType: "number"
        });

        for (var i = 3; i > 0; i--) {
            pkgUnitX = dataRowStock["material_package" + i + "_unit"].value;
            pkgQtyX = dataRowStock["material_package" + i + "_qty"].value;
            if (!pkgUnitX.equals("") && pkgQtyX > 0) {
                dtbSource.addRow();
                dtbSource.rows[dtbSource.rowCount - 1]["package"].value = pkgUnitX + "（" + pkgQtyX + " " + materialUnit + "）";
                dtbSource.rows[dtbSource.rowCount - 1]["unit"].value = pkgUnitX;
                dtbSource.rows[dtbSource.rowCount - 1]["rate"].value = pkgQtyX;
            }
        }
        dtbSource.addRow();
        dtbSource.rows[dtbSource.rowCount - 1]["package"].value = materialUnit;
        dtbSource.rows[dtbSource.rowCount - 1]["unit"].value = materialUnit;
        dtbSource.rows[dtbSource.rowCount - 1]["rate"].value = 1;

        var jsonProp = {
            txtHost: gId("_fPackage_unit"),
            dtbSource: dtbSource,
            visibleSN: false,
            fieldValue: "unit",
            fieldText: "package",
            fieldsVisible: "package",
            pageMaxRows: 5,
            rowClick: function(para) {
                if (gId("_fPackage_qty").value.toInt() > 0) {
                    return calQty();
                }
                return true;
            }
        };
        gId("_fPackage_unit").dropdown = new window.xwf_dropdown(jsonProp);
        if (dataRowStock["material_replenish_unit"].value) {
            gId("_fPackage_unit").setValue(dataRowStock["material_replenish_unit"].value);
        } else {
            gId("_fPackage_unit").setValue(dtbSource.rows[0]["unit"].value);
        }
        return true;
    }

    function _fPackage_qty_onblur() {
        calQty();
    }
</script>

<!-- vf.events -->
<script>
    vf.afterAddnew = function() {
        frm._cAStatus.value = "0";
        frm._cApply_username.value = topWin.userName;
        frm._cApply_date.value = (new Date).toString();

        frm._cDept_name.value = topWin.stationDeptName;
        frm._cDept_id.value = topWin.stationDeptId;
        frm._cStorage_id_dept.value = topWin.stationStorageId;
        frm._cStorage_name_dept.value = topWin.stationStorageName;

        frm._cStorage_id_res.value = storageIdRes;
        frm._cStorage_name_res.value = storageNameRes;
    }

    vf.afterMove = function() {
        var applyId = frm._cAPPLY_ID.value.toInt();
        gridview.setViewFilter("apply_id = " + applyId);
    }

    vf.beforeFlowClick = function(para) {
        if (gridview.dtbViewData.rowCount == 0) {
            showWarn("请先录入请领明细。");
            return false;
        }

        if (parseFloat(gId("cost").value) > parseFloat(gId("limit").value)) {
            showWarn("已超过当月限额");
            return false;
        }
        return true;
    }
    vf.beforeClick = function(para) {
        var btnKey = para.buttonKey;

        printBill(btnKey);
    }
</script>
<!-- gridview -->
<script>
    function initGridView() {
        var allowDelete = (astatusNav == 0 || astatusNav == 2);
        var prop = {
            divContainer: divGrid,
            viewKey: viewKeyDtl,
            viewFilter: "1 = 0",
            rowFill: rowFill,
            allowDelete: allowDelete,
            afterDelete: gridRowAfterDelete
        };
        gridview = new window.xwf_gridview(prop);
    }

    function gridRowAfterDelete() {
        vf.refreshRecord();
    }

    function rowFill(para) {
        var dataRow = para.drRow;
        var stockId = dataRow["stock_id"].value;

        if (stockId == 0) {
            dataRow["matr_name"].className = "cellZeroStock";
        }
    }
</script>

<!-- 申请处理 -->
<script>
    function btnAddDtl_click() {
        if (!calQty(true)) return;
        if (vf.status.equals("addnew")) {
            if (!vf.save()) return;
        }

        var applyId = frm._cAPPLY_ID.value.toInt();
        var matrId = dataRowStock["material_id"].value;
        var qty = gId("_fMatr_qty").value;
        var packageUnit = dataRowUnit["unit"].value;
        var rate = dataRowUnit["rate"].value;
        var remark = gId("_fRemark").value;

        if (g.a.send("processType=h_spd.dept.ThdApplyAux&actionType=addApplyDtl", {
                applyId: applyId,
                storageIdRes: storageIdRes,
                matrId: matrId,
                qty: qty,
                allowApplyZeroStock: (allowApplyZeroStock ? 1 : 0),
                packageUnit: packageUnit,
                rate: rate,
                remark: remark
            }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                gridview.refresh();
                resetSelectArea();
            } else {
                return false;
            }
        } else {
            return false;
        }
    }

    function calQty(check) {
        if (txtPackageQty.value.trim().equals("")) return false;
        if (dataRowStock == null) {
            showWarn("请先选择您要申领单商品。");
            return false;
        }
        var qtyStock = dataRowStock["qty_stock"].value;
        var qty = 0,
            rate = 0;
        var qtyPackage = txtPackageQty.value;
        //申请数量
        if (!g.x.isFloat2(txtPackageQty.value, 99999999)) {
            showWarn("数量应该大于0并且小数位不超过2位并且不超过99999999");
            return false;
        }

        var ist = gId("_fPackage_unit").instance;

        if (ist == null) {
            return false;
        }
        dataRowUnit = ist.dataRow;
        if (dataRowUnit == null) {
            if (check) {
                showWarn("请选择包装单位。");
                gId("_fPackage_unit").focus();
            }
            return false;
        }
        rate = dataRowUnit["rate"].value;

        if (qtyPackage <= 0) {
            if (check) {
                showWarn("请输入包装数量。");
                txtPackageQty.select();
                txtPackageQty.focus();
            }
            return false;
        }
        qty = qtyPackage * rate;
        gId("_fMatr_qty").value = qty;

        if (qty > qtyStock) {
            if (allowApplyZeroStock) {
                // -- --
            } else {
                if (check) {
                    showWarn("请领数量(" + qty + ")超过库存数量（" + qtyStock + "），请检查。");
                    txtPackageQty.select();
                    txtPackageQty.focus();
                    return false;
                }
            }
        }
        return true;
    }

    function resetSelectArea() {
        dataRowStock = null;

        gId("_fMatr_name").value = "";
        gId("_fMatr_spec").value = "";
        gId("_fPackage_unit").value = "";
        txtPackageQty.value = "";
        gId("_fMatr_price").value = "";
        gId("_fMatr_qty").value = "";
        gId("_fRemark").value = "";

        txtMatr.instance.expand();
    }
</script>
<!-- 模板导入 -->
<script>
    function btnFromTemplet_click() {
        var prop = {
            title: "请选择科室请领模板...",
            width: 960,
            height: 0.8,
            parent: win
        };
        var para = {
            viewKey: "pack_templet_select",
            viewMode: "singleSelect",
            viewFilter: "pack_type = 'DEPT_APPLY' AND dept_id = " + topWin.officeId,
            selectCallback: onPackTempletSelect
        };
        topWin.openSelectView(prop, para);
    }
    function onPackTempletSelect(dataRow) {
        var applyId = frm._cAPPLY_ID.value.toInt();
        var packTempletId = dataRow["pack_templet_id"].value;

        // ----------------------------------------------------
        if (applyId == 0) {
            if (!vf.save()) {
                return;
            }
            applyId = frm._cAPPLY_ID.value.toInt();
        }
        // ----------------------------------------------------
        if (g.a.send("processType=h_spd.dept.ThdApplyAux&actionType=addFromDeptApplyTemplet", { applyId: applyId, storageIdRes: storageIdRes, packTempletId: packTempletId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                gridview.refresh();
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }

        // ----------------------------------------------------
        return true;
    }
</script>

<!-- print -->
<script>
    function printBill(btnKey) {
        if (btnKey === "printIO") { //打印
            var param = {
                title: "科室请领(" + gId("_cApply_key").value + ")",
                colNumThs: 3, //表头每行多少列，默认为4
                colNumTfooters: 3, //表尾每行多少列，默认为4
                form: {
                    ths: [{
                        text: "请领日期",
                        value: gId("_cApply_date").value
                    }, {
                        text: "请领科室",
                        value: gId("_cDept_name").value
                    }, {
                        text: "金额",
                        value: gId("_cAmount").value
                    }, {
                        text: "请领人",
                        value: gId("_cApply_username").value
                    }, {
                        text: "备注",
                        value: gId("_cRemark").value,
                        colspan: 3
                    }],
                    tfooters: [{
                        text: "主管",
                        value: ""
                    }, {
                        text: "经手人",
                        value: ""
                    }, {
                        text: "签收",
                        value: ""
                    }]
                },
                sumTableFun: function(jqPageTable) { //打印汇总函数，即每个分页最后一行汇总行的处理方法，可以不传，可以参考 balance_matr.html 用法
                    var trRet = ["<tr>"];

                    //合计标题列和空列
                    trRet.push("<td>合计</td>");
                    trRet.push("<td></td>");
                    trRet.push("<td></td>");
                    trRet.push("<td></td>");


                    //合计列
                    var sumqtyin = 0,
                        sumamount = 0;
                    jqPageTable.find(".datarow").each(function() {
                        var tr = $(this);
                        var thqtyin = parseFloat(tr.children("td:eq(4)").text());
                        var thqamount = parseFloat(tr.children("td:eq(6)").text());
                        if (!isNaN(thqtyin)) sumqtyin += thqtyin;
                        if (!isNaN(thqamount)) sumamount += thqamount;
                    });
                    trRet.push("<td></td>");
                    trRet.push("<td>" + g.x.toFixedN(sumqtyin, 2) + "</td>");
                    trRet.push("<td>" + g.x.toFixedN(sumamount, 4) + "</td>");
                    trRet.push("<td></td>");

                    trRet.push("</tr>");
                    return trRet.join("");
                },
                grid: {
                    ths: ["序号", "品名", "品规", "单位", "数量", "单价", "金额", "厂商"],
                    thwidths: ["66px", "auto", "150px", "100px", "100px", "100px", "100px", "150px"],
                    data: (function() {
                        var arr = [],
                            row, sp_amount = 0,
                            sell_amount = 0;
                        if (gridview && gridview.dtbViewData.rowCount > 0) {
                            var totalprice = 0,
                                totalPriceSell = 0,
                                rowData;
                            for (var i in gridview.dtbViewData.rows) {
                                row = gridview.dtbViewData.rows[i];
                                rowData = [];
                                rowData[0] = (parseInt(i) + 1);
                                rowData[1] = row["matr_name"].value;
                                rowData[2] = row["matr_spec"].value;
                                rowData[3] = row["matr_unit"].value;
                                rowData[4] = row["qty"].value;
                                rowData[5] = row["price"].value;
                                rowData[6] = row["amount"].value;
                                rowData[7] = row["manufacturer_name"].value;
                                arr.push(rowData);
                            }
                        }
                        return arr;
                    })()
                }
            };
            WebPrint.goPrintFormModel(param);
            return false;
        }
    }
</script>
<script>
    //得到本月累计耗材消耗总额及限额
    function initDeptKpi() {
        var dept_id = topWin.officeId;
        var date = new Date().toString("yyyy-MM");
        if (g.a.send("processType=g_spd.dept.DeptKpi&actionType=getDeptKpi", {
                dept_id: dept_id,
                date: date,
                type: "apply"
            }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var allowShowLimit = cReturn.allowShowLimitapply;
                if (allowShowLimit == 0) {
                    gId("tbForm3").style.display = "none";
                    gId("info").style.display = "none";
                } else {
                    var matr_consume = cReturn.cost;
                    var limit_money = cReturn.limit;
                    gId("cost").innerText = matr_consume + "元";
                    gId("limit").innerText = limit_money + "元";
                    if (parseFloat(matr_consume) > parseFloat(limit_money)) {
                        gId("info").style.color = "red";
                    }
                }
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
</script>