<!DOCTYPE html>
<html>
<head>
    <title>耗材准入审批</title>
	<script src="../../../../../res/jscript/xwf.js"></script>
	<script src="../../../../../res/jscript/xwf.ajax.js"></script>	
	<script src="../../../../../res/jscript/xwf.const.js"></script> 
		
	<script src="../../../../../res/control/tab/xwf.tab.js"></script>
	<script src="../../../../../res/control/grid/xwf.grid.js"></script>
	<script src="../../../../../res/control/grid/xwf.gridview.js"></script>
	<script src="../../../../../res/control/uvform/xwf.uvform.js"></script>
	<script src="../../../../../res/control/upload/xwf.upload_core.js"></script>

	<script src="../../../../../res/jscript/xwf.css.js"></script>

	<style type="text/css">
	    body {
	        width: 1020px;
			overflow: hidden;
	    }

	    .divContent {
			border: dotted green 0px;
			overflow: hidden;
		}
	    .txtContent {
			width: 99%;
		}

		#divGridDoc input {
            border: 0px;
			text-align: left;
			padding-left: 5px;
        }
	</style>
</head>
<body>
	<div id="divDC"></div>
	<div id="divTab1" class="xwf_tab_divContainer">
		<form id="frm" action="" target="h_spd.base_data.matr.VIEW_matrAdmittance"> 
			<table id="tbForm" class="tbForm" style="width:1010px;">
				<tr class="trH">
					<th style="width:15%;"></th>
					<th style="width:25%;"></th>
					<th style="width:12%;"></th>
					<th style="width:23%;"></th>
					<th style="width:12%;"></th>
					<th style="width:23%;"></th>
				</tr>
				<tr>				
					<td>单号</td>
					<td><input type="text" id="_cBus_key" disabled="disabled" /></td>
					<td>日期</td>
					<td><input type="text" id="_cBus_date" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})" /></td>
					<td>申请人</td>
					<td><input type="text" id="_cBus_user" /></td>
				</tr>
				<tr>				
					<td>科室</td>
					<td><input id="_cDept_id" type="text" controlType="dropdown" fieldValue="dept_id" fieldText="dept_name" fieldsSearch="dept_name" /></td>
					<td>标题</td>
					<td colspan="3"><input type="text" id="_cTitle" /></td>
				</tr>
				<tr>	
					<td>申请说明</td>
					<td colspan="5"><textarea id="_cInstructions" rows="5" cols="0"></textarea></td>
				</tr>
				<tr>
					<td>备注</td>
					<td colspan="5"><input type="text" id="_cRemark" /></td>
				</tr>
			</table>		
			<input id="_cMATR_ADMITTANCE_ID" type="hidden" />
		</form>
		<div id="div11" class="divContent" style="display:none">
			<textarea id="_cContent_11" class="txtContent" rows="13" cols="0"></textarea>
		</div>
		<div id="div12" class="divContent" style="display:none">
			<textarea id="_cContent_12" class="txtContent" rows="13" cols="0"></textarea>
		</div>
		<div id="div13" class="divContent" style="display:none">
			<textarea id="_cContent_13" class="txtContent" rows="13" cols="0"></textarea>
		</div>
		<div id="div14" class="divContent" style="display:none">
			<textarea id="_cContent_14" class="txtContent" rows="13" cols="0"></textarea>
		</div>
		<div id="div15" class="divContent" style="display:none">
			<textarea id="_cContent_15" class="txtContent" rows="13" cols="0"></textarea>
		</div>
		<div id="div16" class="divContent" style="display:none">
			<textarea id="_cContent_16" class="txtContent" rows="13" cols="0"></textarea>
		</div>
		<div id="div17" class="divContent" style="display:none">
			<textarea id="_cContent_17" class="txtContent" rows="13" cols="0"></textarea>
		</div>
	</div>
	<div style="height:10px;"></div>
	<div id="divTab2" class="xwf_tab_divContainer">
		<div id="divGridDtl" style="width:1000px;height:300px;"></div>
		<div id="divGridDoc" style="width:1000px;height:300px;display:none;">divGridDoc</div>
	</div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var treeParent = null; 

	var divGridDtl = gId("divGridDtl");
	var divGridDoc = gId("divGridDoc");

	var tab1 = null, tab2 = null;
	var gvDtl = null, gvDoc = null;

	var flowNodeKey = "", flowNodeName = "", flowNodeOrder = 0;
	// ------------------------------------------------------------------------
	function formLoad() {
		treeParent = win.parentWindow.gridView.tree;
		if (treeParent.selectedNode.level == 2) {
			var drFlowNode = treeParent.selectedNode.drFlowNode;
			flowNodeKey =  drFlowNode["fn_key"].value;
			flowNodeName = drFlowNode["fn_name"].value;
			flowNodeOrder = treeParent.selectedNode.drFlowNode["fn_order"].value;
			if (flowNodeKey.equals("13") || flowNodeKey.equals("16")) {
				// -- 设备科节点 --
			}
		}
		else {
			flowNodeName = "制单";
			flowNodeOrder = 1;
		}

		vf.css(gId("tbForm"));
		//vf.addExtraButton({ key: "printWi", text: "打印入库单" });

		tab1 = new window.xwf_tab({ divContainer: gId("divTab1"), tabClick: tab1_click });
		tab1.addTab({ key: "tabFirst", text: "科室申请", control: gId("tbForm") });
		tab1.addTab({ key: "tab11", text: "医务部论证", title: "", control: gId("div11") });
		tab1.addTab({ key: "tab12", text: "医保办审批", title: "", control: gId("div12") });
		tab1.addTab({ key: "tab13", text: "设备科调研、询价", title: "", control: gId("div13") });
		tab1.addTab({ key: "tab14", text: "分管院长审批", title: "", control: gId("div14") });
		tab1.addTab({ key: "tab15", text: "院长审批", title: "", control: gId("div15") });
		tab1.addTab({ key: "tab16", text: "设备科价格谈判", title: "", control: gId("div16") });
		tab1.addTab({ key: "tab17", text: "院长办公会审议决定", title: "", control: gId("div17") });

		tab2 = new window.xwf_tab({ divContainer: gId("divTab2"), tabClick: tab2_click });
		tab2.addTab({ key: "tabDtl", text: "申请列表", title: "", control: divGridDtl });
		tab2.addTab({ key: "tabDoc", text: "申请及审批材料", title: "申请及审批材料附件", control: divGridDoc });
	}	
</script>

<!-- vf.events -->
<script> 
	vf.afterAddnew = function () {
		frm._cBus_date.value = (new Date).toString();
	}
	vf.afterMove = function () {
		tab1_click(tab1.tabSelected);
		tab2_click(tab2.tabSelected);
	}	
</script>

<!-- tabs and gridview -->
<script>
	function tab1_click(tab) {
		var matrAdmittanceId = frm._cMATR_ADMITTANCE_ID.value.toInt();
		if (tab.key == "tabFirst") {
			
		}
		else if (tab.key == "tab11") {

		}
		else if (tab.key == "tab12") {

		}
		else {
			// showError("please debug here");
		}
		return true;
	}
	function tab2_click(tab) {
		var matrAdmittanceId = frm._cMATR_ADMITTANCE_ID.value.toInt();
		if (tab.key == "tabDtl") {
			if (gvDtl == null) {
				var prop = {
					divContainer: divGridDtl,
					viewKey: "matr_admittance_dtl",
					viewFilter: "matr_admittance_id = " + matrAdmittanceId,
					viewForm: "project/h_spd/html/base_data/matr/matr_admittance_dtl.html",
					toolbarVisible: true,
					jsonToolbar: { height: "M", onclick: onDtlToolbarClick }
				};
				gvDtl = new window.xwf_gridview(prop);
				gvDtl.toolbar.addBar({ type: "button", key: "addDtl", text: "<i class='fa fa-plus'></i> 添加明细", align: "left", style: "Grid" });
				gvDtl.beforeAddnew = function () {
					if (!vf.status.equals("view")) {
						showWarn("当前状态不允许添加明细记录。");
						return false;
					}
					return true;
				}
			}
			else {
				gvDtl.setViewFilter("matr_admittance_id = " + matrAdmittanceId);
			}
		}
		else if (tab.key == "tabDoc") {
			if (gvDoc == null) {
				var prop = {
					divContainer: divGridDoc,
					viewKey: "matr_admittance_doc",
					viewFilter: "matr_admittance_id = " + matrAdmittanceId,
					viewForm: "project/h_spd/html/base_data/matr/matr_admittance_doc.html",
					 cellBlur: gvDtlCellBlur,
					toolbarVisible: true,
					jsonToolbar: { height: "M", onclick: onDocToolbarClick } 
				};
				gvDoc = new window.xwf_gridview(prop);
				gvDoc.toolbar.addBar({ type: "button", key: "addDtl", text: "<i class='fa fa-file'></i> 添加附件", align: "left", style: "Grid" });
				gvDoc.beforeAddnew = function () {
					if (!vf.status.equals("view")) {
						showWarn("当前状态不允许添加明细记录。");
						return false;
					}
					return true;
				}

				initUploadInstance();
			}
			else {
				gvDoc.setViewFilter("matr_admittance_id = " + matrAdmittanceId);
			}
		}
		else {
			alert("debug here");
		}
	}

	function onDtlToolbarClick(para) {
		gvDtl.addnew();
	}
	function onDocToolbarClick(para) {
		alert("debug here");
	}

	function gvDtlCellBlur(para) {
		var dataRow = para.drRow;
		var matrAdmittanceDocId = dataRow["matr_admittance_doc_id"].value;
		var fieldName = para.fieldName;
		var newValue = para.newValue;

		if (para.newValue == para.oldValue) {
			return true;
		}

		var para = {
			viewKey: "matr_admittance_doc",
			matrAdmittanceDocId: matrAdmittanceDocId,
			fieldName: fieldName,
			fieldValue: newValue
		};

		if (g.a.send("processType=h_spd.base_data.matr.VIEW_matrAdmittanceDoc&actionType=updateDtlByEdit", para, true)) {
			if (g.a.OK) {
				return true;
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}

	function viewExtraButtonClick(para) {
		var dataRow = para.drViewData;
		
		if (para.viewKey.equals("matr_admittance_doc")) {
			if (para.btnKey.equals("preview")) {
				var docUrl = dataRow["doc_url"].value;
				var url = g.httpServer + docUrl;

				window.open(url, "_blank");
			}
		}
	}
</script>

<!-- 文件上传 -->
<script type="text/javascript">
	var uploadCore = null;
	// ----------------------------------------------------
	function initUploadInstance() {
		var matrAdmittanceId = frm._cMATR_ADMITTANCE_ID.value.toInt();
		var jsonProp = {
			divContainer: null, 							// -- 建议提供(非必需) --
			domAdd: gvDoc.toolbar.Bars["addDtl"].dom, 		// -- 必需提供，添加文件dom对象 --

			action: g.httpServer + g.appPath + "filter.do?processType=h_spd.base_data.matr.MatrAdmittanceUpload",

			maxSizeK: 1024,
			autoUpload: true,
			fileType: "*",

			callback: afgerUpload,

			matrAdmittanceId: matrAdmittanceId,
			flowNodeName: flowNodeName,
			flowNodeOrder: flowNodeOrder
		};

		uploadCore = new window.xwf_upload_core(jsonProp);
	}

	function afgerUpload(para) {
		if (para.OK) {
			gvDoc.refresh();
		}
		else {
			showErr(para.errMessage);
		}
	}
</script>