<!DOCTYPE html>
<html>
<head>
    <title>科室业务耗材范围配置</title>
	<script src="../../../../../res/jscript/xwf.js"></script>
	<script src="../../../../../res/jscript/xwf.ajax.js"></script>	
	<script src="../../../../../res/jscript/xwf.const.js"></script>

	<script src="../../../../../res/control/tree/xwf.tree.js"></script>
	<script src="../../../../../res/control/grid/xwf.grid.js"></script>
	<script src="../../../../../res/control/grid/xwf.gridview.js"></script>

	<script src="../../../../../res/jscript/xwf.css.js"></script>
	<style type="text/css">
		body {
			overflow: hidden;
		}
		#tbLayout {
			 border-collapse: collapse;
		}
		.tdLayout {
			padding: 0px;
			overflow: hidden;
			vertical-align: top;			
		}
		#tdLayoutLeft {
			border-top: solid 1px #c0c0c0;
			border-left: solid 1px #c0c0c0;
			border-bottom: solid 1px #c0c0c0;
		}
		#tdLayoutRight {
			border-top: solid 1px #c0c0c0;
			border-bottom: solid 1px #c0c0c0;
		}

        #divTree {
			width: 320px;
			overflow: auto;
		}

		#divButton {
			padding: 10px 0px 10px 0px;
		}

	    .btnCommand {
            border: 0px;
            height: 36px;
            width: 180px;
            color: white;
            background-color: #3280FA;            
            border-radius: 4px;
            margin-right: 20px;
        }
            .btnCommand:hover {
                color: yellow;
            }
             .btnCommand:disabled {
                color: gray;
            }
	</style>
</head>
<body>
	<table id="tbLayout">
		<tr>
			<td id="tdLayoutLeft" class="tdLayout"><div id="divTree"></div></td>
			<td id="tdLayoutRight" class="tdLayout">
                <div id="divGrid1"></div>
				<div id="divButton">
					<input id="btnAdd" type="button" class="btnCommand" value="添加" onclick="return btnAdd_click()" />
					<input id="btnRemove" type="button" class="btnCommand" value="移除" onclick="return btnRemove_click()" />
				</div>
				<div id="divGrid2"></div>
			</td>
		</tr>
	</table>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">    
    var allowType = urlPara["allowType"];
    var treeTitle = "";
    var viewKey = "", fieldName = "";
    var eventSkip = false;

    var tbLayout = gId("tbLayout");
    var divButton = gId("divButton");
    var divTree = gId("divTree");
    var divGrid1 = gId("divGrid1"), divGrid2 = gId("divGrid2");

    var tree = null;
    var gridView1 = null, gridView2 = null;
    // ----------------------------------------------------
    function formLoad() {
        if (allowType.equals("APPLY")) {
            treeTitle = "科室请领范围设定"; 
            fieldName = "allow_apply"
        }
        else if (allowType.equals("DEMAND")) {
            treeTitle = "科室需求范围-科室导航"; 
            fieldName = "allow_demand"
        }
        else {
            showErr("错误的菜单入口，请检查。");
        }

        formResize();

        initGridview();
        initTree();        
    }
    function formResize() {
        var height = win.p.height - 2 * tbLayout.offsetTop - divTree.offsetTop;
        var width = (win.p.width - divTree.offsetWidth - 20);

        divTree.style.height = height + "px";
        divGrid1.style.height = (height - divButton.offsetHeight - 6) / 2 + "px";
        divGrid2.style.height = divGrid1.offsetHeight + "px";

        divGrid1.style.width = width + "px";
        divGrid2.style.width = width + "px";
        divButton.style.width = width + "px";
    }
</script>

<!-- tree -->
<script type="text/javascript">
    function initTree() {
        var rootKey = "0", groupKey = "", nodeKey = "";
        var jsonPara = {
            divContainer: gId("divTree"),
            imgPath: "../../../../../res/control/tree/" + top.cssStyle + "/",
            title: treeTitle,
            beforeExpand: beforeNodeExpand,
            nodeClick: onNodeClick,
            nodeCheck: onNodeCheck
        };
        tree = new window.xwf_tree(jsonPara);

        groupKey = rootKey + tree.sd + "global";
        tree.addNode({ key: groupKey, text: "全局配置", groupKey: "global" });
        tree.addNode({ key: groupKey + tree.sd + "-1", text: "允许配置范围", deptId: "-1" });
        tree.addNode({ key: groupKey + tree.sd + "0", text: "所有科室范围", deptId: "0" });

        groupKey = rootKey + tree.sd + "dept";
        tree.addNode({ key: groupKey, text: "科室", groupKey: "dept" });
        loadDeptNode(groupKey);

        tree.expand(rootKey + tree.sd + "global");
    }
    function loadDeptNode(pNodeKey) {
        if (g.a.send("processType=h_spd.base_data.dept.Dept_Matr&actionType=getDeptList", {}, true)) {
            if (g.a.OK) {
                var c = g.a.cReturn;
                var dtb = c.dtbDept;
                for (var i = 0; i < dtb.rowCount; i++) {
                    var nodeKey = pNodeKey + tree.sd + dtb.rows[i]["dept_id"].value;
                    var nodeText = dtb.rows[i]["dept_name"].value;
                    var deptId = dtb.rows[i]["dept_id"].value;

                    tree.addNode({ key: nodeKey, text: nodeText, deptId: deptId, title: deptId, showCheckBox: true });
                }
            }
            else {
                return;
            }
        }
        else {
            return;
        }
    }

    function beforeNodeExpand(node, firstExpand) {
        if (node.groupKey.equals("global")) {
            tree.collapse("0" + tree.sd + "dept");
            tree.selectNode("0" + tree.sd + "global");
        }
        else if (node.groupKey.equals("dept")) {
            tree.collapse("0" + tree.sd + "global");
            tree.selectNode("0" + tree.sd + "dept");
        }
    }
    function onNodeClick(node) {
        if (eventSkip) return;

        var deptId = node.deptId;
        // ------------------------------------------------
        if (node.level == 1) {
            if (node.groupKey.equals("global")) {
                gridview1.setViewFilter("1 = 0");
                gridview2.setViewFilter("1 = 0");
            }
            else if (node.groupKey.equals("dept")) {
                showViewFilter();
            }
            else {
                showErr("未知的节点类别。");
            }
        }
        else if (node.level == 2) {
            if (deptId > 0) {
                eventSkip = true;
                clearTreeChecked();
                tree.setNodeChecked(node.key, true);
                eventSkip = false;
            }
            if (deptId == -1) {
                gridview1.setViewFilter("material_id NOT IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = " + node.deptId + " AND " + fieldName + " = 1)");                
            }
            else {
                gridview1.setViewFilter("material_id IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = -1 AND " + fieldName + " = 1) AND material_id NOT IN(SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = " + node.deptId + " AND " + fieldName + " = 1)");
            }
            gridview2.setViewFilter("material_id     IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = " + node.deptId + " AND " + fieldName + " = 1)");
        }
        else {
            showErr("未知的节点级别。");
        }
        return;

        if (node.groupKey && node.groupKey.equals("global")) {
            gridview1.setViewFilter("1 = 0");
            gridview2.setViewFilter("1 = 0");
        }
        else if (node.groupKey && node.groupKey.equals("dept")) {
            showViewFilter();
        }
        else if (node.level == 2 && node.deptId == -1) {
            gridview1.setViewFilter("material_id NOT IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = -1 AND " + fieldName + " = 1)");
            gridview2.setViewFilter("material_id     IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = -1 AND " + fieldName + " = 1)");
        }
        else if (node.level == 2 && node.deptId == 0) {
            gridview1.setViewFilter("material_id IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = -1 AND " + fieldName + " = 1) AND NOT material_id IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = 0 AND " + fieldName + " =1)");
            gridview2.setViewFilter("material_id IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = 0 AND " + fieldName + " = 1)");
        }
        else {
            eventSkip = true;
            clearTreeChecked();
            tree.setNodeChecked(node.key, true);
            showViewFilter();  
            eventSkip = false;
        }
    }
    function onNodeCheck(node) {
        if (eventSkip) return;
        eventSkip = true;

        tree.selectNode("0" + tree.sd + "dept" );
        showViewFilter();

        eventSkip = false;
    }

    function clearTreeChecked() {
        var arr = tree.getCheckedKeys();
        for (var i = 0; i < arr.length; i++) {
            tree.setNodeChecked(arr[i], false);
        }
    }

    function showViewFilter() {
        var sqlHaving = "";
        var deptIds = getDeptIds();
        var nDeptCount = deptIds.split(",").length;

        if (deptIds.equals("")) {
            gridview1.setViewFilter("material_id IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = -1 AND " + fieldName + " = 1)");
            gridview2.setViewFilter("1 = 0");
        }
        else {
            sqlHaving = "SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id IN (" + deptIds + ") AND " + fieldName + " = 1 GROUP BY matr_id HAVING COUNT(1) = " + nDeptCount;
            gridview1.setViewFilter("material_id IN (SELECT matr_id FROM TDEPT_R_MATR WHERE dept_id = -1 AND " + fieldName + " = 1) AND material_id NOT IN (" + sqlHaving + ")");
            gridview2.setViewFilter("material_id IN (" + sqlHaving + ")");
        }
    }
    function getDeptIds() {
        var deptIds = "";
        var arrDeptId = new Array();
        var arrNodeKey = null;
        var node = tree.selectedNode;
        // ------------------------------------------------
        if (node.level == 1) {
            if (node.groupKey.equals("glboal")) {
                arrDeptId.push("");
            }
            else if (node.groupKey.equals("dept")) {
                arrNodeKey = tree.getCheckedKeys();
                if (arrNodeKey.length > 0) {
                    for (var i = 0; i < arrNodeKey.length; i++) {
                        arrDeptId.push(tree.nodes[arrNodeKey[i]].deptId);
                    }
                }
                else {
                    arrDeptId.push("");
                }
            }
            else {
                showErr("未知的节点类别。");
            }
        }
        else if (node.level == 2) {
            arrDeptId.push(node.deptId);
        }
        else {
            showErr("未知的节点级别。");
        }
        // ------------------------------------------------
        deptIds = arrDeptId.join(",");
        debug("deptIds = " + deptIds);
        return deptIds;
    }
</script>
<!-- gridview -->
<script type="text/javascript">
    function initGridview() {
        var prop = {
            divContainer: divGrid1,
            viewKey: "tdept_r_matr_allow",
            viewFilter: "1 = 0"
        };
        gridview1 = new window.xwf_gridview(prop);

        var prop = {
            divContainer: divGrid2,
            viewKey: "tdept_r_matr_allow",
            viewFilter: "1 = 0"
        };
        gridview2 = new window.xwf_gridview(prop);
    }
</script>

<!-- add、remove -->
<script type="text/javascript">
    function btnAdd_click() {
        var arrMatrId = new Array();
        var matrIds = "", deptIds = getDeptIds();
        // ------------------------------------------------
        for (var i = gridview1.dtbViewData.rowCount - 1; i >= 0; i--) {
            if (gridview1.dtbViewData.rows[i].checked) {
                arrMatrId.push(gridview1.dtbViewData.rows[i]["material_id"].value);

                gridview1.selectRow(i);
                gridview1.remove();
            }
        }
        matrIds = arrMatrId.join(",");
        if (matrIds.length <1) {
            showWarn("请选择要加入的耗材。");
            return;
        }
        if (deptIds.equals("")) {
            showWarn("请选择一个或勾选多个科室。");
            return;
        }
        // ------------------------------------------------
        if (g.a.send("processType=h_spd.base_data.dept.Dept_Matr&actionType=addTo", {allowType: allowType, deptIds: deptIds, matrIds:matrIds}, true)) {
            if (g.a.OK) {
                var c = g.a.cReturn;

                // -- gridview1.refresh();
                gridview2.refresh();
            }
            else {
                return;
            }
        }
        else {
            return;
        }
    }
    function btnRemove_click() {
        var arrMatrId = new Array();
        var matrIds = "", deptIds = getDeptIds();
        // ------------------------------------------------
        for (var i = 0; i < gridview2.dtbViewData.rowCount; i++) {
            if (gridview2.dtbViewData.rows[i].checked) {
                arrMatrId.push(gridview2.dtbViewData.rows[i]["material_id"].value);
            }
        }
        matrIds = arrMatrId.join(",");
        if (matrIds.equals("")) {
            showWarn("请选择要移除的耗材。");
            return;
        }
        // ------------------------------------------------
        if (g.a.send("processType=h_spd.base_data.dept.Dept_Matr&actionType=remove", { allowType: allowType, deptIds: deptIds, matrIds: matrIds }, true)) {
            if (g.a.OK) {
                var c = g.a.cReturn;

                // -- gridview1.refresh();
                gridview2.refresh();
            }
            else {
                return;
            }
        }
        else {
            return;
        }
    }
</script>