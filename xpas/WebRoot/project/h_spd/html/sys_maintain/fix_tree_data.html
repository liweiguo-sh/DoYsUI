<!DOCTYPE html>
<html>
<head>
    <title>树形结构数据修复</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
            font-family: 微软雅黑;
        }

        #btnExec {
            color: red;
        }

            #btnExec:hover {
                color: Yellow;
            }

        .tbItem {
            border-collapse: collapse;
        }

            .tbItem td {
                overflow: hidden;
                padding-top: 5px;
                padding-bottom: 5px;
                border: dotted 0px #f0f0f0;
                -ms-user-select: none;
            }

        .tdTitle {
            color: Orange;
        }

        .tdItem {
            color: Olive;
            padding-left: 10px;
            padding-right: 10px;
        }

        .divMessage {
            overflow: auto;
            margin-top: 15px;
            font-size: 11pt;
            line-height: 24px;
            background-color: White;
        }

        .errMessage {
            color: Red;
        }
    </style>
</head>
<body>
    <div id="divButton" class="uvButtons">
        <input type="button" id="btnClose" onclick="btnClose_click();" value="关闭" />
        <input type="button" id="btnExec" onclick="btnExec_click();" value="执行修复" />
    </div>
    <div class="PanelA">
        <form id="frm" action="">
            <table id="tbInitRes" class="tbItem">
                <tr>
                    <td class="tdTitle" rowspan="2">修复内容</td>
                    <td class="tdItem"><input type="radio" name="group" id="rdoCategory" onclick="rdoClick(this)" /><label for="rdoCategory">物料品类</label></td>
                    <td class="tdItem"><input type="radio" name="group" id="rdoStorage" onclick="rdoClick(this)" /><label for="rdoStorage">库存地</label></td>
                </tr>
                <tr>
                    <td class="tdItem"><input type="radio" name="group" id="rdoOffice" onclick="rdoClick(this)" /><label for="rdoOffice">机构</label></td>
                </tr>
            </table>
        </form>
        <div id="divMessage" class="divMessage"></div>
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var itemKey = "";

    var arrMessage = new Array();
    var divMessage = gId("divMessage");
    // ------------------------------------------------------------------------
    function formLoad() {
        formResize();
    }

    function formResize() {
        divMessage.style.height = (win.p.height - divMessage.offsetTop - 20) + "px";
    }

    function btnClose_click() {
        win.close();
    }
</script>

<!-- 一键初始化 -->
<script type="text/javascript">
    function rdoClick(rdo) {
        itemKey = rdo.id.substring(3);
    }
    function btnExec_click() {        
        var d1;

        if (itemKey.equals("")) {
            showMsg("请先选择修复项。");
            return;
        }
        // ------------------------------------------------
        for (var i = 1; i <= 2; i++) {
            if (!showConfirm("第 " + i + " 警告：\n\n执行修复会重置 node_key 的值，请慎重考虑。\n\n\n您确认要执行吗？")) {
                return;
            }
        }
        // ------------------------------------------------
        d1 = new Date();
        clearMessage();
        writeMessage("一键修复开始，请耐心等待 ......");

        execFix();

        writeMessage("总计耗时：" + g.x.timeInterval(d1, new Date()) + "。");
    }
    
    function execFix() {
        if (g.a.send("processType=h_spd.sys_maintain.FixTreeData&actionType=execFix", { itemKey: itemKey }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                writeMessage("树形结构数据修复完成.");
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>

<!-- 辅助函数 -->
<script type="text/javascript">
    function clearMessage() {
        arrMessage = new Array();
        divMessage.innerHTML = "";
    }

    function writeError(strError) {
        arrMessage.push((new Date).toString("hh:mm:ss.ms") + " - <span class='errMessage'>" + strError + "</span>");
        divMessage.innerHTML = arrMessage.join("<br />");
    }
    function writeMessage(strMessage) {
        if (strMessage.equals("")) {
            arrMessage.push("");
        }
        else {
            arrMessage.push((new Date).toString("hh:mm:ss.ms") + " - " + strMessage);
        }
        divMessage.innerHTML = arrMessage.join("<br />");
    }
</script>