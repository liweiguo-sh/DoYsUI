<!DOCTYPE html>
<html>
<head>
    <title>系统初始化</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
            font-family: 微软雅黑;
        }

        #btnInit {
            color: red;
        }

            #btnInit:hover {
                color: Yellow;
            }

        .tbItem {
            border-collapse: collapse;
        }

            .tbItem td {
                overflow: hidden;
                padding-top: 5px;
                padding-bottom: 5px;
                border: dotted 0px #f0f0f0;
                -ms-user-select: none;
            }

        .tdTitle {
            color: Orange;
        }

        .tdItem {
            color: Olive;
            padding-left: 10px;
            padding-right: 10px;
        }

        .divMessage {
            overflow: auto;
            margin-top: 15px;
            font-size: 11pt;
            line-height: 24px;
            background-color: White;
        }

        .errMessage {
            color: Red;
        }
    </style>
</head>
<body>
    <div id="divButton" class="uvButtons">
        <input type="button" id="btnClose" onclick="btnClose_click();" value="关闭" />
        <input type="button" id="btnInit" onclick="btnInit_click();" value="执行初始化" />
        <input type="button" id="btnInitPY" onclick="btnInitPY_click();" value="补全助记码" />
        <input type="button" id="btnDelTmpTable" onclick="btnDelTmpTable_click();" value="删除临时表" />
    </div>
    <div class="PanelA">
        <form id="frm" action="">
            <table id="tbInitRes" class="tbItem">
                <tr>
                    <td class="tdTitle" rowspan="3">初始化内容</td>
                    <td class="tdItem" colspan="2"><input type="checkbox" id="chkBus" checked="checked" /><label for="chkBus">业务数据</label></td>
                    <td class="tdItem" colspan="3"><input type="checkbox" id="chkTCB" checked="checked" /><label for="chkTCB">智能柜服务端数据</label></td>
                </tr>
                <tr>
                    <td class="tdItem"><input type="checkbox" id="chkSp" /><label for="chkSp">供应商</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkDept" /><label for="chkDept">科室</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkStorage" /><label for="chkStorage">库存地</label></td> 
                    <td class="tdItem"><input type="checkbox" id="chkCategory" /><label for="chkCategory">品类</label></td> 
                    <td class="tdItem"><input type="checkbox" id="chkMatrial" /><label for="chkMatrial">物料</label></td>                    
                </tr>
                <tr>
                    <td class="tdItem"><input type="checkbox" id="chkOffice" /><label for="chkOffice">机构</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkUser" /><label for="chkUser">用户</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkGroup" /><label for="chkGroup">用户组</label></td>
                </tr>
            </table>
        </form>
        <div id="divMessage" class="divMessage"></div>
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var arrMessage = new Array();
    var divMessage = gId("divMessage");
    // ------------------------------------------------------------------------
    function formLoad() {
        formResize();
    }

    function formResize() {
        divMessage.style.height = (win.p.height - divMessage.offsetTop - 20) + "px";
    }

    function btnClose_click() {
        win.close();
    }
</script>

<!-- 一键初始化 -->
<script type="text/javascript">
    function btnInit_click() {        
        var d1;
        // ------------------------------------------------
        for (var i = 1; i <= 3; i++) {
            if (!showConfirm("第 " + i + " 警告：\n\n执行系统初始化会造成数据不可恢复，请慎重考虑。\n\n\n您确认要执行吗？")) {
                return;
            }
        }
        // ------------------------------------------------
        d1 = new Date();
        clearMessage();
        writeMessage("一键初始化开始，请耐心等待 ......");

        initAll();
        clearInvalidData();

        writeMessage("总计耗时：" + g.x.timeInterval(d1, new Date()) + "。");
    }
    
    function initAll() {
        var initItems = "";
        // ------------------------------------------------
        writeMessage("");

        initItems = getAllCheckedItems();
        if (initItems.equals("")) return;

        if (g.a.send("processType=h_spd.sys_maintain.InitSystem&actionType=initSystem", { initItems: initItems }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                writeMessage("系统初始化完成.");
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }     
    }
    function clearInvalidData() {
        if (g.a.send("processType=com.xznext.xpas.Common&actionType=clearInvalidData", {}, true)) {
            if (g.a.OK) {
                writeMessage("无效数据清理完成。");
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }

    function getAllCheckedItems() {
        var arrItem = new Array();

        if (frm.chkBus.checked) arrItem.push("bus");

        if (frm.chkSp.checked) arrItem.push("sp");
        if (frm.chkDept.checked) arrItem.push("dept");
        if (frm.chkStorage.checked) arrItem.push("storage");
        if (frm.chkCategory.checked) arrItem.push("category");
        if (frm.chkMatrial.checked) arrItem.push("material");

        if (frm.chkTCB.checked) arrItem.push("TCB");

        if (frm.chkOffice.checked) arrItem.push("office");
        if (frm.chkUser.checked) arrItem.push("user");
        if (frm.chkGroup.checked) arrItem.push("group");

        return arrItem.join(",");
    }
</script>
<!-- 补全助记码、删除临时表 -->
<script>
    function btnInitPY_click() {
        var d1;
        // ------------------------------------------------
        if (!showConfirm("您确定要补全\n\n供应商、耗材、厂商\n\n缺失的助记码吗？")) {
            return;
        }
        // ------------------------------------------------
        d1 = new Date();
        clearMessage();
        writeMessage("初始化助记码开始，请耐心等待 ......");

        // ------------------------------------------------
        if (g.a.send("processType=h_spd.sys_maintain.InitPinYin&actionType=initPY", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                writeMessage("助记码初始化完成.");
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }

        writeMessage("总计耗时：" + g.x.timeInterval(d1, new Date()) + "。");
    }
    function btnDelTmpTable_click() {
        var d1;
        // ------------------------------------------------
        if (!showConfirm("您确定要删除其它项目中用到的临时表吗？")) {
            return;
        }
        // ------------------------------------------------
        d1 = new Date();
        clearMessage();
        writeMessage("删除临时表开始，请耐心等待 ......");

        // ------------------------------------------------
        if (g.a.send("processType=h_spd.sys_maintain.InitSystem&actionType=delTmpTable", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                writeMessage("删除临时表完成.");
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }

        writeMessage("总计耗时：" + g.x.timeInterval(d1, new Date()) + "。");
    }
</script>

<!-- 辅助函数 -->
<script type="text/javascript">
    function clearMessage() {
        arrMessage = new Array();
        divMessage.innerHTML = "";
    }

    function writeError(strError) {
        arrMessage.push((new Date).toString("hh:mm:ss.ms") + " - <span class='errMessage'>" + strError + "</span>");
        divMessage.innerHTML = arrMessage.join("<br />");
    }
    function writeMessage(strMessage) {
        if (strMessage.equals("")) {
            arrMessage.push("");
        }
        else {
            arrMessage.push((new Date).toString("hh:mm:ss.ms") + " - " + strMessage);
        }
        divMessage.innerHTML = arrMessage.join("<br />");
    }
</script>