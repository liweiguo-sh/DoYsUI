<!DOCTYPE html>
<html>
<head>
    <title>SN对账</title>
    <script src="../../../../res_plugin/jquery/jquery-3.1.1.min.js"></script>

	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script> 
		
    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }
    </style>
</head>
<body>
	<div id="divDC"></div>
    <div class="PanelA">
	    <form id="frm" action="" target=""> 
		    <table id="tbForm" class="tbForm" style="width:905px;">
			    <tr class="trH">
				    <th style="width:150px;"></th>
				    <th style="width:300px;"></th>
				    <th style="width:150px;"></th>
				    <th style="width:300px;"></th>
			    </tr>
			    <tr>				
				    <td>SN</td>
				    <td><input type="text" id="_cSN_NO" value="" disabled="disabled" /></td>
				    <td>对账人</td>
				    <td><input type="text" id="_cDept_consume_user" value="" disabled="disabled" /></td>
			    </tr>
			    <tr>			
                    <td>科室记帐</td>
				    <td><input type="checkbox" id="_cDept_consume" onclick="dept_his_click();" /><label for="_cDept_consume">科室有纸质消耗记录</label></td>
				    <td>对账时间</td>
				    <td><input type="text" id="_cDept_consume_dt" value="" disabled="disabled" /></td>
			    </tr>
			    <tr>
				    <td>备注</td>
				    <td colspan="3"><textarea id="_cRemark" rows="3" cols="0"></textarea></td>
			    </tr>
                <tr>				
				    <td>品名</td>
				    <td><input type="text" id="_gMaterial_name" value="" disabled="disabled" /></td>
				    <td>品规</td>
				    <td><input type="text" id="_gMaterial_spec" value="" disabled="disabled" /></td>
			    </tr>
                <tr>
                    <td>接口LOG有记录</td>
                    <td><input type="text" id="_cLog_consume" value="" disabled="disabled" /></td>
                    <td>HIS记帐</td>
                    <td><input type="text" id="_cHis_consume" value="" disabled="disabled" /></td>				    				   
			    </tr>
                
                <tr>
                    <td>接口LOG记录时间</td>
				    <td><input type="text" id="_cLog_consume_date" value="" disabled="disabled" /></td>
                    <td>入库日期</td>
				    <td><input type="text" id="_gWi_date" value="" disabled="disabled" /></td>
                </tr>
                <tr>
                    <td>时间范围（分钟）</td>
                    <td><input type="text" id="_xDuration" value="5" /></td>
                    <td></td>
                    <td></td>
                </tr>
		    </table>
	    </form>
        <div id="divGrid" style="width:900px;height:300px;">dd</div>
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var divGrid = gId("divGrid");

    var gridview = null;
    // ------------------------------------------------------------------------
    function formLoad() {
        vf.css(gId("tbForm"));

        initGrid();

        jQuery(gId("_xDuration")).keyup(function (e) {
            var key = e.which;
            if (key == 13) {
                vf.afterMove();
            }
        });
    }    
</script>

<!-- 界面控件事件 -->
<script type="text/javascript">
    function dept_his_click() {
        frm._cDept_consume_user.value = topWin.userKey;
        frm._cDept_consume_dt.value = (new Date()).toString("yyyy-MM-dd HH:mm:ss");
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterMove = function () {
        if (frm._cHis_consume.value.toInt() == 1 || frm._cLog_consume.value.toInt() == 0 || frm._gWi_date.value >= "2019-07-05") {
            divGrid.style.display = "none";
            return;
        }
        divGrid.style.display = "";

        var nDuration = frm._xDuration.value.toInt();  // -- 最近几分钟范围内 --
        var time1 = frm._cLog_consume_date.value;
        var time2 = (new Date(time1.replace(/-/g, '/'))).add(nDuration, "mi").toString("yyyy-MM-dd HH:mm:ss");
        var viewFilter = "material_name = '" + frm._gMaterial_name.value + "' AND material_spec = '" + frm._gMaterial_spec.value
            + "' AND his_time >= '" + time1 + "' AND his_time <= '" + time2 + "'";
        gridview.setViewFilter(viewFilter);
        debug(viewFilter);
    }	
</script>

<!-- grid -->
<script type="text/javascript">
    function initGrid() {
        var prop = {
            divContainer: divGrid,
            viewKey: "AT_SN_488",
            viewFilter: "1 = 0"
        };
        gridview = new window.xwf_gridview(prop);
    }

    function viewExtraButtonClick(jsonProp) {
        if (jsonProp.btnKey.equals("match")) {
            var dataRow = jsonProp.drViewData;
            var id = dataRow["id"].value;
            var snType = dataRow["sn_type"].value;
            var oldSn = dataRow["sn_no"].value;

            var snNo = frm._cSN_NO.value;
            // ----------------------------------------------------
            if (snType == 1) {
                showWarn("原始621记录中已经有SN，不能用手工匹配的覆盖。");
                return;
            }
            if (oldSn != "" && !oldSn.equals(snNo)) {
                showWarn("不应该出现的意外错误，请检查。");
                return;
            }

            if (g.a.send("processType=h_spd.sys_maintain.sdzl_0803.SnCheck&actionType=matchSN", { id: id, snNo: snNo, oldSn: oldSn }, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;
                    
                    gridview.refresh();
                    if (oldSn.equals("")) {
                        win.flashTitle("匹配成功。");
                    }
                    else {
                        win.flashTitle("取消匹配成功。");
                    }
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }
        else {
        }
    };
</script>