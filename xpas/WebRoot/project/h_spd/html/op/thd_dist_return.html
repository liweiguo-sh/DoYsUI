<!DOCTYPE html>
<html>
<head>
    <title>科室退货单</title>
	<script src="../../../../res/jscript/xwf.js"></script>
	<script src="../../../../res/jscript/xwf.ajax.js"></script>	
	<script src="../../../../res/jscript/xwf.const.js"></script> 
		
	<script src="../../../../res/control/grid/xwf.grid.js"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js"></script>

	<script src="../../../../res/jscript/xwf.css.js"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }
        #divGrid input[type='text'] {
            border: 0px;
        }
    </style>
</head>
<body>
	<div id="divDC"></div>
    <div class="PanelA">
	<form id="frm" target="h_spd.op.VIEW_thdReturn"> 
		<table id="tbForm" class="tbForm" style="width:1080px;">
			<tr class="trH">
				<th style="width:12%;"></th>
				<th style="width:23%;"></th>
				<th style="width:12%;"></th>
				<th style="width:18%;"></th>
                <th style="width:12%;"></th>
				<th style="width:18%;"></th>
			</tr>
			<tr>				
				<td>单号</td>
				<td><input type="text" id="_cDist_key" value="" disabled="disabled" /></td>
				<td>日期</td>
				<td><input type="text" id="_cDist_Date" class="Wdate" onclick="WdatePicker({dateFmt:'yyyy-MM-dd'})" /></td>
                <td>金额</td>
                <td><input type="text" id="_cAmount" value="" disabled="disabled" /></td>
			</tr>
            <tr>				
				<td>科室</td>
                <td><input id="_cDEPT_ID" type="text" controlType="dropdown" fieldValue="dept_id" fieldText="dept_name" fieldsSearch="dept_name" /></td>
				<td>库存地</td>
				<td><input type="text" id="_cStorage_name" value="" disabled="disabled" /></td>
                <td>收货人</td>
                <td><input type="text" id="_cPick_user" /></td>
			</tr>
			<tr>
				<td>备注</td>
                <td colspan="3"><input type="text" id="_cRemark" /></td>
                <td>退货人</td>
                <td><input type="text" id="_cDeliver_user" /></td>
			</tr>
		</table>		
		<input id="_cDIST_ID" type="hidden" value="" />
        <input id="_cSTORAGE_ID" type="hidden" value="" />
        <input id="_cDist_type" type="hidden" value="" />  
        <input id="_cRef_type" type="hidden" value="" />                
	</form>
    <div id="divGrid" style="height:360px;"></div> 
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var astatusNav = 0;

    var frmParent = null, nodeNav = null;
    var gridview = null;
    // ------------------------------------------------------------------------
    function formLoad() {
        frmParent = win.parentWindow;
        nodeNav = frmParent.gridView.tree.selectedNode;
        astatusNav = (nodeNav.level > 1 ? nodeNav.value : 0);

        vf.css(gId("tbForm"));

        initGridview();
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
	vf.afterAddnew = function () {
        frm._cDist_Date.value = (new Date).toString();
        frm._cRef_type.value = "MANUAL";
        frm._cDist_type.value = "DEPT_RETURN";
        frm._cAmount.value = "0";        
        frm._cPick_user.value = topWin.userName;

        frm._cSTORAGE_ID.value = topWin.stationStorageId;
        frm._cStorage_name.value = topWin.stationStorageName;
	}

    vf.afterMove = function () {
        var distId = frm._cDIST_ID.value.toInt();
        var astatus = vf.getStatus();

        gridview.setViewFilter("dist_id = " + distId);
	}	
</script>
<!-- gridview -->
<script type="text/javascript">
    function initGridview() {
        var allowDelete = (astatusNav == 0 || astatusNav == 2);
        var prop = {
            divContainer: divGrid,
            viewKey: "thd_dist_return_dtl",
            viewFilter: "1 = 0",
            allowDelete: allowDelete,
            afterDelete: gridRowAfterDelete,
            toolbarVisible: allowDelete,
            cellBlur: cellBlur,
            jsonToolbar: { height: "M", onclick: onToolbarClick }
        };
        gridview = new window.xwf_gridview(prop);
        gridview.toolbar.addBar({ type: "button", key: "selectMatr", text: "<i class='fa fa-plus'></i>选择退货明细" });
    }

    function gridRowAfterDelete() {
        vf.refreshRecord();
    }
    function cellBlur(para) {
        var dataRow = para.drRow;
        var newValue = -Math.abs(para.newValue);
        var distDtlId = dataRow["dist_dtl_id"].value;

        var distId = frm._cDIST_ID.value.toInt();
        var jsonPara = {
            viewKey: "thd_dist_return",
            distId: distId,
            distDtlId: distDtlId,
            qtyNew: newValue
        };
        // ------------------------------------------------
        if (para.newValue == para.oldValue) {
            return true;
        }
        if (newValue == 0) {
            showErr("请输入正确的数字。")
            return false;
        }

        if (g.a.send("processType=h_spd.op.VIEW_thdReturnDtl&actionType=updateQtyByEdit", jsonPara, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var amount = (dataRow["price"].value * newValue).toFixed(2);
                gridview.setValue(gridview.recordRow, "qty", newValue);
                gridview.setValue(gridview.recordRow, "amount", amount);

                para.newValue = newValue;

                vf.refreshRecord();
                return true;
            }
            else {
                return false;
            }
        } else {
            return false;
        }
    }
</script>

<!-- 选择退货明细 -->
<script type="text/javascript">
    function onToolbarClick(para) {
        var distId = frm._cDIST_ID.value.toInt();
        var deptId = frm._cDEPT_ID.underValue.toInt();
        var viewFilter = "";
        // ------------------------------------------------
        if (para.key.equals("selectMatr")) {
            if (vf.status.equals("addnew")) {
                if (!vf.save()) {
                    return false;
                }
            }

            viewFilter = "dept_id = " + deptId + " AND wo_dtl_id NOT IN (SELECT wo_dtl_id FROM THD_DIST_DTL WHERE dist_id = " + distId + ")";
            var prop = {
                title: "请选择退货明细...",
                width: 1300,
                height: 600,
                parent: win
            };
            var para = {
                viewKey: "wo_dtl_for_dept_return",
                viewMode: "multiSelect",
                viewFilter: viewFilter,
                selectCallback: callbackAddMatr
            };
            topWin.openSelectView(prop, para);
        }
        else {
            showErr("unknown button " + para.key);
        }
    }
    function callbackAddMatr(arrDataRow) {
        var distId = frm._cDIST_ID.value.toInt();
        var woDtlIds = "";
        var arrIds = new Array();

        for (var i = 0; i < arrDataRow.length; i++) {
            arrIds.push(arrDataRow[i]["wo_dtl_id"].value);
        }
        woDtlIds = arrIds.join(",");

        if (g.a.send("processType=h_spd.op.VIEW_thdReturnDtl&actionType=addDtlBySelect", { viewKey: "thd_dist_return", distId: distId, woDtlIds: woDtlIds }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                vf.refreshRecord();
                gridview.refresh();
                return true;
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>