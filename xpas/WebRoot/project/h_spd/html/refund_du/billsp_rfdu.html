<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>记帐单红冲</title>
    <!--菜单:财务\记帐管理\记帐单红冲 !-->
    
    <!--xpas begin !-->
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<script src="../../../g_spd/js/select_storage.js" type="text/javascript" title="库存地选择"></script>
    <!--xpas end !-->
    <!--zui begin !-->
    <script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zuiExt.js" type="text/javascript"></script>
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zui.css" rel="stylesheet" type="text/css" />
    <link href="../../../../res_plugin/zui-1.8.1-dist/css/zuiExt.css" rel="stylesheet" type="text/css" />
    <!--zui end !-->
</head>
<body>
<div class="container-fluid">
	<div class="row">
		<div class="col-xs-12">
		    <div id="divDC" class="ScreenCenter" title="工具栏"></div>
		</div>
	</div>   
	<div class="row">
		<div class="col-xs-3">
			<div class="panel-group">
			  <div class="panel panel-default">
			    <div class="panel-heading" id="headingOne">
			      <h4 class="panel-title">
			        <a data-toggle="collapse"  href="#collapseOne">
			          	记账单
			        </a>
			      </h4>
			    </div>
			    <div id="collapseOne" class="panel-collapse collapse in">
			      <div class="panel-body">
				      	<form   class="form-horizontal" id="frm" action="" target="h_spd.refund_du.View_billspRfdu">
				      		<input type="hidden" id="_xbill_sp_id" title="所选记账单id"/>
				      		<input type="hidden" id="_xstorage_id" title="所选入库库存地id"/>
							 <table class="tbForm table table-hover table-borderless table-condensed" id="tbForm" >
				                <tr filter="1" >
				                  	<td>记账单来源筛选</td>
									<td colspan="3">
										<input class="form-control" id="_xbill_type" type="text" controlType="dropdown" fieldValue="wo_type" fieldText="wo_type_name"  />
									</td>
				                </tr>
				                <tr>
				                  	<td>记账单<span style="color:chocolate;"  require="1"> *</span></td>
									<td colspan="3">
										<div class="input-group" style="width:100%;">
										  <div class="input-control search-box search-box-circle has-icon-left has-icon-right search-example" id="searchboxExample">
										    <input id="_xbill_key" readonly="readonly" type="text" class="form-control search-input curp" placeholder="请选择"  onclick="vf.selectBill();"/>
										  </div>
										  <span class="input-group-btn">
										    <button class="btn btn-primary  btn-sm" onclick="vf.selectBill();" type="button">选择</button>
										  </span>
										</div>
									</td>
				                </tr>
				                <tr>
				                  	<td>入库库存地<span style="color:chocolate;"  require="1"> *</span></td>
									<td colspan="3">
										<div class="input-group" style="width:100%;">
										  <div class="input-control search-box search-box-circle has-icon-left has-icon-right search-example" id="searchboxExample">
										    <input id="_xstorage_name" readonly="readonly" type="text" class="form-control search-input curp" placeholder="请选择" onclick="vf.selectStorage();" />
										  </div>
										  <span class="input-group-btn">
										    <button class="btn btn-primary  btn-sm" onclick="vf.selectStorage();" type="button">选择</button>
										  </span>
										</div>
									</td>
				                </tr>
				                <tr>
				                     <td>备注</td>
				                    <td colspan="3"><input type="text" class="form-control" id="_xremark"  onkeydown="if(event.keyCode == 13)vf.save();"  /></td>
				                </tr>
				            </table>
					    </form>
			      </div>
			      <div class="panel-footer">
				    <div class="alert alert-info-inverse with-icon">
					    <i class="icon-info-sign"></i>
					    <div class="content">
					    	<h1>关于记账单冲红的说明</h1>
					    	<hr>
					    	<p class="lead">
						   		 寄售类物料，科室确认消耗，产生记帐单，之后因各种原因，需要将物料退回运营仓库。称为记帐单红冲，制作记帐单红冲单据，完成物料入库，库存增加，同时生成新的记帐单，数量为负数，完成对原有物料记帐的单的红冲。
					    	</p>
					    </div>
					  </div>
				  </div>
			    </div>
			  </div>
			</div>
		</div>
		<div class="col-xs-9">
			 <div  id="divGrid" class="PanelA" style="margin-top:5px;">
		        <div id="divGridDtl" style="height:250px;cursor:pointer;"></div>
		    </div>
		</div>
	</div>   
</div> 
</body>
</html>
<script type="text/javascript">
var gridDtl=null,_xbill_type=gId("_xbill_type");//明细网格、记账单来源控件
//窗口加载后调用
function formLoad() {
   
    //明细网格高度
    var restHeight = win.p.height - gId("divGridDtl").offsetTop - 20;
    if (restHeight < 250) {
        restHeight = 250;
    }
    gId("divGridDtl").style.height = restHeight-40 + "px";
	
    //初始化下拉框记账单来源
	vf.initDropDownBillType();
	
    //明细网格
    vf.showGridDtl(-1);
}

 //表单状态更新后执行
  vf.afterSetStatus = function () {
      if("addnew".equals(vf.status)){		//新增时
      	$(vf.toolbar.Bars["save"].dom).text("红冲");
      }else{//查看时只保留关闭按钮
      	$(vf.toolbar.Bars["addnew"].dom).hide();
      	$(vf.toolbar.Bars["save"].dom).hide();
      	//uview所选数据
      	var rowSelect=win.para.dtbViewOne.rows[0];
      	
      	//记账单
      	try{
	      	frm._xbill_key.value=rowSelect.bill_key.value;
	      	//入库库存地
	      	frm._xstorage_name.value=rowSelect.office_name.value;
	      	//备注
	      	frm._xremark.value=rowSelect.bill_remark.value;
	        vf.showGridDtl(rowSelect.bill_sp_id.value);
      	}catch(e){};
      	zuiExt.disabled("#frm *",true);
        zuiExt.hide(".fa-chevron-down",true);
        zuiExt.hide("span[require=1]",true);
        $(".curp").removeClass("curp");
       	$('tr[filter="1"]').hide();
      }
       //设置了工位的，绑定到默认库存地
	    if (jsoStorage.getStationStorage().stationStorageId) {
	    	var stationStorage=jsoStorage.getStationStorage();
	        gId("_xstorage_id").value=stationStorage.stationStorageId;  
	        gId("_xstorage_name").value=stationStorage.stationStorageName;  
	    }
   };
    
//网格明细
vf.showGridDtl=function(bill_sp_id) {
        var gridViewFilter = "bill_sp_id =" + bill_sp_id;
        if (gridDtl == null) {
            var prop = {
                divContainer: gId("divGridDtl"),
                viewKey: "rfdu_bill_sp_dtl",
                viewFilter: gridViewFilter,
            };
            gridDtl = new window.xwf_gridview(prop);
        }
        else {
            gridDtl.setViewFilter(gridViewFilter);
        }
        gridDtl.selectAll(true);
}

//初始化下拉框记账单来源
vf.initDropDownBillType=function() {
 if (g.a.send("processType=h_spd.refund_du.View_billspRfdu&actionType=getBillType", {viewKey:"rfdu_bill_sp",filterSql:""}, true)) {
    if (g.a.OK) {
        var dtbSource = g.a.cReturn.dtbDataSource;
       	 var jsonProp = {
                txtHost: _xbill_type,
                dtbSource: dtbSource,
                visibleSN: true,
                rowClick:function(para) {
		            var dataRow = para.dataRow;
		            //更改记账单来源，清空所选记账单以及明细网格
		            if(!dataRow.wo_type.value.equals(_xbill_type.underValue)){
		            	frm._xbill_key.value="";
        				frm._xbill_sp_id.value="";
       				    vf.showGridDtl(-1);
		            }
			        return true;
		    	}
        };
        _xbill_type.dropdown = new window.xwf_dropdown(jsonProp);
    }
 }
}

//选择记账单,必须先选择记账单来源
vf.selectBill=function() {
	var prop = {
        title: "请选择需要冲红的记账单(记账单来源:"+_xbill_type.value+")",
        width: 0.6,
        height: 0.8,
        parent: win
    };
    var viewFilter="";
    if(_xbill_type.underValue) viewFilter=" t4.wo_type='"+_xbill_type.underValue+"'";
    
    var para = {
        viewKey: "rfdu_bill_sp_select",
        viewFilter:viewFilter ,
        selectCallback: function(dr) {
        	frm._xbill_key.value=dr["bill_key"].value;
        	frm._xbill_sp_id.value=dr["bill_sp_id"].value;
        	vf.showGridDtl(dr["bill_sp_id"].value);
	        return true;
	    }
    };
    topWin.openSelectView(prop, para);
}

//选择库存地,只允许选择物理库存地
vf.selectStorage=function() {
	jsoStorage.selectStorage({title:"请选择入库库存地..."}, { selectPhysicalStorage: true,selectFilter:" (storage_is_physical=1 or  node_key='000')", callback: function(para) {
		var drRow = para.node.drRow;
		frm._xstorage_id.value = drRow["storage_id"].value;
        frm._xstorage_name.value = drRow["storage_name"].value;
	}});
}

//保存前方法
vf.beforeSave = function () {
    //记账单
    if ("".equals(gId("_xbill_sp_id").value)) {
	    vf.selectBill();
        return false;
    }
    //记账单
    if ("".equals(gId("_xstorage_id").value)) {
        vf.selectStorage();
        return false;
    }
    
    //所选记账单明细
    var ckIds=[];
    for (var i = 0; i < gridDtl.dtbViewData.rowCount; i++) {
         if (gridDtl.dtbViewData.rows[i].checked) {
             ckIds.push(gridDtl.dtbViewData.rows[i]["bill_sp_dtl_id"].value);
         }
    }
    if(ckIds.length<1){
    	zuiExt.msg({msg:"请在右侧记账单明细网格至少选中一条数据",type:"warning"});
    	return false;
    }
    if (!showConfirm("确认进行红冲操作么？")) return false;  
   	//执行红冲操作
   	vf.submitRedCancel(ckIds.join(","));
   	
    return false;
}

//执行红冲操作
vf.submitRedCancel=function(bill_sp_dtl_ids) {
 var param={};
 param.viewKey="rfdu_bill_sp";
 param.bill_sp_id=gId("_xbill_sp_id").value;
 param.bill_sp_dtl_ids=bill_sp_dtl_ids;
 param.storage_id=frm._xstorage_id.value;
 param.bill_key=frm._xbill_key.value;
 param.bill_remark=frm._xremark.value;

 if (g.a.send("processType=h_spd.refund_du.View_billspRfdu&actionType=billRfdu",param, true)) {
    if (g.a.OK) {
        var cReturn = g.a.cReturn;
        var msg=cReturn.info?"红冲操作执行成功"+cReturn.info:"红冲操作执行成功"
    	zuiExt.msg({msg:msg,type:"success"});
    	setTimeout(function(){
    		//刷新父网格
    		win.para.gridView.refresh();
	    	vf.close();
    	},2000);
    }
 }
}
</script>