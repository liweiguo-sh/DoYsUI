<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>创建供应商</title>
    <link rel="stylesheet" href="../../../../res_plugin/zui-1.8.1-dist/css/zui.min.css" />
    <link rel="stylesheet" href="../../../../res_plugin/zui-1.8.1-dist/lib/chosen/chosen.min.css" />
    <script src="../../../../res_plugin/jquery/jquery-3.1.1.min.js"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.min.js"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/lib/chosen/chosen.min.js"></script>
    <script src="../../js/xwf.js"></script>
    <script src="../../../../res/jscript/xwf.ajax.js"></script>
    <script src="../../../../res/jscript/xwf.const.js"></script>
    <script src="../../../../res/jscript/xwf.datatable.js"></script>
    <style>
        body,
        .app {
            width: 100%;
            height: 100%;
            margin: 0;
        }
        
        .container-fluid {
            border: solid 1px #428BCA;
        }
        
        form {
            margin-top: 50px;
        }
        
        label {
            height: 32px;
            line-height: 32px;
            font-size: 16px;
            font-weight: 500;
        }
        
        .form-horizontal label.required::after {
            right: -10px;
        }
        
        .form-horizontal legend {
            margin-bottom: 80px;
        }
        
        .help-block.help-block-error {
            color: #ea644a;
        }
    </style>
</head>

<body>
    <div class="app" id="app">
        <div class="container">
            <div class="row">
                <div class="col-md-12 col-lg-12">
                    <form class="form-horizontal">
                        <fieldset>
                            <legend>账号信息</legend>
                            <div class="form-group row">
                                <div class="col-md-1 col-lg-1 col-md-offset-1 col-lg-offset-1">
                                    <label for="companyName" class="required">企业名称</label>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <input type="text" class="form-control" id="companyName" placeholder="请输入企业名称" data-toggle="popover" data-container="body" data-content="企业全称，确保和工商营业执照上的名称保持一致" onkeyup="verifyCompanyName(event.target.value);" />
                                    <div class="help-block help-block-error companyName-error"></div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-1 col-lg-1 col-md-offset-1 col-lg-offset-1">
                                    <label for="userName" class="required">用户名</label>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <input type="text" class="form-control" id="userName" placeholder="请输入用户名" data-toggle="popover" data-container="body" data-content="5-20位，下列字符不能在用户名中出现：/\'$%^&*" onkeyup="verifyUserName(event.target.value)" />
                                    <div class="help-block help-block-error userName-error"></div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-1 col-lg-1 col-md-offset-1 col-lg-offset-1">
                                    <label for="userPassword" class="required">登录密码</label>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <input type="password" class="form-control" id="userPassword" placeholder="请输入登录密码" data-toggle="popover" data-container="body" data-content="密码长度6-20位，不能和用户名相同" onkeyup="verifyUserPassword(event.target.value)" />
                                    <div class="help-block help-block-error userPassword-error"></div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-1 col-lg-1 col-md-offset-1 col-lg-offset-1">
                                    <label for="confirmPassword" class="required">确认密码</label>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <input type="password" class="form-control" id="confirmPassword" placeholder="请确认密码" data-toggle="popover" data-container="body" data-content="请确保和输入的登录密码一致" onkeyup="verifyConfirmPassword(event.target.value)" />
                                    <div class="help-block help-block-error confirmPassword-error"></div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-1 col-lg-1 col-md-offset-1 col-lg-offset-1">
                                    <label for="certNo" class="required">证照号码</label>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <input type="text" class="form-control" id="certNo" placeholder="请输入证照号码" data-toggle="popover" data-container="body" data-content="不能为空" />
                                    <div class="help-block help-block-error certNo-error"></div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-1 col-lg-1 col-md-offset-1 col-lg-offset-1">
                                    <label for="hospital-select" class="required">医疗机构</label>
                                </div>
                                <div class="col-md-8 col-lg-8">
                                    <select data-placeholder="请选择下属医院" class="chosen-select form-control" id="hospital-select"></select>
                                    <div class="help-block help-block-error hospitalId-error"></div>
                                </div>
                            </div>
                            <div class="form-group row">
                                <div class="col-md-9 col-lg-9 col-md-offset-1 col-lg-offset-1">
                                    <button class="btn btn-primary btn-block" type="button" onclick="company.submitAccount()">一键创建</button>
                                </div>
                            </div>
                        </fieldset>
                    </form>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    function Company() {}

    Company.prototype = {
        constructor: Company,
        init: init,
        getHospitals: getHospitals,
        formatObjectData: formatObjectData,
        verifyCompanyName: verifyCompanyName, // 验证企业名
        verifyUserName: verifyUserName, // 验证用户名
        verifyUserPassword: verifyUserPassword, // 验证登录密码
        verifyConfirmPassword: verifyConfirmPassword, // 验证确认密码
        submitAccount: submitAccount
    }

    var company = new Company();
    company.init();
    company.getHospitals();

    function init() {
        // 初始化页面的宽高
        document.querySelector('html').style.width = window.innerWidth + 'px';
        document.querySelector('html').style.height = window.innerHeight + 'px';

        // 初始化 select 选择框
        $('select.chosen-select').chosen({
            no_results_text: '暂无数据', // 当检索时没有找到匹配项时显示的提示文本
            disable_search_threshold: 10, // 10 个以下的选择项则不显示检索框
            search_contains: true // 从任意位置开始检索
        });

        // 初始化输入框提示内容
        $("[data-toggle='popover']").popover();
    }

    function getHospitals() {
        if (g.a.send("processType=g_mshare.account.Account&actionType=getHospitals", {}, true)) {
            if (g.a.OK) {
                $('#hospital-select').html(''); // 每次渲染时，清空 select 数据
                var options = '<option value=""></option>';
                var hospitals = g.a.cReturn.hospitals.rows;
                if (hospitals.length > 0 && hospitals[0] !== "") {
                    var array = company.formatObjectData(hospitals);
                    for (var i = 0, len = array.length; i < len; i++) {
                        options = options + '<option value="' + array[i]["company_id"] + '">' + array[i]["company_name"] + '</option>';
                    }
                } else {
                    new $.zui.Messager('暂无医疗机构数据', {
                        type: 'warning'
                    }).show();
                    return false;
                }
                $('#hospital-select').html(options).trigger('chosen:updated');
            } else {
                new $.zui.Messager('获取医疗机构请求失败', {
                    type: 'danger'
                }).show();
                return false;
            }
        }
    }

    function formatObjectData(arr) {
        var array = [],
            len = arr.length;
        for (var i = 0; i < len; i++) {
            var obj = {};
            Object.keys(arr[i]).forEach(function(key) {
                if (isNaN(key) && key !== '$') {
                    obj[key] = arr[i][key].value;
                }
            });
            array.push(obj);
        }
        return array;
    }

    function verifyCompanyName(companyName) {
        if (companyName.trim() != '') {
            $('#companyName').popover('hide');
            $('.companyName-error').html('');
        } else {
            $('.companyName-error').html('企业名称不能为空！');
        }
    }

    function verifyUserName(userName) {
        var reg = /^[^/\\'$%^&*]{5,20}$/ig;
        if (userName.trim() != '') {
            $('#userName').popover('hide');
            if (!reg.test(userName.trim())) {
                $('.userName-error').html("5-20位，下列字符不能在用户名中出现：/\'$%^&*");
            } else {
                $('.userName-error').html('');
            }
        } else {
            $('.userName-error').html('用户名不能为空！');
        }
    }

    function verifyUserPassword(userPassword) {
        var reg = /^.{6,20}$/ig;
        if (userPassword.trim() != '') {
            $('#userPassword').popover('hide');
            if (!reg.test(userPassword.trim())) {
                $('.userPassword-error').html('密码长度为 6-20位');
            } else if (userPassword.trim() === $('#userName').val().trim()) {
                $('.userPassword-error').html('登录密码不能和用户名相同！');
            } else {
                $('.userPassword-error').html('');
            }
        } else {
            $('.userPassword-error').html('登录密码不能为空！');
        }
    }

    function verifyConfirmPassword(confirmPassword) {
        if (confirmPassword.trim() != '') {
            $('#confirmPassword').popover('hide');
            if (confirmPassword.trim() != $('#userPassword').val().trim()) {
                $('.confirmPassword-error').html('确认密码必须和登录密码一致！');
            } else {
                $('.confirmPassword-error').html('');
            }
        } else {
            $('.confirmPassword-error').html('确认密码不能为空！');
        }
    }

    function submitAccount() {
        var companyName = $('#companyName').val();
        var userName = $('#userName').val();
        var userPassword = $('#userPassword').val();
        var confirmPassword = $('#confirmPassword').val();
        var certNo = $('#certNo').val();
        var hospitalId = $('#hospital-select').val();

        // 判断表单不能为空
        if (companyName === '') {
            $('.companyName-error').html('企业名称不能为空！');
            return false;
        } else if (userName === '') {
            $('.userName-error').html('用户名不能为空！');
            return false;
        } else if (userPassword === '') {
            $('.userPassword-error').html('登录密码不能为空！');
            return false;
        } else if (confirmPassword === '') {
            $('.confirmPassword-error').html('确认密码不能为空！');
            return false;
        } else if (certNo === '') {
            $('.certNo-error').html('证件号码不能为空！');
            return false;
        } else if (hospitalId == '') {
            $('.hospitalId-error').html('所属医院必须选择！');
            return false;
        }

        var params = {
            companyName: companyName,
            userName: userName,
            userPassword: userPassword,
            confirmPassword: confirmPassword,
            certNo: certNo,
            hospitalId: hospitalId
        };

        if (g.a.send("processType=g_mshare.account.Account&actionType=setAccountInfo", params, true)) {
            if (g.a.OK) {
                var errMsg = g.a.cReturn.err || '';
                var successMsg = g.a.cReturn.success || '';
                if (errMsg !== '') {
                    new $.zui.Messager(errMsg, {
                        type: 'danger'
                    }).show();
                    return false;
                }

                if (successMsg !== '') {
                    new $.zui.Messager(successMsg, {
                        type: 'success'
                    }).show();
                    // 重置表单
                    $('#companyName').val('');
                    $('#userName').val('');
                    $('#userPassword').val('');
                    $('#confirmPassword').val('');
                    $('#certNo').val('');
                    $('#hospital-select').val('');
                }
            } else {
                new $.zui.Messager('创建供应商账户失败', {
                    type: 'danger'
                }).show();
                return false;
            }
        }
    }
</script>

</html>