<!DOCTYPE html>
<html>

<head>
    <title>推送单</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/tab/xwf.tab.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }
        
        #divGridM,
        #divGridC {
            height: 400px;
        }
    </style>
</head>

<body>
    <div id="divDC"></div>
    <form id="frm" action="" target="g_mshare.push.VIEW_Push">
        <table id="tbForm" class="tbForm" style="width: 705px;">
            <tr class="trH">
                <th style="width: 150px;"></th>
                <th style="width: 200px;"></th>
                <th style="width: 150px;"></th>
                <th style="width: 200px;"></th>
            </tr>
            <tr>
                <td>单号</td>
                <td><input type="text" id="_cPush_key" value="" disabled="disabled" /></td>
                <td>日期</td>
                <td><input type="text" id="_cPush_date" class="Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" /></td>
            </tr>
            <tr>
                <td>接收机构</td>
                <td colspan="3"><input type="text" id="_cCompany_id_to" controltype="dropdown" fieldValue="company_id" fieldText="company_name" fieldsVisible="company_name" /></td>
            </tr>
            <tr>
                <td>标题</td>
                <td colspan="3"><input type="text" id="_cPush_title" value="" /></td>
            </tr>
            <tr>
                <td>备注</td>
                <td colspan="3"><textarea id="_cPush_remark" rows="3" cols="0"></textarea></td>
            </tr>
        </table>
        <input id="_cPUSH_ID" type="hidden" value="" />
        <input id="_cAstatus" type="hidden" value="" />
        <input id="_cStatus_receive" type="hidden" value="" />
    </form>
    <div id="divTab" class="xwf_tab_divContainer" style="width: 700px;">
        <div id="divGridM"></div>
        <!--<div id="divGridC"></div>-->
    </div>
</body>

</html>

<!-- formLoad -->
<script type="text/javascript">
    var gridviewM = null;
    var gridviewC = null;

    var divGridM = gId("divGridM");
    var divGridC = gId("divGridC");

    var winSelectC = null;
    // ------------------------------------------------------------------------
    function formLoad() {
        vf.css(gId("tbForm"));

        tabs = new window.xwf_tab({
            divContainer: gId("divTab"),
            tabClick: tab_click
        });
        tabs.addTab({
            key: "tabM",
            text: "耗材列表",
            control: divGridM
        });
        //tabs.addTab({ key: "tabC", text: "资质列表", control: divGridC });
    }

    function tab_click(tab) {
        var pushId = frm._cPUSH_ID.value.toInt();

        if (tab.key == "tabM") {
            if (gridviewM == null) {
                var prop = {
                    divContainer: divGridM,
                    viewKey: "push_matr",
                    viewFilter: "push_id = " + pushId,
                    toolbarVisible: true,
                    viewForm: "",
                    showDeleteColumn: vf.buttons["save"].style.display.equals(""),
                    jsonToolbar: {
                        height: "M",
                        onclick: onToolbarClickM
                    }
                };
                gridviewM = new window.xwf_gridview(prop);

                // 制单和已退回状态下可添加耗材
                if (frm._cAstatus.value == 0 && (frm._cStatus_receive.value == 0 || frm._cStatus_receive.value == 1)) {
                    gridviewM.toolbar.addBar({
                        type: "button",
                        key: "addMatr",
                        text: "<i class='fa fa-plus'></i>  添加耗材"
                    });
                }
            } else {
                gridviewM.setViewFilter("push_id = " + pushId);
            }
        }
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterAddnew = function() {
        frm._cPush_date.value = (new Date).toString();
        frm._cAstatus.value = "0";
        frm._cStatus_receive.value = "0";
    };

    vf.afterMove = function() {
        tab_click(tabs.tabSelected);
    };

    vf.beforeFlowClick = function(prop) {
        if (prop.fbKey.equals("approve")) {
            if (gridviewM.dtbViewData.rowCount == 0 && gridviewC.dtbViewData.rowCount == 0) {
                showErr("请先选择要推送的耗材 或 资质。");
                return false;
            }
        }
        return true;
    };
</script>

<!-- 添加推送耗材、资质 -->
<script type="text/javascript">
    function onToolbarClickM(para) {
        if (para.key.equals("addMatr")) {
            if (frm._cPUSH_ID.value.toInt() == 0) {
                if (!vf.save()) {
                    return;
                }
            }

            var companyIdTo = frm._cCompany_id_to.underValue;
            var prop = {
                title: "请选择要推送的耗材（已推送耗材已过滤）",
                width: 0.8,
                height: 0.8,
                parent: win
            };
            var para = {
                viewKey: "matr_push_select",
                viewFilter: "matr_id NOT IN (SELECT matr_id FROM T_PUSH m INNER JOIN T_PUSH_MATR d ON m.push_id = d.push_id WHERE company_id = '%companyId%' AND company_id_to = " + companyIdTo + ")",
                viewMode: "multiSelect",
                selectCallback: onMatrSelect
            };
            topWin.openSelectView(prop, para);
        } else {
            showErr("unknown button " + para.key);
        }
    }

    function onMatrSelect(arrRows) {
        var pushId = frm._cPUSH_ID.value.toInt();
        var matrIds = "";
        var arrMatrIds = new Array();
        var dataRow = null;

        for (var i = 0; i < arrRows.length; i++) {
            dataRow = arrRows[i];
            arrMatrIds.push(dataRow["matr_id"].value);
        }
        matrIds = arrMatrIds.join(",");

        if (g.a.send("processType=g_mshare.push.VIEW_Push&actionType=addMatr", {
                viewKey: "push",
                pushId: pushId,
                matrIds: matrIds
            }, true)) {
            if (g.a.OK) {
                gridviewM.refresh();
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
</script>