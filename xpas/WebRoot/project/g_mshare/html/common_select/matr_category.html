<!DOCTYPE html>
<html>
<head>
    <title>耗材品类选择...</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <style type="text/css">
        body {
            overflow: hidden;
        }

        #divTree {
            overflow: auto;
            width: 600px;
            height: 200px;
        }
    </style>
</head>
<body scroll="no">
    <div id="divToolbar"></div>
    <div class="PanelA" style="margin-top:5px;">
        <div id="divTree"></div>
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var divToolbar = gId("divToolbar");
    var divTree = gId("divTree");

    var multiSelect = false;        // -- true：多选模式；false：单选模式 --
    var allowSelectRoot = false;    // -- true：允许选择根节点；false：不允许选择根节点 --

    var tree = null;
    var toolbar = null;

    var categoryType = urlPara["category_type"];
    // ----------------------------------------------------
    function formLoad() {
        multiSelect = (win.para.multiSelect ? true : false);

        var json = {
            domContainer: divToolbar,
            height: "M",
            onclick: barClick
        };
        toolbar = new window.xwf_toolbar(json);
        toolbar.addBar({ type: "button", key: "select", align: "left", icon: null, text: "<i class='fa fa-check'></i> 确定" });
        toolbar.addBar({ type: "button", key: "close", align: "left", icon: null, text: "<i class='fa fa-close'></i>  关闭" });

        divTree.style.height = (0.8 * win.p.maxHeight) + "px";
        initTree();
    }
</script>

<!-- 加载分类 -->
<script type="text/javascript">
    function initTree() {
        var showCheckBoxs = "";
        if (multiSelect) {
            showCheckBoxs = "all";
        }
        var rootNodeKey = "";
        var jsonPara = {
            divContainer: gId("divTree"),
            imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
            title: "品类导航",
            showCheckBoxs: showCheckBoxs,
            selecteMode: "single",
            beforeExpand: beforeNodeExpand
        };
        tree = new window.xwf_tree(jsonPara);

        var categoryId = 1;
        rootNodeKey = "0" + tree.sd + categoryId;
        tree.addNode({ key: rootNodeKey, text: "品类总节点", categoryId: categoryId });
        tree.addNode({ key: rootNodeKey + tree.sd + "loading", text: "loading..." });

        tree.expand(rootNodeKey);
    }
    function beforeNodeExpand(node, firstExpand) {
        if (!firstExpand) return;
        tree.removeNode(node.key + tree.sd + "loading");

        loadCategoryNode(node.key, node.categoryId);
    }

    function loadCategoryNode(pNodeKey, categoryId) {
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=getCategoryNodeData", { categoryType: categoryType, categoryId: categoryId }, true)) {
            if (g.a.OK) {
                var c = g.a.cReturn;
                var dtb = c.dtb;
                for (var i = 0; i < dtb.rowCount; i++) {
                    var categoryId = dtb.rows[i]["category_id"].value;
                    var categoryName = dtb.rows[i]["category_name"].value;
                    var categoryFullname = dtb.rows[i]["category_fullname"].value;
                    var lastCategory = (dtb.rows[i]["category_is_last_node"].value == 1 ? true : false);
                    var title = "";

                    if (g.debug) {
                        title = categoryId + " - " + categoryName;
                    }

                    tree.addNode({ key: pNodeKey + tree.sd + categoryId, text: categoryName, title: title, categoryId: categoryId, categoryFullname: categoryFullname, lastCategory: lastCategory });
                    // -- 加载虚拟子节点 ------------------
                    if (!lastCategory) {
                        tree.addNode({ key: pNodeKey + tree.sd + categoryId + tree.sd + "loading", text: "loading..." });
                    }
                }
            }
            else {
                return;
            }
        }
        else {
            return;
        }
    }
</script>
<!-- 工具条 -->
<script type="text/javascript">
    function barClick(para) {
        var paraCallback = {};
        if (para.key.equals("select")) {
            if (multiSelect) {
                var arrKeys = tree.getCheckedKeys();
                if (arrKeys.length == 0) {
                    showErr("请先勾选品类节点。");
                    return false;
                }

                var node = null;
                var arrReturn = new Array();
                for (var i = 0; i < arrKeys.length; i++) {
                    node = tree.nodes[arrKeys[i]];
                    arrReturn.push(node.categoryId);
                }
                paraCallback.categoryIds = arrReturn.join(",");                
            }
            else {
                if (!tree.selectedNode) {
                    showErr("请先选择品类节点。");
                    return false;
                }
                if (tree.selectedNode.level == 1) {
                    if (!allowSelectRoot) {
                        showErr("请先选择品类节点(不能选择根节点)。");
                        return false;
                    }
                }
                paraCallback.categoryId = tree.selectedNode.categoryId;
                paraCallback.categoryFullname = tree.selectedNode.categoryFullname;
            }
            win.para.callback(paraCallback);
            win.close();
        }
        else if (para.key.equals("close")) {
            win.close();
        }
        else {
            showErr("unknown button " + para.key);
        }
    }
</script>