<!DOCTYPE html>
<html>

<head>
    <title>耗材选择...</title>
    <script src="../../../../res/jscript/xwf.js"></script>
    <script src="../../../../res/jscript/xwf.ajax.js"></script>
    <script src="../../../../res/jscript/xwf.const.js"></script>

    <script src="../../../../res/control/tree/xwf.tree.js"></script>

    <script src="../../../../res/jscript/xwf.css.js"></script>
    <style type="text/css">
        body {
            overflow: hidden;
        }
        
        .divTree {
            overflow: auto;
            width: 700px;
            height: 500px;
        }
        
        .divTree::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>

<body scroll="no">
    <div id="divToolbar"></div>
    <div class="PanelA" style="margin-top:5px;">
        <div id="divTree" class="divTree"></div>
    </div>
</body>

</html>

<!-- formLoad -->
<script type="text/javascript">
    var divToolbar = gId("divToolbar");
    var divTree = gId("divTree");

    var existNonLastNodeMatr = true; // -- 存在非末级节点物料 --

    var tree = null;
    var toolbar = null;

    var selecteMode = "single";
    var showCheckBoxs = "none";

    var categoryType = urlPara["category_type"];
    // ----------------------------------------------------
    function formLoad() {
        //selecteMode = win.para["selecteMode"];
        //showCheckBoxs = win.para["showCheckBoxs"];
        var json = {
            domContainer: divToolbar,
            height: "M",
            onclick: barClick
        };
        toolbar = new window.xwf_toolbar(json);
        toolbar.addBar({
            type: "button",
            key: "select",
            align: "left",
            icon: null,
            text: "<i class='fa fa-check'></i> 确定"
        });
        toolbar.addBar({
            type: "button",
            key: "close",
            align: "left",
            icon: null,
            text: "<i class='fa fa-close'></i>  关闭"
        });

        divTree.style.height = (0.8 * win.p.maxHeight) + "px";
        initTree();
    }
</script>

<!-- 加载分类 -->
<script type="text/javascript">
    function initTree() {
        var rootNodeKey = "";
        var jsonPara = {
            divContainer: gId("divTree"),
            imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
            title: "耗材导航",
            showCheckBoxs: showCheckBoxs,
            selecteMode: selecteMode,
            beforeExpand: beforeNodeExpand
        };
        tree = new window.xwf_tree(jsonPara);

        var categoryId = 1;
        rootNodeKey = "0" + tree.sd + categoryId;
        tree.addNode({
            key: rootNodeKey,
            text: "品类总节点",
            categoryId: categoryId
        });
        tree.addNode({
            key: rootNodeKey + tree.sd + "loading",
            text: "loading..."
        });

        tree.expand(rootNodeKey);
    }

    function beforeNodeExpand(node, firstExpand) {
        if (!firstExpand) return;
        tree.removeNode(node.key + tree.sd + "loading");

        if (node.lastCategory) {
            loadMatrNode(node.key, node.categoryId);
        } else {
            loadCategoryNode(node.key, node.categoryId);
            if (existNonLastNodeMatr) {
                loadMatrNode(node.key, node.categoryId);
            }
        }
    }

    function loadCategoryNode(pNodeKey, categoryId) {
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=getCategoryNodeData", {
                categoryType: categoryType,
                categoryId: categoryId
            }, true)) {
            if (g.a.OK) {
                var c = g.a.cReturn;
                var dtb = c.dtb;
                for (var i = 0; i < dtb.rowCount; i++) {
                    var categoryId = dtb.rows[i]["category_id"].value;
                    var nodeText = dtb.rows[i]["category_name"].value;
                    var lastCategory = (dtb.rows[i]["category_is_last_node"].value == 1 ? true : false);
                    var title = "";

                    if (g.debug) {
                        title = categoryId + " - " + nodeText;
                    }

                    tree.addNode({
                        key: pNodeKey + tree.sd + categoryId,
                        text: nodeText,
                        categoryId: categoryId,
                        title: title,
                        lastCategory: lastCategory
                    });
                    tree.addNode({
                        key: pNodeKey + tree.sd + categoryId + tree.sd + "loading",
                        text: "loading..."
                    });
                }
            } else {
                return;
            }
        } else {
            return;
        }
    }

    function loadMatrNode(pNodeKey, categoryId) {
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=getMatrNodeData", {
                categoryId: categoryId
            }, true)) {
            if (g.a.OK) {
                var c = g.a.cReturn;
                var dtb = c.dtb;
                for (var i = 0; i < dtb.rowCount; i++) {
                    var matrId = dtb.rows[i]["matr_id"].value;
                    var matrName = dtb.rows[i]["matr_name"].value;
                    var matrSpec = dtb.rows[i]["matr_spec"].value;
                    var matrText = matrName + " (" + matrSpec + ")";
                    var title = matrSpec;

                    if (!g.debug) {
                        title = matrId + " - " + matrText;
                    }

                    tree.addNode({
                        key: pNodeKey + tree.sd + matrId,
                        text: matrText,
                        matrId: matrId,
                        title: title,
                        showCheckBox: true
                    });
                }
            } else {
                return;
            }
        } else {
            return;
        }
    }
</script>
<!-- 工具条 -->
<script type="text/javascript">
    function barClick(para) {
        if (para.key.equals("select")) {
            var arrKeys = tree.getCheckedKeys();
            if (arrKeys.length == 0) {
                showErr("请选中要添加的耗材。");
                return false;
            }

            var node = null;
            var arrReturn = new Array();
            for (var i = 0; i < arrKeys.length; i++) {
                node = tree.nodes[arrKeys[i]];
                if (node.matrId) {
                    arrReturn.push(node.matrId);
                }
            }
            win.para.callback({
                matrIds: arrReturn.join(",")
            });
            win.close();
        } else if (para.key.equals("close")) {
            win.close();
        } else {
            showErr("unknown button " + para.key);
        }
    }
</script>