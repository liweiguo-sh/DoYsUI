<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>品类管理</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

	<style type="text/css">
		body {
			overflow: hidden;
		}
		#tbLayout {
			 border-collapse: collapse;
		}
		.tdLayout {
			padding: 0px;
			border-bottom: solid 0px red;
			vertical-align: top;
		}
		#divTree {
			width:320px;
			overflow: auto;
		}
		#divGrid {
			border: solid 0px red;
		}
	</style>
</head>
<body scroll="no">

	<table id="tbLayout">
		<tr>
			<td style="width:320px;" class="tdLayout"><div id="divTree"></div></td>
			<td id="tdLayoutRight" class="tdLayout pageButtons">
				<div>
					<input id="btnAddnew" type="button" value="添加(A)" onclick="return btnAddnew_click()" />
					<input id="btnClose" type="button" value="关闭(C)" onclick="return btnClose_click();" />
					<div id="divGrid" style="margin-top:5px;"></div>
				</div>
			</td>
		</tr>
	</table>

</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var divTree = gId("divTree");
	var divButton = gId("divButton");
	var divGrid = gId("divGrid");
	var tree = null;
	var gridView = null;
	var topWin = null;
	// ----------------------------------------------------
	function formLoad() {
		topWin = win.p.topWin;
		divTree.style.height = (win.p.height - 2) + "px";
		divGrid.style.height = (win.p.height - divGrid.offsetTop - 6) + "px";
		divGrid.style.width = (win.p.width - divTree.offsetWidth - 6) + "px";

		initTree();
	}
</script>

<!-- 加载机构 -->
<script type="text/javascript">
	function initTree() {
		var rootNodeKey = "";
		var jsonPara = {
			divContainer: gId("divTree"),
			imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
			title: "品类设定",
			beforeExpand: beforeNodeExpand,
			nodeClick: onNodeClick
		};
		tree = new window.xwf_tree(jsonPara);

		rootNodeKey = "0" + tree.sd + "1";
		tree.addNode({ key: rootNodeKey, text: "品类总节点", categoryId: 1, nodeKey: "000" });
		tree.addNode({ key: rootNodeKey + tree.sd + "loading", text: "loading..." });

		tree.expand(rootNodeKey);
		tree.textClick(rootNodeKey);		
	}
	function loadTreeNodes(pNodeKey, categoryId) {
		if (g.a.send("processType=g_mshare.base.mart_Category&actionType=getCategoryNodeData", { categoryId: categoryId, viewKey: "mart_category" }, true)) {
			if (g.a.OK) {
				var c = g.a.cReturn;
				var dtb = c.dtbCategoryNodeData;
				for (var i = 0; i < dtb.rowCount; i++) {
					var node_key = dtb.rows[i]["node_key"].value;
					var nodeText = dtb.rows[i]["category_name"].value;
					var categoryId = dtb.rows[i]["mart_category_id"].value;

					var nodeKey = node_key.substring(0, 3);
					for (var j = 1; j < node_key.length / 3; j++) {
						nodeKey += tree.sd + node_key.substring(3 * j, 3 * j + 3);
					}
					tree.addNode({ key: pNodeKey + tree.sd + categoryId, text: nodeText, categoryId: categoryId, nodeKey: node_key });
					// -- 加载虚拟子节点 ------------------
					if (dtb.rows[i]["children"].value > 0) {
                        tree.addNode({ key: pNodeKey + tree.sd + categoryId + tree.sd + "loading", text: "loading..." + dtb.rows[i]["children"].value });
					}
				}
			}
			else {
				return;
			}
		}
		else {
			return;
		}
	}
	function beforeNodeExpand(node, firstExpand) {
		if (!firstExpand) return;
		tree.removeNode(node.key + tree.sd + "loading");

		loadTreeNodes(node.key, node.categoryId);
	}

	function onNodeClick(node) {
		if (node.level > 3) {
			gId("btnAddnew").style.visibility = "hidden";
		} else {
			gId("btnAddnew").style.visibility = "visible";
		}
		if (gridView == null) {
			var prop = {
				divContainer: divGrid,
				viewKey: "mart_category",
				viewForm: g.appPath + "project/g_mshare/html/base/mart_category.html",
				viewFilter: "category_id_parent = " + node.categoryId
			};
			gridView = new window.xwf_gridview(prop);
		}
		else {
			gridView.setViewFilter("category_id_parent = " + node.categoryId);
		}
	}
</script>

<!-- addnew、close -->
<script type="text/javascript">
	function btnAddnew_click() {
		gridView.addnew();
	}

	function btnClose_click() {
		win.close();
	}
</script>