<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>新增产品</title>
    <link href="../../../../res_plugin/bootstrap3.7/bootstrap/css/bootstrap.min.css"     rel="stylesheet" type="text/css" />
    <link href="../../../../res_plugin/bootstrap3.7/bootstrap-table/css/bootstrap-table.css"      rel="stylesheet" type="text/css" />
	<link href="../../../../res_plugin/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet"	type="text/css" />
    <script src="../../../../res_plugin/jquery/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table-local-zh-CN.js" type="text/javascript"></script>
	<!-- 日期选择 -->
	<link href="../../../../res_plugin/bootstrap3.7/dtpicker/css/bootstrap-datetimepicker.min.css" rel="stylesheet" type="text/css" />
	<script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/bootstrap-datetimepicker.min.js"	type="text/javascript"></script>
	<script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/locales/bootstrap-datetimepicker.zh-CN.js"	type="text/javascript"></script>

    <script src="../../js/rstodata.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
    <script src="../../../../res/control/toolbar/xwf.toolbar.js" type="text/javascript"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
    <script src="../../../../res/control/upload/xwf.upload.js" type="text/javascript"></script>
    <script src="../../../../res/control/upload/xwf.upload_core.js" type="text/javascript"></script>

    <script src="../../../../res_plugin/util/chinese_py.js" type="text/javascript"></script>
    <script src="../../js/doc_center.js" type="text/javascript"></script>
    <style type="text/css">
        body
        {
            background-color: lightGray;
        }
        .self-panel-main
        {
			width:80%;
			margin-left:auto;
			margin-right:auto;
			margin-top:20px;
            background-color: White;
            box-shadow: 3px 3px 3px #888888;
            padding: 80px;
        }
       
        .div-title
        {
            font-size: 1.3em;
            font-family: 微软雅黑;
            color: #3498DB;
            width: 100%;
            border-bottom: 1px solid #3498DB;
        }
        .div-input-info
        {
            font-size: 0.9em;
            font-family: 微软雅黑;
            color: #2C3E50;
            width: 90%;
            margin-left: 20px;
            margin-top: 50px;
			margin-bottom: 50px;
        }
		.form-group label{
			color:Gray;
		}
        #divProductCert th
        {
            background-color: #3498DB;
            color: White;
            font-size: 0.9em;
            text-align: center;
        }
    </style>
</head>
<body>
	
    <div class="self-panel-main" style="">
        <form id="frm" role="form" action="" onsubmit="return false;" target="g_mshare.base.product">
			<!--区域1 -->
		
			<div class="div-title" style="border:0px;">基本信息</div>
			<div class="div-title"></div>
			<br />
			<br />
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>产品分类：</label></div>
				<div class="col-xs-4">
					<div class="input-group">
						<input type="text"  class="form-control" id="_gCategory_name" />
						<span class="input-group-addon"><i class="fa fa-search" style="cursor:pointer;" data-toggle="modal" data-target="#choseProductCate"></i></span>
					</div>
				</div>
				<div class="col-xs-5"></div>
			</div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>注册名称<span style="color:red">&nbsp;*</span>：</label></div>
				<div class="col-xs-6"><input type="text"  class="form-control" id="_cMatr_name" disabled="disabled"/></div>
				<div class="col-xs-3"></div>
			</div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>商品名：</label></div>
				<div class="col-xs-6"><input type="text"  class="form-control" id="_cMatr_trade_name" disabled="disabled"/></div>
				<div class="col-xs-3"></div>
			</div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>规格<span style="color:red">&nbsp;*</span>：</label></div>
				<div class="col-xs-4"><input type="text"  class="form-control" id="_cMatr_spec" disabled="disabled"/></div>
				<div class="col-xs-5"></div>
			</div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>剂型<span style="color:red">&nbsp;*</span>：</label></div>
				<div class="col-xs-4"><input type="text"  class="form-control" id="_cMatr_dosage" disabled="disabled"/></div>
				<div class="col-xs-5"></div>
			</div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>单位<span style="color:red">&nbsp;*</span>：</label></div>
				<div class="col-xs-2"><input type="text"  class="form-control" id="_cMatr_unit" disabled="disabled"/></div>
				<div class="col-xs-7"></div>
			</div>
            <div class="row form-group">
                <div class="col-xs-3" style="text-align:right;"><label>主码：</label></div>
                <div class="col-xs-4"><input type="text" class="form-control" id="_cMatr_gtin" disabled="disabled"/></div>
                <div class="col-xs-5"></div>
            </div>
            <div class="row form-group">
                <div class="col-xs-3" style="text-align:right;"><label>辅码：</label></div>
                <div class="col-xs-4"><input type="text" class="form-control" id="_cMatr_hibc" disabled="disabled"/></div>
                <div class="col-xs-5"></div>
            </div>
            <div class="row form-group">
                <div class="col-xs-3" style="text-align:right;"><label>内部编码：</label></div>
                <div class="col-xs-4"><input type="text" class="form-control" id="_cErp_code" disabled="disabled"/></div>
                <div class="col-xs-5"></div>
            </div>
			<!--区域1 结束-->
			<!--区域2-->
			<div class="div-title" style="border:0px;">厂商及注册证</div>
			<div class="div-title"></div>
			<br />
			<br />
            <div class="row form-group">
                <div class="col-xs-3" style="text-align:right;"><label>进口：</label></div>
                <div class="col-xs-1"><input type="checkbox" id="_cMatr_is_imported" /></div>
            </div>
            <div class="row form-group">
                <div class="col-xs-3" style="text-align:right;"><label>品牌：</label></div>
                <div class="col-xs-6"><input type="text" class="form-control" id="_cBrand_name" disabled="disabled"/></div>
                <div class="col-xs-3"></div>
            </div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>生产厂商<span style="color:red">&nbsp;*</span>：</label></div>
				<div class="col-xs-6"><input type="text"  class="form-control" id="_cManufacturer_name" disabled="disabled"/></div>
				<div class="col-xs-3"></div>
			</div>
            <div class="row form-group">
                <div class="col-xs-3" style="text-align:right;"><label><span style="color:red">&nbsp;*</span>批准文号：</label></div>
                <div class="col-xs-4"><input type="text" class="form-control" id="_cApproval_no" disabled="disabled"/></div>
                <div class="col-xs-5"></div>
            </div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>注册证号<span style="color:red">&nbsp;*</span>：</label></div>
				<div class="col-xs-4"><input type="text"  class="form-control" id="_cRegister_no" disabled="disabled"/></div>
				<div class="col-xs-5"></div>
			</div>
			<div class="row form-group">
				<div class="col-xs-3"  style="text-align:right;"><label>注册证有效期<span style="color:red">&nbsp;*</span>：</label></div>
				<div class="col-xs-3">
					<div class="input-group date" id="exp_date" data-date="" data-date-format="yyyy-mm-dd">
						<input class="form-control" size="16" type="text" id="_cRegister_exp" disabled="disabled"/>
						<span class="input-group-addon"><span class="glyphicon glyphicon-calendar"></span></span>
					</div>
				</div>
				<div class="col-xs-6"></div>
			</div>
			<!--区域2 结束-->
			<input type="hidden" id="_cmatr_id" />
			<input type="hidden" id="_cCompany_id" />
			<input type="hidden" id="_cCategory_id" />
			<input type="hidden" id="_cmatr_name_py" />
			<input type="hidden" id="_cmatr_trade_name_py" />
            <input type="hidden" id="_cDoc_id" />
			
		</form>
        <!--区域1 结束-->
        <br />
		<br />
		<div id="divProductCert">

           <!-- <div class="div-title" style="border:0px;">产品资料</div>
            <div class="div-title"></div>

            <br />
            <div id="divCertUpload" style="width:100%;height:200px;"></div>-->

			<div class="div-title" style="border: 0px;">产品资料维护</div>
			<div class="div-title"></div>
					
            <div id="toolbar1">
				<button class="btn btn-info" id="btnLoad" data-toggle="modal" data-target="#addProductCert">补充产品资质</button>
			</div>
			<table id="tbMatrDocs" 
				data-toggle="table" 
				data-toolbar="#toolbar1" 
				data-height="500"
				data-sort-name="no" 
				data-sort-order="asc" 
				data-pagination="true" 
				data-search="true"
				data-page-size="10" 
				data-page-list="[10,20,30]" >
				<thead>
					<tr>
						<th data-width="5%" data-field="no">序</th>
						<th data-width="35%" data-field="cert_name" data-sortable="true">资质名称</th>
						<th data-width="10%" data-field="creator">创建者</th>
						<th data-width="25%" data-field="cdate" data-sortable="true">创建时间</th>
						<th data-width="10%" data-field="cert_doc_id" >上传状态</th>
						<th data-width="15%" data-field="operate">操作</th>
					</tr>
				</thead>
			</table>
		</div>	
    </div>
    <div id="divDC" class="ScreenCenter" style="display: none; width: 1000px"></div>
    <!--产品类别选择框-->
    <div class="modal fade" id="choseProductCate" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        ×
                    </button>
                    <h3 class="modal-title">
                        请选择产品类别
                    </h3>

                </div>
                <div class="modal-body">
                    <table style="width:100%">
                        <tr>
                            <td> <input type="text" class="form-control" id="cateName" placeholder="请输入类别名称"></td>
                            <td>
                                <button type="button" class="btn btn-primary" id="btnSubmit" onclick="addcatelog()">
                                    添加类别
                                </button>
                            </td>
                        </tr>
                    </table>
                    <table id="tbCateList" data-toggle="table" data-height="300" data-toolbar="#toolbarCate"
                           data-sort-name="no" data-pagination="true" data-sort-order="asc" data-search="false" data-page-size="100" data-single-select="true">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true">
                                    选择
                                </th>
                                <th data-field="no">
                                    序
                                </th>
                                <th data-field="category_name" data-sortable="true">
                                    类别名称
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    <button type="button" class="btn btn-primary" id="btnSubmit" onclick="choicecate()">
                        确定选择
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!--产品资质选择框 -->
    <div class="modal fade" id="addProductCert" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        ×
                    </button>
                    <h3 class="modal-title">
                        请选择需要补充的产品资质
                    </h3>
                </div>
                <div class="modal-body">
                    <table id="tbProductList" data-toggle="table" data-height="300" data-toolbar="#toolbarProduct"
                           data-sort-name="no" data-pagination="true" data-sort-order="asc" data-search="false" data-page-size="100">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true">
                                    选择
                                </th>
                                <th data-field="no">
                                    序
                                </th>
                                <!--<th data-field="operate">
                                    操作
                                </th>-->
                                <th data-field="cert_category_name" data-sortable="true">
                                    资质名称
                                </th>
                                <th data-field="ext_limit">
                                    类型限制
                                </th>
                                <th data-field="file_max_count">
                                    上传数量限制
                                </th>
                                <th data-field="file_max_size">
                                    上传大小限制/KB
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    <button type="button" class="btn btn-primary" id="btnSubmit" onclick="choiceproduct()">
                        确定选择
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
</body>
</html>
<script type="text/javascript">
    var pWin = null;
    var mmid;
    var my_matr_id;
    var $table = $('#tbMatrDocs');
    var isfresh = true;
    var cert_category_ids = "";
    var company_id_from;
    var is_js = "true";
    var type = 1;
    $(function () {
        pWin = win.parentWindow;
        if (vf.status.equals("view")) { editdata(); }
        win.addEventListener("afterClose",
			function () {
			    if (win.para.callback) {
			        win.para.callback();
			    }
			}
		);
        $('#addProductCert').on('show.bs.modal', function () {
            showproduct();
        })

        $('#choseProductCate').on('show.bs.modal', function () {
            choseProductCate();
        });
    });
    function addcert() {
        var para = {
            flowKey: "",
            viewKey: "",
            isAddnew: false,
            primaryKey: "matr_id," + mmid,
            company_id_from:"company_id_from,"+company_id_from,
            name: "name," + $("#_cMatr_name").val(),
            type:"1",
            is_js:"true",
            callback: callback

        };
        var prop = {
            text: "资质定义",
            url: g.appPath + "project/g_mshare/html/base/cert_add.html"
        };

        top.topWin.openFullWindow(prop, para);

    }

    vf.afterMove = function () {
        if (vf.status.equals("view") && isfresh == true) {
            editdata();
        } else {
          
        }

      //  docService.createUploadArea({
      //      divContainer: gId("divCertUpload"),
      //      docId: frm._cDoc_id.value.toInt(),
      //      certCategoryId: 0,
      ///      showTitle: false,
      //      showNotes: false,
     //       allowView: false,
     //       showSign: false,
      //      showRemove: true,
     ///       showDownload: false,
      //      afterDocSave: afterDocSave
     //   });
    }
   // function afterDocSave(ctl) {
   //     frm._cDoc_id.value = ctl.docId;
   //     vf.save();
   // }

    function callback() {
        editdata();
    }
    function editdata() {
        if (vf.status.equals("view")) {  
        mmid = win.para.primaryKey.split(",")[1];
        my_matr_id = win.para.my_matr_id.split(",")[1];
        company_id_from = win.para.company_id_from;
    }
        if (g.a.send("processType=g_mshare.base.certMaterial&actionType=getMatrCert_js", { "viewKey": "receive", company_id_from:company_id_from,"my_matr_id": my_matr_id }, true)) {
            if (g.a.OK) {
                matrrs = g.a.cReturn.matrrs
                matrcertrs = g.a.cReturn.matrcertrs
                fillcomcert(matrcertrs);
            }
            else {
                return false;
            }
        } 
    
    }
    function fillcomcert(rs) {
        for (var i = 0; i < rs.rowCount; i++) {
            if (rs.rows[i]['company_id'].value.equals(rs.rows[i]['company_id_create'].value)) {
                rs.rows[i]['cert_name'].value = rs.rows[i]['cert_name'].value + "&nbsp;&nbsp;<span class='badge badge-success' style='background-color:green'>附加</span>"; 
                     if(!rs.rows[i]['operate'].value.equals("-1")){
                     rs.rows[i]['operate'].value = "<i class='fa fa-close'  style='color:#E74C3C;cursor:pointer' ><span   onclick='del(" + rs.rows[i]['my_cert_id'].value + ")'>删除</span></i> &nbsp;&nbsp;<i class='fa fa-edit' style='color:#2980B9;cursor:pointer' ><span onclick='edit2(" + i + ")'>修改</span></i>";
                  
                  }else{
                                  rs.rows[i]['operate'].value = " &nbsp;&nbsp;<i class='fa fa-magic' style='color:#2980B9;cursor:pointer' ><span onclick='edit3(" + i + ")'>更新</span></i>";
                  
                  }
                  
                }else{
                rs.rows[i]['operate'].value = " &nbsp;&nbsp;<i class='fa fa-magic' style='color:#2980B9;cursor:pointer' ><span onclick='edit1(" + i + ")'>查看</span></i>";
           }
          
        }
        var rows = todatatable(rs);
        $table.bootstrapTable('load', rows);
    }
    
       function del(index) {
       if (confirm("确认删除吗？") == true) {
           if (g.a.send("processType=g_mshare.base.certMaterial&actionType=detematr_cert", { "viewKey": "receive", "my_cert_id": index }, true)) {
               if (g.a.OK) {
                   editdata();
               }
               else {
                   return false;
               }
           }
       }
	}
    
    function edit1(index) {
        var rs =getRow($('#tbMatrDocs').bootstrapTable('getData'),index);
        btnEditCert_click_read(rs, topWin.officeId);

    }
      function edit3(index) {
        var rs =getRow($('#tbMatrDocs').bootstrapTable('getData'),index);
        btnEditCert_click_read(rs, topWin.officeId);
    }
    
    function edit2(index) {
    var rs =getRow($('#tbMatrDocs').bootstrapTable('getData'),index);
        btnEditCert_click(rs);

    }
    function onMaterialNameChanged(obj) {
        var py = makePy(obj.value);
        if (py.length > 1) {
            showMsg("请留意名称中的多音字并校正拼音码！");
        }
        frm._cmatr_name_py.value = py[0].substring(0, 10);
    }
    function onMaterialNameChanged1(obj) {
        var py = makePy(obj.value);
        if (py.length > 1) {
            showMsg("请留意名称中的多音字并校正拼音码！");
        }
        frm._cmatr_trade_name_py.value = py[0].substring(0, 10);
    }

    function btnSelectCatagory_click() {
        var prop = {
            title: "请选择分类...",
            parent: win
        };
        var para = {
            viewKey: "mart_category_chose",
            viewForm: g.appPath + "project/g_mshare/html/base/mart_category_chose.html",
            selectCallback: callbackSelectOperation,
            callbackPara: {}
        };
        topWin.openSelectView(prop, para);
    }

    function callbackSelectOperation(drRow) {
        gId("_gcategory_name").value = drRow.category_name.value;
        gId("_ccategory_id").value = drRow.mart_category_id.value;
        return true;
    }
    function btnSend_click(cert_category_ids) {

        if ("".equals(cert_category_ids) || cert_category_ids == null) {
            alert("请选择资质");
            return false;
        }
        if (g.a.send("processType=g_mshare.base.certMaterial&actionType=material_cert_add", { matr_id: mmid, cert_category_ids: cert_category_ids, company_id_from: company_id_from, type: "1", viewkey: "PUSH" }, true)) {
            if (g.a.OK) {
                editdata();
            }
        }
    }


    function showproduct() {
        cert_category_ids = "";
        if (g.a.send("processType=g_mshare.base.certMaterial&actionType=getCert_category", {
            "viewKey": "receive", "matr_id": mmid, "company_id_from": company_id_from, "is_js": is_js, "cert_category_ids": cert_category_ids
        }, true)) {
            if (g.a.OK) {
                var rs = g.a.cReturn.rs;
                var rows = fillmatr(rs);
                $('#tbProductList').bootstrapTable('load', rows);
            }
            else {
                return false;
            }
        }
    }

    function fillmatr(rs) {
        for (var i = 0; i < rs.rowCount; i++) {
            if (rs.rows[i]['operate'].value.equals("-1")) {
                rs.rows[i]['operate'].value = " &nbsp;&nbsp;<i class='fa fa-flag' style='color:#2980B9;cursor:pointer' ><span onclick='edit(" + rs.rows[i]['my_cert_id'].value + ")'>维护</span></i>";
            } else {

                rs.rows[i]['operate'].value = "<i class='fa fa-close'  style='color:#E74C3C;cursor:pointer' ><span   onclick='delmatr(" + i + ")'>删除</span></i> ";
            }
        }
        var rows = todatatable(rs);
        return rows;
    }


    function choiceproduct() {
        var rows = $.map($('#tbProductList').bootstrapTable('getSelections'), function (row) {
            return row
        });
        rows = refreshnomatr(rows);
        $('#addProductCert').modal('hide');
        cert_category_ids = getcatelogidsbyrows(rows);
        btnSend_click(cert_category_ids);
    }


    function choseProductCate() {
        if (g.a.send("processType=g_mshare.base.certMaterial&actionType=getproduct_category", {
            "viewKey": "receive"
        }, true)) {
            if (g.a.OK) {
                var rs = g.a.cReturn.rs;
                var rows = fillcate(rs);
                $('#tbCateList').bootstrapTable('load', rows);
            }
            else {
                return false;
            }
        }
    }



    function fillcate(rs) {
        var rows = todatatable(rs);
        return rows;
    }


    function choicecate() {
        var rows = $.map($('#tbCateList').bootstrapTable('getSelections'), function (row) {
            return row
        });
        gId("_gCategory_name").value = rows[0].category_name;
        gId("_cCategory_id").value = rows[0].mart_category_id;
        $('#choseProductCate').modal('hide');
    }
    
</script>
