<!DOCTYPE html>
<html>
<head>
    <title>我的帐户信息</title>
    <link href="../../../../res_plugin/bootstrap3.7/bootstrap/css/bootstrap.min.css"
          rel="stylesheet" type="text/css" />
    <link href="../../../../res_plugin/bootstrap3.7/bootstrap-table/css/bootstrap-table.css"
          rel="stylesheet" type="text/css" />
    <script src="../../../../res_plugin/jquery/jquery-3.1.1.min.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table-local-zh-CN.js" type="text/javascript"></script>
    <!--系统框架引用 -->
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
    <script src="../../../../res/control/window/xwf.window.js" type="text/javascript"></script>
    <script src="../../../../res/control/upload/xwf.upload.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <script src="../../js/rstodata.js" type="text/javascript"></script>
    <style type="text/css">
        body {
            background-color: lightGray;
        }

        .self-panel-main {
            border: 1px solid lightGray;
            width: 80%;
            margin-top: 20px;
            margin-bottom: 20px;
            background-color: White;
            box-shadow: 3px 3px 3px #7F8C8D;
            padding: 80px;
        }

        h5 {
            color: #7F8C8D;
        }

        th {
            background-color: #3498DB;
            color: White;
            font-size: 0.9em;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container self-panel-main" style="">
        <div class="row">
            <!--第一行-->
            <div class="col-lg-3">
                <div style="width: 100%; height: 200px; line-height: 200px; text-align: center; border: 1px dashed LightGray">
                    <img src="" style="width: 100%; height: 200px;" id="logo" class="img-rounded">
                </div>
            </div>
            <div class="col-lg-6">
                <div class="row">
                    <div class="col-lg-4">
                        <h3 style="text-align: right">
                            推送企业：
                        </h3>
                    </div>
                    <div class="col-lg-8">
                        <h3 style="text-align: left" id="_cCompany_name">
                            华润医药商业有限公司
                        </h3>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4">
                        <h5 style="text-align: right">
                            代码：&nbsp;&nbsp;
                        </h5>
                    </div>
                    <div class="col-lg-8">
                        <h5 style="text-align: left" id="_cCompany_code">
                            910587P8UTRE874
                        </h5>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4">
                        <h5 style="text-align: right">
                            联系人：&nbsp;&nbsp;
                        </h5>
                    </div>
                    <div class="col-lg-8">
                        <h5 style="text-align: left" id="_cCompany_contactor">
                            李小二
                        </h5>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4">
                        <h5 style="text-align: right">
                            电话：&nbsp;&nbsp;
                        </h5>
                    </div>
                    <div class="col-lg-8">
                        <h5 style="text-align: left" id="_cCompany_mobile">
                            138*****1122
                        </h5>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-4">
                        <h5 style="text-align: right">
                            地址：&nbsp;&nbsp;
                        </h5>
                    </div>
                    <div class="col-lg-8">
                        <h5 style="text-align: left" id="_cCompany_address">
                            上海市静安区彭江路1188号
                        </h5>
                    </div>
                </div>
            </div>
            <div class="col-lg-3">
                <div style="width: 100%; height: 150px; line-height: 150px; text-align: center; border-bottom: 1px dashed LightGray">
                    <i class="fa fa-cc fa-5x" style="color: #27AE60"></i>
                </div>
                <div class="row">
                    <div class="col-lg-5">
                        <h6 style="text-align: right">
                            有效期至：
                        </h6>
                    </div>
                    <div class="col-lg-4">
                        <h6 style="text-align: left" id="_cComany_exp_date">
                            2018/12/10
                        </h6>
                    </div>
                    <div class="col-lg-3" style="text-align: right; padding-top: 5px;">
                        <a class="btn btn-success btn-xs">去认证</a>
                    </div>
                </div>
            </div>
        </div>
        <!--第一行.结束-->
        <br />
        <br />
        <br />
        <div class="row">
            <!--第2行-->
            <h2>
                <i class="fa fa-info-circle"></i>&nbsp;&nbsp;企业资料
            </h2>
            <div style="width: 100%; height: 5px; background-color: lightGray;">
            </div>
        </div>
        <!--第2行.结束-->
        <div class="row">
            <!--第3行-->
            <div id="toolbar">
                <button class="btn btn-info" id="btnAddTarget" data-toggle="modal" data-target="#addCompanyCert">
                    补充企业资质
                </button>
            </div>
            <table id="tbCompanyDocs" data-toggle="table" data-toolbar="#toolbar" data-height="500"
                   data-sort-name="no" data-sort-order="asc" data-pagination="true" data-search="true"
                   data-page-size="10" data-page-list="[10,20,30]" kk_data-url="../json/data1.json">
                <thead>
                    <tr>
                        <th style="width: 10%" data-field="no">
                            序
                        </th>
                        <th style="width: 50%" data-field="cert_name" data-sortable="true">
                            企业资质名称
                        </th>
                        <th style="width: 10%" data-field="creator">
                            接收者
                        </th>
                        <th style="width: 20%" data-field="cdate" data-sortable="true">
                            接收时间
                        </th>
                        <th style="width: 10%" data-field="cert_version">
                            版本
                        </th>
                        <th style="width: 10%" data-field="operate">
                            操作
                        </th>
                    </tr>
                </thead>
            </table>
        </div>
        <!--第3行.结束-->
    </div>
    <!--企业资质选择框 -->
    <div class="modal fade" id="addCompanyCert" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                        ×
                    </button>
                    <h3 class="modal-title">
                        请选择需要补充的企业资质
                    </h3>
                </div>
                <div class="modal-body">
                    <table id="tbProductList" data-toggle="table" data-height="300" data-toolbar="#toolbarProduct"
                           data-sort-name="no" data-pagination="true" data-sort-order="asc" data-search="false" data-page-size="100">
                        <thead>
                            <tr>
                                <th data-field="state" data-checkbox="true">
                                    选择
                                </th>
                                <th data-field="no">
                                    序
                                </th>
                                <!--<th data-field="operate">
                                    操作
                                </th>-->
                                <th data-field="cert_category_name" data-sortable="true">
                                    资质名称
                                </th>
                                <th data-field="ext_limit">
                                    类型限制
                                </th>
                                <th data-field="file_max_count">
                                    上传数量限制
                                </th>
                                <th data-field="file_max_size">
                                    上传大小限制/KB
                                </th>
                            </tr>
                        </thead>
                    </table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">
                        关闭
                    </button>
                    <button type="button" class="btn btn-primary" id="btnSubmit" onclick="choiceproduct()">
                        确定选择
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
</body>
</html>
<script type="text/javascript">
    var $table = $('#tbCompanyDocs'),
        $button = $('#btnLoad');
    var company_id;
    var matr_id = "";
    var cert_category_ids = "";
    var company_id_from;
    var is_js = "true";
    var type = 2;
    $(function () {
        company_id = win.para.primaryKey.split(",")[1];
        editdata();
        $('#addCompanyCert').on('show.bs.modal', function () {
            showCompany();
        })
        win.addEventListener("afterClose",
            function () {
                if (win.para.callback) {
                    win.para.callback();
                }
            }
        );
    });
    function addcert() {
        var para = {
            flowKey: "",
            viewKey: "",
            isAddnew: false,
            primaryKey: "company_id," + company_id,
            name: "name," + $("#_cCompany_name").html(),
            type: "2",
            is_js: "true",
            callback: callback

        };
        var prop = {
            text: "资质定义",
            url: g.appPath + "project/g_mshare/html/base/cert_add.html"
        };

        top.topWin.openFullWindow(prop, para);

    }
    function editdata() {
        if (g.a.send("processType=g_mshare.base.certCompany&actionType=getCompany_js", { "viewKey": "receive", company_id: company_id }, true)) {
            if (g.a.OK) {
                comrs = g.a.cReturn.comrs
                comcertrs = g.a.cReturn.comcertrs
                fillcom(comrs);
                fillcomcert(comcertrs);
            }
            else {
                return false;
            }
        }
    }

    function fillcom(rs) {
        var row = rs.rows[0];
        $("#_cCompany_name").html(row['company_name'].value);
        $("#_cCompany_code").html(row['company_code'].value);
        $("#_cCompany_contactor").html(row['company_contactor'].value);
        $("#_cCompany_mobile").html(row['company_contactor_mobile'].value);
        $("#_cCompany_address").html(row['company_address'].value);
        $("#logo").attr('src', row['company_logo'].value);
    }

    function fillcomcert(rs) {

        for (var i = 0; i < rs.rowCount; i++) {
            if (rs.rows[i]['company_id'].value.equals(rs.rows[i]['company_id_create'].value)) {
                rs.rows[i]['cert_name'].value = rs.rows[i]['cert_name'].value + "&nbsp;&nbsp;<span class='badge badge-success' style='background-color:green'>附加</span>";
                if (!rs.rows[i]['operate'].value.equals("-1")) {
                    rs.rows[i]['operate'].value = "<i class='fa fa-close'  style='color:#E74C3C;cursor:pointer' ><span   onclick='del(" + rs.rows[i]['my_cert_id'].value + ")'>删除</span></i> &nbsp;&nbsp;<i class='fa fa-edit' style='color:#2980B9;cursor:pointer' ><span onclick='edit1(" + i + ")'>修改</span></i>";
                } else {
                    rs.rows[i]['operate'].value = " <i class='fa fa-magic' style='color:#2980B9;cursor:pointer' ><span onclick='edit3(" + i + ")'>更新</span></i>";
                }
            } else {
                rs.rows[i]['operate'].value = " <i class='fa fa-wrench' style='color:#2980B9;cursor:pointer' ><span onclick='edit2(" + i + ")'>查看</span></i>";
            }
        }
        var rows = todatatable(rs);
        $table.bootstrapTable('load', rows);
    }
    function edit1(index) {
        var rs = getRow($('#tbCompanyDocs').bootstrapTable('getData'), index);

        btnEditCert_click(rs, topWin.officeId);

    }
    function edit2(index) {
        var rs = getRow($('#tbCompanyDocs').bootstrapTable('getData'), index);
        btnEditCert_click_read(rs);

    }
    function edit3(index) {
        var rs = getRow($('#tbCompanyDocs').bootstrapTable('getData'), index);
        btnEditCert_click_read(rs, topWin.officeId);
    }
    function callback() {
        editdata();

    }
    function datatorows(rs) {
        var rows = [];
        var row1 = {};
        for (var i = 0; i < rs.rowCount; i++) {
            var rowstr = '{';
            for (var j = 0; j < rs.columnCount; j++) {
                if (j == 0) {
                    var vale = i + 1;
                    rowstr = rowstr + '"no":' + '"' + vale + '",';
                }
                else {
                    rowstr = rowstr + '"' + rs.columns[j].name + '" :"' + rs.rows[i][rs.columns[j].name].value + '",';
                }
            }
            if (rowstr.length > 4) {
                rowstr = rowstr.substring(0, rowstr.length - 1);
            }
            row1 = JSON.parse(rowstr + "}");
            rows.push(row1);
        }
        return rows;
    }

    function del(index) {

        if (confirm("确认删除吗？") == true) {
            if (g.a.send("processType=g_mshare.base.certMaterial&actionType=detematr_cert", { "viewKey": "receive", "my_cert_id": index }, true)) {
                if (g.a.OK) {
                    editdata();
                }
                else {
                    return false;
                }
            }
        }
    }
    function edit(index) {

        alert("eidt:" + index);
    }

    function btnSend_click(cert_category_ids) {

        if ("".equals(cert_category_ids) || cert_category_ids == null) {
            alert("请选择资质");
            return false;
        }
        company_id_from = company_id;
        matr_id = 0;
        if (g.a.send("processType=g_mshare.base.certMaterial&actionType=material_cert_add", { matr_id: matr_id, cert_category_ids: cert_category_ids, company_id_from: company_id_from, type: "1", viewkey: "PUSH" }, true)) {
            if (g.a.OK) {
                editdata();
            }
        }
    }


    function showCompany() {
        cert_category_ids = "";
        matr_id = 0;
        if (g.a.send("processType=g_mshare.base.certCompany&actionType=getCert_category", {
            "viewKey": "receive", "company_id_from": company_id, "is_js": is_js, "cert_category_ids": cert_category_ids
        }, true)) {
            if (g.a.OK) {
                var rs = g.a.cReturn.rs;
                var rows = fillmatr(rs);
                $('#tbProductList').bootstrapTable('load', rows);
            }
            else {
                return false;
            }
        }
    }

    function fillmatr(rs) {
        for (var i = 0; i < rs.rowCount; i++) {
            if (rs.rows[i]['operate'].value.equals("-1")) {
                rs.rows[i]['operate'].value = " &nbsp;&nbsp;<i class='fa fa-flag' style='color:#2980B9;cursor:pointer' ><span onclick='edit(" + rs.rows[i]['my_cert_id'].value + ")'>维护</span></i>";
            } else {

                rs.rows[i]['operate'].value = "<i class='fa fa-close'  style='color:#E74C3C;cursor:pointer' ><span   onclick='delmatr(" + i + ")'>删除</span></i> ";
            }
        }
        var rows = todatatable(rs);
        return rows;
    }


    function choiceproduct() {
        var rows = $.map($('#tbProductList').bootstrapTable('getSelections'), function (row) {
            return row
        });
        rows = refreshnomatr(rows);
        $('#addCompanyCert').modal('hide');
        cert_category_ids = getcatelogidsbyrows(rows);
        btnSend_click(cert_category_ids);

    }
</script>
