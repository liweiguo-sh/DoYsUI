<!DOCTYPE html>
<html>

<head>
    <title>资质维护</title>
    <link href="../../../../res_plugin/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="../../../../res/control/upload/style3/xwf.upload.css" rel="stylesheet" />

    <script src="../../../../res/jscript/xwf.js"></script>
    <script src="../../../../res/jscript/xwf.ajax.js"></script>
    <script src="../../../../res/jscript/xwf.const.js"></script>

    <script src="../../../../res/control/tab/xwf.tab.js"></script>
    <script src="../../../../res/control/tree/xwf.tree.js"></script>
    <script src="../../../../res/control/grid/xwf.grid.js"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js"></script>

    <script src="../../../../res/control/upload/xwf.upload.js"></script>
    <script src="../../../../res/control/upload/xwf.upload_core.js"></script>
    <script src="../../js/doc_center.js"></script>

    <script src="../../../../res/jscript/xwf.css.js"></script>
    <style>
        .enclosure {
            margin-left: 10px;
        }
        
        .divCertUpload {
            width: 100%;
            height: 270px;
            border: 0px solid green;
            overflow: auto;
            padding-left: 10px;
        }
    </style>
</head>

<body>
    <div id="divDC"></div>
    <div id="panelA" class="PanelA ScreenCenter" style="width: 865px;">
        <div id="divTab" class="xwf_tab_divContainer" style="width:845px;">
            <div id="divForm">
                <form id="frm" action="" target="g_mshare.company_data.Cert">
                    <table id="tbForm" class="tbForm" style="width:845px;">
                        <tr class="trH">
                            <th style="width: 120px;"></th>
                            <th style="width: 300px;"></th>
                            <th style="width: 120px;"></th>
                            <th style="width: 300px;"></th>
                        </tr>
                        <tr>
                            <td>资质分类：</td>
                            <td colspan="3"><input type="text" id="_cCert_category_id" controltype="dropdown" fieldValue="cert_category_id" fieldText="cert_category_name" fieldsVisible="cert_category_type_name, cert_category_name" widthFields="30,70" /></td>
                        </tr>
                        <tr>
                            <td>资质代码：</td>
                            <td><input type="text" id="_cCert_code" value="" /></td>
                            <td>有效期：</td>
                            <td><input type="text" id="_cCert_exp" class="Wdate" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" /></td>
                        </tr>
                        <tr>
                            <td>资质名称：</td>
                            <td><input type="text" id="_cCert_name" value="" /></td>
                            <td>版本号：</td>
                            <td><input type="text" id="_cCert_version" value="" disabled="disabled" /></td>
                        </tr>
                        <tr id="trAuth">
                            <td>授权\签发方：</td>
                            <td><input type="text" id="_cCert_from" value="" /></td>
                            <td>被授权方：</td>
                            <td><input type="text" id="_cCert_receive" value="" /></td>
                        </tr>
                        <tr>
                            <td>备注：</td>
                            <td colspan="3"><textarea id="_cCert_remark" rows="3" cols="0"></textarea></td>
                        </tr>
                    </table>
                    <input id="_cCERT_ID" type="hidden" value="" />
                    <input id="_cCERT_DOC_ID" type="hidden" value="" />

                    <input id="_cCert_date" type="hidden" value="" />

                    <input id="_xMATR_CATEGORY_ID" type="hidden" value="" />
                    <input id="_xMATR_ID" type="hidden" value="" />
                </form>
                <br />
                <label for="divCertUpload" class="enclosure">附件</label>
                <div id="divCertUpload" class="divCertUpload"></div>
            </div>
            <div id="divGridF" style="display: none"></div>
            <div id="divGridC" style="display: none"></div>
            <div id="divGridM" style="display: none"></div>
            <div id="divGridT" style="display: none"></div>
        </div>
    </div>
</body>

</html>

<!-- formLoad -->
<script type="text/javascript">
    var treeParent = null;
    var tabs = null;
    var gridviewF = null,
        gridviewC = null,
        gridviewM = null,
        gridviewT = null;

    var categoryType = "";
    // ------------------------------------------------------------------------
    function formLoad() {
        categoryType = win.parentWindow.categoryType;
        treeParent = win.parentWindow.tree;
        vf.css(gId("tbForm"));

        tabs = new window.xwf_tab({
            divContainer: gId("divTab"),
            tabClick: tab_click
        });
        tabs.addTab({
            key: "tabI",
            text: "资质信息",
            control: gId("divForm")
        });
        tabs.addTab({
            key: "tabF",
            text: "适用厂商",
            title: "针对授权书。授权书授权的耗材所属厂商范围",
            control: gId("divGridF")
        });
        tabs.addTab({
            key: "tabC",
            text: "适用品类",
            title: "适用耗材品类列表",
            control: gId("divGridC")
        });
        tabs.addTab({
            key: "tabM",
            text: "适用耗材",
            title: "适用耗材列表",
            control: gId("divGridM")
        });
        tabs.addTab({
            key: "tabT",
            text: "适用客户",
            title: "适用客户列表",
            control: gId("divGridT")
        });
    }

    function tab_click(tab) {
        var certId = frm._cCERT_ID.value.toInt();

        if (tab.key == "tabI") {
            loadDoc();
        } else if (tab.key == "tabF") {
            if (gridviewF == null) {
                var prop = {
                    divContainer: gId("divGridF"),
                    toolbarVisible: true,
                    viewKey: "cert_manufacturer",
                    viewFilter: vf.status == "addnew" ? "1 != 1" :  "cert_id = " + certId,
                    jsonToolbar: {
                        height: "M",
                        onclick: onToolbarClickF
                    }
                };
                gridviewF = new window.xwf_gridview(prop);
                gridviewF.toolbar.addBar({
                    type: "button",
                    key: "addManufacturer",
                    text: "<i class='fa fa-plus'></i>  添加适用厂商"
                });
            } else {
                gridviewF.setViewFilter(vf.status == "addnew" ? "1 != 1" : ("cert_id = " + certId));//防止先编辑在添加报错
            }
        } else if (tab.key == "tabC") {

            if (gridviewC == null) {
                var prop = {
                    divContainer: gId("divGridC"),
                    toolbarVisible: true,
                    viewKey: "cert_matr_category",
                    viewFilter: vf.status == "addnew" ? "1 != 1" : ("cert_id = " + certId),
                    jsonToolbar: {
                        height: "M",
                        onclick: onToolbarClickC
                    }
                };
                gridviewC = new window.xwf_gridview(prop);
                gridviewC.toolbar.addBar({
                    type: "button",
                    key: "addCategory",
                    text: "<i class='fa fa-plus'></i>  添加适用品类"
                });
            } else {
                gridviewC.setViewFilter(vf.status == "addnew" ? "1 != 1" : ("cert_id = " + certId));
            }
        } else if (tab.key == "tabM") {
            if (gridviewM == null) {
                var prop = {
                    divContainer: gId("divGridM"),
                    toolbarVisible: true,
                    viewKey: "cert_matr",
                    viewFilter: vf.status == "addnew" ? "1 != 1" : ("cert_id = " + certId),
                    jsonToolbar: {
                        height: "M",
                        onclick: onToolbarClickM
                    }
                };
                gridviewM = new window.xwf_gridview(prop);
                gridviewM.toolbar.addBar({
                    type: "button",
                    key: "addMatr",
                    text: "<i class='fa fa-plus'></i>  添加适用耗材"
                });
            } else {
                gridviewM.setViewFilter(vf.status == "addnew" ? "1 != 1" : ("cert_id = " + certId));
            }
        } else if (tab.key == "tabT") {
            if (gridviewT == null) {
                var prop = {
                    divContainer: gId("divGridT"),
                    toolbarVisible: true,
                    viewKey: "cert_company",
                    viewFilter: "cert_id = " + certId,
                    afterDelete: afterRowDeleteT,
                    jsonToolbar: {
                        height: "M",
                        onclick: onToolbarClickT
                    }
                };
                gridviewT = new window.xwf_gridview(prop);
                gridviewT.toolbar.addBar({
                    type: "button",
                    key: "addCompany",
                    text: "<i class='fa fa-plus'></i>  添加适用客户"
                });
                gridviewT.toolbar.addBar({
                    type: "label",
                    key: "tip",
                    text: "xxx",
                    style: "info_red"
                });
            } else {
                gridviewT.setViewFilter("cert_id = " + certId);
            }
            refreshTipT();
        }
        return true;
    }

    function refreshTipT() {
        if (gridviewT.dtbViewData.rowCount == 0) {
            gridviewT.toolbar.setBarText("tip", "适用所有企业", "info_green");
        } else {
            gridviewT.toolbar.setBarText("tip", "仅适用列表中的企业", "info_red");
        }
    }

    function afterRowDeleteT() {
        setTimeout("refreshTipT()", 1000);
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterLoad = function() {
        frm._cCert_category_id.instance.rowClick = onCertCategory_RowClick;
    }

    function onCertCategory_RowClick(para) {
        var dataRow = para.dataRow;

        frm._cCert_name.value = dataRow["cert_category_name"].value;
        frm._cCert_name.select();
        return true;
    }

    vf.afterAddnew = function() {
        frm._cCert_date.value = (new Date).toString();
        frm._cCert_version.value = "1";
        frm._cCERT_DOC_ID.value = "0";
    }

    vf.beforeSave = function() {
        var node = treeParent.selectedNode;
        if (node.nodeType.equals("CATEGORY")) {
            frm._xMATR_CATEGORY_ID.value = node.categoryId;
        } else if (node.nodeType.equals("MATR")) {
            frm._xMATR_ID.value = treeParent.selectedNode.matrId;
        } else {
            // -- 所有没有明确品类或耗材的节点 --
            frm._xMATR_CATEGORY_ID.value = 1;
        }

        var dropdown = frm._cCert_category_id.instance;
        var dataRow = dropdown.dataRow;
        if (dataRow == null) {
            showErr("请选择资质分类。");
            dropdown.expand();
            return false;
        }
        var certCategoryType = dataRow["cert_category_type"].value;
        if (certCategoryType.equals("A")) {
            if (frm._cCert_from.value.equals("")) {
                showErr("授权书的 授权\\签发方 不能为空，请填写。");
                frm._cCert_from.focus();
                return false;
            }
            if (frm._cCert_receive.value.equals("")) {
                showErr("授权书的 被授权方 不能为空，请填写。");
                frm._cCert_receive.focus();
                return false;
            }
        }
        return true;
    }

    vf.afterMove = function() {
        tab_click(tabs.tabSelected);
    }
</script>

<!-- doc -->
<script type="text/javascript">
    function loadDoc() {
        var upA = docService.createUploadArea({
            divContainer: gId("divCertUpload"),
            docId: frm._cCERT_DOC_ID.value.toInt(),
            certCategoryId: frm._cCert_category_id.underValue.toInt(),
            showTitle: false,
            showNotes: true,
            allowView: false,
            showSign: true,
            showRemove: true,
            showDownload: false,
            maxSize: 5120,
            //readonly: win.para.readonly,
            //fileCount: 5,
            allowView: true,
            allowDownload: true,
            afterDocSave: afterDocSave
        });
    }

    function afterDocSave(ctl) {
        frm._cCERT_DOC_ID.value = ctl.docId;
        vf.save();
    }
</script>
<!-- 添加资质适用范围 -->
<script type="text/javascript">
    function onToolbarClickF(para) {
        if (para.key.equals("addManufacturer")) {
            var prop = {
                title: "请选择适用厂商...",
                width: 700,
                height: 0.7,
                parent: win
            };
            var para = {
                viewKey: "s_manufacturer",
                viewForm: "",
                userFilter: "",
                viewMode: "multiSelect",
                selectCallback: onManufacturerSelect
            };
            topWin.openSelectView(prop, para);
        } else {
            showErr("unknown button " + para.key);
        }
    }

    function onManufacturerSelect(arrRows) {
        var certId = frm._cCERT_ID.value.toInt();
        var manufacturerIds = "";
        var arrManufacturerId = new Array();

        for (var i = 0; i < arrRows.length; i++) {
            arrManufacturerId.push(arrRows[i]["manufacturer_id"].value);
        }
        manufacturerIds = arrManufacturerId.join(",");
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=addCertManufacturer", {
                certId: certId,
                manufacturerIds: manufacturerIds
            }, true)) {
            if (g.a.OK) {
                gridviewF.refresh();
                //refreshTipT();
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }

    function onToolbarClickC(para) {
        if (para.key.equals("addCategory")) {
            var prop = {
                url: "project/g_mshare/html/common_select/matr_category.html?category_type=" + categoryType,
                text: "品类选择...",
                parent: win,
                modal: true
            };
            var para = {
                multiSelect: true,
                callback: onCategorySelect
            };
            topWin.openWindow(prop, para);
        } else {
            showErr("unknown button " + para.key);
        }
    }

    function onCategorySelect(para) {
        var categoryIds = para.categoryIds;
        var certId = frm._cCERT_ID.value.toInt();
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=addCertCategory", {
                certId: certId,
                categoryIds: categoryIds
            }, true)) {
            if (g.a.OK) {
                gridviewC.refresh();
            } else {
                return false;
            }
        } else {
            return false;
        }
    }

    function onToolbarClickM(para) {
        if (para.key.equals("addMatr")) {
            var prop = {
                url: "project/g_mshare/html/common_select/matr.html?category_type=" + categoryType,
                text: "适用耗材选择...",
                parent: win,
                modal: true
            };
            var para = {
                callback: onMatrSelect
            };
            win.para.winSelectC = topWin.openWindow(prop, para);
        } else {
            showErr("unknown button " + para.key);
        }
    }

    function onMatrSelect(para) {
        var matrIds = para.matrIds;
        var certId = frm._cCERT_ID.value.toInt();
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=addCertMatr", {
                certId: certId,
                matrIds: matrIds
            }, true)) {
            if (g.a.OK) {
                gridviewM.refresh();
            } else {
                return false;
            }
        } else {
            return false;
        }
    }

    function onToolbarClickT(para) {
        if (para.key.equals("addCompany")) {
            var prop = {
                title: "请选择适用客户...",
                width: 600,
                height: 0.7,
                parent: win
            };
            var para = {
                viewKey: "customer_select",
                viewForm: "",
                userFilter: "",
                viewMode: "multiSelect",
                selectCallback: onCompanySelect
            };
            topWin.openSelectView(prop, para);
        } else {
            showErr("unknown button " + para.key);
        }
    }

    function onCompanySelect(arrRows) {
        var certId = frm._cCERT_ID.value.toInt();
        var companyIds = "";
        var arrCompanyId = new Array();

        for (var i = 0; i < arrRows.length; i++) {
            arrCompanyId.push(arrRows[i]["company_id"].value);
        }
        companyIds = arrCompanyId.join(",");
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=addCertCompany", {
                certId: certId,
                companyIds: companyIds
            }, true)) {
            if (g.a.OK) {
                gridviewT.refresh();
                refreshTipT();
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
</script>