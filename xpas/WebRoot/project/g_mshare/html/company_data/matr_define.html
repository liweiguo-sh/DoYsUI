<!DOCTYPE html>
<html>

<head>
    <title>基础数据-耗材维护</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <style type="text/css">
        body {
            overflow: hidden;
        }
        
        #tbLayout {
            border-collapse: collapse;
        }
        
        .tdLayout {
            padding: 0px;
            overflow: hidden;
            vertical-align: top;
        }
        
        .tdLayoutLeft {
            display: inline-block;
            margin-right: -1px;
            border: solid 1px #c0c0c0;
        }
        
        .xwf_gridview_divToolbar {
            border: solid 1px #c0c0c0;
            border-bottom: solid 0 transparent;
        }
        
        .tdLayoutRight .xwf_toolbar_tdLayout {
            padding-left: 10px;
        }
        
        .divTree {
            overflow: auto;
        }
        
        .divTree::-webkit-scrollbar {
            display: none;
        }
        
        .divCategoryOption {
            height: 39px;
            line-height: 39px;
            text-indent: 5px;
            border-bottom: solid 1px #c0c0c0;
        }
    </style>
</head>

<body scroll="no">
    <table id="tbLayout">
        <tr>
            <td id="tdLayoutLeft" class="tdLayout tdLayoutLeft">
                <div id="divCategoryOption" class="divCategoryOption">
                    <input type="checkbox" id="chkAllCategory" onclick="chkAllCategory_click();" />
                    <label for="chkAllCategory" class="xwf_select_none">显示全部品类</label>
                </div>
                <div id="divTree" class="divTree"></div>
            </td>
            <td id="tdLayoutRight" class="tdLayout tdLayoutRight">
                <div id="divGrid"></div>
            </td>
        </tr>
    </table>
</body>

</html>

<!-- formLoad -->
<script type="text/javascript">
    var tbLayout = gId("tbLayout");
    var divTree = gId("divTree");
    var divGrid = gId("divGrid");

    var tree = null;
    var gridView = null;

    var categoryType = urlPara["category_type"];
    var onlyMyCategory = 1;
    // ------------------------------------------------------------------------
    function formLoad() {
        win.addEventListener("beforeClose", beforeClose);

        divTree.style.width = (win.p.width * 0.2) + "px";
        // divTree.style.height = (win.p.height - 2 * tbLayout.offsetTop - divTree.offsetTop - gId("divCategoryOption").offsetHeight) + "px";
        divTree.style.height = (win.p.height - 2 * tbLayout.offsetTop - divTree.offsetTop - 4) + "px";
        divGrid.style.width = (win.p.width - 2 * tbLayout.offsetLeft - divTree.offsetWidth) + "px";
        divGrid.style.height = (win.p.height - 2 * tbLayout.offsetTop - divGrid.offsetTop) + "px";

        initTree();
        initGrid();
    }

    function beforeClose() {

    }
</script>

<!-- 加载分类 -->
<script type="text/javascript">
    function chkAllCategory_click() {
        onlyMyCategory = gId("chkAllCategory").checked ? 0 : 1;

        initTree();
    }

    function initGrid() {
        var viewForm = "";
        if (categoryType == 0) {
            viewForm = "project/g_mshare/html/company_data/matr.html";
        } else {
            viewForm = "project/g_mshare/html/company_data/drug.html";
        }

        var prop = {
            divContainer: divGrid,
            toolbarVisible: true,
            viewKey: "matr",
            viewForm: viewForm,
            viewFilter: "1 = 0",
            jsonToolbar: {
                height: "M",
                onclick: onToolbarClick
            }
        };
        gridView = new window.xwf_gridview(prop);

        gridView.beforeAddnew = function() {
            if (!tree.selectedNode || tree.selectedNode.quickType) {
                showErr("请先选择资质适用的品类节点。");
                return false;
            }
            return true;
        }

        gridView.toolbar.addBar({
            type: "button",
            key: "addnew",
            text: "<i class='fa fa-plus'></i>  添加",
            align: "left",
            style: "Grid",
            icon: null
        });
        gridView.toolbar.addBar({
            type: "button",
            key: "close",
            text: "<i class='fa fa-close'></i>  关闭",
            align: "left",
            style: "Grid",
            icon: null
        });

    }

    function initTree() {
        var rootNodeKey = "";
        var jsonPara = {
            divContainer: gId("divTree"),
            imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
            title: "品类导航",
            beforeExpand: beforeNodeExpand,
            nodeClick: onNodeClick
        };
        tree = new window.xwf_tree(jsonPara);

        rootNodeKey = "0" + tree.sd + "Q";
        tree.addNode({
            key: rootNodeKey,
            text: "全部耗材",
            nodeType: "QUICK",
            typeValue: "ALL"
        });
        tree.addNode({
            key: rootNodeKey + tree.sd + "NOCATEGORY",
            text: "无品类耗材",
            nodeType: "QUICK",
            typeValue: "NOCATEGORY",
            title: "用于维护初始化数据或异常数据"
        });

        rootNodeKey = "0" + tree.sd + "C";
        tree.addNode({
            key: rootNodeKey,
            text: "品类总节点",
            categoryId: 1,
            nodeType: "CATEGORY"
        });
        tree.addNode({
            key: rootNodeKey + tree.sd + "loading",
            text: "loading..."
        });

        tree.expand("0" + tree.sd + "Q");
        tree.expand(rootNodeKey);
        tree.textClick(rootNodeKey);
    }

    function beforeNodeExpand(node, firstExpand) {
        if (!firstExpand) return;
        tree.removeNode(node.key + tree.sd + "loading");

        if (node.nodeType.equals("QUICK")) {

        } else if (node.nodeType.equals("CATEGORY")) {
            if (node.lastCategory) {
                loadMatrNode(node.key, node.categoryId);
            } else {
                loadCategoryNode(node.key, node.categoryId);
            }
        }
    }

    function loadCategoryNode(pNodeKey, categoryId) {
        if (g.a.send("processType=g_mshare.company_data.CertDefine&actionType=getCategoryNodeData", {
                categoryType: categoryType,
                categoryId: categoryId,
                onlyMyCategory: onlyMyCategory
            }, true)) {
            if (g.a.OK) {
                var c = g.a.cReturn;
                var dtb = c.dtb;
                for (var i = 0; i < dtb.rowCount; i++) {
                    var categoryId = dtb.rows[i]["category_id"].value;
                    var nodeKey = dtb.rows[i]["node_key"].value;
                    var nodeText = dtb.rows[i]["category_code"].value ? dtb.rows[i]["category_code"].value + '-' + dtb.rows[i]["category_name"].value : dtb.rows[i]["category_name"].value;
                    var lastCategory = (dtb.rows[i]["category_is_last_node"].value == 1 ? true : false);
                    var title = "";

                    if (g.debug) {
                        title = categoryId + " - " + nodeText;
                    }

                    tree.addNode({
                        key: pNodeKey + tree.sd + categoryId,
                        text: nodeText,
                        categoryId: categoryId,
                        nodeKey: nodeKey,
                        title: title,
                        lastCategory: lastCategory,
                        nodeType: "CATEGORY"
                    });
                    // -- 加载虚拟子节点 ------------------
                    if (!lastCategory) {
                        tree.addNode({
                            key: pNodeKey + tree.sd + categoryId + tree.sd + "loading",
                            text: "loading..."
                        });
                    }
                }
            } else {
                return;
            }
        } else {
            return;
        }
    }

    function onNodeClick(node) {
        if (gridView == null) return;

        if (node.nodeType.equals("QUICK")) {
            if (node.typeValue.equals("ALL")) {
                gridView.setViewFilter("");
            } else if (node.typeValue.equals("NOCATEGORY")) {
                gridView.setViewFilter("category_id NOT IN (SELECT category_id FROM TG_MATR_CATEGORY WHERE category_id > 1)");
            } else {
                showErr(node.typeValue);
            }
        } else if (node.nodeType.equals("CATEGORY")) {
            if (node.categoryId == 1) {
                gridView.setViewFilter("");
            } else {
                var nodeKey = node.nodeKey;
                gridView.setViewFilter("category_id IN (SELECT category_id FROM TG_MATR_CATEGORY WHERE LEFT(node_key, " + nodeKey.length + ") = '" + nodeKey + "')");
            }
        } else {
            showErr(node.nodeType);
        }
    }
</script>
<!-- 工具栏 -->
<script type="text/javascript">
    function onToolbarClick(para) {
        if (para.key.equals("addnew")) {
            var node = tree.selectedNode;
            if (!node.categoryId || node.categoryId <= 1) {
                showWarn("添加新纪录前，请先从左侧导航树中选择品类。");
                return;
            }
            gridView.addnew();
        } else if (para.key.equals("close")) {
            win.close();
        } else {
            showErr("unknown button " + para.key);
        }
    }
</script>