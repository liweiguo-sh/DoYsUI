<!DOCTYPE html>
<html>

<head>
    <title>耗材接收单</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/control/tab/xwf.tab.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
    <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
    <script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
        }
        
        #divGridM {
            height: 400px;
        }
    </style>
</head>

<body>
    <div id="divDC"></div>
    <form id="frm" action="" target="g_mshare.receive.VIEW_Receive">
        <table id="tbForm" class="tbForm" style="width: 705px;">
            <tr class="trH">
                <th style="width: 150px;"></th>
                <th style="width: 200px;"></th>
                <th style="width: 150px;"></th>
                <th style="width: 200px;"></th>
            </tr>
            <tr>
                <td>单号</td>
                <td><input type="text" id="_cReceive_key" value="" disabled /></td>
                <td>推送日期</td>
                <td><input type="text" id="_gPush_date" disabled /></td>
            </tr>
            <tr>
                <td>推送方</td>
                <td colspan="3"><input type="text" id="_gCompany_name_from" disabled /></td>
            </tr>
            <tr>
                <td>标题</td>
                <td colspan="3"><input type="text" id="_gPush_title" value="" disabled /></td>
            </tr>
            <tr>
                <td>备注</td>
                <td colspan="3"><textarea id="_gPush_remark" rows="3" cols="0"></textarea></td>
            </tr>
        </table>
        <input id="_cRECEIVE_ID" type="hidden" value="" />
        <input id="_cPUSH_ID" type="hidden" value="" />
    </form>
    <div id="divTab" class="xwf_tab_divContainer" style="width: 700px;">
        <div id="divGridM"></div>
        <!--<div id="divGridC"></div>-->
    </div>
</body>

</html>

<!-- formLoad -->
<script type="text/javascript">
    var gridviewM = null;
    var gridviewC = null;

    var divGridM = gId("divGridM");
    var divGridC = gId("divGridC");
    // ------------------------------------------------------------------------
    function formLoad() {
        vf.css(gId("tbForm"));

        tabs = new window.xwf_tab({
            divContainer: gId("divTab"),
            tabClick: tab_click
        });
        tabs.addTab({
            key: "tabM",
            text: "耗材列表",
            control: divGridM
        });
    }

    function tab_click(tab) {
        var pushId = frm._cPUSH_ID.value.toInt();

        if (tab.key == "tabM") {
            if (gridviewM == null) {
                var prop = {
                    divContainer: divGridM,
                    viewKey: "receive_matr",
                    viewFilter: "push_id = " + pushId,
                    viewForm: "project/g_mshare/html/receive/matr_info.html"
                };
                gridviewM = new window.xwf_gridview(prop);
            } else {
                gridviewM.setViewFilter("push_id = " + pushId);
            }
        }
        return true;
    }
</script>

<!-- vf.events -->
<script type="text/javascript">
    vf.afterMove = function() {
        tab_click(tabs.tabSelected);
    }
    vf.beforeSave = function() {
        var pushRemark = frm._gPush_remark.value;
        var isSave = updatePushRemark(pushRemark);
        return isSave;
    }

    vf.beforeFlowClick = function(prop) {
        var pushRemark = "";
        var isSave = true;
        if (prop.fbKey.equals("approve")) {
            isSave = updatePushRemark(pushRemark);
            return isSave;
        } else if (prop.fbKey.equals("approve_return")) {
            pushRemark = frm._gPush_remark.value;
            isSave = updatePushRemark(pushRemark);
            return isSave;

        } else {
            return true;
        }
    };

    // 更新推送单的备注信息
    function updatePushRemark(pushRemark) {
        var pushId = frm._cPUSH_ID.value.toInt();

        var params = {
            pushId: pushId,
            pushRemark: pushRemark,
            viewKey: 'receive'
        };
        if (g.a.send("processType=g_mshare.receive.VIEW_Receive&actionType=updatePushRemark", params, true)) {
            if (g.a.OK) {
                gridviewM.refresh();
                return true;
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
</script>