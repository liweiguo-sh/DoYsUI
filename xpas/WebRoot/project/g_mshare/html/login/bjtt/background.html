<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <!-- 医疗首营平台工作台 -->
    <title></title>
    <link href="../../../../../res_plugin/bootstrap3.7/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="../../../../../res_plugin/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet" />

    <script src="../../../../../res_plugin/jquery/jquery-1.11.3.min.js"></script>
    <script src="../../../../../res/jscript/xwf.js"></script>
    <script src="../../../../../res/jscript/xwf.ajax.js"></script>
    <script src="../../../../../res/jscript/xwf.const.js"></script>
    <script src="../../../../../res/jscript/xwf.datatable.js"></script>

    <script src="../../../../../res_plugin/echarts/echarts.min.js"></script>
    <style>
        body {
            margin: 0px;
            overflow: hidden;
            background-color: #F0F0F0;
            background-repeat: no-repeat;
        }
        
        #tbLayout td {
            padding: 5px;
            border: 0px solid blue;
        }
        
        #tbCompany td {
            border: 0px solid blue;
        }
        
        .pannel,
        .panel-default {
            margin-bottom: 0px;
        }
        
        .pannel-company {
            height: 200px;
            width: 100%;
            padding: 15px;
        }
        
        .company-title {
            font-size: 1.2em;
            font-family: 微软雅黑;
            height: 80px;
            border-bottom: 1px solid #F0F0F0;
            text-align: center;
        }
        
        .fixed-contents {
            font-size: 1em;
            color: DarkGray;
            height: 40px;
        }
        
        .company-logo {
            height: 140px;
            padding: 10px;
            background-image: url(images/default-company-logo.png);
            background-repeat: no-repeat;
            background-position: center center;
            border: 0px solid green;
        }
        
        .process-qty {
            font-size: 1.2em;
            color: #2980B9;
            cursor: pointer;
        }
        
        .process-txt {
            font-size: 1.2em;
            color: Gray;
        }
        
        .task-div {
            height: 60px;
            line-height: 60px;
            border: 0px solid;
            padding-left: 20px;
        }
        
        .task-icon {
            font-size: 1.2em;
            color: LightGray;
        }
        
        .task-alert {
            color: #E74C3C;
        }
        
        .matrTotal:hover,
        .certTotal:hover {
            text-decoration: underline;
            color: blue;
        }
    </style>
</head>

<body onload="formLoad();">
    <div style="background-color:#F0F0F0;padding:5px;">
        <table id="tbLayout" style="width:100%">
            <tr>
                <td style="width:40%">
                    <div class="panel panel-default pannel-company">
                        <table id="tbCompany" style="width:100%;">
                            <tr>
                                <td style="width:40%;border-right:1px solid #F0F0F0;" rowspan="4">
                                    <div id="divLogo" class="company-logo"></div>
                                </td>
                            </tr>
                            <tr>
                                <td colspan="3" class="company-title" id="_cCompany_name"></td>
                            </tr>
                            <tr>
                                <td style="width:25%;border-bottom:1px solid #F0F0F0;" class="fixed-contents">&nbsp;&nbsp;注册日期</td>
                                <td style="width:25%;border-bottom:1px solid #F0F0F0;"><span id="_cCompany_reg_date">2018-01-01</span>
                                </td>
                                <td style="width:10%;border-bottom:1px solid #F0F0F0;"><button class="btn btn-link" style="display:none">去认证</button></td>
                            </tr>
                            <tr>
                                <td style="width:25%;" class="fixed-contents">&nbsp;&nbsp;商品总量</td>
                                <td style="width:25%;"><span id="_xMatr_count"></span></td>
                                <td style="width:10%;"><button class="btn btn-link" style="display:none">去充值</button></td>
                            </tr>
                        </table>
                    </div>
                </td>
                <td style="width:60%">
                    <div class="panel panel-default pannel-company">
                        <div style="font-size:1em;font-family:微软雅黑;">最新消息:</div>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="panel panel-default">
                        <div class="row">
                            <div class="col-xs-3">
                                <div class="task-div">
                                    <span class="fa-stack fa-lg task-icon">
										<i class="fa fa-circle fa-stack-2x"></i>
										<i class="fa fa-sign-in fa-stack-1x fa-inverse"></i>
									</span>
                                    <span class="process-txt">待签收&nbsp;&nbsp;&nbsp;<i class="process-qty"><a
												href="javascript:gotoReceive();" id="receiveNum"></a></i></span>
                                </div>
                            </div>
                            <div class="col-xs-3">
                                <div class="task-div">
                                    <span class="fa-stack fa-lg task-icon">
										<i class="fa fa-circle fa-stack-2x"></i>
										<i class="fa fa-sign-out fa-stack-1x fa-inverse"></i>
									</span>
                                    <span class="process-txt">推送记录&nbsp;&nbsp;&nbsp;<i class="process-qty"><a
												href="javascript:gotoPushes();" id="pushNum"></a></i></span>
                                </div>
                            </div>
                            <div class="col-xs-3">
                                <div class="task-div">
                                    <span class="fa-stack fa-lg task-icon">
										<i class="fa fa-circle fa-stack-2x"></i>
										<i class="fa fa-exclamation fa-stack-1x fa-inverse"></i>
									</span>
                                    <span class="process-txt">产品过期资质&nbsp;&nbsp;&nbsp;<i
											class="process-qty task-alert matrTotal"></i></span>
                                </div>
                            </div>
                            <div class="col-xs-3">
                                <div class="task-div">
                                    <span class="fa-stack fa-lg task-icon">
										<i class="fa fa-circle fa-stack-2x"></i>
										<i class="fa fa-bell fa-stack-1x fa-inverse"></i>
									</span>
                                    <span class="process-txt">企业过期资质&nbsp;&nbsp;&nbsp;<i
											class="process-qty task-alert certTotal"></i></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
            <tr>
                <td colspan="2">
                    <div class="panel panel-default" style="padding:30px;">
                        <div class="row">
                            <div class="col-xs-6">
                                <div id="divChart1"></div>
                            </div>
                            <div class="col-xs-6">
                                <div id="divChart2"></div>
                            </div>
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </div>
</body>

</html>

<script type="text/javascript">
    var background = {};
    var targetWindow = null;
    var topWin = top.topWin;
    // ------------------------------------------------------------------------

    background.init = function() {
        background.queryMatrOverDueTotal();
        background.queryCertOverDueTotal();

        // 查看企业过期产品
        $('.matrTotal').on('click', function() {
            try {
                topWin.openMenu({
                    menuKey: "PG200F00B"
                });
            } catch (e) {
                showMsg('打开企业过期产品失败！')
                return false;
            }
        });

        // 查看企业过期资质
        $('.certTotal').on('click', function() {
            try {
                topWin.openMenu({
                    menuKey: "PG200F00C"
                });
            } catch (e) {
                showMsg('打开企业过期资质失败！')
                return false;
            }
        });
    }

    function formLoad() {
        var tdLogo = top.window.document.getElementById("tdTopLeft");
        var tdProjectName = top.window.document.getElementById("tdProjectName");
        // ------------------------------------------------
        topWin.cMenu.addEventListener("beforeClick", onMenuClick);

        tdLogo.style.background = "url('project/g_mshare/html/login/bjtt/images/logo_left_top.png') no-repeat center left";
        tdLogo.style.width = "200px";
        if (tdProjectName) {
            tdProjectName.innerHTML = "医疗首营平台";
        }

        // ------------------------------------------------
        showCompanyInfo();
        if (topWin.companyRealId > 0) {
            setTimeout(showCompanyReal, 100);
        }
        return;

        //setTimeout(applicationLoad, 100);

        //--获取接收、推送数量-----------------------------------------------------
        var receiveNum;
        var pushNum;
        if (g.a.send("processType=g_mshare.base.ProductReceive&actionType=getReceiveNum", {
                "viewKey": "receive"
            }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                receiveNum = cReturn.receiveNum;
                pushNum = cReturn.pushNum;
            } else {
                return false;
            }
        } else {
            return false;
        }

        $("#receiveNum").text(receiveNum);
        $("#pushNum").text(pushNum);

        // -- 企业基础信息 --
        editdata();
        ceateChartArea();
    }

    function onMenuClick(menu) {
        var menuKey = menu.menuKey;
        if (menuKey.equals("PG200B001")) {
            showCompanyReal();
            return false;
        } else if (menuKey.equals("PG2003003")) {
            if (targetWindow && targetWindow.closed) {
                applicationLoad();
            }
            return false;
        }
        return true;
    }
</script>

<!-- 企业认证 -->
<script type="text/javascript">
    function showCompanyReal() {
        if (topWin.companyRealId == 0) {
            showMsg("当前没有关于企业认证的记录，请到企业认证查询中查看。");
            return;
        }

        var prop = {
            text: "企业认证",
            url: g.appPath + "project/g_mshare/html/company_real/company_real.html"
        };
        topWin.openFullWindow(prop, {});
    }
</script>

<!-- 加载主页信息 -->
<script type="text/javascript">
    function showCompanyInfo() {
        if (g.a.send("processType=g_mshare.home.Home&actionType=getHomeInfo", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var matrCount = cReturn.matrCount;
                var dtbCompany = cReturn.dtbCompany;

                if (dtbCompany.rowCount == 1) {
                    gId("_cCompany_name").innerHTML = dtbCompany.rows[0]["company_name"].value;
                    gId("_cCompany_reg_date").innerHTML = dtbCompany.rows[0]["company_reg_date"].value.substring(0, 10);
                    gId("_xMatr_count").innerHTML = matrCount;
                } else {
                    gId("_xMatr_count").innerHTML = '0';
                }
            } else {
                return false;
            }
        } else {
            return false;
        }
    }
</script>
<!-- 加载主页图表 -->
<script type="text/javascript">
    var eChart1 = null;
    var eChart2 = null;
    var toolbox = {
        show: false,
        feature: {
            saveAsImage: {}
        }
    };

    function ceateChartArea() {
        var chartHeight = document.documentElement.clientHeight - getOffsetTop(gId("divChart1")) - 40;
        gId("divChart1").style.height = chartHeight + "px";
        gId("divChart2").style.height = chartHeight + "px";
        eChart1 = echarts.init(gId("divChart1"));
        eChart1.setOption(getOption_Bar());

        eChart2 = echarts.init(gId("divChart2"));
        eChart2.setOption(getOption_Pie());
    }

    function getOption_Bar() {
        var arrDataX = new Array();
        var arrDataS = new Array();

        for (var i = 0; i < 11; i++) {
            arrDataX.push((i + 1) + "月份");
            arrDataS.push(parseInt(getrealDataBymonth(i)));
        }

        var option = {
            title: {
                text: "产品资料推送月度统计",
                subtext: ""
            },
            tooltip: {
                show: true,
                formatter: "{a} <br/>{b} : {c} 份"
            },
            toolbox: toolbox,
            legend: {
                data: ['产品资料推送']
            },
            xAxis: [{
                type: 'category',
                data: arrDataX
            }],
            yAxis: [{
                type: "value"
            }],
            series: [{
                "name": "月度推送",
                "type": "line",
                "data": arrDataS
            }]
        };
        return option;
    }

    function getOption_Pie() {
        var arrData = new Array();

        var productarr = [];
        var productdata = [];
        var returnproduct = "";
        if (g.a.send("processType=g_mshare.base.ProductSend&actionType=getProductarr", {
                "viewKey": "receive"
            }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                returnproduct = cReturn.productarr;
                for (var i = 0; i < returnproduct.rowCount; i++) {
                    productarr.push(returnproduct.rows[i].matr_name.value);
                    productdata.push(returnproduct.rows[i].num.value);
                }
            } else {
                return false;
            }
        } else {
            return false;
        }

        for (var i = 0; i < 9; i++) {
            arrData.push({
                value: parseInt(productdata[i]),
                name: productarr[i]
            });
        }

        var option = {
            title: {
                text: "年度推送数量TOP 10",
                subtext: ""
            },
            tooltip: {
                trigger: 'item',
                formatter: "{a} <br/>{b} : {c} ({d}%)"
            },
            toolbox: toolbox,

            yAxis: [],
            series: [{
                name: '年度推送数量',
                type: 'pie',
                radius: '55%',
                center: ['50%', '60%'],
                data: arrData,
                itemStyle: {
                    emphasis: {
                        shadowBlur: 10,
                        shadowOffsetX: 0,
                        shadowColor: 'rgba(0, 0, 0, 0.5)'
                    }
                }
            }]
        };
        return option;
    }


    //产品资料推送月度统计：参数i(月份)
    function getrealDataBymonth(i) {
        var databyMonth = "";
        if (g.a.send("processType=g_mshare.base.ProductSend&actionType=getSendNumByMonth", {
                "viewKey": "receive",
                index: i + 1
            }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                databyMonth = cReturn.pushNum;
            } else {
                return false;
            }
        } else {
            return false;
        }
        return databyMonth;
    }
</script>

<! -- 待删除 -->
<script type="text/javascript">
    function applicationLoad() {
        if (top.topWin.matchGroup("COMPANY_REG")) {
            var companyId = 0;
            var status = 0;
            if (g.a.send("processType=g_mshare.base.registerBaseAjax&actionType=getCompanyId", {}, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;
                    companyId = cReturn.companyId;
                    status = cReturn.status;
                } else {
                    return false;
                }
            } else {
                return false;
            }
            var para = {
                flowKey: "",
                viewKey: "company_reg_info",
                isAddnew: false,
                primaryKey: "company_id," + companyId

            };
            var prop = {
                text: "企业基本信息",
                url: g.appPath + "project/g_mshare/html/base/certificate.html"
            };
            if (companyId > 0 && (status == 0 || status == -2 || status == 1)) {
                targetWindow = top.topWin.openFullWindow(prop, para);
            }

        }
    }

    function gotoReceive() {
        var para = {};
        var prop = {
            text: "资料接受",
            url: g.appPath + "project/g_mshare/html/trans/recevices.html"
        };
        top.topWin.openFullWindow(prop, para);
    }

    function gotoPushes() {
        var para = {};
        var prop = {
            text: "推送记录",
            url: g.appPath + "project/g_mshare/html/trans/pushes.html"
        };
        top.topWin.openFullWindow(prop, para);
    }

    function editdata() {
        if (g.a.send("processType=g_mshare.base.certCompany&actionType=getCompany", {
                "viewKey": "receive",
                company_id: company_id
            }, true)) {
            if (g.a.OK) {
                comrs = g.a.cReturn.comrs
                comcertrs = g.a.cReturn.comcertrs
                fillcom(comrs);
            } else {
                return false;
            }
        }
    }

    function fillcom(rs) {
        if (rs.rowCount == 0) {
            return;
        }
        var row = rs.rows[0];
        $("#_cCompany_name").html(row['company_name'].value);
        // $("#_cComany_exp_date").html(row['company_real_exp'].value);
        if (!row['company_logo'].value.equals("")) {
            gId("divLogo").style.backgroundImage = "url(" + row['company_logo'].value + "?rnd=" + Math.random() + ")";
        }
    }

    // 统计资质过去产品数量
    background.queryMatrOverDueTotal = function() {
        var params = {
            viewKey: 'query_matr_overdue'
        };

        if (g.a.send("processType=g_mshare.base.certCompany&actionType=queryMatrOverDueTotal", params, true)) {
            if (g.a.OK) {
                var data = g.a.cReturn.data;
                if (data && data.rowCount > 0) {
                    $('.matrTotal').text(data.rows[0]["matr_total"].value);
                } else {
                    $('.matrTotal').text(0);
                }
            }
        }
    }

    // 统计企业过期资质数量
    background.queryCertOverDueTotal = function() {
        var params = {
            viewKey: 'query_cert_overdue'
        };

        if (g.a.send("processType=g_mshare.base.certCompany&actionType=queryCertOverDueTotal", params, true)) {
            if (g.a.OK) {
                var data = g.a.cReturn.data;
                if (data && data.rowCount > 0) {
                    $('.certTotal').text(data.rows[0]["cert_total"].value);
                } else {
                    $('.certTotal').text(0);
                }
            }
        }
    }
    background.init();
</script>