<!DOCTYPE html>
<html>
<head>
    <title>机构管理</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<style type="text/css">
		body {
			overflow: hidden;
		}
		#tbLayout {
			 border-collapse: collapse;
		}
		.tdLayout {
			padding: 0px;
			overflow: hidden;
			vertical-align: top;			
		}

		#tdLayoutLeft {
			border-top: solid 1px #c0c0c0;
			border-left: solid 1px #c0c0c0;
			border-bottom: solid 1px #c0c0c0;
		}
		#tdLayoutRight {
			border-top: solid 1px #c0c0c0;
			border-bottom: solid 1px #c0c0c0;
		}

		#divButton {
			margin: 0px;
			padding: 1px 0px 2px 0px;
			border-left:solid 1px #c0c0c0;
			border-right:solid 1px #c0c0c0;
		}
		#divTree {
			width: 320px;
			overflow: auto;
		}
	</style>
</head>
<body scroll="no">
	<table id="tbLayout">
		<tr>
			<td id="tdLayoutLeft" class="tdLayout"><div id="divTree"></div></td>
			<td id="tdLayoutRight" class="tdLayout">
				<div id="divButton" class="uvButtons">
					<input id="Button1" type="button" value="刷新(R)" onclick="return btnRefresh_click()" />
					<input id="btnAddnew" type="button" value="添加(A)" onclick="return btnAddnew_click()" />
					<input id="btnClose" type="button" value="关闭(C)" onclick="return btnClose_click();" />
				</div>
				<div id="divGrid"></div>
			</td>
		</tr>
	</table>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var tbLayout = gId("tbLayout");
	var divButton = gId("divButton");
	var divTree = gId("divTree");
	var divGrid = gId("divGrid");

	var tree = null;
	var gridView = null;
	// ----------------------------------------------------
	function formLoad() {
		divTree.style.height = (win.p.height - 2 * tbLayout.offsetTop - divTree.offsetTop) + "px";
		divGrid.style.height = (win.p.height - 2 * tbLayout.offsetTop - divGrid.offsetTop) + "px";
		divGrid.style.width = (win.p.width - 2 * tbLayout.offsetLeft - divTree.offsetWidth) + "px";

		initTree();
	}
</script>

<!-- addnew、close -->
<script type="text/javascript">
	function btnRefresh_click() {
		gridView.refresh();
	}
	function btnAddnew_click() {
		gridView.addnew();
	}

	function btnClose_click() {
		win.close();
	}
</script>
<!-- 加载机构 -->
<script type="text/javascript">
	function initTree() {
		var rootNodeKey = "";
		var jsonPara = {
			divContainer: gId("divTree"),
			imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
			title: "组织机构设定",
			beforeExpand: beforeNodeExpand,
			nodeClick: onNodeClick
		};
		tree = new window.xwf_tree(jsonPara);

		rootNodeKey = "0" + tree.sd + topWin.officeId;
		tree.addNode({ key: rootNodeKey, text: topWin.officeShortname, officeId: topWin.officeId, nodeKey: topWin.officeNodeKey });
		tree.addNode({ key: rootNodeKey + tree.sd + "loading", text: "loading..." });

		tree.expand(rootNodeKey);
		tree.textClick(rootNodeKey);		
	}
	function loadTreeNodes(pNodeKey, OfficeID) {
		if (g.a.send("processType=com.xznext.xpas.Common&actionType=getOfficeNodeData", { OfficeID: OfficeID }, true)) {
			if (g.a.OK) {
				var c = g.a.cReturn;
				var dtb = c.dtbOfficeNodeData;
				for (var i = 0; i < dtb.rowCount; i++) {
					var node_key = dtb.rows[i]["node_key"].value;
					var nodeText = dtb.rows[i]["office_name"].value;
					var officeId = dtb.rows[i]["office_id"].value;

					var nodeKey = node_key.substring(0, 3);
					for (var j = 1; j < node_key.length / 3; j++) {
						nodeKey += tree.sd + node_key.substring(3 * j, 3 * j + 3);
					}
					tree.addNode({ key: pNodeKey + tree.sd + officeId, text: nodeText, officeId: officeId, nodeKey: node_key });
					// -- 加载虚拟子节点 ------------------
					if (dtb.rows[i]["children"].value > 0) {
                        tree.addNode({ key: pNodeKey + tree.sd + officeId + tree.sd + "loading", text: "loading..." + dtb.rows[i]["children"].value });
					}
				}
			}
			else {
				return;
			}
		}
		else {
			return;
		}
	}
	function beforeNodeExpand(node, firstExpand) {
		if (!firstExpand) return;
		tree.removeNode(node.key + tree.sd + "loading");

		loadTreeNodes(node.key, node.officeId);
	}

	function onNodeClick(node) {
		if (gridView == null) {
			var prop = {
				divContainer: divGrid,
				viewKey: "fv_office",
				viewForm: g.appPath + "project/xpas/html/organization/office.html",
				viewFilter: "poffice_id = " + node.officeId
			};
			gridView = new window.xwf_gridview(prop);
		}
		else {
			gridView.setViewFilter("poffice_id = " + node.officeId);
		}
	}
</script>