<!DOCTYPE html>
<html>
<head>
    <title>用户权限设定</title>
	<link href="../../../../res/control/tree/style1/xwf.tree.css" rel="stylesheet" type="text/css" />
	<link href="../../../../res/control/tab/style1/xwf.tab.css" rel="stylesheet" type="text/css" />
	
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/control/tab/xwf.tab.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

	<style type="text/css">
		.tdLayout {
			padding: 0px;
			vertical-align: top;
		}
		
		#divTreeUser {
			width: 320px;
			border: solid 1px olive;
			overflow: auto;
		}
	</style>
</head>
<body>
	<div class="divButtons">					
		<input id="btnClose" type="button" value="关闭(C)" onclick="return btnClose_click();" />
		<input id="btnSave" type="button" value="保存(S)" onclick="return btnSave_click()" />
	</div>
	<table>		
		<tr>
			<td id="tdLeft" class="tdLayout">
				<div id="divTreeUser" style="overflow:auto"></div>
			</td>
			<td class="tdLayout">
				<div id="divTabs" class="xwf_tab_divContainer" style="width:420px;height:500px;overflow:auto;">
					<div id="divTreeMenu"></div>
					<div id="divTreeGroup"></div>
				</div>
			</td>
		</tr>
	</table>
</body>
</html>

<!-- formLoad etc. -->
<script type="text/javascript">
	var divTreeUser = gId("divTreeUser");
	var divTreeGroup = gId("divTreeGroup");
	var divTreeMenu = gId("divTreeMenu");
	
	var tabs = null;
	var treeUser = null, treeMenu = null, treeGroup = null;
	// ----------------------------------------------------
	function formLoad() {
		tabs = new window.xwf_tab({ divContainer: gId("divTabs")});
		tabs.addTab({ key: "tabMenu", text: "菜单访问权限", control: divTreeMenu });
		tabs.addTab({ key: "tabGroup", text: "用户所属组", control: divTreeGroup });
		if (urlPara["tabGroupHidden"] && (urlPara["tabGroupHidden"].equals("1") || urlPara["tabGroupHidden"].equals("true"))) {
		    tabs.setTabVisible("tabGroup", false);
		}

		divTreeUser.style.height = (gId("tdLeft").clientHeight - 2) + "px";

		initTree_User();
		initTree_Menu();
		initTree_Group();
	}

	function btnClose_click() {
		win.close();
	}
</script>

<!-- 加载树（用户、菜单、用户组）-->
<script type="text/javascript">
	function initTree_User() {
		var jsonPara = {
			divContainer: gId("divTreeUser"),
			imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
			title: "系统用户",
			sd: "~",
			nodeClick: nodeClick_user
		};
		treeUser = new window.xwf_tree(jsonPara);

		if (g.a.send("processType=com.xznext.xpas.GroupUserMenu&actionType=getUser", {}, true)) {
			if (g.a.OK) {
				var c = g.a.cReturn;
				var dtb = c.dtbUser;
				for (var i = 0; i < c.officeLevel; i++) {
					var nodeText = (i == 0 ? "本级用户" : "下级 (" + i + "级) 机构用户");
					treeUser.addNode({ key: "0" + treeUser.sd + i, text: nodeText, userKey: "" });
				}
				for (var i = 0; i < dtb.rowCount; i++) {
					var userKey = dtb.rows[i]["user_key"].value;
					var nodeKey = "0" + treeUser.sd + dtb.rows[i]["office_level"].value + treeUser.sd + userKey;
					var nodeText = dtb.rows[i]["user_name"].value + "（" + userKey +"）";
					var nodeTitle = dtb.rows[i]["office_fullname"].value;

					treeUser.addNode({ key: nodeKey, text: nodeText, userKey: userKey, title: nodeTitle });
				}
				treeUser.expand("0" + treeUser.sd + "0");
			}
			else {
				return;
			}
		}
		else {
			return;
		}
	}
	function nodeClick_user(node) {
		if (g.a.send("processType=com.xznext.xpas.GroupUserMenu&actionType=getUserAcl", { userKey: treeUser.selectedNode.userKey }, true)) {
			if (g.a.OK) {
				var c = g.a.cReturn;
				var nFind = 0;
				var arrFind = new Array();
				var dtbAcl = c.dtbAcl;
				var dtbGroup = c.dtbGroup;
				var nodeKey = null;

				dtbAcl.sort("menu_key");
				for (var i = 0; i < treeMenu.nodeKeys.length; i++) {
					nodeKey = treeMenu.nodeKeys[i];
					arrFind[0] = treeMenu.nodes[nodeKey].menuKey;
					nFind = dtbAcl.find(arrFind);
					treeMenu.setNodeChecked(nodeKey, (nFind >= 0 ? dtbAcl.rows[nFind]["menu_acl_value"].value : 0));
				}

				dtbGroup.sort("group_key");
				for (var i = 0; i < treeGroup.nodeKeys.length; i++) {
					nodeKey = treeGroup.nodeKeys[i];
					arrFind[0] = treeGroup.nodes[nodeKey].groupKey;
					if (arrFind[0].equals("")) continue;
					nFind = dtbGroup.find(arrFind);
					treeGroup.setNodeChecked(nodeKey, (nFind >= 0 ? 1 : 0));
				}
			}
		}
	}
		
	function initTree_Menu() {
		var jsonPara = {
			divContainer: gId("divTreeMenu"),
			imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
			title: "系统菜单",
			sd: "~",
			showCheckBoxs: "all"
		};
		treeMenu = new window.xwf_tree(jsonPara);

		if (g.a.send("processType=com.xznext.xpas.GroupUserMenu&actionType=getUserMenu", {  }, true)) {
			if (g.a.OK) {
				var c = g.a.cReturn;
				var dtbMenu = c.dtbMenu;
				for (var i = 0; i < dtbMenu.rowCount; i++) {
					var nodeKey = "0";
					var node_key = dtbMenu.rows[i]["node_key"].value;
					var nodeText = dtbMenu.rows[i]["node_text"].value;
					var menuKey = dtbMenu.rows[i]["menu_key"].value;

					for (var j = 0; j < node_key.length / 3; j++) {
						nodeKey += treeMenu.sd + node_key.substring(3 * j, 3 * j + 3);
					}
					treeMenu.addNode({ key: nodeKey, text: nodeText, menuKey: menuKey });
				}
				treeMenu.expand("0");
			}
			else {
				return;
			}
		}
		else {
			return;
		}
	}
	function initTree_Group() {
		var jsonPara = {
			divContainer: gId("divTreeGroup"),
			imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
			title: "系统用户组",
			sd: "~",
			showCheckBoxs: "leaf"
		};
		treeGroup = new window.xwf_tree(jsonPara);

		if (g.a.send("processType=com.xznext.xpas.GroupUserMenu&actionType=getGroup", {}, true)) {
			if (g.a.OK) {
				var c = g.a.cReturn;
				var dtb = c.dtbGroup;
				// ----------------------------------------
				treeGroup.addNode({ key: "0" + treeGroup.sd + "0", text: "上级用户组", groupKey: "" });
				treeGroup.addNode({ key: "0" + treeGroup.sd + "1", text: "本级用户组", groupKey: "" });
				treeGroup.addNode({ key: "0" + treeGroup.sd + "2", text: "下级用户组", groupKey: "" });
				// ----------------------------------------
				for (var i = 0; i < dtb.rowCount; i++) {
					var nodeKey = dtb.rows[i]["group_key"].value;
					var nodeText = dtb.rows[i]["group_name"].value + " (" + nodeKey + ")";
					var groupLevel = dtb.rows[i]["group_level"].value;

					var key = "0" + treeGroup.sd + groupLevel + treeGroup.sd + nodeKey;
					treeGroup.addNode({ key: key, text: nodeText, groupKey: nodeKey });
				}
				treeGroup.expand("0" + treeGroup.sd + "0");
				treeGroup.expand("0" + treeGroup.sd + "1");
			}
			else {
				return;
			}
		}
		else {
			return;
		}
	}
</script>

<!-- save -->
<script type="text/javascript">
	function btnSave_click() {
		var jsonPara = {};
		var nodeUser = treeUser.selectedNode;
		if (nodeUser == null || nodeUser.userKey.equals("")) {
			showWarn("请先选择用户。");
			return;
		}
		jsonPara["userKey"] = nodeUser.userKey;

		var arr = treeMenu.getCheckedKeys();
		for (var i = 0; i < arr.length; i++) {
			var node = treeMenu.nodes[arr[i]];
			arr[i] = node.level + "," + node.key + "," + node.menuKey + "," + node.checked;
		}
		jsonPara["menuKeys"] = arr.join(";");

		arr = treeGroup.getCheckedKeys();
		for (var i = 0; i < arr.length; i++) {
			var node = treeGroup.nodes[arr[i]];
			arr[i] = node.groupKey;
		}
		jsonPara["groupKeys"] = arr.join(";");

		if (g.a.send("processType=com.xznext.xpas.GroupUserMenu&actionType=saveUserAcl", jsonPara, true)) {
			if (g.a.OK) {
				win.flashTitle("当前操作成功。");
			}
			else {
				return;
			}
		}
		else {
			return;
		}
	}
</script>