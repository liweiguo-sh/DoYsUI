<!DOCTYPE html>
<html>
<head>
    <title>用户选择</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

    <style type="text/css">
        #divTree {
            overflow: auto;
        }
    </style>
</head>
<body>
	<div id="divButton" class="divButtons">
		<input type="button" id="btnSelect" onclick="btnSelect_click();" value="确定" />
		<input type="button" id="btnClose" onclick="btnClose_click();" value="关闭" />
	</div>
	<div class="PanelA" style="margin-top:8px;">
		<div id="divTree" style="width:500px;"></div>
	</div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript"> 
    var userKeys = "";
    var arrUserKey = null;

    var divTree = gId("divTree");

    var tree = null;
	// ------------------------------------------------------------------------
    function formLoad() {
        userKeys = win.para.userKeys;
        arrUserKey = userKeys.split("\n");

        formResize();

        initTree();
    }
    function formResize() {
        var height = win.p.maxHeight;

        divTree.style.height = (height - divTree.offsetHeight - 200) + "px";
    }
</script>

<!-- init -->
<script type="text/javascript">
    function initTree() {
        var checked = 0;
        var officeNodeKey = "", userKey = "", userName = "";
        var rootKey = "0", key = "", parentKey = "", expandKey = "";
        var jsonPara = {
            divContainer: gId("divTree"),
            imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
            title: "用户选择"
        };

        // ------------------------------------------------
        tree = new window.xwf_tree(jsonPara);

        if (g.a.send("processType=com.system.flow.FlowAcl&actionType=getUser", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbUser = cReturn.dtbUser;

                for (var i = 0; i < dtbUser.rowCount; i++) {
                    if (!officeNodeKey.equals(dtbUser.rows[i]["node_key"].value)) {
                        officeNodeKey = dtbUser.rows[i]["node_key"].value;

                        parentKey = rootKey;
                        for (var j = 0; j < officeNodeKey.length / 3; j++) {
                            parentKey += tree.sd + officeNodeKey.substring(3 * j, 3 * (j + 1));
                        }
                        tree.addNode({ key: parentKey, text: dtbUser.rows[i]["office_name"].value });

                        if (i == 0) expandKey = parentKey;
                    }

                    userKey = dtbUser.rows[i]["user_key"].value;
                    userName = dtbUser.rows[i]["user_name"].value;
                    key = parentKey + tree.sd + userKey;
                    checked = 0;
                    for (var k = 0; k < arrUserKey.length; k++) {
                        if (arrUserKey[k].equals(userKey)) {
                            checked = 1;
                            break;
                        }
                    }
                    tree.addNode({ key: key, text: userKey + "&nbsp;&nbsp;&nbsp;&nbsp;" + userName, userKey: userKey, showCheckBox: true, checked: checked });
                }
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
        // ------------------------------------------------
        if (expandKey) {
            tree.expand(expandKey);
        }
        else {
            tree.expand(rootKey);
        }
    }
</script>

<!-- buttons -->
<script type="text/javascript">
    function btnClose_click() {
        win.close();
    }

    function btnSelect_click() {
        var userKeys = "";

        var arrUserKeys = new Array();
        var arrKeys = tree.getCheckedKeys();

        var node = null;
        // ------------------------------------------------
        for (var i = 0; i < arrKeys.length; i++) {
            node = tree.nodes[arrKeys[i]];

            arrUserKeys.push(node.userKey);
        }
        userKeys = arrUserKeys.join("\n");

        win.para.callback({ userKeys: userKeys });
        win.close();
    }
</script>