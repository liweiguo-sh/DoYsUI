<!DOCTYPE html>
<html>
<head>
    <title>用户组选择</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
    <style type="text/css">
        #divTree {
            overflow: auto;
        }
    </style>
</head>
<body>
	<div id="divButton" class="divButtons">
		<input type="button" id="btnSelect" onclick="btnSelect_click();" value="确定" />
		<input type="button" id="btnClose" onclick="btnClose_click();" value="关闭" />
	</div>
	<div class="PanelA" style="margin-top:8px;">
		<div id="divTree" style="width:500px;"></div>
	</div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript"> 
    var groupKeys = "";
    var arrGroupKey = null;

    var divTree = gId("divTree");

    var tree = null;
	// ------------------------------------------------------------------------
    function formLoad() {
        groupKeys = win.para.groupKeys;
        arrGroupKey = groupKeys.split("\n");

        formResize();

        initTree();
    }
    function formResize() {
        var height = win.p.maxHeight;

        divTree.style.height = (height - divTree.offsetHeight - 200) + "px";
    }
</script>

<!-- init -->
<script type="text/javascript">
    function initTree() {
        var checked = 0;
        var officeNodeKey = "", groupKey = "", groupName = "";
        var rootKey = "0", key = "", parentKey = "", expandKey = "";
        var jsonPara = {
            divContainer: gId("divTree"),
            imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
            title: "用户组选择"
        };

        // ------------------------------------------------
        tree = new window.xwf_tree(jsonPara);

        if (g.a.send("processType=com.system.flow.FlowAcl&actionType=getGroup", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                var dtbGroup = cReturn.dtbGroup;

                for (var i = 0; i < dtbGroup.rowCount; i++) {
                    if (!officeNodeKey.equals(dtbGroup.rows[i]["node_key"].value)) {
                        officeNodeKey = dtbGroup.rows[i]["node_key"].value;

                        parentKey = rootKey;
                        for (var j = 0; j < officeNodeKey.length / 3; j++) {
                            parentKey += tree.sd + officeNodeKey.substring(3 * j, 3 * (j + 1));
                        }
                        tree.addNode({ key: parentKey, text: dtbGroup.rows[i]["office_name"].value });

                        if (i == 0) expandKey = parentKey;
                    }

                    groupKey = dtbGroup.rows[i]["group_key"].value;
                    groupName = dtbGroup.rows[i]["group_name"].value;
                    key = parentKey + tree.sd + groupKey;
                    checked = 0;
                    for (var k = 0; k < arrGroupKey.length; k++) {
                        if (arrGroupKey[k].equals(groupKey)) {
                            checked = 1;
                            break;
                        }
                    }
                    tree.addNode({ key: key, text: groupKey + "&nbsp;&nbsp;&nbsp;&nbsp;" + groupName, groupKey: groupKey, showCheckBox: true, checked: checked });
                }
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
        // ------------------------------------------------
        if (expandKey) {
            tree.expand(expandKey);
        }
        else {
            tree.expand(rootKey);
        }
    }
</script>

<!-- buttons -->
<script type="text/javascript">
    function btnClose_click() {
        win.close();
    }

    function btnSelect_click() {
        var groupKeys = "";

        var arrGroupKeys = new Array();
        var arrKeys = tree.getCheckedKeys();

        var node = null;
        // ------------------------------------------------
        for (var i = 0; i < arrKeys.length; i++) {
            node = tree.nodes[arrKeys[i]];

            arrGroupKeys.push(node.groupKey);
        }
        groupKeys = arrGroupKeys.join("\n");

        win.para.callback({ groupKeys: groupKeys });
        win.close();
    }
</script>