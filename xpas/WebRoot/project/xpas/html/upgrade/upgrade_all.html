<!DOCTYPE html>
<html>
<head>
    <title>一键智能升级</title>
    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

    <style type="text/css">
        body {
            overflow: hidden;
            font-family: 微软雅黑;
        }

        #btnUpgrade {
            color: Orange;
        }

            #btnUpgrade:hover {
                color: Yellow;
            }

        .tbItem {
            border-collapse: collapse;
        }

            .tbItem td {
                overflow: hidden;
                padding-top: 5px;
                padding-bottom: 5px;
                border: dotted 0px #f0f0f0;
                -ms-user-select: none;
            }

        .tdTitle {
            color: Orange;
        }

        .tdItem {
            color: Olive;
            padding-left: 10px;
            padding-right: 10px;
        }

        .divMessage {
            overflow: auto;
            margin-top: 15px;
            font-size: 11pt;
            line-height: 24px;
            background-color: White;
        }

        .errMessage {
            color: Red;
        }
    </style>
</head>
<body>
    <div id="divButton" class="uvButtons">
        <input type="button" id="btnClose" onclick="btnClose_click();" value="关闭" />
        <input type="button" id="btnUpgrade" onclick="btnUpgrade_click();" value="一键升级" />
    </div>
    <div class="PanelA">
        <form id="frm" action="">
            <table id="tbUpgradeRes" class="tbItem">
                <tr>
                    <td class="tdTitle" rowspan="3">升级资源项</td>
                    <td class="tdItem" colspan="2"><input type="checkbox" id="chkSQL0" /><label for="chkSQL0">数据库(X99)脚本</label></td>
                    <td></td>
                    <td class="tdItem" colspan="2"><input type="checkbox" id="chkDesign0" /><label for="chkDesign0">数据库(X99)设计</label></td>
                </tr>
                <tr>
                    <td class="tdItem"><input type="checkbox" id="chkTable" checked="checked" /><label for="chkTable">表结构</label></td>
                    <td class="tdItem" colspan="2"><input type="checkbox" id="chkSQL" checked="checked" /><label for="chkSQL">数据库脚本</label></td>
                    <td class="tdItem" colspan="2"><input type="checkbox" id="chkExecSQL" checked="checked" /><label for="chkExecSQL">执行升级脚本</label></td>
                </tr>
                <tr>
                    <td class="tdItem"><input type="checkbox" id="chkMenu" checked="checked" /><label for="chkMenu">菜单</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkFlow" checked="checked" /><label for="chkFlow">流程</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkUView" checked="checked" /><label for="chkUView">视图</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkTree" checked="checked" /><label for="chkTree">树</label></td>
                    <td class="tdItem"><input type="checkbox" id="chkReport" checked="checked" /><label for="chkReport">报表</label></td>
                </tr>
            </table>
        </form>
        <div id="divMessage" class="divMessage"></div>
    </div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
    var arrMessage = new Array();
    var divMessage = gId("divMessage");
    // ------------------------------------------------------------------------
    function formLoad() {
        formResize();
    }

    function formResize() {
        divMessage.style.height = (win.p.height - divMessage.offsetTop - 20) + "px";
    }

    function btnClose_click() {
        win.close();
    }
</script>

<!-- 一键升级 -->
<script type="text/javascript">
    function btnUpgrade_click() {
        var d1 = new Date();

        clearMessage();
        writeMessage("一键升级开始，请耐心等待 ......");

        upgradeAll();
        writeMessage("总计耗时：" + g.x.timeInterval(d1, new Date()) + "。");
    }

    function upgradeAll() {
        // -- 0. 升级 sql0 & design0 -----------------------
        if (frm.chkSQL0.checked) {
            if (!upgradeSQL0()) return;
        }
        if (frm.chkDesign0.checked) {
            upgradeDesign0();
        }
        writeMessage("");

        // -- 1. 下载数据库升级脚本，执行升级脚本 ---------------
        if (frm.chkSQL.checked) {
            if (!upgradeSQL()) return;
        }
        if (frm.chkExecSQL.checked) {
            if (g.a.send("processType=com.xtfs.XtfsSql&actionType=getExecSqlIds", {}, true)) {
                if (g.a.OK) {
                    var cReturn = g.a.cReturn;
                    var dtbExecSqlId = cReturn.dtbExecSqlId;
                    var sqlId = 0;

                    for (var i = 0; i < dtbExecSqlId.rowCount; i++) {
                        sqlId = dtbExecSqlId.rows[i]["sql_id"].value;
                        if (execSQL(sqlId)) {
                            continue;
                        }
                        else {
                            return false;
                        }
                    }
                }
                else {
                    return false;
                }
            }
            else {
                return false;
            }
        }

        // -- 2. 升级设计 ---------------------------------
        var arrDesignType = new Array();

        if (frm.chkTable.checked) arrDesignType.push(new Array("table", "表结构"));

        if (frm.chkMenu.checked) arrDesignType.push(new Array("menu", "菜单"));
        if (frm.chkFlow.checked) arrDesignType.push(new Array("flow", "流程"));
        if (frm.chkUView.checked) arrDesignType.push(new Array("view", "框架视图"));
        if (frm.chkTree.checked) arrDesignType.push(new Array("tree", "树"));
        if (frm.chkReport.checked) arrDesignType.push(new Array("report", "报表"));

        for (var i = 0; i < arrDesignType.length; i++) {
            if (!upgradeDesign(arrDesignType[i][0], arrDesignType[i][1])) {
                break;
            }
        }
    }

    function upgradeSQL0() {
        if (g.a.send("processType=com.xtfs.UpgradeXtfsSys&actionType=upgradeSql0", {}, false)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                if (cReturn.nAddnew || cReturn.nUpdate) {
                    writeMessage("数据库(X99)脚本升级成功。\n本次操作新增 " + cReturn.nAddnew + " 条主数据，更新 " + cReturn.nUpdate + " 条主数据。");
                }
                else {
                    writeMessage("当前站点数据库(X99)脚本数据已是最新版本，未检测到服务器有更新数据。");
                }
                return true;
            }
            else {
                writeError(g.a.ErrMessage);
                return false;
            }
        }
        else {
            return false;
        }
    }
    function upgradeDesign0() {
        var strMessage = "";
        var arrMsg = new Array();
        if (g.a.send("processType=com.xtfs.UpgradeXtfsSys&actionType=upgradeDesign0", {}, false)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                if (cReturn.nAddnew || cReturn.nUpdate || cReturn.nDelete) {
                    arrMsg.push("数据库(X99)设计升级成功。本次操作");
                    if (cReturn.nAddnew > 0) arrMsg.push("新增 " + cReturn.nAddnew + " 条主数据，");
                    if (cReturn.nUpdate > 0) arrMsg.push("更新 " + cReturn.nUpdate + " 条主数据，");
                    if (cReturn.nDelete > 0) arrMsg.push("删除 " + cReturn.nDelete + " 条主数据，");
                    strMessage = arrMsg.join("");
                    writeMessage(strMessage.substring(0, strMessage.length - 1) + "。");
                }
                else {
                    writeMessage("当前站点数据库(X99)设计数据已是最新版本，未检测到服务器有更新数据。");
                }
                return true;
            }
            else {
                writeError(g.a.ErrMessage);
                return false;
            }
        }
        else {
            return false;
        }
    }

    function upgradeSQL() {
        if (g.a.send("processType=com.xtfs.XtfsSql&actionType=getLastVersion", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                if (cReturn.nAddnew || cReturn.nUpdate) {
                    writeMessage("获取数据库脚本操作成功。\n本次操作新增 " + cReturn.nAddnew + " 条主数据，更新 " + cReturn.nUpdate + " 条主数据。");
                }
                else {
                    writeMessage("当前站点数据库脚本数据已是最新版本，未检测到服务器有更新数据。");
                }
                return true;
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
    function execSQL(sqlId) {
        if (g.a.send("processType=com.xtfs.XtfsSql&actionType=execSQL", { sqlId: sqlId }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                writeMessage("数据库脚本 ( SQL_ID = " + sqlId + " ) 执行成功。");
                return true;
            }
            else {
                writeError("数据库脚本 ( SQL_ID = " + sqlId + " )执行失败。");
                return false;
            }
        }
        else {
            return false;
        }
    }

    function upgradeDesign(mdataType, mdataText) {
        if (g.a.send("processType=com.xtfs.XtfsCore&actionType=getLastVersion", { mdataType: mdataType, mdataKeys: "*" }, true)) {
            if (g.a.OK) {
                writeMessage(mdataText + "升级成功。");
                return true;
            }
            else {
                writeError(mdataText + "升级失败。");
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>

<!-- 辅助函数 -->
<script type="text/javascript">
    function clearMessage() {
        arrMessage = new Array();
        divMessage.innerHTML = "";
    }

    function writeError(strError) {
        arrMessage.push((new Date).toString("hh:mm:ss.ms") + " - <span class='errMessage'>" + strError + "</span>");
        divMessage.innerHTML = arrMessage.join("<br />");
    }
    function writeMessage(strMessage) {
        if (strMessage.equals("")) {
            arrMessage.push("");
        }
        else {
            arrMessage.push((new Date).toString("hh:mm:ss.ms") + " - " + strMessage);
        }
        divMessage.innerHTML = arrMessage.join("<br />");
    }
</script>
