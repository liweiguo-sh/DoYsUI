<!DOCTYPE html>
<html>
<head>
    <title>数据库维护SQL</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>	

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<style type="text/css">
		body {
			overflow: hidden;
		}
		#_cSql_sql {
			overflow: auto;
		}
	</style>
</head>
<body>
	<div id="divDC" style="width:1400px" class="ScreenCenter"></div>
	<div class="PanelA">
		<form id="frm" action="" target="com.xtfs.SqlScript">
			<table id="tbForm" class="tbForm" style="width:100%">
				<tr id="trH">
					<th style="width:  9%;"></th>
					<th style="width: 14%;"></th>
					<th style="width:  9%;"></th>
					<th style="width: 14%;"></th>
					<th style="width:  9%;"></th>
					<th style="width: 22%;"></th>
					<th style="width:  9%;"></th>
					<th style="width: 14%;"></th>
				</tr>
				<tr>				
					<td>SQL_ID</td>
					<td><input type="text" id="_cSQL_ID" disabled="disabled" placeholder="系统自动生成" /></td>
					<td>数据库</td>
					<td><input type="text" id="_cDatabase_key" controlType="dropdown" fieldValue="database_key" visibleSearch="false" /></td>
					<td>操作表</td>
					<td><input type="text" id="_cTable_key" controlType="dropdown" fieldValue="table_key" widthPanel="330" /></td>
					<td>脚本类型</td>
					<!--<td><input type="text" id="_cSql_type" controlType="dropdown" fieldValue="type_key" fieldText="type_name" fieldsVisible="type_name" dataSource="[['type_key','type_name'],['data','数据维护'],['table','表结构']]" enabled="false" /></td>-->
					<td><input type="text" id="_cSql_type" /></td>
				</tr>
				<tr>
					<td>签入状态</td>
					<td><input type="text" id="_cSql_checkin_status" controlType="dropdown" fieldValue="status_id" fieldText="status_name" fieldsVisible="status_name" dataSource="[['status_id','status_name'],[0,'待签入'],[1,'已签入']]" enabled="false" /></td>										
					<td>签入时间</td>
					<td><input type="text" id="_cSql_checkin_time" disabled="disabled" /></td>
					<td>执行状态</td>
					<td><input type="text" id="_cSql_exec_status" controlType="dropdown" fieldValue="status_id" fieldText="status_name" fieldsVisible="status_name" dataSource="[['status_id','status_name'],[0,'未执行'],[-1,'已执行'],[1,'执行失败']]" enabled="false" /></td>
					<td>执行时间</td>
					<td><input type="text" id="_cSql_exec_time" disabled="disabled" /></td>	
				</tr>
				<tr>
					<td>摘要</td>
					<td colspan="7"><input type="text" id="_cSql_title" id="_cTitle" /></td>							
				</tr>
				<tr>
					<td>SQL</td>
					<td colspan="7"><textarea id="_cSql_sql" rows="25" cols="0" wrap="off"></textarea></td>
				</tr>
				<tr>
					<td>备注</td>
					<td colspan="7"><textarea id="_cSql_remark" rows="4" cols="0"></textarea></td>
				</tr>
				<tr>				
					<td></td>
					<td><span id="_cCreator"></span></td>
					<td></td>
					<td><span id="_cCDate"></span></td>
					<td></td>
					<td><span id="_cModifier"></span></td>
					<td></td>
					<td><span id="_cMDate"></span></td>
				</tr>
			</table>
		</form>
	</div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var checkoutStatus = false;
	// ------------------------------------------------------------------------
	function formLoad() {
		checkoutStatus = win.parentWindow.checkoutStatus;

		vf.addExtraButton({ key: "xTFS", text: "xTFS" });
		vf.css(gId("tbForm"));
	}
</script>

<!-- vf.events -->
<script type="text/javascript">
	vf.beforeAddnew = function () {
		if (!checkoutStatus) {
			showWarn("请先签出数据库管理权。");
			return false;
		}
		return true;
	}
	vf.afterAddnew = function () {
		// frm._cSql_type.setValue("data");
		frm._cSql_type.value = "data";
		frm._cSql_checkin_status.setValue(0);
		frm._cSql_exec_status.setValue(0);
		frm._cSql_checkin_time.value = "";
		frm._cSql_exec_time.value = "";
	}
	vf.afterMove = function () {
		if (!checkoutStatus) {
			vf.buttons["addnew"].style.display = "none";
			vf.buttons["delete"].style.display = "none";
			vf.buttons["save"].style.display = "none";
			vf.buttons["copy"].style.display = "none";
		}
	}

	vf.beforeClick = function (para) {
		if (para.buttonKey.equals("xTFS")) {
			openXtfsMenu({ objDom: para.button });
		}
		return false;
	}
</script>

<!-- xTFS -->
<script type="text/javascript">
	function openXtfsMenu(para) {
		var blCheckin = false, blCancelModify = false;

		var arrMenus = new Array();
		// ------------------------------------------------
		if (vf.checkNeedSave(true, false)) return;

		if (frm._cSql_checkin_status.underValue.toInt() == 0) {
			blCheckin = true;
			blCancelModify = true;
		}
		if (frm._cSql_exec_status.underValue.toInt() != -1) {
			blCheckin = false;
		}
		// ------------------------------------------------
		if (blCheckin) arrMenus.push({ key: "checkin", text: "签入", action: "checkin" });
		arrMenus.push({ key: "execSQL", text: "执行", action: "execSQL" });
		if (blCancelModify) arrMenus.push({ key: "cancelModify", text: "撤销更改", action: "cancelModify" });		
		topWin.context.show({ arrMenus: arrMenus, menuClick: xtfsMenu_click, objDom: para.objDom, top: 0, left: 0 });
	}
	function xtfsMenu_click(para) {
		var menuKey = para.key;
		if (menuKey.equals("checkin")) {
			checkin();
		}
		else if (menuKey.equals("cancelModify")) {
			cancelModify();
		}
		else if (menuKey.equals("execSQL")) {
			execSQL();
		}
		else {
			alert("");
		}
	}

	function checkin() {
		if (g.a.send("processType=com.xtfs.XtfsSql&actionType=checkin", { sqlId: frm._cSQL_ID.value }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				vf.remove();
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
	function cancelModify() {
		if (g.a.send("processType=com.xtfs.XtfsSql&actionType=cancelModify", { sqlId: frm._cSQL_ID.value }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				vf.refreshRecord();
				win.flashTitle("主数据撤销更改成功。");
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}

	function execSQL() {
		var execStatus = frm._cSql_exec_status.underValue.toInt();
		// ------------------------------------------------
		if (execStatus == -1) {
			if (!showConfirm("当前SQL已经成功执行过，确定要重新执行吗？")) {
				return;
			}
		}
		// ------------------------------------------------
		if (g.a.send("processType=com.xtfs.XtfsSql&actionType=execSQL", { sqlId: frm._cSQL_ID.value }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				vf.refreshRecord();
				win.flashTitle("主数据SQL执行完成。");
			}
			else {
				vf.refreshRecord();
				win.flashTitle("主数据执行失败。");
				return false;
			}
		}
		else {
			return false;
		}
	}
</script>