<!DOCTYPE html>
<html>
<head>
    <title>空白APP主页</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
	<script src="../../../../res/jscript_mobile/xmf.sqlite.js" type="text/javascript"></script>
	<script src="../../../../res_plugin/app/WebView.js" type="text/javascript"></script>
	<script src="../../../../res/jscript_mobile/xmf.app.js" type="text/javascript"></script>
	<style type="text/css">
		body {
			margin: 100px 10px 0px 10px;
		}

		#tbMain {
			width: 100%;
			table-layout: fixed;
			border-collapse: collapse;		
		}
		#tbMain td {
			padding: 0px;
			overflow: hidden;
			vertical-align: middle;
			border: solid 0px gray;
		}

		#tdUrl {
			text-align: left;
		}
		#txtUrl {
			width: 98%;
			font-family: 微软雅黑;
			border: solid 1px Green;
		}

		#tdScan {
			 background-image: url('../../images/app/scan.png');
			 background-position: center center;
			 background-repeat: no-repeat;
		}

		#tdLoadUrl {
			text-align: right;
			height: 100px;
		}
		#btnLoadUrl {
			font-size: 12pt;
			line-height: 36px;
			background-color: #e8ebf2;
			border: solid 1px Green;
			padding-right: 5px;
			width: 120px;
			height: 36px;
			border-radius: 3px;
		}
	</style>
</head>
<body onload="formLoad();">
	<div id="divLayout" style="display:none;">
		<table id="tbMain">
			<tr>
				<td style="width:85%;"></td>
				<td style="width:15%;"></td>
			</tr>
			<tr>
				<td colspan="2" style="height:50px;">APP初次使用请扫码登录：</td>
			</tr>
			<tr>
				<td id="tdUrl"><textarea id="txtUrl" rows="2" cols="0"></textarea></td>
				<td id="tdScan" onclick="tdScan_click();"></td>
			</tr>
			<tr>
				<td id="tdLoadUrl"><input type="button" id="btnLoadUrl" onclick="btnLoadUrl_click();" value="确认登录" /></td>
				<td></td>
			</tr>
		</table>
	</div>	
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var dbPath = "D:\\APP\\AppSQLite\\";	// -- 用于PC端模拟调试 --
	var appKey = "example"; 				// -- App标识, 本地SQLite数据库名称与appKey同名 --

	var urlAppLogin = "";
	var txtUrl = gId("txtUrl");
	var divLayout = gId("divLayout");
	// ------------------------------------------------------------------------
	function formLoad() {	    
	    if (!db.openDatabase(appKey, dbPath)) {	        
	        showErr("打开本地SQLite数据库遇到意外错误，请重试。");
	        return;
	    }
		// ------------------------------------------------
	    getUrlAppLogin();
	    if (urlAppLogin.equals("") || urlAppLogin.length < 20) {
	        divLayout.style.display = "";
	        // getUrlByScan();
			return;
        }
		// ------------------------------------------------
        txtUrl.value = urlAppLogin;
		App.loadUrl(urlAppLogin);
	}

	function tdScan_click() {
		getUrlByScan();
	}
	function btnLoadUrl_click() {
		if (!updateUrlAppLogin()) {
			return false;
		}
		App.loadUrl(urlAppLogin);
	}

	function getUrlAppLogin() {
		var nResult = 0;
		var sql = "";
		// ------------------------------------------------
		nResult = db.getInt("SELECT COUNT(*) num1 FROM sqlite_master WHERE type = 'table' AND name = 'T_APP_BLANK'");
		if (nResult == 0) {
			// alert("表 T_APP_BLANK 不存在。");
			sql = "CREATE TABLE T_APP_BLANK (app_blank_key VARCHAR(255), app_blank_value VARCHAR(255))";
			nResult = db.execSQL(sql);
		}

		sql = "SELECT * FROM T_APP_BLANK WHERE app_blank_key = 'url_app_login'";
		dtb = db.getDataTable(sql);
		if (dtb.rowCount == 0) {
			// alert("参数 url_app_login 不存在");
			sql = "INSERT INTO T_APP_BLANK (app_blank_key, app_blank_value) VALUES ('url_app_login', 'http://')";
			nResult = db.execSQL(sql);
			// alert("插入空白参数成功，" + nResult);
		}
		else {
			urlAppLogin = dtb.rows[0]["app_blank_value"].value;
		}
	}
	function updateUrlAppLogin() { 
		var nResult = 0;
		var sql = "";
		// ------------------------------------------------
		urlAppLogin = txtUrl.value.trim();
		if (urlAppLogin.length < 30 || urlAppLogin.indexOf("http://") != 0 || urlAppLogin.indexOf("login.html") < 0) {
			showWarn("网址不合法，请重新扫码。");
			return false;
		}
		sql = "UPDATE T_APP_BLANK SET app_blank_value = '" + urlAppLogin + "' WHERE app_blank_key = 'url_app_login'";
		nResult = db.execSQL(sql);
		// alert("更新参数成功，" + nResult);
		return true;
	}
</script>

<!-- 扫码登录 -->
<script type="text/javascript">
	function getUrlByScan() {
		try {
			App.scanBarcode(scanCallback);
		}
		catch (e) {
			alert(e.toString());
		}
	}
	function scanCallback(barcode) {
		txtUrl.value = barcode;
		urlAppLogin = barcode;
	}
</script>