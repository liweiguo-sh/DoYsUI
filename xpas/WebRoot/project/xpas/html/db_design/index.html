<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>表索引维护窗口</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>	

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<style type="text/css">
		body {
			overflow: hidden;
		}
	</style>
</head>
<body>
	<div id="divDC" style="width:660px" class="ScreenCenter"></div>
	<div class="PanelA">
		<form id="frm" action="" target="com.db_design.Index">
			<table id="tbForm" class="tbForm" style="width:100%">
				<tr id="trH">
					<th style="width: 20%;"></th>
					<th style="width: 40%;"></th>
					<th style="width: 20%;"></th>
					<th style="width: 20%;"></th>
				</tr>
				<tr>				
					<td>索引名称</td>
					<td><input type="text" id="_cINDEX_KEY" /></td>
					<td>索引类型</td>
					<td><input type="text" id="_cIndex_type"  controlType="dropdown" fieldValue="index_type" fieldText="index_type" dataSource="[['index_type'],['FK'],['FX'],['PK'],['UX'],['IX']]" visibleSearch="false" /></td>					
				</tr>
				<tr>
					<td>字段</td>
					<td colspan="3"><textarea id="_cIndex_fields" rows="5" cols="0"></textarea></td>
				</tr>
				<tr>
					<td>备注</td>
					<td colspan="3"><textarea id="_cIndex_remark" rows="2" cols="0"></textarea></td>
				</tr>
			</table>
			<input type="hidden" id="_cTABLE_KEY"/>
		</form>		
	</div>
	<div id="divGrid" style="width:660px;height:442px;margin-top:20px;">a</div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var tableKey = "", tableName = "";

	var txtIndexFields = gId("_cIndex_fields");

	var divGrid = gId("divGrid");
	var gridview = null;
	var frmParent = null;
	// ------------------------------------------------------------------------
	function formLoad() {
		frmParent = win.parentWindow.frm;
		tableKey = frmParent._cTABLE_KEY.value.trim();
		tableName = frmParent._cTable_Name.value.trim();

		vf.css(gId("tbForm"));
		initGrid();		
	}
</script>

<!-- vf.events -->
<script type="text/javascript">
	vf.beforeSave = function () {
		if (frm._cINDEX_KEY.value.equals("")) {
			frm._cINDEX_KEY.value = getIndexKeyNew(frm._cIndex_type.underValue);
		}

		if (frm._cIndex_fields.value.equals("")) {
			showWarn("索引字段不能为空，请检查。");
			frm._cIndex_fields.focus();
			return false;
		}
		frm._cIndex_fields.value = frm._cIndex_fields.value.replaceAll(" ", "");
		frm._cIndex_fields.value = frm._cIndex_fields.value.replaceAll(",", ", ");
		return true;
	}

	vf.afterLoad = function () {
		gId("_cIndex_type").instance.rowClick = indexTypeRowClick;
	}
	vf.afterAddnew = function () {
		var dtbIndex = win.parentWindow.gridviewI.dtbViewData;
		var dtbField = gridview.dtbViewData;

		frm._cTABLE_KEY.value = tableKey;
		if (dtbIndex.rowCount == 0) {
			frm._cIndex_type.setValue("PK");
			for (var i = 0; i < dtbField.rowCount; i++) {
				if (dtbField.rows[i]["field_name"].value.equals(tableName + "_id")) {
					frm._cIndex_fields.value = dtbField.rows[i]["field_name"].value;
					break;
				}
			}
		}
		else {
			frm._cIndex_type.setValue("IX");
		}
		frm._cINDEX_KEY.value = getIndexKeyNew(frm._cIndex_type.underValue);
	}

	function indexTypeRowClick(para) {
		frm._cINDEX_KEY.value = getIndexKeyNew(para.dataRow["index_type"].value);
		return true;
	}
	function getIndexKeyNew(indexType) {
		var blFind = false;
		var indexKeyNew = "";
		var dtbIndex = win.parentWindow.gridviewI.dtbViewData;
		// ------------------------------------------------
		if (indexType.equals("PK") || indexType.equals("FK")) {
			indexKeyNew = indexType + "_" + tableName;
			return indexKeyNew;
		}

		indexKeyNew = indexType + "1_" + tableName;
		for (var i = 0; i < dtbIndex.rowCount; i++) {
			indexKeyNew = indexType + (i + 1) + "_" + tableName;
			for (var iRow = 0; iRow < dtbIndex.rowCount; iRow++) {
				if (dtbIndex.rows[iRow]["index_key"].value.equals(indexKeyNew)) {
					blFind = true;
					break;
				}
			}
			if (!blFind) break;
			blFind = false;
		}
		// ------------------------------------------------
		return indexKeyNew;
	}
</script>

<!-- 字段视图 -->
<script type="text/javascript">
	function initGrid() {
		var prop = {
			divContainer: divGrid,
			viewKey: "fv_index_field",
			viewFilter: "table_key = '" + tableKey + "'"
		};
		gridview = new window.xwf_gridview(prop);
	}

	function viewExtraButtonClick(para) {
		var dataRow = para.drViewData;
		var fieldName = dataRow["field_name"].value;
		var indexFields = txtIndexFields.value.trim();

		if ((indexFields + ",").indexOf(fieldName + ",") >= 0) {
			showWarn("当前字段已经追加到索引中。");
			return;
		}
		else {
			txtIndexFields.value = indexFields + (indexFields.equals("") ? "" : ", ") + fieldName;
		}
	}
</script>