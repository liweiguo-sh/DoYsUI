<!DOCTYPE html>
<html>

<head>
    <title>报表简单</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
    <script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>


    <script src="../../../../res/jscript/web_print.js?v=20191116" type="text/javascript"></script>
	 <script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.js"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zuiExt.js"></script>
    
    <link rel="stylesheet" href="../../../../res_plugin/zui-1.8.1-dist/lib/chosen/chosen.min.css" />
    <script src="../../../../res_plugin/zui-1.8.1-dist/lib/chosen/chosen.min.js"></script>
     <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    
   
    <link rel="stylesheet" href="../../../../res_plugin/bootstrap3.7/bootstrap-table/css/bootstrap-table.css" />
    <link rel="stylesheet" href="../../../../res_plugin/bootstrap3.7/dtpicker/css/bootstrap-datetimepicker.min.css" />
    
    
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table-local-zh-CN.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    
    
    
    <script src="../../../../res_plugin/jquery/jquery-migrate-1.2.1.js" title="jQuery migrate插件解决迁移兼容问题"></script>
	<script src="../../../../res_plugin/jquery/jquery-barcode.min.js" title="条形码"></script>
	<script src="../../../../res_plugin/jquery/jquery.jqprint-0.3.js" title="打印插件"></script>


    <script src="../../../../res/jscript/reportSIMPModel.js?v=20200115"></script>
    <link rel="stylesheet" href="../../../../res_plugin/zui-1.8.1-dist/css/zui.min.css" />
    <style type="text/css">
    	 body{
    	 	overflow: hidden;
    	 }
    	 
    </style>
</head>

<body>
    <div class="container-fluid" >
        <div class="row" >
            <div class="row">
				  <div class="col-xs-12">
				  		 <ul class="nav nav-primary nav-justified" id="reportNav" style="    padding: 0px 18px;">
				    	</ul>
					    <div class="tab-content col-xs-12" id="reportNavContent">
					    </div>
				  </div>
			</div>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
var viewKey,reportSIMPModelUse,formtool={},reportUse={},version="20200210001",opDelayTIme=3000;
var reportList=[],reportCurrIndex=-1,viewKeyList=[],timeoutload=300;
var reportNav,reportNavContent;

function formLoad() {
	//接受参数,url参数优先级低
    //rs_deptout_bycatr,rs_deptout_bymatr
    viewKey=win.p.menu.drMenu.menu_parameter.value;
    viewKeyList=viewKey.split(",");
    reportNav=$("#reportNav");
    reportNavContent=$("#reportNavContent");
    
    var reportOb,param;
    var navId,navContentHtml=[];
    for(var i=0;i<viewKeyList.length;i++){
    	reportOb={};
    	param={};
    	reportOb.index=i;
    	reportOb.reportKey=viewKeyList[i];
    	 //加载相关JS，参数优先级高
    	reportUse={};
	    g.a.attachJavaScriptFile(g.appPath + "project/g_spd/js/reportSIMP/reportSIMP."+reportOb.reportKey+".js?v="+version);
	    if(reportUse && reportUse.getReportParam){
	    	 if(reportUse.getReportParam ){
	    	 	var param2=reportUse.getReportParam();
	    	 	 for (var key in param2) {
			        param[key] = param2[key];
			    }
	    	 } 
	    }
	    param.tableBox="tableBox";
	    param.tableId="drugsTable";
	    param.reportKey=viewKey;
	    param.formId="form-filter";
	    param.reportKey=viewKeyList[i];
	    reportOb.param=param;
	    reportList.push(reportOb);
	   
	    
    }
    
    //追加各个统计报表
    var listyle="float: left; width: 199px; text-align: center;"
    for(var i=0;i<reportList.length;i++){
    	reportOb=reportList[i];
    	param=reportOb.param;
    	reportOb.navId="nav"+i;
    	reportOb.toolboxId="toolbox"+i;
    	reportOb.formId="formfilter"+i;
    	reportOb.treeboxId="treeBox"+i;
    	reportOb.tableBoxId="tableBox"+i;
    	reportOb.tableId="table"+i;
    	reportOb.title=param.title;
    	
    	param.tableBox=reportOb.tableBoxId;
	    param.tableId=reportOb.tableId;
	    param.formId=reportOb.formId;
    	navContentHtml=[];
    	
    	if(reportList.length >1){
	    	if(i == 0 ){
	     	 	reportNav.append('<li class="active" style="'+listyle+'"><a href="###" data-target="#'+reportOb.navId+'" data-toggle="tab" onclick="formtool.reloadReport($(this),'+i+')">'+reportOb.title+' <i style="font-size: 18px;margin-top: 2px;" title="单独打开该报表" class="icon-expand-full pull-right" onclick="formtool.openReport($(this),'+i+')"></i></a></li>');
	     	 	navContentHtml.push('<div class="tab-pane fade active in" id="'+reportOb.navId+'">');
	    	 }else{
	     	 	reportNav.append('<li style="'+listyle+'"><a href="###" data-target="#'+reportOb.navId+'" data-toggle="tab" onclick="formtool.reloadReport($(this),'+i+')">'+reportOb.title+' <i style="font-size: 18px;margin-top: 2px;" title="单独打开该报表" class="icon-expand-full pull-right" onclick="formtool.openReport($(this),'+i+')"></i></a></li>');
	     	 	navContentHtml.push('<div class="tab-pane fade" id="'+reportOb.navId+'">');
	    	 }
    	}
    	 
    	 navContentHtml.push('<div class="row" id="'+reportOb.toolboxId+'">');
    	 navContentHtml.push('		<form class="form-inline form-filter" id="'+reportOb.formId+'" style="display: none;">');
    	 navContentHtml.push('			<div class="btn-group">');
    	 navContentHtml.push('				 <button type="button" class="btn  btn-primary" onclick="formtool.reloadReport($(this));">查询</button>');
    	 navContentHtml.push('				 <button type="button" class="btn btn-primary" onclick="formtool.print($(this));" style="    margin-left: 3px;">打印表格</button>');
    	 navContentHtml.push('				 <button  type="button" class="btn btn-primary" onclick="formtool.export($(this));"  style="    margin-left: 3px;">导出数据</button>');
    	 navContentHtml.push('				 <button type="button" class="btn" onclick="win.close();"  style="    margin-left: 3px;">关闭</button>');
    	 navContentHtml.push('			</div>');
    	 navContentHtml.push('		</form>');
    	 navContentHtml.push('</div>');
    	 
    	 navContentHtml.push('<div class="row" >');
    	 navContentHtml.push('		<div class="col-md-2 with-padding" id="'+reportOb.treeboxId+'" style="display: none;"> </div> ');
    	 navContentHtml.push('		<div class="col-md-12 with-padding" id="'+reportOb.tableBoxId+'"> <table class="table table-striped table-hover " id="'+reportOb.tableId+'"> </table> </div> ');
    	 navContentHtml.push('</div>');
    	 
    	 
    	 //结束标志
    	 navContentHtml.push(' </div>');
       	 reportNavContent.append(navContentHtml.join(""));
       	 reportOb.param=param;
       	 reportList[i]=reportOb;
    }
    
    
    //左侧导航，上下居中
    var reportNavTop = window.innerHeight-reportNav.outerHeight();
    //reportNav.css("margin-top",reportNavTop/2+"px");
    
    
    
    //初始化
    showWait();
    setTimeout(function(){
	    reportSIMPModelUse=new reportSIMPModel(reportList[0].param);
	    reportSIMPModelUse.loadData();
	    reportList[0].isInit=true;
	    reportList[0].reportSIMPModelUse=reportSIMPModelUse;
	    reportCurrIndex=0;
    	hideWait();
    },timeoutload);
}

formtool.reloadReport=function(btn,reportListIndex){
	btn.prop("disabled",true);
	if(!isNaN(reportListIndex)){
		reportCurrIndex=reportListIndex;
		if(!reportList[reportListIndex].isInit){
			 showWait();
			 setTimeout(function(){
				reportSIMPModelUse=new reportSIMPModel(reportList[reportListIndex].param);
			    reportSIMPModelUse.loadData();
			    reportList[reportListIndex].isInit=true;
			    reportList[reportListIndex].reportSIMPModelUse=reportSIMPModelUse;
			    hideWait();
		    },timeoutload);
		}else{
			reportSIMPModelUse=reportList[reportListIndex].reportSIMPModelUse;
		}
		
	}else{
		 showWait();
		 setTimeout(function(){
		    reportSIMPModelUse.loadData();
		    hideWait();
	    },timeoutload);
	}
   	btn.prop("disabled",false);
}


formtool.openReport=function(btn,reportListIndex){
	btn.prop("disabled",true);
	var reportCurrOb=reportList[reportListIndex];
	
	var reportHtml="project/xpas/html/frame/reportSIMPSUMModel.html";
	var drMenu={drMenu:{menu_parameter:{value:reportCurrOb.reportKey},id:{value:reportCurrOb.reportKey},menu_onlyone:{value:1}}};
	
	var prop = {
         menu: drMenu,
        text: reportCurrOb.title,
         url: g.appPath +reportHtml,
        title: "报表窗口：" + reportCurrOb.title
     };
     var para = {
         viewKey: "sum"
     };
     topWin.openFullWindow(prop, para);
     
	
   	btn.prop("disabled",false);
}

formtool.resetReport=function(btn){
	btn.prop("disabled",true);
	$("#form-filter input").val("");
	
	$("#form-filter select.chosen-select-filter").val("").trigger("chosen:updated");
    reportSIMPModelUse.loadData();
    btn.prop("disabled",false);
}

formtool.export=function(btn){
	 if (!(reportSIMPModelUse && reportSIMPModelUse.data && reportSIMPModelUse.data.rows && reportSIMPModelUse.data.rows.length > 0)) {
	 	alert("没有可导出的数据");
	 	return;
	 }
	btn.prop("disabled",true);
	//表头列
	 var strHeader = [],headerNum=0,column;
	 if(!headerNum) headerNum=9999;
	for(var i=0;i<reportSIMPModelUse.tablecolumns.length;i++){
		column=reportSIMPModelUse.tablecolumns[i];
		strHeader.push(column.title);
	}
	
	
	
     
     var param={};
     param.viewKey="wi_sp";
     param.filename=reportSIMPModelUse.title?reportSIMPModelUse.title:"表格数据";
     param.strHeader=strHeader.join(",");
     param.headerNum=headerNum;
     param.reportKey=reportSIMPModelUse.reportKey;
     param.filterSql=reportSIMPModelUse.filterSql;
     
     
     //表头行，表尾列，表尾行
     var strHeaderAline=[],strFooterCol=[],strFooterAline=[];
     
     
     //使用打印表头+打印表头列   作为导出excel表头
     var arr=[],arrob,sum=0,strOne="";
     if(reportSIMPModelUse.funGetThs && typeof(reportSIMPModelUse.funGetThs) == "function") arr= reportSIMPModelUse.funGetThs();
     if(arr.length >0){
     	for(var i in arr){
     		sum++;
     		arrob=arr[i];
     		if(!arrob.text && !arrob.value) continue;
     		 strOne+=arrob.text+":"+arrob.value+"   ";
     		 if ((sum) % 4 == 0) { //一行 
	     		 strHeaderAline.push(strOne);
     		 	 strOne="";
             }
     	}
     	if(strOne.length >1){
     		 strHeaderAline.push(strOne);
     	}
     }
     strHeaderAline.push(reportSIMPModelUse.title);
     
     
     //遍历汇总行列，作为表尾列
     $(".fixed-table-footer:eq("+reportCurrIndex+") td").each(function(){
     	var td=$(this);
     	var tdVal=$.trim(td.text());
     	if(tdVal.length<0) tdVal="   ";
	     strFooterCol.push(tdVal);
     });
     
     
    //使用打印表尾  作为导出excel尾部
     var arr=[],arrob,sum=0,strOne="";
     if(reportSIMPModelUse.funGetTfooters && typeof(reportSIMPModelUse.funGetTfooters) == "function") arr= reportSIMPModelUse.funGetTfooters();
     if(arr.length >0){
     	for(var i in arr){
     		arrob=arr[i];
     		strFooterAline.push(arrob.text+":");
     		strFooterAline.push(arrob.value);
     	}
     	if(strOne.length >1){
     		 strFooterAline.push(strOne);
     	}
     }
     
     
     
     param.strHeaderAline=strHeaderAline.join(",");
     param.strFooterCol=strFooterCol.join(",");
     param.strFooterAline=strFooterAline.join(",");
     
     
     

     if (g.a.send("processType=com.xznext.report.EchartModelView&actionType=downloadExcel", param, true)) {
         var c = g.a.cReturn;
         if (g.a.OK) {
             var c = g.a.cReturn;
             var urlFileOb =c.urlFileOb;
             topWin.downloadFileByUrl(urlFileOb);
         }
         else {
             return false;
         }
     }
     else {
         return false;
     }
      btn.prop("disabled",false);
}

formtool.print=function(btn){
	btn.prop("disabled",true);
	//先查询，跟用户所见数据保持一致
	//reportSIMPModelUse.loadData();

	var gridths=["序号"],thwidths=['66px'],column,width;
	for(var i=0;i<reportSIMPModelUse.tablecolumns.length;i++){
		column=reportSIMPModelUse.tablecolumns[i];
		gridths.push(column.title);
		width="auto";
		if(column.width) width=column.width+"px";
		thwidths.push(width);
	}


     var param = {
          title:reportSIMPModelUse.title ,
          printNow: true,  //直接打印
          pageRowNum: 20,  
          colNumThs: 4, //表头每行多少列，默认为4
          colNumTfooters: 4, //表尾每行多少列，默认为4
          form: {
              ths:(function(){
              		var arr=[];
              		if(reportSIMPModelUse.funGetThs && typeof(reportSIMPModelUse.funGetThs) == "function") arr= reportSIMPModelUse.funGetThs();
              		return arr;
              })() ,
              tfooters: (function(){
              		var arr=[];
              		if(reportSIMPModelUse.funGetTfooters && typeof(reportSIMPModelUse.funGetTfooters) == "function") arr= reportSIMPModelUse.funGetTfooters();
              		return arr;
              })() 
          },
          grid: {
              ths: gridths,
              thwidths: thwidths,
              data: (function () {
                  var arr = [], row,rowData,isNull=false;
                  if (reportSIMPModelUse && reportSIMPModelUse.data && reportSIMPModelUse.data.rows && reportSIMPModelUse.data.rows.length > 0) {
                      for (var i in reportSIMPModelUse.data.rows) {
                          row = reportSIMPModelUse.data.rows[i];
                          rowData = [];
                          //列
                          rowData[0] = (parseInt(i) + 1);
                          
                          isNull=false
                          for(var j=0;j<reportSIMPModelUse.tablecolumns.length;j++){
								column=reportSIMPModelUse.tablecolumns[j];
								if(!row[column.field]){
									 isNull=true;
									 break;
								}
								rowData[j+1]=row[column.field].value;
						  }
						  if(isNull) continue;
                          arr.push(rowData);
                      }
                  }
                  return arr;
              })()
          }
      };
      if(reportSIMPModelUse.funSumTableFun && typeof(reportSIMPModelUse.funSumTableFun) == "function") param.sumTableFun= reportSIMPModelUse.funSumTableFun;
      WebPrint.goPrintFormModel(param);
       btn.prop("disabled",false);
}
 
    
</script>