<!DOCTYPE html>
<html>

<head>
    <title>报表简单</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
    <script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
    <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>


    <script src="../../../../res/jscript/web_print.js?v=20191116" type="text/javascript"></script>
	 <script src="../../../../res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js" type="text/javascript"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zui.js"></script>
    <script src="../../../../res_plugin/zui-1.8.1-dist/js/zuiExt.js"></script>
    
    <link rel="stylesheet" href="../../../../res_plugin/zui-1.8.1-dist/lib/chosen/chosen.min.css" />
    <script src="../../../../res_plugin/zui-1.8.1-dist/lib/chosen/chosen.min.js"></script>
     <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    
   
    <link rel="stylesheet" href="../../../../res_plugin/bootstrap3.7/bootstrap-table/css/bootstrap-table.css" />
    <link rel="stylesheet" href="../../../../res_plugin/bootstrap3.7/dtpicker/css/bootstrap-datetimepicker.min.css" />
    
    
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/bootstrap-table/js/bootstrap-table-local-zh-CN.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/bootstrap-datetimepicker.min.js"></script>
    <script src="../../../../res_plugin/bootstrap3.7/dtpicker/js/locales/bootstrap-datetimepicker.zh-CN.js"></script>
    
    
    
    <script src="../../../../res_plugin/jquery/jquery-migrate-1.2.1.js" title="jQuery migrate插件解决迁移兼容问题"></script>
	<script src="../../../../res_plugin/jquery/jquery-barcode.min.js" title="条形码"></script>
	<script src="../../../../res_plugin/jquery/jquery.jqprint-0.3.js" title="打印插件"></script>


    <script src="../../../../res/jscript/reportSIMPModel.js?v=20200115"></script>
    <link rel="stylesheet" href="../../../../res_plugin/zui-1.8.1-dist/css/zui.min.css" />
    <style type="text/css">
    	 body{
    	 	overflow: hidden;
    	 }
    	 
    </style>
</head>

<body>
    <div class="container-fluid" >
        <div class="row" id="toolbox">
        	<form class="form-inline form-filter" id="form-filter" style="display: none;">
	            <div class="btn-group">
				  <button type="button" class="btn  btn-primary" onclick="formtool.reloadReport($(this));">查询</button>
				  <button type="button" class="btn btn-primary" onclick="formtool.print($(this));" style="    margin-left: 3px;">打印表格</button>
				  <button  type="button" class="btn btn-primary" onclick="formtool.export($(this));"  style="    margin-left: 3px;">导出数据</button>
				  <!-- <button type="button" class="btn" onclick="formtool.resetReport($(this));"  style="    margin-left: 3px;">重置</button> -->
				  <button type="button" class="btn" onclick="win.close();"  style="    margin-left: 3px;">关闭</button>
				</div>
          </form>
        </div>
        <div class="row" >
            <div class="col-md-2 with-padding" id="leftTreeBox" style="display: none;">
            	
            </div>
            <div class="col-md-12 with-padding" id="tableBox">
            	  <table class="table table-striped table-hover " id="drugsTable">
            	  </table>
            </div>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
var viewKey,reportSIMPModel,formtool={},reportUse={},version="20191217",opDelayTIme=3000;

function formLoad() {
	//接受参数,url参数优先级低
    var param={};
    viewKey=win.para.viewKey;
    
    //加载相关JS，参数优先级高
    g.a.attachJavaScriptFile(g.appPath + "project/g_spd/js/reportSIMP/reportSIMP."+viewKey+".js?v="+version);
    if(reportUse && reportUse.getReportParam){
    	 if(reportUse.getReportParam ){
    	 	var param2=reportUse.getReportParam();
    	 	 for (var key in param2) {
		        param[key] = param2[key];
		    }
    	 } 
    }
    param.tableBox="tableBox";
    param.tableId="drugsTable";
    param.reportKey=viewKey;
    param.formId="form-filter";
    
    //初始化
    showWait();
    setTimeout(function(){
	    reportSIMPModel=new reportSIMPModel(param);
	    reportSIMPModel.loadData();
    	hideWait();
    },1000);
    
   
}

formtool.reloadReport=function(btn){
	btn.prop("disabled",true);
    reportSIMPModel.loadData();
   	btn.prop("disabled",false);
}

formtool.resetReport=function(btn){
	btn.prop("disabled",true);
	$("#form-filter input").val("");
	
	$("#form-filter select.chosen-select-filter").val("").trigger("chosen:updated");
    reportSIMPModel.loadData();
    btn.prop("disabled",false);
}

formtool.export=function(btn){
	 if (!(reportSIMPModel && reportSIMPModel.data && reportSIMPModel.data.rows && reportSIMPModel.data.rows.length > 0)) {
	 	alert("没有可导出的数据");
	 	return;
	 }
	btn.prop("disabled",true);
	//表头列
	 var strHeader = [],headerNum=0,column;
	 if(!headerNum) headerNum=9999;
	for(var i=0;i<reportSIMPModel.tablecolumns.length;i++){
		column=reportSIMPModel.tablecolumns[i];
		strHeader.push(column.title);
	}
	
	
	
     
     var param={};
     param.viewKey="wi_sp";
     param.filename=reportSIMPModel.title?reportSIMPModel.title:"表格数据";
     param.strHeader=strHeader.join(",");
     param.headerNum=headerNum;
     param.reportKey=reportSIMPModel.reportKey;
     param.filterSql=reportSIMPModel.filterSql;
     
     
     //表头行，表尾列，表尾行
     var strHeaderAline=[],strFooterCol=[],strFooterAline=[];
     
     
     //使用打印表头+打印表头列   作为导出excel表头
     var arr=[],arrob,sum=0,strOne="";
     if(reportSIMPModel.funGetThs && typeof(reportSIMPModel.funGetThs) == "function") arr= reportSIMPModel.funGetThs();
     if(arr.length >0){
     	for(var i in arr){
     		sum++;
     		arrob=arr[i];
     		if(!arrob.text && !arrob.value) continue;
     		 strOne+=arrob.text+":"+arrob.value+"   ";
     		 if ((sum) % 4 == 0) { //一行 
	     		 strHeaderAline.push(strOne);
     		 	 strOne="";
             }
     	}
     	if(strOne.length >1){
     		 strHeaderAline.push(strOne);
     	}
     }
     strHeaderAline.push(reportSIMPModel.title);
     
     
     //遍历汇总行列，作为表尾列
     $(".fixed-table-footer td").each(function(){
     	var td=$(this);
     	var tdVal=$.trim(td.text());
     	if(tdVal.length<0) tdVal="   ";
	     strFooterCol.push(tdVal);
     });
     
     
    //使用打印表尾  作为导出excel尾部
     var arr=[],arrob,sum=0,strOne="";
     if(reportSIMPModel.funGetTfooters && typeof(reportSIMPModel.funGetTfooters) == "function") arr= reportSIMPModel.funGetTfooters();
     if(arr.length >0){
     	for(var i in arr){
     		arrob=arr[i];
     		strFooterAline.push(arrob.text+":");
     		strFooterAline.push(arrob.value);
     	}
     	if(strOne.length >1){
     		 strFooterAline.push(strOne);
     	}
     }
     
     
     
     param.strHeaderAline=strHeaderAline.join(",");
     param.strFooterCol=strFooterCol.join(",");
     param.strFooterAline=strFooterAline.join(",");
     
     
     

     if (g.a.send("processType=com.xznext.report.EchartModelView&actionType=downloadExcel", param, true)) {
         var c = g.a.cReturn;
         if (g.a.OK) {
             var c = g.a.cReturn;
             var urlFileOb =c.urlFileOb;
             topWin.downloadFileByUrl(urlFileOb);
         }
         else {
             return false;
         }
     }
     else {
         return false;
     }
      btn.prop("disabled",false);
}

formtool.print=function(btn){
	btn.prop("disabled",true);
	//先查询，跟用户所见数据保持一致
	//reportSIMPModel.loadData();

	var gridths=["序号"],thwidths=['66px'],column,width;
	for(var i=0;i<reportSIMPModel.tablecolumns.length;i++){
		column=reportSIMPModel.tablecolumns[i];
		gridths.push(column.title);
		width="auto";
		if(column.width) width=column.width+"px";
		thwidths.push(width);
	}


     var param = {
          title:reportSIMPModel.title ,
          printNow: true,  //直接打印
          pageRowNum: 20,  
          colNumThs: 4, //表头每行多少列，默认为4
          colNumTfooters: 4, //表尾每行多少列，默认为4
          form: {
              ths:(function(){
              		var arr=[];
              		if(reportSIMPModel.funGetThs && typeof(reportSIMPModel.funGetThs) == "function") arr= reportSIMPModel.funGetThs();
              		return arr;
              })() ,
              tfooters: (function(){
              		var arr=[];
              		if(reportSIMPModel.funGetTfooters && typeof(reportSIMPModel.funGetTfooters) == "function") arr= reportSIMPModel.funGetTfooters();
              		return arr;
              })() 
          },
          grid: {
              ths: gridths,
              thwidths: thwidths,
              data: (function () {
                  var arr = [], row,rowData,isNull=false;
                  if (reportSIMPModel && reportSIMPModel.data && reportSIMPModel.data.rows && reportSIMPModel.data.rows.length > 0) {
                      for (var i in reportSIMPModel.data.rows) {
                          row = reportSIMPModel.data.rows[i];
                          rowData = [];
                          //列
                          rowData[0] = (parseInt(i) + 1);
                          
                          isNull=false
                          for(var j=0;j<reportSIMPModel.tablecolumns.length;j++){
								column=reportSIMPModel.tablecolumns[j];
								if(!row[column.field]){
									 isNull=true;
									 break;
								}
								rowData[j+1]=row[column.field].value;
						  }
						  if(isNull) continue;
                          arr.push(rowData);
                      }
                  }
                  return arr;
              })()
          }
      };
      if(reportSIMPModel.funSumTableFun && typeof(reportSIMPModel.funSumTableFun) == "function") param.sumTableFun= reportSIMPModel.funSumTableFun;
      WebPrint.goPrintFormModel(param);
       btn.prop("disabled",false);
}
 
    
</script>