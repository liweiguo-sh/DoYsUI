<!DOCTYPE html>
<html>
<head>
    <title>数据视图定义</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
		
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>
	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
	
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<script src="../../js/xtfs.js" type="text/javascript"></script>
    <style type="text/css">
        
    </style>
</head>
<body>
	<div id="divDC"></div>
	<div id="divTab" class="xwf_tab_divContainer" style="width:1207px;height:610px;">
		<form id="frm" action="" target="com.xznext.xpas.UserView">
			<div id="divBase" style="overflow:hidden;">				
				<table id="tbForm" class="tbForm" style="width:1207px;">
					<tr class="trH">
						<th style="width:130px;"></th>
						<th style="width:250px;"></th>
						<th style="width:130px;"></th>
						<th style="width:300px;"></th>
						<th style="width:140px;"></th>
						<th style="width:250px;"></th>
					</tr>
					<tr>
						<td>VIEW_KEY</td>
						<td><input id="_cVIEW_KEY" type="text" value="" /></td>
						<td>视图名称</td>
						<td><input id="_cView_Name" type="text" value="" /></td>
						<td>子系统名称</td>
						<td><input id="_cSystem_Name" type="text" controlType="dropdown" fieldValue="system_name" fieldText="system_text" visibleSearch="false" /></td>
					</tr>
					<tr>
						<td>数据库</td>
						<td><input id="_cDatabase_Key" type="text" controlType="dropdown" fieldValue="database_key" fieldText="database_text" fieldsSearch="database_key,database_text" visibleSearch="false" /></td>
						<td>基础表标识</td>
						<td><input id="_cTable_Key" type="text" controlType="dropdown" fieldValue="table_key" fieldText="table_key" visibleSN="true" fieldsVisible="table_key, table_name" widthPanel="500" widthFields="60,40" pageMaxRows="15" /></td>
						<td style="color:Blue">自动备份表：</td>
						<td><input id="_cView_backup_table" type="text" value="" /></td>
					</tr>
					<tr>
						<td>固定列列数</td>
						<td><input id="_cView_fixed_columns" type="text" value="" /></td>
						<td>浮动列列数</td>
						<td><input id="_cView_float_columns" type="text" value="" /></td>
						<td>导航树初始宽度：</td>
						<td><input id="_cView_tree_width" type="text" value="" /></td>
					</tr>
					<tr>
						<td>视图按钮</td>
						<td><input id="_cView_allow_addnew" type="checkbox" /><label for="_cView_allow_addnew">允许添加</label></td>
						<td>禁止导出</td>
						<td><input id="_cView_prohibit_export" type="checkbox" /><label for="_cView_prohibit_export">禁止导出数据</label></td>
						<td>网格列：</td>
						<td>							
							<input id="_cView_fn_view" type="checkbox" /><label for="_cView_fn_view">编辑</label>
							<input id="_cView_fn_delete" type="checkbox" /><label for="_cView_fn_delete">删除</label>
							<input id="_cView_fn_select" type="checkbox" /><label for="_cView_fn_select">选择</label>
						</td>
					</tr>
					<tr>
						<td></td>
						<td></td>
						<td>视图实例类</td>
						<td><input id="_cView_form_target" type="text" value="" /></td>						
						<td>编辑列名称</td>
						<td><input id="_cView_fn_view_name" type="text" value="" /></td>
					</tr>
					<tr>
						<td>备注</td>
						<td colspan="5"><textarea id="_cView_Remark" rows="5" cols="0"></textarea></td>
					</tr>
					<tr>
						<td>创建人</td>
						<td><span id="_cCreator"></span></td>
						<td>修改人</td>
						<td><span id="_cModifier"></span></td>
						<td>修改时间</td>
						<td><span id="_cMDate"></span></td>
					</tr>				
					<tr>
						<td colspan="6" style="border-top:solid 2px Olive;height:40px;vertical-align: bottom;"><span style="color: Red;">编辑窗口：</span></td>
					</tr>
					<tr>
						<td>VF按钮</td>
						<td colspan="3">
							<input id="_cView_allow_modify" type="checkbox" /><label for="_cView_allow_modify">允许修改</label>
							<input id="_cView_allow_delete" type="checkbox" /><label for="_cView_allow_delete">允许删除</label>
							<input id="_cView_allow_copy" type="checkbox" /><label for="_cView_allow_copy">允许复制</label>							
						</td>
						<td></td>
						<td></td>
					</tr>
					<tr>
						<td>下拉框测试</td>
						<td colspan="3">
							<input type="button" onclick="initDropdown();" value="初始化Dropdown数据" />
							<input type="button" onclick="setValue();" value="下拉框赋值" />
						</td>
						<td></td>
						<td><input id="_dTable_Key" type="text" disabled="disabled" controlType="dropdown" fieldValue="table_key" fieldText="table_name" fieldsVisible="database_key, table_key, table_name" fieldsSearch="table_key,table_name" widthPanel="420" widthFields="20,50,30" /></td>
					</tr>
				</table>
			</div>
			<div id="divSQL">
				<table id="tbSQL" class="tbForm" style="width:1177px;">
					<tr class="trH">
						<th style="width:150px;"></th>
						<th style="width:1070px;"></th>
					</tr>
					<tr>
						<td>SQL SELECT</td>
						<td colspan="2"><textarea id="_cView_SQL_SELECT" rows="8" cols="0"></textarea></td>
					</tr>
					<tr>
						<td>SQL FROM</td>
						<td colspan="2"><textarea id="_cView_SQL_FROM" rows="12" cols="0"></textarea></td>
					</tr>
					<tr>
						<td>SQL WHERE</td>
						<td colspan="2"><textarea id="_cView_SQL_WHERE" rows="5" cols="0"></textarea></td>
					</tr>
					<tr>
						<td>GROUP BY</td>
						<td colspan="2"><textarea id="_cView_SQL_GroupBy" rows="4" cols="0"></textarea></td>
					</tr>
					<tr>
						<td>ORDER BY</td>
						<td colspan="2"><textarea id="_cView_SQL_OrderBy" rows="3" cols="0"></textarea></td>
					</tr>
				</table>				
			</div>
			<input id="_xViewKeyOld" type="hidden" />
		</form>		
		<div id="divGridSF"></div>
		<div id="divGridC"></div>
		<div id="divGridG"></div>
		<div id="divGridE"></div>
		<div id="divGridT"></div>
	</div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var viewKeyOld = "";

	var tabs = null;
	var gridviewSF = null, gridviewC = null, gridviewG = null, gridviewE = null, gridviewT = null;
	// ------------------------------------------------------------------------
	function formLoad() {
		vf.addExtraButton({ key: "preview", text: "视图预览(P)" });
		vf.addExtraButton({ key: "createViewExtraJs", text: "打开view.js" });
		vf.addExtraButton({ key: "xTFS", text: "xTFS" });
		vf.css(gId("tbForm"));
		vf.css(gId("tbSQL"));
		
		tabs = new window.xwf_tab({ divContainer: gId("divTab"), tabClick: tab_click });
		tabs.addTab({ key: "tabB", text: "基本信息", control: gId("divBase") });
		tabs.addTab({ key: "tabS", text: "SQL", control: gId("divSQL") });
		tabs.addTab({ key: "tabSF", text: "SELECT字段", title: "SELECT字段", control: gId("divGridSF") });
		tabs.addTab({ key: "tabC", text: "基础表字段C", title: "基础表字段C", control: gId("divGridC") });
		tabs.addTab({ key: "tabG", text: "其它字段G", title: "其它字段G", control: gId("divGridG") });
		tabs.addTab({ key: "tabE", text: "扩展按钮E", title: "视图扩展按钮", control: gId("divGridE") });
		tabs.addTab({ key: "tabT", text: "视图导航T", title: "视图导航树列表", control: gId("divGridT") });
	}

	function tab_click(tab) {
		if (tab.key == "tabSF") {
			var sqlSelect = frm._cView_SQL_SELECT.value.toLowerCase().trim();
			var viewFilter = "view_key = '" + frm._cVIEW_KEY.value + "'";
			if (sqlSelect.equals("*")) {
				viewFilter += " AND table_key = '" + frm._cTable_Key.value + "'";
			}
			else {
				var arrField = null;
				var arrFields = sqlSelect.split(",");
				for (var i = 0; i < arrFields.length; i++) {
					arrField = arrFields[i].trim().split(" ");
					arrFields[i] = arrField[arrField.length - 1];
				}
				sqlSelect = "'" + arrFields.join("','") + "'";
				viewFilter += " AND field_name IN(" + sqlSelect + ")";
			}

			if (gridviewSF == null) {
				var prop = {
					divContainer: gId("divGridSF"),
					viewKey: "fv_view_field",
					viewFilter: viewFilter,
					viewForm: "project/xpas/html/frame/uview_field.html"
				};
				gridviewSF = new window.xwf_gridview(prop);
				gridviewSF.beforeAddnew = function () {
					if (!vf.status.equals("view")) {
						showWarn("当前状态不允许添加明细记录。");
						return false;
					}
				}
			}
			else {
				gridviewSF.setViewFilter(viewFilter);
			}
		}
		else if (tab.key == "tabC") {
			if (gridviewC == null) {
				var prop = {
					divContainer: gId("divGridC"),
					viewKey: "fv_view_field",
					viewFilter: "view_key = '" + frm._cVIEW_KEY.value + "' AND table_key = '" + frm._cTable_Key.value + "'",
					viewForm: "project/xpas/html/frame/uview_field.html"
				};
				gridviewC = new window.xwf_gridview(prop);
				gridviewC.beforeAddnew = function () {
					if (!vf.status.equals("view")) {
						showWarn("当前状态不允许添加明细记录。");
						return false;
					}
				}
			}
			else {
				gridviewC.setViewFilter("view_key = '" + frm._cVIEW_KEY.value + "' AND table_key = '" + frm._cTable_Key.value + "'");
			}
		}
		else if (tab.key == "tabG") {
			if (gridviewG == null) {
				var prop = {
					divContainer: gId("divGridG"),
					viewKey: "fv_view_field",
					viewFilter: "view_key = '" + frm._cVIEW_KEY.value + "' AND (table_key IS NULL OR table_key <> '" + frm._cTable_Key.value + "')",
					viewForm: "project/xpas/html/frame/uview_field.html"
				};
				gridviewG = new window.xwf_gridview(prop);
			}
			else {
				gridviewG.setViewFilter("view_key = '" + frm._cVIEW_KEY.value + "' AND (table_key IS NULL OR table_key <> '" + frm._cTable_Key.value + "')");
			}
		}
		else if (tab.key == "tabE") {
			if (gridviewE == null) {
				var prop = {
					divContainer: gId("divGridE"),
					toolbarVisible: true,
					jsonToolbar: { onclick: onToolbarClick },
					viewKey: "fv_view_extra",
					viewFilter: "view_key = '" + frm._cVIEW_KEY.value + "'",
					viewForm: "project/xpas/html/frame/view_extra.html"
				};
				gridviewE = new window.xwf_gridview(prop);
				gridviewE.toolbar.addBar({ type: "button", key: "addnew", text: "添加扩展按钮", highlight: false });
			}
			else {
				gridviewE.setViewFilter("view_key = '" + frm._cVIEW_KEY.value + "'");
			}
		}
		else if (tab.key == "tabT") {
			if (gridviewT == null) {
				var prop = {
					divContainer: gId("divGridT"),
					viewKey: "fv_tree_for_uview",
					viewFilter: "tree_key IN(SELECT tree_key FROM ST_VIEW_TREE WHERE view_key = '" + frm._cVIEW_KEY.value + "')",
					viewForm: "project/xpas/html/tree/tree.html",
					allowAdd: false,
					vfAllowAddnew: false
				};
				gridviewT = new window.xwf_gridview(prop);
			}
			else {
				gridviewT.setViewFilter("tree_key IN(SELECT tree_key FROM ST_VIEW_TREE WHERE view_key = '" + frm._cVIEW_KEY.value + "')");
			}
		}
		return true;
	}
	function onToolbarClick(para) {
		if (para.key.equals("addnew")) {
			gridviewE.addnew();
		}
	}
</script>
<!-- vf.events -->
<script type="text/javascript">
	vf.beforeSave = function () {
		// -- xTFS：判断是否已签出 ------------------------
		if (g.a.send("processType=com.xtfs.XtfsCore&actionType=getMDataStatus", { mdataType: "view", mdataKey: frm._cVIEW_KEY.value }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				if (!cReturn.newMData && !cReturn.myCheckout) {
					showWarn("主数据尚未签出，同步xTFS时修改会丢失，请谨慎操作。");
				}
			}
		}
		// ------------------------------------------------
		frm._cView_SQL_SELECT.value = frm._cView_SQL_SELECT.value.replaceAll("\\[", "").replaceAll("\\]", "");		
		return true;
	}
	vf.beforeClick = function (prop) {
		if (prop.buttonKey.equals("preview")) {
			topWin.openTopView({ text: frm._cView_Name.value, text: "预览：" + frm._cView_Name.value, title: "数据视图预览" }, { viewKey: frm._cVIEW_KEY.value, flowKey: "" });
		}
		else if (prop.buttonKey.equals("createViewExtraJs")) {
			var arrMenus = new Array();
			//arrMenus.push({ key: "vs", text: "Visual Studio" });
			//arrMenus.push({ key: "ue", text: "Ultra Edit" });
			arrMenus.push({ key: "notepad", text: "Notepad" });
			topWin.context.show({ arrMenus: arrMenus, menuClick: getViewJs, objDom: prop.button, top: 0, left: 0 });
		}
		else if (prop.buttonKey.equals("xTFS")) {
			var jsonPara = {
				mdataType: "view",
				mdataKeys: "'" + frm._cVIEW_KEY.value + "'",
				objDom: prop.button
			}
			xTFS.openMenu(jsonPara);
		}
		return false;
	}
	vf.beforeCopy = function () {
		viewKeyOld = frm._cVIEW_KEY.value;
		return true;
	}

	vf.afterAddnew = function () {
		if (!vf.copyAdd) {
			frm._cView_tree_width.value = "210";
			frm._cView_fixed_columns.value = "1";
			frm._cView_float_columns.value = "10";
		}
	}
	vf.afterMove = function () {
		frm._xViewKeyOld.value = frm._cVIEW_KEY.value;
		tab_click(tabs.tabSelected);
	}

	vf.afterSave = function () {
		if (vf.copyAdd) {
			if (g.a.send("processType=com.xznext.xpas.ViewAid&actionType=copyView", { viewKey: frm._cVIEW_KEY.value, viewKeyOld: viewKeyOld }, true)) {
				if (g.a.OK) {
					tab_click(tabs.tabSelected);
					showMsg("视图复制成功。");
				}
				else {
					return false;
				}
			}
			else {
				return false;
			}
		}
	}
</script>

<!-- 打开view.js -->
<script type="text/javascript">
	function getViewJs(menu) {
		var menuKey = menu.key;
		if (g.a.send("processType=com.xznext.xpas.ViewAid&actionType=createViewExtraJs", { systemName: frm._cSystem_Name.underValue, viewKey: frm._cVIEW_KEY.value }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				var jsFile = cReturn.jsFile;
				openViewJs(menuKey, jsFile);				
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
	function openViewJs(appType, jsFile) {
		var cmdText = "";

		var objShell = null;
		var returnShell = null;
		// ------------------------------------------------
		try {
			objShell = new ActiveXObject("WScript.Shell");
		}
		catch (e) {
			showErr("WScript.Shell创建失败，请先初始化IE注册表文件。\n" + e.toString());
			return;
		}
		// ------------------------------------------------
		try {
			if (appType.equals("vs")) {
				cmdText = "devenv " + jsFile;
			}
			else if (appType.equals("ue")) {
				cmdText = "uedit32 " + jsFile;
			}
			else {
				cmdText = "notepad " + jsFile;
			}
			returnShell = objShell.exec(cmdText);
		}
		catch (e) {
			showErr(e.toString());
			return;
		}
	}
</script>

<!-- 下拉框样例 -->
<script type="text/javascript">
	var txtTableKey = gId("_dTable_Key");
	function initDropdown() {
		var dtbSource = gId("_cTable_Key").instance.dtbSource;
		// -- dtbSource.filter([["table_key", "xxx"]]); --

		var jsonProp = {
			txtHost: txtTableKey,
			dtbSource: dtbSource,
			visibleSN: true,
			pageMaxRows: 12,
			rowClick: rowClick
		};
		txtTableKey.dropdown = new window.xwf_dropdown(jsonProp);
	}
	function rowClick(para) {
		var dataRow = para.dataRow;
		debug(dataRow["table_key"].value);
		return true;
	}

	function setValue() {
		if (txtTableKey.setValue) {
			txtTableKey.setValue("sys.ST_SYSTEM");
		}
		else {
			txtTableKey.setValue("");
			showWarn("下拉框尚未初始化数据，请先初始化。");
		}
	}
</script>