<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>用户菜单收藏</title>
	<link href="../../../../res/control/tree/style1/xwf.tree.css" rel="stylesheet" type="text/css" />
	<link href="../../../../res/control/tab/style1/xwf.tab.css" rel="stylesheet" type="text/css" />
	
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/control/tab/xwf.tab.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

	<style type="text/css">
		.tdLayout {
			padding: 0px;
			vertical-align: top;
		}
		
		#divTreeMenu {
			width: 500px;
			height:500px;
			border: solid 1px Gray;
			overflow: auto;
		}
		#selectMenu,#divCount{
			font-size:0.8em;
			line-height:24px;
			overflow:hidden;
		}
	</style>
</head>
<body>
	<div class="pageButtons">					
		<input id="btnSave" type="button" value="确认选择" onclick="return btnSave_click()" />
		<input id="btnClose" type="button" value="关闭" onclick="return btnClose_click();" />
		<span style="float:right;font-family:微软雅黑;font-size:1em">已选中的数量：<i id="collectCount">5</i></span>
	</div>
	<div style="margin:5px 0px 5px 0px;">
		<textarea id="selectMenu" rows="5" cols="0" style="width:99%" disabled="disabled"></textarea>
	</div>
	
	<div id="divTreeMenu"></div>
</body>
</html>

<!-- formLoad etc. -->
<script type="text/javascript">
	var divTreeMenu = gId("divTreeMenu");
	var treeMenu = null
	// ----------------------------------------------------
	function formLoad() {
		initTree_Menu();
	}
	function btnClose_click() {
		win.close();
	}
</script>

<!-- 加载树（菜单）-->
<script type="text/javascript">

	function initTree_Menu() {
		var jsonPara = {
			divContainer: gId("divTreeMenu"),
			imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
			title: "系统菜单",
			sd: "~",
			nodeCheck:nodeCheck,
			showCheckBoxs: "leaf"
		};
		treeMenu = new window.xwf_tree(jsonPara);
		var menuName = new Array();
		var dtbMenu = top.topWin.dtbMenu;
		var dtbMenuCollect = win.para.dtbMenuCollect;
		for (var i = 0; i < dtbMenu.rowCount; i++) {
			
			var nodeKey = "0";
			var node_key = dtbMenu.rows[i]["node_key"].value;
			var nodeText = dtbMenu.rows[i]["menu_text"].value;
			var menuKey = dtbMenu.rows[i]["menu_key"].value;
			if (nodeText.equals("-")) {
				continue;
			}
			for (var j = 0; j < node_key.length / 3; j++) {
				nodeKey += treeMenu.sd + node_key.substring(3 * j, 3 * j + 3);
			}
			treeMenu.addNode({ key: nodeKey, text: nodeText, menuKey: menuKey });
			var pos = dtbMenuCollect.find([menuKey]);
			if (pos >= 0) {
				treeMenu.setNodeChecked(nodeKey, 1);
				menuName.push(nodeText);
			}
		}
		treeMenu.expandAll("0");
		gId("selectMenu").innerHTML = menuName.join(",");
		gId("collectCount").innerHTML = menuName.length;
	}

	function refreshSelect() {
		var arr = treeMenu.getCheckedKeys();
		var menuName = new Array();
		for (var i = 0; i < arr.length; i++) {
			var node = treeMenu.nodes[arr[i]];
			arr[i] = node.menuKey;
			menuName.push(node.text);
		}
		gId("selectMenu").innerHTML = menuName.join(",");
		gId("collectCount").innerHTML = menuName.length;
		return menuName.length;
	}
	function nodeCheck(node) {
		var count = refreshSelect();
		if (count > 9) {
			showErr("选中的菜单数量超过最大限额：9，请取消多余的选择！");
		}
	}
</script>

<!-- save -->
<script type="text/javascript">
	function btnSave_click() {
		var jsonPara = {};
		var arr = treeMenu.getCheckedKeys();
		if (arr.length > 9) {
			showErr("收藏的菜单不能超过9个！");
			return;
		}
		for (var i = 0; i < arr.length; i++) {
			var node = treeMenu.nodes[arr[i]];
			arr[i] = node.menuKey;
		}
		jsonPara["menuKeys"] = arr.join(",");

		if (g.a.send("processType=com.xznext.Framework&actionType=saveMenuCollect", jsonPara, true)) {
			if (g.a.OK) {
				if (win.para.callback) {
					win.para.callback();
				}
				win.close();
			}
		}
		
	}
</script>