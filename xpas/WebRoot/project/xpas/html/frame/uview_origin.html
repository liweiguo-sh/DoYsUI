<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title></title>
  <script src="../../../../res_plugin/jquery/jquery-3.1.1.min.js" type="text/javascript"></script>

  <script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
  <script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
  <script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

  <script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
  <script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>

  <script src="../../../../res/jscript/excel.js" type="text/javascript"></script>
  <script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

  <script src="../../../../res/jscript/_view.debug.js" type="text/javascript"></script>
  <script src="../../js/xtfs.js" type="text/javascript"></script>
  <script src="../../../../res/jscript/web_print.js" type="text/javascript"></script>
  <style type="text/css">
    body {
      overflow: hidden;
      margin: 0px 5px 0px 5px;
    }

    #divGrid {
      border-bottom: solid 0px pink;
    }

    .xwf_grid_tbData .fa-chevron-down {
      display: none !important;
    }
  </style>
</head>

<body scroll="no">
  <div id="divGrid"></div>
</body>

</html>
<!-- formLoad -->
<script type="text/javascript">
  var viewKey = "",
    flowKey = "";
  var filterFirst = false;
  var filterMust = false;

  var divGrid = gId("divGrid");

  var gridView = null;
  var winFilter = null;
  // ------------------------------------------------------------------------
  function formLoad() {
    if (!win.p.windowState.equals("maximized")) {
      window.document.body.style.backgroundColor = "White";
    }
    win.addEventListener("beforeClose", formUnload);

    flowKey = win.para.flowKey;
    viewKey = win.para.viewKey;
    filterFirst = win.para.filterFirst;
    filterMust = win.para.filterMust;

    divGrid.innerHTML = "uview.html, viewKey = " + viewKey;
    divGrid.style.height = (win.p.height - divGrid.offsetTop - 8) + "px";

    initGridView();
  }

  function formUnload() {
    return true;
  }
</script>

<!-- toolbar -->
<script type="text/javascript">
  function initToolbar() {
    var defaultWidth = 70;
    // ------------------------------------------------
    gridView.toolbar.addBar({
      type: "button",
      key: "refresh",
      text: "<i class='fa fa-refresh'></i>  刷新",
      align: "left",
      style: "Grid",
      icon: null,
      width: defaultWidth
    });
    if (gridView.dtbView.rows[0]["view_allow_addnew"].value == 1) {
      gridView.toolbar.addBar({
        type: "button",
        key: "addnew",
        text: "<i class='fa fa-plus'></i>  添加",
        align: "left",
        style: "Grid",
        icon: null,
        width: defaultWidth
      });
    }
    if (win.para.viewMode && win.para.viewMode.equals("multiSelect")) {
      gridView.toolbar.addBar({
        type: "button",
        key: "select",
        text: "<i class='fa fa-check'></i>  确认选择",
        align: "left",
        style: "Grid",
        icon: null,
        width: 100
      });
    }
    // -- 视图扩展按钮 --------------------------------
    var arrExtra = gridView.dtbExtra.filter([
      ["view_extra_type", "1"]
    ]);
    for (var i = 0; i < arrExtra.length; i++) {
      var key = arrExtra[i]["view_extra_key"].value;
      var text = arrExtra[i]["view_extra_text"].value;
      gridView.toolbar.addBar({
        type: "button",
        key: key,
        text: "<i class='fa fa-tag'></i> " + text,
        align: "left",
        style: "Grid",
        icon: null
      });
    }
    gridView.toolbar.addBar({
      type: "button",
      key: "close",
      text: "<i class='fa fa-close'></i>  关闭",
      align: "left",
      style: "Grid",
      icon: null,
      width: defaultWidth
    });
    // -- 通用按钮 ------------------------------------
    if (g.debug || g.local || topWin.isDeveloper) {
      gridView.toolbar.addBar({
        type: "button",
        key: "config",
        text: "<i class='fa fa-gear'></i>",
        align: "right",
        style: "Grid",
        icon: null,
        width: 35
      });
    }
    if (g.debug || g.local || topWin.isDeveloper) {
      //gridView.toolbar.addBar({ type: "text", key: "search", align: "right", icon: null, placeholder: "请输入关键字搜索" });
    }
    gridView.toolbar.addBar({
      type: "button",
      key: "filter",
      text: "<i class='fa fa-filter'></i>",
      align: "right",
      style: "Grid",
      icon: null,
      width: 35
    });
    if (!gridView.dtbView.rows[0]["view_prohibit_export"].value) {
      gridView.toolbar.addBar({
        type: "button",
        key: "export",
        text: "<i class='fa fa-share'></i>",
        align: "right",
        style: "Grid",
        icon: null,
        width: 35
      });
    }

  }

  function onToolbarClick(para) {
    if (para.key.equals("refresh")) {
      if (filterMust) {
        if (gridView.userFilter.equals("")) {
          showWarn("当前视图必需设置筛选条件，请先设置筛选条件。");
          btnFilter_click();
          return;
        }
        gridView.setUserFilter(gridView.userFilter);
      } else {
        gridView.refresh();
      }
    } else if (para.key.equals("addnew")) {
      gridView.addnew();
    } else if (para.key.equals("select")) {
      btnSelect_click();
    } else if (para.key.equals("export")) {
      btnExport_click();
    } else if (para.key.equals("filter")) {
      if (winFilter && !winFilter.closed) {
        winFilter.show();
        return;
      }

      var prop = {
        url: "project/xpas/html/frame/uview_filter.html",
        title: "视图数据筛选条件设定界面",
        parent: win,
        modal: true
      }
      var para = {
        viewKey: viewKey,
        dtbViewField: gridView.dtbViewField,
        filterMust: filterMust,
        callback: function (userFilter) {
          if (filterMust && userFilter.equals("")) {
            showWarn("当前视图配置为必需设置筛选条件。");
            return;
          }
          gridView.setUserFilter(userFilter);
        }
      };
      winFilter = topWin.openWindow(prop, para);
    } else if (para.key.equals("config")) {
      gridView.showConfig();
    } else if (para.key.equals("close")) {
      if (win.para.closeMode && win.para.closeMode.equals("hide")) {
        win.hide();
      } else {
        win.close();
      }
    } else {
      // -- 扩展按钮 --
      if (window.viewExtraButtonClick) {
        window.viewExtraButtonClick({
          button: para.dom,
          btnKey: para.key,
          dtbViewData: gridView.dtbViewData
        });
      }
    }
  }

  function setButtonVisible(btnKey, btnVisible) {
    for (var i = 0; i < gridView.toolbar.bars.length; i++) {
      if (gridView.toolbar.bars[i].key.equals(btnKey)) {
        gridView.toolbar.bars[i].dom.style.display = (btnVisible ? "" : "none");
        break;
      }
    }
  }
</script>
<!-- viewGrid -->
<script type="text/javascript">
  function initGridView() {
    var jsonToolbar = {
      height: "M",
      onclick: onToolbarClick
    };
    var prop = {
      divContainer: divGrid,
      toolbarVisible: true,
      jsonToolbar: jsonToolbar,
      flowKey: (win.para.flowKey ? win.para.flowKey : ""),
      flowTextMenu: win.para.flowTextMenu,
      viewKey: viewKey,
      viewFilter: (win.para.viewFilter ? win.para.viewFilter : ""),
      navFilter: (win.para.navFilter ? win.para.navFilter : null),
      allowSort: true,
      vfAllowAddnew: win.para.vfAllowAddnew,
      vfAllowModify: win.para.vfAllowModify,
      vfAllowDelete: win.para.vfAllowDelete,
      vfAllowCopy: win.para.vfAllowCopy,
      vfAllowMove: win.para.vfAllowMove,
      autoSelectFirstRow: true,
      viewForm: win.para.viewForm,
      viewMode: (win.para.viewMode ? win.para.viewMode : ""),
      vfWindowState: (win.para.vfWindowState ? win.para.vfWindowState : ""),
      fnViewName: (win.para.fnViewName ? win.para.fnViewName : ""),
      selectCallback: (win.para.selectCallback ? win.para.selectCallback : null),
      callbackPara: (win.para.callbackPara ? win.para.callbackPara : null),
      // onRowSelect: rowSelect,
      commandClick: commandClick
    };
    if (win.para.onceFilter) prop.onceFilter = win.para.onceFilter;
    if (filterFirst) prop.onceFilter = "1 = 0";

    gridView = new window.xwf_gridview(prop);
    initToolbar();

    if (win.para.vfAllowAddnew != undefined) {
      gridView.dtbView.rows[0]["view_allow_addnew"].value = (win.para.vfAllowAddnew ? 1 : 0);
    }
    if (filterFirst) {
      btnFilter_click();
    }
    try {
      if (uviewformLoad) uviewformLoad();
    } catch (e) {};
  }
</script>

<!-- Refresh、Filter、etc -->
<script type="text/javascript">
  function btnRefresh_click() {
    if (filterMust) {
      if (gridView.userFilter.equals("")) {
        showWarn("当前视图必需设置筛选条件，请先设置筛选条件。");
        btnFilter_click();
        return;
      }
      gridView.setUserFilter(gridView.userFilter);
    } else {
      gridView.refresh();
    }
  }

  function btnFilter_click() {
    if (winFilter && !winFilter.closed) {
      winFilter.show();
      return;
    }

    var prop = {
      url: "project/xpas/html/frame/uview_filter.html",
      title: "视图数据筛选条件设定界面",
      parent: win,
      modal: true
    }
    var para = {
      viewKey: viewKey,
      dtbViewField: gridView.dtbViewField,
      filterMust: filterMust,
      callback: function (userFilter) {
        if (filterMust && userFilter.equals("")) {
          showWarn("当前视图配置为必需设置筛选条件。");
          return;
        }
        gridView.setUserFilter(userFilter);
      }
    };
    winFilter = topWin.openWindow(prop, para);
  }

  function btnAddnew_click() {
    gridView.addnew();
  }

  function btnSelect_click() {
    if (win.para.selectCallback) {
      var selectedRows = gridView.dtbViewData.getSelectedRows();
      if (selectedRows.length == 0) {
        showWarn("没有选中的记录，请选择。");
        return false;
      }
      if (win.para.selectCallback(selectedRows, win.para.callbackPara)) {
        if (win.para.closeMode && win.para.closeMode.equals("hide")) {
          gridView.selectAll(false);
          win.hide();
        } else {
          win.close();
        }
      }
    } else {
      showMsg("缺少名称为(selectCallback)的回调处理函数，请检查。");
    }
  }
</script>
<!-- 数据导出 -->
<script type="text/javascript">
  function btnExport_click() {
    var btnExport = g.x.getEventTarget(event);
    var arrMenus = new Array();

    arrMenus.push({
      key: "exportData_CSV",
      text: "数据导出到CSV文件"
    });
    arrMenus.push({
      key: "exportData_XLS",
      text: "数据导出到XLS文件",
      title: "支持MS Office 2007及以上版本"
    });
    topWin.context.show({
      menuClick: exportMenuClick,
      arrMenus: arrMenus,
      objDom: btnExport,
      top: 0,
      left: 0
    });
  }

  function exportMenuClick(liMenu) {
    if (liMenu.key.equals("exportData_CSV")) {
      exportData_CSV();
    } else if (liMenu.key.equals("exportData_XLS")) {
      exportData_XLS();
    } else {
      showErr("暂未实现的导出文件类型。");
    }
  }

  function exportData_CSV() {
    var strHeader = "";
    for (var i = 0; i < gridView.arrColumns.length; i++) {
      if (gridView.arrColumns[i].type.equals("data")) {
        strHeader += (gridView.arrColumns[i].text + ",");
      }
    }

    if (g.a.send("processType=com.xznext.xpas.Common&actionType=exportData_CSV", {
        viewKey: viewKey,
        sqlUVData: gridView.sqlUVData,
        strHeader: strHeader
      }, true)) {
      var c = g.a.cReturn;
      if (g.a.OK) {
        var c = g.a.cReturn;
        var urlFile = c.urlFile;
        topWin.downloadFile(urlFile);
      } else {
        return false;
      }
    } else {
      return false;
    }
  }

  function exportData_XLS() {
    var strHeader = "";
    for (var i = 0; i < gridView.arrColumns.length; i++) {
      if (gridView.arrColumns[i].type.equals("data")) {
        strHeader += (gridView.arrColumns[i].text + ",");
      }
    }

    if (g.a.send("processType=com.xznext.xpas.Common&actionType=exportData_XLS", {
        viewKey: viewKey,
        sqlUVData: gridView.sqlUVData,
        strHeader: strHeader
      }, true)) {
      var c = g.a.cReturn;
      if (g.a.OK) {
        var c = g.a.cReturn;
        var urlFile = c.urlFile;
        openExcel(g.xpasRunPath + urlFile);
      } else {
        return false;
      }
    } else {
      return false;
    }
  }
</script>

<!-- 样例及测试代码 -->
<script type="text/javascript">
  function rowSelect(para) {
    var recordIndex = para.recordIndex;
    var dataRow = para.dataRow;
    if (recordIndex >= 0) {
      alert(dataRow["view_name"].value);
    } else {
      alert("空行");
    }
  }

  function commandClick(ctl, rowIndex) {
    // - 样例函数 -------------------------------------
    // -- ctl: checkbox控件 --
    // -- rowIndex: 当前行在数据集(dtbViewData.rows[rowIndex].checked)中的下标 --
  }
</script>