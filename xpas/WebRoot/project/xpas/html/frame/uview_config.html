<!DOCTYPE html>
<html>
<head>
    <title>视图配置窗口</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<style type="text/css">
		body {
			font-family: 微软雅黑;
		}
		.tbLayout {
			table-layout: fixed;
			border-collapse: collapse;
		}
		.tdLayout {
			padding: 0px;
			overflow: hidden;
			border: dashed 0px #c0c0c0;
		}
		.divPanel {
			height: 480px;
			overflow: auto;
		}
	</style>
	<!-- 字段区 -->
	<style type="text/css">
		.tbColumns {
			width: 230px;
			table-layout: fixed;
		}
		.tbColumns th {
			color: White;
			line-height: 30px;
			background-color: #c0c0c0;
		}
		.tbColumns td {
			padding: 6px;
			overflow: hidden;
		}
		.tdVisibleColumn {
			border: solid 1px Green;
		}
		.tdHiddenColumn {
			border: solid 1px Gray;
		}
		.tbColumns span {
			cursor: default;
		}
		.tbColumns span:hover {
			color: red;
		}
	</style>
</head>
<body>
	<div id="divButton" class="divButtons">
		<input type="button" id="btnSave" onclick="btnSave_click();" value="保存配置" />
		<input type="button" id="btnSaveAsDesign" onclick="btnSaveAsDesign_click();" value="保存为设计" style="display:none;color:Red;" />
		<input type="button" id="Button1" onclick="btnReset_click();" value="恢复原始状态" />
		<input type="button" id="btnClose" onclick="btnClose_click();" value="关闭" />
	</div>
	<table id="tbLayout1" class="tbLayout" style="width:225px;">
		<tr>
			<th style="width:162px;"></th>
			<th style="width:60px;"></th>
		</tr>
		<tr>
			<td class="tdLayout">每页显示记录条数：</td>
			<td class="tdLayout"><input type="text" id="txtPageRows" value="" /></td>
		</tr>
	</table>
	<table id="tbLayout2" class="tbLayout" style="width:500px;margin-top:5px;">
		<tr>
			<td class="tdLayout"><div id="divL" class="divPanel"></div></td>
			<td class="tdLayout"><div id="divR" class="divPanel"></div></td>
		</tr>
	</table>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var parentWin = null;

	var viewKey = "";
	var blSaved = false;

	var txtPageRows = gId("txtPageRows");
	var divL = gId("divL");
	var divR = gId("divR");
	// ----------------------------------------------------
	function formLoad() {
		parentWin = win.parentWindow;
		viewKey = win.para["viewKey"];
        txtPageRows.value = win.para["pageMaxRows"];
		win.addEventListener("afterClose", afterClose);

		initConfig();

		cssFormat(gId("tbLayout1"));
		if (g.debug || g.local || topWin.isDeveloper) {
			gId("btnSaveAsDesign").style.display = "";
		}
	}

	function btnClose_click() {
		win.close();
	}
	function afterClose() {
		if (blSaved) {
            var pageMaxRows = txtPageRows.value.toInt();
            win.para.gridView.reInit({ pageMaxRows: pageMaxRows });
		}
	}
</script>
<!-- 初始化界面 -->
<script type="text/javascript">
	var sqlFields = "";
	
	var dtbView = null, dtbView_ = null;
	var dtbViewField = null;
	// ----------------------------------------------------
	function initConfig() {
		var maxCols = 0;
		if (g.a.send("processType=com.xznext.xpas.ViewAid&actionType=getView_userConfig", { viewKey: viewKey }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				dtbView_ = cReturn.dtbView_;
				dtbView = cReturn.dtbView;
				dtbViewField = cReturn.dtbViewField;
				dtbViewField.sort("field_name");

				sqlFields = dtbView.rows[0]["view_sql_select"].value;
				if (dtbView_.rowCount == 1) {
					maxCols = dtbView_.rows[0]["view_fixed_columns"].value + dtbView_.rows[0]["view_float_columns"].value;
				}
				else {
					maxCols = dtbView.rows[0]["view_fixed_columns"].value + dtbView.rows[0]["view_float_columns"].value;
				}
				// ----------------------------------------
				var nFind = 0;
				var fieldName0 = "", fieldName = "";
				var arrField = null;
				var arrFields = sqlFields.split(",");
				for (var i = 0; i < arrFields.length; i++) {
					fieldName0 = arrFields[i].trim();
					arrField = fieldName0.split(" ");
					fieldName = arrField[arrField.length - 1];
					fieldName = fieldName.trim().replaceAll("\r", "").replaceAll("\n", "").replaceAll("\\[", "").replaceAll("\\]", "");

					nFind = dtbViewField.find([fieldName]);
					if (nFind < 0) {
						debug("字段 [" + fieldName + "] 没找到，请检查。原始字段：\n" + fieldName0 + "。");
						continue;
					}
					dtbViewField.rows[nFind]["field_name0"].value = fieldName0;
					// ------------------------------------
					if (maxCols > 0 && i > maxCols - 1) continue;
					dtbViewField.rows[nFind]["field_order"].value = 2 * (i + 1);
				}
				dtbViewField.sort("field_order");
				buildHtml();
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
	function buildHtml() {
		var iRow = 0;
		var arrHtml = new Array();

		// ------------------------------------------------
		arrHtml.push("<table class='tbColumns'>");
		arrHtml.push("<tr><th class='tdVisibleColumn'>显示列</th></tr>");
		for (; iRow < dtbViewField.rowCount; iRow++) {
			if (dtbViewField.rows[iRow]["field_order"].value >= 9999) break;

			var fieldName = dtbViewField.rows[iRow]["field_name"].value;
			var fieldText = dtbViewField.rows[iRow]["field_text"].value;

			arrHtml.push("<tr><td fieldName='" + fieldName + "' class='tdVisibleColumn' ondragover='dragover(event)' ondrop='drop(event)'>");
			arrHtml.push("<span fieldName='" + fieldName + "' draggable='true' ondragstart='dragstart(event)'>" + fieldText);
			arrHtml.push("</span></td></tr>");
		}
		arrHtml.push("</table>");

		divL.innerHTML = arrHtml.join("\n");
		divL.ondragover = dragover;
		divL.ondrop = drop;		
		// ------------------------------------------------
		
		arrHtml = new Array();
		arrHtml.push("<table class='tbColumns'>");
		arrHtml.push("<tr><th class='tdHiddenColumn'>隐藏列</th></tr>");
		for (; iRow < dtbViewField.rowCount; iRow++) {
			var fieldName = dtbViewField.rows[iRow]["field_name"].value;
			var fieldText = dtbViewField.rows[iRow]["field_text"].value;

			arrHtml.push("<tr><td fieldName='" + fieldName + "' class='tdHiddenColumn' ondragover='dragover(event)' ondrop='drop(event)'>");
			arrHtml.push("<span fieldName='" + fieldName + "' draggable='true' ondragstart='dragstart(event)'>" + fieldText);
			arrHtml.push("</span></td></tr>");
		}
		arrHtml.push("</table>");

		divR.innerHTML = arrHtml.join("\n");
		divR.ondragover = dragover;
		divR.ondrop = drop;		
	}
</script>

<!-- 字段拖放处理 -->
<script type="text/javascript">
	function dragstart(event) {
		var srcEl = g.x.getEventTarget(event);
		var fieldName = srcEl.getAttribute("fieldName");
		event.dataTransfer.setData("Text", fieldName);
	}
	function dragover(event) {
		event.preventDefault();
	}
	
	function drop(event) {
		event.preventDefault();

		var srcElement = g.x.getEventTarget(event);
		var columnDrag = event.dataTransfer.getData("Text");
		var columnDrop = srcElement.getAttribute("fieldName");

		var idxDrop = 9999;
		// --------------------------------------
		if (columnDrag == null) return;
		if (columnDrag.equals(columnDrop)) return;
		if (srcElement.id.equals("divR")) {
			idxDrop = 9999;
		}
		else if (srcElement.id.equals("divL")) {
			idxDrop = 8888;
		}
		else {
			if (!srcElement.className.equals("tdVisibleColumn") && !srcElement.className.equals("tdHiddenColumn")) {
				return;
			}
			for (var i = 0; i < dtbViewField.rowCount; i++) {
				if (dtbViewField.rows[i]["field_name"].value.equals(columnDrop)) {
					idxDrop = dtbViewField.rows[i]["field_order"].value + 1;					
					break;
				}
			}
		}

		for (var i = 0; i < dtbViewField.rowCount; i++) {
			if (dtbViewField.rows[i]["field_name"].value.equals(columnDrag)) {
				dtbViewField.rows[i]["field_order"].value = idxDrop;
				break;
			}
		}
		// ------------------------------------------------
		dtbViewField.sort("field_order");
		for (var i = 0; i < dtbViewField.rowCount; i++) {
			if (dtbViewField.rows[i]["field_order"].value >= 9999) {
				continue;
			}
			dtbViewField.rows[i]["field_order"].value = 2 * (i + 1);
		}

		buildHtml();
	}
</script>
<!-- 保存配置 -->
<script type="text/javascript">
	function btnSave_click() {
		saveConfig("false");
	}
	function btnSaveAsDesign_click() {
		saveConfig("true");
	}
	function saveConfig(asDesign) {
		var fixedCols = 0, floatCols = 0;
		var viewSqlSelect = "";

		// ------------------------------------------------
		fixedCols = dtbView.rows[0]["view_fixed_columns"].value;
		for (var i = 0; i < dtbViewField.rowCount; i++) {
			if (dtbViewField.rows[i]["field_order"].value >= 9999) {
				// break;
			}
			else {
				if (i >= fixedCols) {
					floatCols++;
				}
			}
			viewSqlSelect += "," + dtbViewField.rows[i]["field_name0"].value;
		}
		if (viewSqlSelect.length == 0 || viewSqlSelect.substring(1).split(",").length < (fixedCols + 1)) {
			showMsg("当前视图允许显示最少列数为: " + (fixedCols + 1) + "列, 请选择.");
			return;
		}
		viewSqlSelect = viewSqlSelect.substring(1);

		// -- 未设定为显示状态的主键字段-------------------
		for (var i = 0; i < dtbViewField.rowCount; i++) {
			if (dtbViewField.rows[i]["field_order"].value < 9999) continue;
			if (dtbViewField.rows[i]["field_pkey"].value == 1) {
				viewSqlSelect += "," + dtbViewField.rows[i]["field_name0"].value;
			}
		}

		if (g.a.send("processType=com.xznext.xpas.ViewAid&actionType=saveView_userConfig", { asDesign: asDesign, viewKey: viewKey, viewSqlSelect: viewSqlSelect, fixedCols: fixedCols, floatCols: floatCols }, true)) {
			if (g.a.OK) {
				blSaved = true;
				win.close();
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}

	function btnReset_click() {
		if (g.a.send("processType=com.xznext.xpas.ViewAid&actionType=deleteView_userConfig", { viewKey: viewKey }, true)) {
			if (g.a.OK) {
				blSaved = true;
				win.close();
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
</script>