<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>数据筛选条件设定界面</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>
	
	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

	<!-- 布局区 -->
	<style type="text/css">
		body {
			overflow: hidden;
			font-size: 11pt;
			font-family: 微软雅黑;
		}

		.tbLayout {
			table-layout: fixed;
			border-collapse: collapse;	
			margin-top: 5px;					
		}
		.tdLayout {			
			padding: 0px;
			vertical-align: top;
			border: solid 1px #c0c0c0;
		}
		#divTree {
			overflow: auto;		
		}
	</style>
	<!-- 输入筛选区 -->
	<style type="text/css">		
		#divMain {
			overflow: auto;
		}
		.tbMain {
			table-layout: fixed;
			border-collapse: collapse;
		}
		.tbMain th {
			line-height: 36px;
		}
		.tbMain td {
			padding: 0px;
			overflow: hidden;
			height: 32px;
			border: solid 1px #c0c0c0;
			
			white-space: nowrap;
		}

		.tdText span {
			color: Blue;			
			padding-left: 5px;		
			cursor: default;	
		}
		.tdText span:hover {
			font-weight: bold;
			color: Red;
		}
		.tdSelect select {
			width: 100px;
			border: 0px;
			margin-right: 3px;
		}
		.tdValue textarea {
			margin: 1px 3px 1px 3px;
			line-height: 21px;
		}
	</style>
</head>
<body scroll="no">
	<div id="divButtons" class="divButtons">
		<input id="btnOK" type="button" value="确定(O)" onclick="btnOK_click(); return false;" />
		<input id="btnClear" type="button" value="清除(E)" onclick="btnClear_click(); return false;" />
		<input id="btnClose" type="button" value="关闭(C)" onclick="btnClose_click(); return false;" />
	</div>
	<table class="tbLayout" id="tbLayout">
		<tr>
			<td id="tdLeft"  class="tdLayout" style="width:300px;"><div id="divTree"></div></td>
			<td id="tdRight" class="tdLayout" style="width:650px;"><div id="divMain"></div></td>
		</tr>
	</table>	
</body>
</html>

<!-- formLoad and button click -->
<script type="text/javascript">
	var nTreeFields = 0, nKeyboardFields = 0;
	var filterType = "view", viewKey = "", reportKey = "", databaseType = "";

	var tree = null;
	var tbMain = null;
	var dtbQueryField = null;
	var divTree = gId("divTree");

	var divMain = gId("divMain");
	var txtDebug = gId("txtDebug");
	var arrControls = new Array();

	var dtFormat = "yyyy-MM-dd hh:mm:ss";
	//-----------------------------------------------------
	function formLoad() {
		if (win.para.filterType) {
			filterType = win.para.filterType;
		}
		if (filterType.equals("view")) {
			viewKey = win.para.viewKey;
		}
		else if (filterType.equals("report")) {
			reportKey = win.para.reportKey;
		}
		else {
			showErr("Unknown filterType [" + filterType + "], please check it.");
			return;
		}
		// ------------------------------------------------
		init();
		formResize();
		// ------------------------------------------------
		if (databaseType.equals("Oracle")) {
			dtFormat = "yyyy-mm-dd hh24:mi:ss";
		}
	}
	function formResize() {
		var tbLayout = gId("tbLayout");
		var tdLeft = gId("tdLeft");
		var tdRight = gId("tdRight");
		var maxHeight = win.p.maxHeight - divMain.offsetTop;

		//-------------------------------------------------
		if (divMain.offsetHeight > maxHeight) {
			divMain.style.height = maxHeight + "px";
			divMain.style.width = (tbMain.offsetWidth + 20) + "px";
			gId("divButtons").style.width = (tbMain.offsetWidth + 20) + "px";
		}
		else {
			divMain.style.height = (divMain.offsetHeight + 50) + "px";
		}

		if (nTreeFields == 0) {
			tbLayout.style.width = "650px";
			tdLeft.style.display = "none";
		}
		else if (nKeyboardFields == 0) {
			tdRight.style.display = "none";
			tbLayout.style.width = "350px";
			divTree.style.height = "350px";
		}
		else {
			tbLayout.style.width = "950px";
			if (divMain.offsetHeight > 350) {
				divTree.style.height = divMain.style.height;
			}
			else {
				divTree.style.height = "350px";
			}
		}
		// ------------------------------------------------
		win.p.top = null;
		win.p.left = null;
	}
	//-----------------------------------------------------
	function btnOK_click() {
		var userFilter = getUserFilter();
		if (win.para.filterMust && userFilter.equals("")) {
			showWarn("当前视图配置为必需设置筛选条件。");
			return;
		}

		win.para.callback(userFilter);
		win.hide();
	}

	function btnClear_click() {
		for (var i = 0; i < arrControls.length; i++) {
			arrControls[i].ctlSelect.selectedIndex = 0;
			arrControls[i].ctlValue0.value = "";
			arrControls[i].ctlValue1.value = "";
			arrControls[i].ctlValue0.rows = 1;
			arrControls[i].ctlValue0.rows = 1;
			arrControls[i].ctlValue0.style.width = "400px";
			arrControls[i].ctlValue1.style.display = "none";
		}

		var node = null, key = "";
		if (tree) {
			for (var i = 0; i < tree.nodeKeys.length; i++) {
				key = tree.nodeKeys[i];
				node = tree.nodes[key];
				if (node.checked) {
					tree.setNodeChecked(key, false);
				}
			}
		}
	}
	function btnClose_click() {
		win.hide();
	}
</script>

<!-- init and getFilter -->
<script type="text/javascript">
	function init() {
		var blAjax = false;
		var idx = 0, nRowCount = 0;
		var arrHtml = new Array();
		var fieldKey = "", fieldType = "", fieldName = "";
		var fieldQueryType = "";
		var blDraggable = (g.debug || g.local || topWin.isDeveloper) && filterType.equals("view");
		//-- 读取查询字段信息 -----------------------------
		if (filterType.equals("view")) {
			blAjax = g.a.send("processType=com.xznext.xpas.ViewAid&actionType=getViewQueryField", { viewKey: viewKey }, true);
		}
		else if (filterType.equals("report")) {
			blAjax = g.a.send("processType=com.xznext.report.ReportAid&actionType=getReportQueryField", { reportKey: reportKey }, true);
		}
		if (blAjax) {
			if (g.a.OK) {
				databaseType = g.a.cReturn.databaseType;
				dtbQueryField = g.a.cReturn.dtbQueryField;
				nRowCount = dtbQueryField.rowCount;
				if (nRowCount == 0) {
					divMain.innerHTML = "<hr /><span style='color:red;padding:20px;'>没有找到需要筛选的字段信息。</span>";
					gId("btnOK").style.display = "none";
					gId("btnClear").style.display = "none";
					return;
				}
			}
			else {
				return;
			}
		}
		else {
			return;
		}
		//-------------------------------------------------
		arrHtml[idx++] = "<table id='tbMain' class='tbMain'>";
		arrHtml[idx++] = "<tr>";
		arrHtml[idx++] = "<th style='width:150px;'>字段名称</th>";
		arrHtml[idx++] = "<th>条件类型</th>";
		arrHtml[idx++] = "<th>条件值</th>";
		arrHtml[idx++] = "</tr>";

		for (var i = 0; i < nRowCount; i++) {
			fieldKey = dtbQueryField.rows[i]["field_key"].value;
			fieldQueryType = dtbQueryField.rows[i]["field_query_type"].value;

			if (fieldQueryType.equals("keyboard")) {
				nKeyboardFields++;
				arrHtml[idx++] = "<tr>";
				arrHtml[idx++] = "<td fieldKey='" + fieldKey + "' class='tdText' ondragover='dragover(event)' ondrop='drop(event)'>"
				arrHtml[idx++] = "<span fieldKey='" + fieldKey + "'" + (blDraggable ? " draggable='true'" : "") + " ondragstart='dragstart(event)'>";
				arrHtml[idx++] = dtbQueryField.rows[i]["field_text"].value + "</span></td>";
				arrHtml[idx++] = "<td class='tdSelect'><select id='_s_" + fieldKey + "'>" + getDroplist(dtbQueryField.rows[i]["field_type"].value) + "</select></td>";

				arrHtml[idx++] = "<td class='tdValue'>";
				arrHtml[idx++] = "<textarea id='_v_" + fieldKey + "_0' rows='1' cols='0' style='width:400px;'></textarea>";
				arrHtml[idx++] = "<textarea id='_v_" + fieldKey + "_1' rows='1' cols='0' style='width:194px;display:none;'></textarea>";
				arrHtml[idx++] = "</td></tr>";
			}
			else if (fieldQueryType.equals("tree")) {
				nTreeFields++;
				addTreeNode(dtbQueryField.rows[i]);
			}
			else {
				showErr("Unknown field query type: " + fieldQueryType + ".");
				continue;
			}
		}
		arrHtml[idx++] = "</table>";
		divMain.innerHTML = arrHtml.join("");
		tbMain = gId("tbMain");
		if (tree) tree.expand("0");
		//-------------------------------------------------
		for (var i = 0; i < nRowCount; i++) {
			fieldKey = dtbQueryField.rows[i]["field_key"].value;
			fieldType = dtbQueryField.rows[i]["field_type"].value;
			fieldName = dtbQueryField.rows[i]["field_name"].value;
			fieldQueryType = dtbQueryField.rows[i]["field_query_type"].value;

			if (!fieldQueryType.equals("keyboard")) continue;
			if (fieldKey.split(".").length == 2) {	// -- _g字段，设定过筛选字段 --
				fieldName = fieldKey;
			}
			fieldPrefix = dtbQueryField.rows[i]["field_prefix"].value;

			var json = { fieldKey: fieldKey, fieldType: fieldType, fieldName: fieldName, fieldPrefix: fieldPrefix };
			arrControls.push(json);
			json.ctlSelect = gId("_s_" + fieldKey);
			json.ctlValue0 = gId("_v_" + fieldKey + "_0");
			json.ctlValue1 = gId("_v_" + fieldKey + "_1");

			json.ctlSelect.onchange = select_onclick(json);
			if (fieldType.equals("datetime")) {
				json.ctlValue0.onclick = WdatePicker;
				json.ctlValue1.onclick = WdatePicker;
			}
			else {
				json.ctlValue0.onfocus = value_onfocus(json);
				json.ctlValue1.onfocus = value_onfocus(json);
				json.ctlValue0.onblur = value_onblur(json);
				json.ctlValue1.onblur = value_onblur(json);
			}
		}
	}
	function getDroplist(fieldType) {
		var optionString = "", optionNumber = "";
		optionString = "<option value='*'>包含</option>"
					 + "<option value='='>等于</option>"
					 + "<option value='<>'>不等于</option>"
					 + "<option value='!*'>不包含</option>"
		// + "<option value='E'>表达式</option>"
					 + "<option value=''></option>";

		optionNumber = "<option value='='>等于</option>"
					 + "<option value='>'>大于</option>"
					 + "<option value='>='>大于等于</option>"
					 + "<option value='<'>小于</option>"
					 + "<option value='<='>小于等于</option>"
					 + "<option value='<>'>不等于</option>"
					 + "<option value='[]'>两者之间 [ ]</option>"
					 + "<option value=']['>两者之外 ( )</option>"
					 + "<option value=''></option>";
		//-------------------------------------------------
		if (fieldType.equals("string")) {
			return optionString;
		}
		else {
			return optionNumber;
		}
	}

	function addTreeNode(drRow) {
		if (tree == null) {
			var jsonPara = {
				divContainer: divTree,
				imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
				title: "查询条件导航",
				beforeExpand: this.onNodeFirstExpand,
				showCheckBoxs: "leaf",
				sd: "~"
			};
			tree = new window.xwf_tree(jsonPara);
		}

		var fieldName = drRow["field_name"].value;
		var fieldText = drRow["field_text"].value;
		var nodeKey = "0" + tree.sd + fieldName;
		tree.addNode({ key: nodeKey, text: fieldText, fieldName: fieldName ,fieldPrefix: drRow["field_prefix"].value });
		tree.addNode({ key: nodeKey + tree.sd + "loading", text: "loading..." });
	}
	function onNodeFirstExpand(node, blFirstExpand) {
		if (!blFirstExpand) return;
		tree.removeNode(node.key + tree.sd + "loading");

		if (g.a.send("processType=com.xznext.xpas.ViewAid&actionType=getTreeNodeData", { viewKey: viewKey, fieldName: node.fieldName }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				var dtbQueryData = cReturn.dtbQueryData;

				if (dtbQueryData == null) return;
				for (var i = 0; i < dtbQueryData.rowCount; i++) {
					var nodeValue = dtbQueryData.rows[i][0].value;
					var nodeText = dtbQueryData.rows[i][1].value;
					tree.addNode({ key: node.key + tree.sd + nodeValue, text: nodeText, fieldName: node.fieldName, fieldValue: nodeValue });
				}
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
</script>
<!-- getFilter -->
<script type="text/javascript">
	function getUserFilter() {
		var idx = 0, index = 0;
		var arrFilter = new Array(), arrValue0 = null, arrValue1 = null;
		var selectType = "", fieldType = "", fieldKey = "", fieldName = "", fieldPrefix = "";
		var andOr = "", symbol = "", fieldPrefix = "";
		// -- 输入查询条件 --------------------------------
		for (var i = 0; i < arrControls.length; i++) {
			arrControls[i].ctlValue0.value = arrControls[i].ctlValue0.value.trim();
			arrControls[i].ctlValue1.value = arrControls[i].ctlValue1.value.trim();

			selectType = arrControls[i].ctlSelect.value;
			fieldType = arrControls[i].fieldType;
			fieldKey = arrControls[i].fieldKey;
			fieldName = arrControls[i].fieldName;
			fieldPrefix = arrControls[i].fieldPrefix;
			if (fieldPrefix.equals("")) {	// -- 多表有相同字段，用于区分查询字段属于哪张表 --
				fieldKey = fieldName;
			}
			else {
				fieldKey = fieldPrefix + "." + fieldName;
			}
			symbol = fieldType.equals("number") ? "" : "'";
			andOr = (selectType.equals("*") || selectType.equals("=")) ? " OR " : " AND ";

			arrValue0 = arrControls[i].ctlValue0.value.replaceAll("\r", "").split("\n");
			arrValue1 = arrControls[i].ctlValue1.value.replaceAll("\r", "").split("\n");

			if (selectType.equals("") || (arrValue0.length == 1 && arrValue0[0].equals(""))
									  || (selectType.indexOf("[") >= 0 && arrValue1[0].equals(""))) continue;
			//-------------------------
			if (selectType.equals("*") || selectType.equals("!*")) {
				for (var j = 0; j < arrValue0.length; j++) {
					arrValue0[j] = fieldKey + (selectType.equals("*") ? " LIKE" : " NOT LIKE") + " '%" + arrValue0[j] + "%'";
				}
				arrFilter[idx++] = "(" + arrValue0.join(andOr) + ")";
			}
			else if (selectType.equals("=") || selectType.equals("<>")) {
				for (var j = 0; j < arrValue0.length; j++) {
					if (fieldType.equals("datetime")) {
						if (databaseType.equals("Oracle")) {
							arrValue0[j] = "TO_CHAR(" + fieldKey + ",'" + dtFormat.substr(0, arrValue0[j].length) + "') " + selectType + " '" + arrValue0[j] + "'";
						}
						else if (databaseType.equals("SQLServer")) {
							arrValue0[j] = "CONVERT(varchar(" + arrValue0[j].length + "), " + fieldKey + ", 120) " + selectType + " '" + arrValue0[j] + "'";
						}
						else if (databaseType.equals("MySQL")) {
							arrValue0[j] = "DATE_FORMAT(" + fieldKey + ",'%Y-%m-%d') " + selectType + " '" + arrValue0[j] + "'";
						}
						else {

						}
					}
					else {
						arrValue0[j] = fieldKey + " " + selectType + " '" + arrValue0[j] + "'";
					}
				}
				arrFilter[idx++] = "(" + arrValue0.join(andOr) + ")";
			}
			else if (selectType.equals(">") || selectType.equals(">=") || selectType.equals("<") || selectType.equals("<=")) {
				if (fieldType.equals("datetime")) {
					if (databaseType.equals("Oracle")) {
						arrFilter[idx++] = "(TO_CHAR(" + fieldKey + ",'" + dtFormat.substr(0, arrValue0[0].length) + "') " + selectType + " '" + arrValue0[0] + "' )";
					}
					else if (databaseType.equals("SQLServer")) {
						arrFilter[idx++] = "(CONVERT(varchar(" + arrValue0[0].length + "), " + fieldKey + ", 120) " + selectType + " '" + arrValue0[0] + "' )";
					}
					else if (databaseType.equals("MySQL")) {
						arrFilter[idx++] = "(DATE_FORMAT(" + fieldKey + ",'%Y-%m-%d') " + selectType + " '" + arrValue0[0] + "' )";
					}
					else {

					}
				}
				else {
					arrFilter[idx++] = "(" + fieldKey + " " + selectType + " '" + arrValue0[0] + "' )";
				}
			}
			else if (selectType.equals("[]")) {
				if (fieldType.equals("datetime")) {
					if (databaseType.equals("Oracle")) {
						arrFilter[idx++] = "(TO_CHAR(" + fieldKey + ",'" + dtFormat.substr(0, arrValue0[0].length) + "') >= '" + arrValue0[0] + "' AND TO_CHAR(" + fieldKey + ",'" + dtFormat.substr(0, arrValue0[0].length) + "') <= '" + arrValue1[0] + "')";
					}
					else if (databaseType.equals("SQLServer")) {
						arrFilter[idx++] = "(CONVERT(varchar(" + arrValue0[0].length + "), " + fieldKey + ", 120) >= '" + arrValue0[0] + "' AND CONVERT(varchar(" + arrValue0[0].length + "), " + fieldKey + ", 120) <= '" + arrValue1[0] + "')";
					}
					else if (databaseType.equals("MySQL")) {
						arrFilter[idx++] = "(DATE_FORMAT(" + fieldKey + ",'%Y-%m-%d') >= '" + arrValue0[0] + "' AND DATE_FORMAT(" + fieldKey + ",'%Y-%m-%d') <= '" + arrValue1[0] + "')";
					}
					else {

					}
				}
				else {
					arrFilter[idx++] = "(" + fieldKey + " >= '" + arrValue0[0] + "' AND " + fieldKey + " <= '" + arrValue1[0] + "')";
				}
			}
			else if (selectType.equals("][")) {
				if (fieldType.equals("datetime")) {
					if (databaseType.equals("Oracle")) {
						arrFilter[idx++] = "(TO_CHAR(" + fieldKey + ",'" + dtFormat.substr(0, arrValue0[0].length) + "') < '" + arrValue0[0] + "' OR TO_CHAR(" + fieldKey + ",'" + dtFormat.substr(0, arrValue0[0].length) + "') > '" + arrValue1[0] + "')";
					}
					else if (databaseType.equals("SQLServer")) {
						arrFilter[idx++] = "(CONVERT(varchar(" + arrValue0[0].length + "), " + fieldKey + ", 120) < '" + arrValue0[0] + "' OR CONVERT(varchar(" + arrValue0[0].length + "), " + fieldKey + ", 120) > '" + arrValue1[0] + "')";
					}
					else if (databaseType.equals("MySQL")) {
						arrFilter[idx++] = "(DATE_FORMAT(" + fieldKey + ",'%Y-%m-%d') < '" + arrValue0[0] + "' OR DATE_FORMAT(" + fieldKey + ",'%Y-%m-%d') > '" + arrValue1[0] + "')";
					}
					else {

					}
				}
				else {
					arrFilter[idx++] = "(" + fieldKey + " < '" + arrValue0[0] + "' OR " + fieldKey + " > '" + arrValue1[0] + "')";
				}
			}
			else {
				showErr("error, please debug here.");
			}
		}
		// -- 导航查询条件 --------------------------------
		if (tree) {
			var nodeRoot = tree.nodes["0"];
			var nodeP = null, nodeC = null;
			var arrAND = new Array();
			for (var i = 0; i < nodeRoot.keys.length; i++) {
				nodeP = tree.nodes[nodeRoot.keys[i]];
				fieldPrefix = (nodeP.fieldPrefix.equals("") ? "" : nodeP.fieldPrefix + ".");
				var arrOR = new Array();
				for (var j = 0; j < nodeP.keys.length; j++) {
					nodeC = tree.nodes[nodeP.keys[j]];
					if (!nodeC.checked) continue;
					arrOR.push(fieldPrefix + nodeC.fieldName + " = '" + nodeC.fieldValue + "'");
				}
				if (arrOR.length > 0) {
					arrFilter[idx++] = "(" + arrOR.join(" OR ") + ")";
				}
			}
		}
		// -- 返回查询条件 --------------------------------
		if (idx == 0) return "";
		return arrFilter.join(" AND ");
	}
</script>

<!-- 控件事件控制 -->
<script type="text/javascript">
	function select_onclick(json) {
		return function () {
			if (json.ctlSelect.value.indexOf("[") >= 0) {
				json.ctlValue0.style.width = "194px";
				json.ctlValue1.style.display = "";
			}
			else {
				json.ctlValue0.style.width = "400px";
				json.ctlValue1.style.display = "none";
			}
		};
	}

	function value_onfocus(json) {
		return function (event) {
			json.ctlValue0.rows = 3;
			json.ctlValue1.rows = 3;
		};
	}
	function value_onblur(json) {
		return function (event) {
			var nRows = Math.max(json.ctlValue0.value.split("\n").length, json.ctlValue1.value.split("\n").length);
			nRows = Math.min(nRows, 3);
			json.ctlValue0.rows = nRows;
			json.ctlValue1.rows = nRows;
		};
	}
	// -- 拖放事件 ------------------------------------------------------------
	function dragstart(event) {
		var srcEl = g.x.getEventTarget(event);
		event.dataTransfer.setData("Text", srcEl.getAttribute("fieldKey"));
	}
	function dragover(event) {
		event.preventDefault();
	}
	function drop(event) {
		event.preventDefault();

		var tdTarget = g.x.getEventTarget(event);
		var fieldKeyFrom = event.dataTransfer.getData("Text");
		var fieldKeyTo = tdTarget.getAttribute("fieldKey");

		if (fieldKeyFrom.equals(fieldKeyTo)) return;
		doDrop(fieldKeyFrom, fieldKeyTo, (event.x > tdTarget.clientWidth / 2 ? 1 : -1));
	}

	function doDrop(fieldKeyFrom, fieldKeyTo, frontBack) {
		if (filterType.equals("view")) {
			processType = "com.xznext.xpas.ViewAid";
			if (g.a.send("processType=com.xznext.xpas.ViewAid&actionType=saveQueryOrder", { viewKey: viewKey, fieldKeyFrom: fieldKeyFrom, fieldKeyTo: fieldKeyTo, frontBack: frontBack }, true)) {
				if (g.a.OK) {
				}
				else {
					return false;
				}
			}
			else {
				return false;
			}
		}
		else {
			return;
		}
		// ------------------------------------------------
		init();
	}
</script>