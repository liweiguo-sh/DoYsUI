<!DOCTYPE html>
<html>
<head>
    <title>导航树定义</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<script src="../../js/xtfs.js" type="text/javascript"></script>
</head>
<body>
	<div id="divDC"></div>
	<form id="frm" action="" target="com.xznext.xpas.Tree">
		<table id="tbForm" class="tbForm" style="width:675px;">
			<tr class="trH">
				<th style="width:140px;"></th>
				<th style="width:250px;"></th>
				<th style="width:130px;"></th>
				<th style="width:150px;"></th>
			</tr>
			<tr>
				<td>树标识</td>
				<td><input id="_cTREE_KEY" type="text" value="" maxlength="30" /></td>
				<td>数据库</td>
				<td><input id="_cDatabase_Key" type="text" controlType="dropdown" fieldValue="database_key" fieldText="database_text" visibleSearch="false" /></td>				
			</tr>
			<tr>
				<td>树名称</td>
				<td><input id="_cTree_Name" type="text" value="" /></td>
				<td>自动展开</td>
				<td><input id="_cTree_auto_expand" type="checkbox" value="" /></td>
			</tr>
			<tr id="trVT" style="display:none;">
				<td>导航类型</td>
				<td><input id="_xVt_nav_type" type="text" controlType="dropdown" fieldValue="a" fieldText="b" dataSource="[['a','b'],['default','常规导航'],['script','脚本导航']]" visibleSearch="false" /></td>
				<td>序号</td>
				<td><input id="_xView_tree_order" type="text" /></td>
			</tr>
			<tr>
				<td>根节点条件</td>
				<td colspan="3"><textarea id="_cTree_root_where" rows="4" cols="0"></textarea></td>				
			</tr>
			<tr>
				<td>根节点值</td>
				<td colspan="3"><input id="_cTree_first_node_value" type="text" value="" /></td>
			</tr>
			<tr>
				<td>备注</td>
				<td colspan="3"><textarea id="_cTree_Remark" rows="3" cols="0"></textarea></td>
			</tr>
		</table>		
		<input type="hidden" id="_xVIEW_KEY" />
	</form>
	<div id="divGrid" style="width:660px;height:240px;"></div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var parentWin = null;
	var gridView = null;

	var blUserView = false;
	// ----------------------------------------------------
	function formLoad() {
		parentWin = win.parentWindow;
		blUserView = (parentWin.location.href.indexOf("userview.html") > 0);
		if (blUserView) {
			vf.addExtraButton({ key: "removeTree", text: "移除" });
			frm._xVIEW_KEY.value = parentWin.frm._cVIEW_KEY.value;
			gId("trVT").style.display = "";
		}
		else {
			gId("_xVt_nav_type").id = "";
			gId("_xView_tree_order").id = "";
			gId("_xVIEW_KEY").id = "";
		}

		vf.addExtraButton({ key: "xTFS", text: "xTFS" });
		vf.css(gId("tbForm"));

		initGridView();
		if (blUserView) {
			gId("_xVt_nav_type").dropdown = new window.xwf_dropdown({ txtHost: gId("_xVt_nav_type") });
		}
	}
</script>

<!-- viewGrid -->
<script type="text/javascript">
	function initGridView() {
		var prop = {
			divContainer: divGrid,
			viewKey: "fv_tree_node",
			viewFilter: "1 = 0",
            viewForm: "project/xpas/html/tree/tree_node.html",
            toolbarVisible: true,
            jsonToolbar: { height: "M", onclick: onToolbarClick }
		};
        gridView = new window.xwf_gridview(prop);
        gridView.beforeAddnew = function () {
            if (frm._cTREE_KEY.value.equals("")) {
                if (!vf.save()) {
                    return false;
                }
            }
            return true;
        }
        gridView.toolbar.addBar({ type: "button", key: "addnew", text: "<i class='fa fa-plus'></i>  添加", align: "left", style: "Grid" });
    }

    function onToolbarClick(para) {
        if (para.key.equals("addnew")) {
            gridView.addnew();
        }
        else {
            showErr("unknown button " + para.key);
        }
    }
</script>

<!-- uviewForm -->
<script type="text/javascript">
	vf.beforeSave = function () {
		// -- xTFS：判断是否已签出 ------------------------
		if (g.a.send("processType=com.xtfs.XtfsCore&actionType=getMDataStatus", { mdataType: "tree", mdataKey: frm._cTREE_KEY.value }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				if (!cReturn.newMData && !cReturn.myCheckout) {
					showWarn("主数据尚未签出，同步xTFS时修改会丢失，请谨慎操作。");
				}
			}
		}
		// ------------------------------------------------
		return true;
	}
	vf.afterMove = function () {
		gridView.setViewFilter("tree_key = '" + frm._cTREE_KEY.value + "'");
		if (blUserView) {
			if (g.a.send("processType=com.xznext.xpas.Tree&actionType=getViewTree", { viewKey: frm._xVIEW_KEY.value, treeKey: frm._cTREE_KEY.value }, true)) {
				if (g.a.OK) {
					var cReturn = g.a.cReturn;
					var dtbViewTree = cReturn.dtbViewTree;
					frm._xVt_nav_type.setValue(dtbViewTree.rows[0]["vt_nav_type"].value);
					frm._xView_tree_order.value = dtbViewTree.rows[0]["view_tree_order"].value;
				}
				else {
					return false;
				}
			}
			else {
				return false;
			}
		}
	}

	vf.beforeClick = function (prop) {
		if (prop.buttonKey.equals("removeTree")) {
			if (confirm("您确定要移除当前视图导航树吗？\n此处只解除树与视图的绑定关系，不删除树定义。")) {
				if (g.a.send("processType=com.xznext.xpas.Tree&actionType=removeTree", { viewKey: frm._xVIEW_KEY.value, treeKey: frm._cTREE_KEY.value }, true)) {
					if (g.a.OK) {
						vf.remove();
					}
				}
			}
		}
		else if (prop.buttonKey.equals("xTFS")) {
			var jsonPara = {
				mdataType: "tree",
				mdataKeys: "'" + frm._cTREE_KEY.value + "'",
				objDom: prop.button
			}
			xTFS.openMenu(jsonPara);
		}
		return false;
	}
</script>