<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>

	<script src="../../../../res/control/tree/xwf.tree.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>

	<style type="text/css">
		body {
			margin: 0px;
		}
		#divTree {
			overflow: auto;
			border: solid 1px Olive;
			margin-top: 5px;
		}
	</style>
</head>
<body>
	<div id="divButton" class="divButtons">
		<input type="button" id="btnOK" onclick="btnOK_click();" value="确认选择" />
		<input type="button" id="btnDesign" onclick="btnDesign_click();" value="设计" style="display:none;" />
		<input type="button" id="btnClose" onclick="btnClose_click();" value="关闭" />
	</div>
	<div id="divTree"></div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var treeKey = "", treeTitle = "数据选择";
	var selectMode = "";				// -- selectMode: singleSelect 单选 --
	var rootReplace = "";				// -- 根节点条件 --
	var xNodeReplace = ""; 				// -- 任意节点条件 --

	var divTree = gId("divTree");
	var tree = null;
	// ------------------------------------------------------------------------
	function formLoad() {
		treeKey = win.para.treeKey;
		treeTitle = win.para.treeTitle || treeTitle;
		selectMode = win.para.selectMode;
		rootReplace = win.para.rootReplace;
		xNodeReplace = win.para.xNodeReplace;

		divTree.style.height = (win.p.height - divTree.offsetTop -2) + "px";
		initTree();

		if (g.debug || g.local || topWin.isDeveloper) {
			gId("btnDesign").style.display = "";
		}
	}
</script>
<!-- 功能操作 -->
<script type="text/javascript">
	function btnOK_click() {
		var node = tree.selectedNode;
		if (win.para.callback) {
			win.para.callback({
				node: tree.selectedNode,
				callPara: win.para
			});
			win.close();
		}
		else {
			showWarn("缺少回调函数，请检查。");
		}
	}
	function btnDesign_click() {
		var prop = {
			url: g.appPath + "project/xpas/html/tree/tree.html",
			parent: win
		};
		var para = {
			flowKey: "",
			viewKey: "fv_tree",
			primaryKey: "tree_key," + treeKey,
			allowModify: true,
			allowMove: false
		};
		topWin.openWindow(prop, para);
	}

	function btnClose_click() {
		win.close();
	}
</script>

<!-- 加载树 -->
<script type="text/javascript">
	function initTree() {
		var jsonPara = {
			divContainer: divTree,
			imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
			title: treeTitle ,
			beforeExpand: this.onNodeFirstExpand,
			showCheckBoxs: (selectMode.equals("singleSelect") ? "none" : "leaf"),
			nodeClick: onNodeClick,
			sd: "~"
		};
		tree = new window.xwf_tree(jsonPara);
		onNodeFirstExpand(tree.nodes["0"], true);
		tree.expand("0");
	}
	
	function onNodeFirstExpand(node, blFirstExpand) {
		if (!blFirstExpand) return;
		tree.removeNode(node.key + tree.sd + "loading");

		var nodeRoot = node;
		var jsonPost = {tree_key : treeKey};
		// ----------------------------------------------------
		while (nodeRoot.level > 1) {
			nodeRoot = nodeRoot.parent;
			jsonPost["NodeValue_" + (nodeRoot.level + 1)] = nodeRoot.value;
		}
		jsonPost["NodeValue_" + (node.level + 1)] = node.value;

		jsonPost["tree_node_level"] = (node.level + 1);
		if (node.level == 0 && rootReplace) {	// -- 根节点 --
			jsonPost["replaceFilter"] = rootReplace;
		}
		else {
			if (xNodeReplace) jsonPost["replaceFilter"] = xNodeReplace;
		}
		// ----------------------------------------------------
		if (g.a.send("processType=com.xznext.Tree&actionType=getNodeData", jsonPost, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				var dtbNodeData = cReturn.dtbNodeData;
				// --------------------
				for (var i = 0; i < dtbNodeData.rowCount; i++) {
					var jsonNode = { sub_nodes: 0, treeNodeField: cReturn.treeNodeField, singleCondition: cReturn.singleCondition, treeNodeFieldType: cReturn.treeNodeFieldType };
					var jsonColumnValue = {};
					for (var j = 0; j < dtbNodeData.columnCount; j++) {
						var colName = dtbNodeData.columns[j].name;
						if (colName.equals("node_value")) {
							jsonNode["value"] = dtbNodeData.rows[i][colName].value;
						}
						else if (colName.equals("node_text")) {
							jsonNode["text"] = dtbNodeData.rows[i][colName].value;
						}
						else if (colName.equals("node_title")) {
							jsonNode["title"] = dtbNodeData.rows[i][colName].value;
						}
						else if (colName.equals("sub_nodes")) {
							jsonNode["sub_nodes"] = dtbNodeData.rows[i][colName].value;
						}
						jsonColumnValue[colName] = dtbNodeData.rows[i][colName].value;
					}
					jsonNode["key"] = node.key + tree.sd + i;
					jsonNode["Columns"] = jsonColumnValue;
					tree.addNode(jsonNode);

					if (jsonNode["sub_nodes"] != 0) {
						tree.addNode({ key: jsonNode["key"] + tree.sd + "loading", text: "loaddding..." });
					}
				}
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
</script>
<!-- 节点选择 -->
<script type="text/javascript">
	function onNodeClick(node) {
		if (selectMode.equals("singleSelect")) {
			btnOK_click();
		}
	}
</script>