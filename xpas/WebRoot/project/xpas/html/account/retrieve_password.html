<!DOCTYPE html />
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>重置密码</title>
	<link href="../../../../res_plugin/bootstrap4.0/my_bootstrap/bootstrap.min.css" rel="stylesheet" type="text/css" />
	<script src="../../../../res_plugin/bootstrap4.0/my_bootstrap/jquery-3.2.1.slim.min.js" type="text/javascript"></script>
	<script src="../../../../res_plugin/bootstrap4.0/my_bootstrap/popper.min.js" type="text/javascript"></script>
	<script src="../../../../res_plugin/bootstrap4.0/my_bootstrap/bootstrap.min.js" type="text/javascript"></script>
	<script src="../../../../res_plugin/jquery/jquery_md5.js" type="text/javascript"></script>
	
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
</head>
<body onload="formLoad();">
	<div class="container-fluid" style="width:50%">
		<h1>&nbsp;</h1>
		<h4>账户管理</h4> 
		<div class="card card-primary">
			<div class="card-header bg-primary text-white">密码重置</div>
			<div class="card-body">
				<div class="row" id="divRow1">
					<div class="col-sm-6">
						<label for="txtUserkey">登录账户</label>
						<input type="text" id="txtUserkey" class="form-control" placeholder="请输入您的登录账户">
						<label for="txtImageCode">验证码</label>
						<div class="row">
							<div class="col-sm-8">
								<div class="input-group">
									<input type="text" id="txtCheckCode" class="form-control" placeholder="请输入验证码" />
									<img id="imgCheckCode" src="" alt="" onclick="getImageCheckCode();" title="点击刷新验证码" />
								</div>
							</div>
						</div>
						<br />
						<label>验证方式</label>
						<div class="radio">
							<label><input type="radio" name="verifyType" id="verifyTypeMobile" value="mobile" checked>手机验证&nbsp;&nbsp;</label>
							<label><input type="radio" name="verifyType" id="verifyTypeEmail" value="email">邮箱验证</label>
						</div>
						<br /><br />
					</div>
					<div class="col-sm-6">
						<div class="jumbotron" style="margin-top:15px;padding-top:15px;text-indent:2em;">
							第一步：输入您的登录账号，以及用于找回密码的手机号码或邮箱，并输入页面验证码，点击下一步。
						</div>
					</div>
				</div>
				<div class="row" id="divRow2">			
					<div class="col-sm-12 text-center">						
						<a href="#" id="btnNext" class="btn btn-primary" style="width:30%;" onclick="btnNext_click();">下一步</a>
						<br />
					</div>
				</div>
				<div class="row" id="divRow3" style="display:none;">
					<div class="col-sm-6">
						<label for="txtPassword">登录密码</label>
						<input type="password" id="txtPassword" class="form-control" placeholder="请输入新的登录密码" />
						<label for="txtPassword2">再输一次</label>
						<input type="password" id="txtPassword2" class="form-control" placeholder="再输一次新登录密码" />
						<br />
						<div class="row">
							<div class="col-sm-4">
								<label for="txtVerifyCode">验证码</label>
								<input type="text" id="txtVerifyCode" class="form-control" />
							</div>
							<div class="col-sm-4">
								<label>&nbsp; &nbsp;</label>
								<a href="#" id="btnGetVerifyCode" class="btn btn-warning" onclick="btnGetVerifyCode_click();">获取验证码</a>	
							</div>							
						</div>
						<br /><br />
					</div>
					<div class="col-sm-6">
						<div class="jumbotron" style="margin-top:15px;padding-top:15px;text-indent:2em;">
							第二步：请输入您要重置的新登录密码，以及您手机收到的验证码（或邮箱收到的验证码），点击“重置密码”完成重置工作。
						</div>
					</div>
				</div>
				<div class="row" id="divRow4" style="display:none;">
					<div class="col-sm-12 text-center">						
						<a href="#" id="btnResetPassword" class="btn btn-primary" style="width:30%;" onclick="btnResetPassword_click();">重置密码</a>
						<br />
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var parentWin = null;

	var txtUserkey = gId("txtUserkey");
	var txtCheckCode = gId("txtCheckCode");
	var imgCheckCode = gId("imgCheckCode");

	var txtPassword = gId("txtPassword");
	var txtPassword2 = gId("txtPassword2");
	var txtVerifyCode = gId("txtVerifyCode");
	var btnGetVerifyCode = gId("btnGetVerifyCode");

	var verifyType = "";		// -- 验证方式，mobile：手机验证，email：邮箱验证 --
	// ------------------------------------------------------------------------
	function formLoad() {
		//parentWin = win.parentWindow;

		getImageCheckCode();
	}
</script>

<!-- 初始化及第一步 -->
<script type="text/javascript">
	function getImageCheckCode() {
		if (g.a.send("processType=com.system.Account&actionType=getImageCheckCode", {}, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				var urlCheckCode = cReturn.urlCheckCode;

				imgCheckCode.src = g.xpasRunPath + "retrieve_password/" + cReturn.urlCheckCode + "?rnd=" + Math.random();		
			}
		}
	}
	function btnNext_click() {
		verifyType = gId("verifyTypeMobile").checked ? "mobile" : "email";

		txtUserkey.value = txtUserkey.value.trim();
		if (txtUserkey.value.equals("")) {
			showWarn("请输入登录账户。");
			txtUserkey.focus();
			return;
		}
		txtCheckCode.value = txtCheckCode.value.trim();
		if (txtCheckCode.value.equals("")) {
			showWarn("请输入验证码。");
			txtCheckCode.focus();
			return;
		}
		// ------------------------------------------------
		if (!sendVerifyCode()) return;

		gId("divRow1").style.display = "none";
		gId("divRow2").style.display = "none";
		gId("divRow3").style.display = "";
		gId("divRow4").style.display = "";

		setBtnGetVerifyCode();
		txtPassword.focus();		
	}
</script>
<!-- 第二步 -->
<script type="text/javascript">
	var nSeconds = -1;
	// ----------------------------------------------------
	function btnGetVerifyCode_click() {
		if (nSeconds != -1) {
			alert("不是-1?");
			return;
		}
		if (!sendVerifyCode()) return;

		setBtnGetVerifyCode();
	}
	function setBtnGetVerifyCode() {
		if (nSeconds == -1) {
			nSeconds = 60;

			btnGetVerifyCode.disabled = true;
			btnGetVerifyCode.innerHTML = "获取验证码 " + nSeconds;
			btnGetVerifyCode.className = "btn btn-secondary";
		}
		else if (nSeconds <= 0) {
			nSeconds = -1;

			btnGetVerifyCode.disabled = false;
			btnGetVerifyCode.innerHTML = "获取验证码";
			btnGetVerifyCode.className = "btn btn-warning";
			return;
		}
		else {
			btnGetVerifyCode.innerHTML = "获取验证码 " + nSeconds;
		}

		nSeconds--;
		setTimeout(setBtnGetVerifyCode, 1000);
	}

	function sendVerifyCode() {		
		if (g.a.send("processType=com.system.Account&actionType=setVerifyCode", { userKey: txtUserkey.value, verifyType: verifyType, checkCode: txtCheckCode.value }, true)) {
			if (g.a.OK) {
				if (verifyType.equals("mobile")) {
					showMsg("验证码已发送到您手机，请注意查收。");
				}
				else {
					showMsg("验证码已发送到您邮箱，请注意查收。");
				}

				txtVerifyCode.value = "";
				txtVerifyCode.focus();
				return true;
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
	function btnResetPassword_click() {
		if (txtVerifyCode.value.equals("")) {
			showWarn("请输入您收到的验证码。");
			txtVerifyCode.focus();
			return;
		}
		if (txtPassword.value.equals("")) {
			showWarn("请输入您要重置的新密码。");
			txtPassword.focus();
			return;
		}
		if (!txtPassword.value.equals(txtPassword2.value)) {
			showWarn("请两次输入的密码不一致，请检查。");
			txtPassword2.focus();
			return;
		}
		var password = $.md5(txtUserkey.value.toLowerCase() + "xwf.js" + txtPassword.value.toLowerCase());
		if (g.a.send("processType=com.system.Account&actionType=resetPassword", { userKey: txtUserkey.value, password: password, verifyCode: txtVerifyCode.value }, true)) {
			if (g.a.OK) {
				showMsg("密码重置成功，请牢记。");
				win.close();
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}
</script>