<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>报表筛选界面</title>	
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.datatable.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<!-- 布局样式 -->
	<style type="text/css">
		body {
			overflow: hidden;
		}
		.tbLayout {
			table-layout: fixed;
			border-collapse: collapse;
		}
		.tdLayout {
			padding: 0px;
		}
		.divLayout {
			margin: 1px;
			padding: 2px;
			border: solid 1px Gray;
			overflow: auto;
		}
	</style>
	<!-- 数据表样式 -->
	<style type="text/css">
		.tbColumn {
			border-collapse: separate;
		}
		.tbColumn th {
			line-height: 24px;
			text-align:center;
			border: solid 1px #c0c0c0;
		}
		.tbColumn td {
			font-size: 11pt;
			border: solid 1px #c0c0c0;
			--line-height: 24px;
		}

		span {
			cursor: default;
		}
		span:hover {
			color: red;
		}
	</style>
</head>
<body scroll="no">
	<div id="divButton" class="divButtons">
		<input id="btnOK" type="button" value="确定(O)" onclick="return btnOK_click();" />
		<input id="btnSave" type="button" value="保存配置(S)" onclick="return btnSave_click();" />
		<input id="btnClose" type="button" value="关闭(C)" onclick="return btnClose_click();" />
	</div>
	<table id="tbLayout" class="tbLayout" style="width:700px">
		<tr>
			<td class="tdLayout" style="width:300px;">
				<div id="divLayoutRC" class="divLayout" style="text-align:center;vertical-align:middle; font-weight:bold;">
					<table style="margin:30px 0px 0px 30px;">
						<tr>
							<td>报表类型：</td>
							<td>
								<select id="_cReportType" onclick="_cReportType_click(this);">
									<option value="1">汇总报表</option>
									<option value="0">明细报表</option>
								</select>
							</td>
						</tr>
						<tr>
							<td>合计选项：</td>
							<td>
								<select id="_cReportSumCount" onclick="_cReportSumCount_click(this);">
									<option value="-1">无合计</option>
									<option value="0">仅总计</option>
									<option value="1">一层合计</option>
									<option value="2">二层合计</option>
									<option value="3">三层合计</option>
									<!--<option value="4">四层合计</option>-->
									<!--<option value="5">五层合计</option>-->
								</select>
							</td>
						</tr>
					</table>
				</div>
			</td>
			<td class="tdLayout" style="width:400px;">
				<div id="divLayoutGC" class="divLayout">C</div>
			</td>
		</tr>
		<tr>
			<td class="tdLayout">
				<div id="divLayoutGR" class="divLayout">R</div>
			</td>
			<td class="tdLayout">
				<div id="divLayoutD" class="divLayout">D</div>
			</td>
		</tr>
	</table>
</body>
</html>
<!-- formLoad -->
<script type="text/javascript">
	var reportKey = "";

	var tbLayout = gId("tbLayout");
	var divLayoutRC = gId("divLayoutRC");
	var divLayoutGC = gId("divLayoutGC");
	var divLayoutGR = gId("divLayoutGR");
	var divLayoutD = gId("divLayoutD");

	var dtbReport = null, dtbReportColumn = null;
	var currentConfig = {};
	var arrRG = new Array();
	// ------------------------------------------------------------------------
	function formLoad() {
		reportKey = win.para.reportKey;

		divLayoutRC.style.height = 0.3 * (win.p.maxHeight - tbLayout.offsetTop - 120) + "px";
		divLayoutGC.style.height = divLayoutRC.style.height;
		divLayoutGR.style.height = 0.7 * (win.p.maxHeight - tbLayout.offsetTop - 120) + "px";
		divLayoutD.style.height = divLayoutGR.style.height;
		win.p.top = null;

		initConfig();
	}

	function btnOK_click() {
		getCurrentConfig();
		win.hide();
		// win.para.callback("国家 = '中国'");
		win.para.callback("年份 = '20013年'");
	}
	function btnSave_click() {
		saveReportConfig();
	}
	function btnClose_click() {
		win.hide();
	}
</script>
<!-- 字段控件配置事件 -->
<script type="text/javascript">
	function _cReportType_click(ctl) {
		dtbReport.rows[0]["report_type"].value = ctl.value;
	}
	function _cReportSumCount_click(ctl) {
		dtbReport.rows[0]["report_sum_count"].value = ctl.value;
	}

	function columnCheckClick(ctl, iRow) {
		dtbReportColumn.rows[iRow]["rc_selected"].value = (ctl.checked ? 1 : 0);
	}
	function columnSelectClick(ctl, iRow) {
		dtbReportColumn.rows[iRow]["rc_formula_col_count"].value = ctl.value;
	}
</script>

<!-- 初始化配置信息、拖放等配置事件处理 -->
<script type="text/javascript">
	function initConfig() {
		if (g.a.send("processType=com.xznext.report.ReportAid&actionType=getReportConfig", { reportKey: reportKey }, true)) {
			if (g.a.OK) {
				dtbReport = g.a.cReturn.dtbReport;
				dtbReportColumn = g.a.cReturn.dtbReportColumn;
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}

		gId("_cReportType").value = dtbReport.rows[0]["report_type"].value;
		gId("_cReportSumCount").value = dtbReport.rows[0]["report_sum_count"].value;

		genHtmlGR();
		genHtmlGC();
		genHtmlD();
	}

	// ------------------------------------------------------------------------
	function genHtmlGR() {
		var nIndex = 0;
		var arrHtml = new Array();

		arrHtml[nIndex++] = "<table class='tbColumn' style='width:270px;'>";
		arrHtml[nIndex++] = "<th columnKey='$R' ondragover='dragover(event)' ondrop='drop(event)'>行分组区(R)</th>";
		for (var i = 0; i < dtbReportColumn.rowCount; i++) {
			if (!dtbReportColumn.rows[i]["rc_rdc"].value.equals("R")) continue;
			var columnKey = dtbReportColumn.rows[i]["report_column_key"].value;
			var columnName = dtbReportColumn.rows[i]["rc_name"].value;
			var rcSelected = dtbReportColumn.rows[i]["rc_selected"].value == 1 ? "checked='checked'" : "";

			arrHtml[nIndex++] = "<tr><td columnKey='" + columnKey + "' ondragover='dragover(event)' ondrop='drop(event)' >"
				+ "<input columnKey='" + columnKey + "' type='checkbox' " + rcSelected + " onclick=\"columnCheckClick(this," + i + ");\" />"
				+ "<span columnKey='" + columnKey + "' draggable='true' ondragstart='dragstart(event)' >" + columnName + "</span>"
				+ "</td></tr>";
		}
		arrHtml[nIndex++] = "</table>";
		divLayoutGR.innerHTML = arrHtml.join("");
	}
	function genHtmlGC() {
		var nIndex = 0;
		var arrHtml = new Array();

		arrHtml[nIndex++] = "<table class='tbColumn' style='width:370px;'>";
		arrHtml[nIndex++] = "<th columnKey='$C' ondragover='dragover(event)' ondrop='drop(event)'>列分组区(C)</th>";
		for (var i = dtbReportColumn.rowCount - 1; i >= 0; i--) {
			if (!dtbReportColumn.rows[i]["rc_rdc"].value.equals("C")) continue;
			var columnKey = dtbReportColumn.rows[i]["report_column_key"].value;
			var columnName = dtbReportColumn.rows[i]["rc_name"].value;
			var rcSelected = dtbReportColumn.rows[i]["rc_selected"].value == 1 ? "checked='checked'" : "";

			arrHtml[nIndex++] = "<tr><td columnKey='" + columnKey + "' ondragover='dragover(event)' ondrop='drop(event)' >"
				+ "<input columnKey='" + columnKey + "' type='checkbox' " + rcSelected + " onclick=\"columnCheckClick(this," + i + ");\" />"
				+ "<span columnKey='" + columnKey + "' draggable='true' ondragstart='dragstart(event)' >" + columnName + "</span>"
				+ "</td></tr>";
		}
		arrHtml[nIndex++] = "</table>";
		divLayoutGC.innerHTML = arrHtml.join("");
	}
	function genHtmlD() {
		var nIndex = 0;
		var arrHtml = new Array();

		arrHtml[nIndex++] = "<table class='tbColumn' style='width:370px;'>";
		arrHtml[nIndex++] = "<th columnKey='$D' ondragover='dragover(event)' ondrop='drop(event)'>数据项(D)</th><th style='width:80px;'>合计</th>";
		for (var i = 0; i < dtbReportColumn.rowCount; i++) {
			if (!dtbReportColumn.rows[i]["rc_rdc"].value.equals("D")) continue;
			var columnKey = dtbReportColumn.rows[i]["report_column_key"].value;
			var columnName = dtbReportColumn.rows[i]["rc_name"].value;
			var rcSelected = dtbReportColumn.rows[i]["rc_selected"].value == 1 ? "checked='checked'" : "";
			var nRcFormulaColCount = dtbReportColumn.rows[i]["rc_formula_col_count"].value;
			var strOptions = "";
			// ------------------------
			if (nRcFormulaColCount == -1) {
				strOptions += "<option value='-1' selected='selected'>无合计</option>";
			}
			else {
				strOptions += "<option value='-1'>无合计</option>";
			}
			if (nRcFormulaColCount == 0) {
				strOptions += "<option value='0' selected='selected'>仅总计</option>";
			}
			else {
				strOptions += "<option value='0'>仅总计</option>";
			}
			if (nRcFormulaColCount == 1) {
				strOptions += "<option value='1' selected='selected'>一层合计</option>";
			}
			else {
				strOptions += "<option value='1'>一层合计</option>";
			}
			if (nRcFormulaColCount == 2) {
				strOptions += "<option value='2' selected='selected'>二层合计</option>";
			}
			else {
				strOptions += "<option value='2'>二层合计</option>";
			}
			// ------------------------
			arrHtml[nIndex++] = "<tr><td columnKey='" + columnKey + "' ondragover='dragover(event)' ondrop='drop(event)' >"
				+ "<input columnKey='" + columnKey + "' type='checkbox' " + rcSelected + " onclick=\"columnCheckClick(this," + i + ");\" />"
				+ "<span columnKey='" + columnKey + "' draggable='true' ondragstart='dragstart(event)' >" + columnName + "</span>"
				+ "</td><td style='text-align:center;'><select columnKey='" + columnKey + "' onclick=\"columnSelectClick(this," + i + ")\" />" + strOptions + "</select>"
				+ "</td></tr>";
		}
		arrHtml[nIndex++] = "</table>";
		divLayoutD.innerHTML = arrHtml.join("");
	}
	// ------------------------------------------------------------------------
	function dragstart(event) {
		var srcEl = g.x.getEventTarget(event);
		event.dataTransfer.setData("Text", srcEl.getAttribute("columnKey"));
	}
	function dragover(event) {
		event.preventDefault();
	}
	function drop(event) {
		event.preventDefault();		
		var columnKeyFrom = event.dataTransfer.getData("Text");
		var columnKeyTo = g.x.getEventTarget(event).getAttribute("columnKey");
		if (columnKeyFrom.equals(columnKeyTo)) return;

		doDrop(columnKeyFrom , columnKeyTo);
	}

	// ------------------------------------------------------------------------
	function doDrop(columnKeyFrom, columnKeyTo) {
		var iFrom = 0, iIndexTo = 0, iIndexNew = 0;
		var rdcNew = "";
		// ------------------------------------------------
		for (var i = 0; i < dtbReportColumn.rowCount; i++) {
			if (dtbReportColumn.rows[i]["rc_rdc"].value.equals("R")) {
				dtbReportColumn.rows[i]["rc_index"].value = 1 + 2 * i;
			}
			else if (dtbReportColumn.rows[i]["rc_rdc"].value.equals("D")) {
				dtbReportColumn.rows[i]["rc_index"].value = 1001 + 2 * i;
			}
			else {
				dtbReportColumn.rows[i]["rc_index"].value = 2001 + 2 * i;
			}

			if (dtbReportColumn.rows[i]["report_column_key"].value.equals(columnKeyFrom)) {
				iFrom = i;
			}
			if (dtbReportColumn.rows[i]["report_column_key"].value.equals(columnKeyTo)) {
				iIndexTo = dtbReportColumn.rows[i]["rc_index"].value;
				rdcNew = dtbReportColumn.rows[i]["rc_rdc"].value;
			}
		}
		// ------------------------------------------------
		if (iIndexTo > 0) {
			iIndexNew = iIndexTo + (rdcNew.equals("C") ? 1 : -1);
		}
		else {
			rdcNew = columnKeyTo.substring(1);
			iIndexNew = (columnKeyTo.equals("$R") ? 0 : (columnKeyTo.equals("$D") ? 1000 : 2999));
		}
		if (!dtbReportColumn.rows[iFrom]["rc_rdc"].value.equals(rdcNew)) {
			dtbReportColumn.rows[iFrom]["rc_rdc"].value = rdcNew;
			dtbReportColumn.rows[iFrom]["rc_formula_col_count"].value = -1;
		}
		dtbReportColumn.rows[iFrom]["rc_index"].value = iIndexNew;

		//-- 重新排序，重新生成界面 -----------------------
		dtbReportColumn.sort("rc_index");
		for (var i = 0; i < dtbReportColumn.rowCount; i++) {
			dtbReportColumn.rows[i]["rc_index"].value = 10 * (i + 1);
		}

		genHtmlGR();
		genHtmlGC();
		genHtmlD();		
	}
</script>
<!-- 生成、保存配置信息 -->
<script type="text/javascript">
	function saveReportConfig() {
		getCurrentConfig();
		if (g.a.send("processType=com.xznext.report.ReportAid&actionType=saveReportConfig", currentConfig, true)) {
			if (g.a.OK) {
				win.flashTitle("报表配置保存成功。");
			}
			else {
				return false;
			}
		}
		else {
			return false;
		}
	}

	function getCurrentConfig() {
		var iIndex = 0;
		var jsonPara = {
			reportValue: "",
			reportColumnValue: "",
			treeMaxLevel: 0
		};
		var arrPara = new Array();
		arrRG = new Array();
		// ------------------------------------------------
		jsonPara.reportValue = reportKey + "," + dtbReport.rows[0]["report_type"].value + "," + dtbReport.rows[0]["report_sum_count"].value;

		for (var i = 0; i < dtbReportColumn.rowCount; i++) {
			arrPara[iIndex++] = dtbReportColumn.rows[i]["report_column_key"].value + ","
				+ dtbReportColumn.rows[i]["rc_rdc"].value + "," + dtbReportColumn.rows[i]["rc_index"].value + ","
				+ dtbReportColumn.rows[i]["rc_selected"].value + "," + dtbReportColumn.rows[i]["rc_formula_col_count"].value;
			if (dtbReportColumn.rows[i]["rc_rdc"].value.equals("R") && dtbReportColumn.rows[i]["rc_selected"].value == 1) {
				arrRG.push({
					fieldName: dtbReportColumn.rows[i]["report_column_key"].value
				});
			}
		}
		jsonPara.reportColumnValue = arrPara.join(";");
		currentConfig = jsonPara;
	}
</script>

