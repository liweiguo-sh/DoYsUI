<!DOCTYPE html>
<html>
<head>
    <title>统计报表</title>
    <script src="../../../../res/jscript/xwf.js"></script>
    <script src="../../../../res/jscript/xwf.ajax.js"></script>
    <script src="../../../../res/jscript/xwf.const.js"></script>
    <script src="../../../../res/jscript/xwf.datatable.js"></script>    

    <script src="../../../../res/control/toolbar/xwf.toolbar.js"></script>    
    <script src="../../../../res/control/tree/xwf.tree.js"></script>

    <script src="../../../../res/jscript/excel.js"></script>
    <script src="../../../../res/jscript/xwf.css.js"></script>
    <style type="text/css">
        body {
            overflow: hidden;
            margin: 3px 3px 3px 5px;
        }

        #divToolbar {
            margin-bottom: 8px;
        }

        #tbLayout {
            margin-top: 5px;
            border-collapse: collapse;
        }
        .tdLayout {
            padding: 0px;
            vertical-align: top;
        }

        #divTree {
            overflow: auto;
            border-top: 1px solid #c0c0c0;
            border-left: 1px solid #c0c0c0;
            border-bottom: 1px solid #c0c0c0;
        }
        #divGrid {
            overflow: auto;
            border: 1px solid #c0c0c0;
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <div id="divToolbar"></div>
    <table id="tbLayout">
        <tr>
            <td class="tdLayout" id="tdLayoutLeft"><div id="divTree">divTree</div></td>
            <td class="tdLayout"><div id="divGrid">divGrid</div></td>
        </tr>
    </table>
</body>
</html>
<!-- 模块变量定义 -->
<script>
    var reportKey = "";
    var filterReport = "", filterUser = "", filterTree = "";
    var blCompactMode = false;

    var aXls = gId("aXls");
    var divToolbar = gId("divToolbar");
    var divTree = gId("divTree");
    var divGrid = gId("divGrid");
    var treeNav = null;
    var toolbar = null;

    var winConfig = null, winFilter = null;
    var jsonConfig = {
        reportValue: "",
        reportColumnValue: "",
        reportFilter: ""
    };
    var jsonConfigHTML = {
        reportValue: "",
        reportColumnValue: "",
        reportFilter: ""
    };

    var dtbReport = null;
    var dtbReportColumn = null;
    var arrRG = new Array();
</script>
<!-- formLoad -->
<script>
    function formLoad() {
        reportKey = win.para.reportKey;
        if (!win.para.reportFilter) win.para.reportFilter = "";

        initToolbar();
        initConfig();
        initTree();

        if (g.debug || g.local || topWin.isDeveloper) {
        }
        else {
            toolbar.Bars["btnDesign"].setVisible(false);
        }
    }
    function formResize() {
        var width = win.p.width - 11;
        var height = win.p.height - divToolbar.offsetHeight - 18;
        var treeWidth = width * 0.2;

        divTree.style.height = height + "px";
        divGrid.style.height = (height) + "px";

        if (arrRG.length <= 1) {
            treeNav = null;
            toolbar.setBarVisible("compactMode", false);

            gId("tdLayoutLeft").style.display = "none";
            divGrid.style.width = (width - 5) + "px";
        }
        else {
            gId("tdLayoutLeft").style.display = "";
            if (treeWidth < 150) treeWidth = 150;
            if (treeWidth > 300) treeWidth = 300;
            divTree.style.width = treeWidth + "px";
            divGrid.style.width = (width - divTree.offsetWidth - 1) + "px";
        }
    }

    function initTree() {
        formResize();
        toolbar.Bars["xls"].setVisible(false);

        if (arrRG.length == 0) {
            divGrid.innerHTML = "<div class='noData'>报表至少需要配置一列行分组字段。</div>";          
            return;
        }
        else if (arrRG.length == 1) {
            exportReportHtml();
            return;
        }
        // ------------------------------------------------
        var jsonPara = {
            divContainer: divTree,
            imgPath: "../../../../res/control/tree/" + top.cssStyle + "/",
            title: "报表导航",
            beforeExpand: beforeNodeExpand,
            nodeClick: nodeClick
        };
        treeNav = new window.xwf_tree(jsonPara);
        treeNav.addNode({ key: "0" + treeNav.sd + "R", text: "全部" });
        treeNav.addNode({ key: "0" + treeNav.sd + "R" + treeNav.sd + "loading", text: "loading..." });
        treeNav.expand("0" + treeNav.sd + "R");
        treeNav.textClick("0" + treeNav.sd + "R");
    }
</script>

<!-- 工具栏 (刷新、筛选、导出、配置、设计) -->
<script>
    function initToolbar() {
        var json = {
            domContainer: divToolbar,
            height: "M",
            onclick: onBarClick
        };

        toolbar = new window.xwf_toolbar(json);

        toolbar.addBar({ type: "button", key: "refresh", text: "<i class='fa fa-refresh'></i> 刷新", style: "Grid" });
        toolbar.addBar({ type: "button", key: "rilter", text: "<i class='fa fa-filter'></i> 筛选", style: "Grid" });
        toolbar.addBar({ type: "button", key: "exportA", text: "<i class='fa fa-arrow-up'></i> 导出全部", style: "Grid" });
        toolbar.addBar({ type: "alink", key: "xls", text: "<i class='fa fa-file-excel-o'></i> Excel", title: "右键点击图标，选择“目标另存为..." });
        toolbar.addBar({ type: "button", key: "exportG", text: "<i class='fa fa-share'></i> 导出网格", style: "Grid" });

        //toolbar.addBar({ type: "checkbox", key: "compactMode", text: "紧凑模式" });
        toolbar.addBar({ type: "button", key: "config", text: "<i class='fa fa-gear'></i> 配置", style: "Grid" });
        toolbar.addBar({ type: "button", key: "design", text: "<i class='fa fa-plus'></i> 设计", style: "Grid" });
        toolbar.addBar({ type: "button", key: "close", align: "left", icon: null, text: "<i class='fa fa-close'></i>  关闭", style: "Grid" });
    }
    function onBarClick(para) {
        var btnKey = para.key;
        if (btnKey.equals("refresh")) {
            filterUser = "";
            initTree();
        }
        else if (btnKey.equals("rilter")) {
            showFilterForm();
        }
        else if (btnKey.equals("exportA")) {
            exportReportXls(jsonConfig);
        }
        else if (btnKey.equals("exportG")) {
            exportReportXls(jsonConfigHTML);
        }
        else if (btnKey.equals("xls")) {
            openExcel(para.url);
        }
        else if (btnKey.equals("compactMode")) {
            blCompactMode = para.checked;

            if (treeNav) {
                treeNav.nodeClick(treeNav.selectedNode);
            }
            else {
                // -- 此时紧凑模式和非紧凑模式结果一样 --
            }
        }
        else if (btnKey.equals("config")) {
            showConfigForm();
        }
        else if (btnKey.equals("design")) {
            showDesignForm();
        }
        else if (btnKey.equals("close")) {
            win.close();
        }
        else {
            showErr("unknown button " + para.key);
        }
    }

    function initConfig() {
        if (g.a.send("processType=com.xznext.report.ReportAid&actionType=getReportConfig", { reportKey: reportKey }, true)) {
            if (g.a.OK) {
                dtbReport = g.a.cReturn.dtbReport;
                dtbReportColumn = g.a.cReturn.dtbReportColumn;

                if (dtbReport.rowCount == 0) {
                    showErr("报表[reportKey = " + reportKey + "]不存在, 请检查.");
                    divGrid.innerHTML = "<div class='noData'>报表 [" + reportKey + "] 不存在, 请检查.</div>";
                    toolbar.Bars["xls"].setVisible(false);
                    return;
                }
                jsonConfig.reportValue = dtbReport.rows[0]["report_key"].value + "," + dtbReport.rows[0]["report_type"].value + ","
                    + dtbReport.rows[0]["report_sum_count"].value;
                var arr = new Array();
                for (var iRow = 0; iRow < dtbReportColumn.rowCount; iRow++) {
                    arr.push(dtbReportColumn.rows[iRow]["report_column_key"].value + "," + dtbReportColumn.rows[iRow]["rc_rdc"].value + ","
                        + dtbReportColumn.rows[iRow]["rc_index"].value + "," + dtbReportColumn.rows[iRow]["rc_selected"].value + ","
                        + dtbReportColumn.rows[iRow]["rc_formula_col_count"].value);
                    if (dtbReportColumn.rows[iRow]["rc_rdc"].value.equals("R") && dtbReportColumn.rows[iRow]["rc_selected"].value == 1) {
                        arrRG.push({
                            fieldName: dtbReportColumn.rows[iRow]["report_column_key"].value
                        });
                    }
                }
                jsonConfig.reportColumnValue = arr.join(";");
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
    function showConfigForm() {
        var prop = {
            url: g.appPath + "project/xpas/html/report/report_config.html",
            text: "报表配置",
            title: "报表配置 - " + reportKey,
            parent: win,
            modal: true
        };
        var para = {
            reportKey: reportKey,
            callback: doConfigOK
        };
        if (winConfig == null) {
            winConfig = topWin.openWindow(prop, para);
        }
        else {
            winConfig.show();
        }
    }
    function doConfigOK(_jsonConfig, _arrRG) {
        jsonConfig = _jsonConfig;
        arrRG = _arrRG;
        initTree();
    }

    function showFilterForm() {
        if (winFilter) {
            winFilter.show();
            return;
        }

        var prop = {
            url: "project/xpas/html/frame/uview_filter.html",
            title: "报表数据筛选条件设定界面",
            parent: win,
            modal: true
        }
        var para = {
            filterType: "report",
            reportKey: reportKey,
            callback: doFilterOK
        };
        winFilter = topWin.openWindow(prop, para);
    }
    function doFilterOK(_filterUser) {
        filterUser = _filterUser;
        initTree();
    }

    function showDesignForm() {
        var prop = {
            url: g.appPath + "project/xpas/html/report/report.html",
            parent: win,
            modal: true
        };
        var para = {
            viewKey: "fv_report",
            primaryKey: "report_key," + reportKey,
            flowKey: ""
        };
        topWin.openWindow(prop, para);
    }
</script>

<!-- 报表条件 -->
<script>
    function getConfigHTML() {
        var arrCV = jsonConfig.reportColumnValue.split(";");
        // ------------------------------------------------
        for (var i = 0; i < arrCV.length; i++) {
            var arr = arrCV[i].split(",");
            if (!arr[1].equals("R")) break;

            if (blCompactMode) {
                if (arr[0].equals(arrRG.length == 1 ? arrRG[0].fieldName : arrRG[treeNav.selectedNode.level - 1].fieldName)) {
                    arr[3] = "1";
                }
                else {
                    arr[3] = "0";
                }
            }
            else {
                if (treeNav) {
                    if (i > treeNav.selectedNode.level - 1) {
                        arr[3] = "0";
                    }
                }
            }
            arrCV[i] = arr.join(",");
        }
        // ------------------------------------------------
        jsonConfigHTML.reportValue = jsonConfig.reportValue;
        jsonConfigHTML.reportColumnValue = arrCV.join(";");
    }

    function getReportFilter() {
        filterReport = "";
        if (!win.para.reportFilter.equals("")) filterReport = " AND " + win.para.reportFilter;
        filterTree = treeNav ? getNodeFilter(treeNav.selectedNode) : "";

        if (!filterTree.equals("")) filterReport += " AND " + filterTree;
        if (!filterUser.equals("")) filterReport += " AND " + filterUser;

        if (!filterReport.equals("")) filterReport = filterReport.substring(5);
        // ------------------------------------------------
        jsonConfig.reportFilter = filterReport;
        jsonConfigHTML.reportFilter = filterReport;
    }
    function getNodeFilter(node) {
        // -- 返回指定节点的限定条件 --
        var strFilter = "";
        while (node.level > 1) {
            strFilter += " AND " + arrRG[node.level - 2].fieldName + " = '" + node.para.columnValue + "'";
            node = node.parent;
        }
        if (!strFilter.equals("")) strFilter = strFilter.substring(5);
        return strFilter;
    }
</script>
<!-- 输出Html预览 -->
<script>
    function beforeNodeExpand(node, firstExpand) {
        if (!firstExpand) return;
        treeNav.removeNode(node.key + treeNav.sd + "loading");
        // ------------------------------------------------
        var nodeFilter = getNodeFilter(node);
        var jsonPara = {
            columnName: arrRG[node.level - 1].fieldName,
            reportFilter: ""
        };
        if (nodeFilter) jsonPara.reportFilter += " AND " + getNodeFilter(node);
        if (filterUser) jsonPara.reportFilter += " AND " + filterUser;
        if (jsonPara.reportFilter) jsonPara.reportFilter = jsonPara.reportFilter.substring(5);
        jsonPara.reportKey = reportKey;
        // ------------------------------------------------
        if (g.a.send("processType=com.xznext.report.ReportView&actionType=getTreeNodes", jsonPara, true)) {
            if (g.a.OK) {
                var dtbNodes = g.a.cReturn.dtbNodes;
                for (var i = 0; i < dtbNodes.rowCount; i++) {
                    treeNav.addNode({
                        key: node.key + treeNav.sd + dtbNodes.rows[i][0].value,
                        text: dtbNodes.rows[i][0].value,
                        para: {
                            columnValue: dtbNodes.rows[i][0].value
                        }
                    });
                    if (node.level + 1 < arrRG.length) {
                        treeNav.addNode({
                            key: node.key + treeNav.sd + dtbNodes.rows[i][0].value + treeNav.sd + "loading",
                            text: "loading..."
                        });
                    }
                }
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
    function nodeClick(node) {
        if (node.level > 1) {
            var strNavFilter = "";
            var nodeF = node;
            while (nodeF.level > 1) {
                strNavFilter += " AND " + arrRG[nodeF.level - 2].fieldName + " = '" + nodeF.para.columnValue + "'";
                nodeF = nodeF.parent;
            }
            strNavFilter = strNavFilter.substring(5);
            jsonConfig.navFilter = strNavFilter;
        }
        exportReportHtml();
    }

    function exportReportHtml() {
        getConfigHTML();
        getReportFilter();
        jsonConfigHTML.reportKey = reportKey;
        if (g.a.send("processType=com.xznext.report.ReportView&actionType=exportReportHtml", jsonConfigHTML, true)) {
            if (g.a.OK) {
                var reportHtml = g.a.cReturn.reportHtml;
                divGrid.innerHTML = reportHtml;
                toolbar.Bars["xls"].setVisible(false);
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>
<!-- 输出Excel报表 -->
<script>
    function exportReportXls(reportConfig) {
        getReportFilter();
        reportConfig.reportKey = reportKey;
        if (g.a.send("processType=com.xznext.report.ReportView&actionType=exportReportXls", reportConfig, true)) {
            if (g.a.OK) {
                var fileName = g.a.cReturn.fileName;
                var urlXls = g.xpasRunPath + "report/" + fileName;
                var barXls = toolbar.Bars["xls"];

                barXls.setUrl(urlXls);
                barXls.setVisible(true);

                openExcel(urlXls);
            }
            else {
                return false;
            }
        }
        else {
            return false;
        }
    }
</script>