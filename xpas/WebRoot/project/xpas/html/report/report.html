<!DOCTYPE html>
<html>
<head>
    <title>报表管理</title>
	<script src="../../../../res/jscript/xwf.js" type="text/javascript"></script>
	<script src="../../../../res/jscript/xwf.ajax.js" type="text/javascript"></script>	
	<script src="../../../../res/jscript/xwf.const.js" type="text/javascript"></script>

	<script src="../../../../res/control/uvform/xwf.uvform.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.grid.js" type="text/javascript"></script>
	<script src="../../../../res/control/grid/xwf.gridview.js" type="text/javascript"></script>

	<script src="../../../../res/jscript/xwf.css.js" type="text/javascript"></script>
	<script src="../../js/xtfs.js" type="text/javascript"></script>

	<style type="text/css">
	    body {
			overflow: hidden;
		}
	</style>
</head>
<body>
	<div id="divDC"></div>
	<form id="frm" action="" target="com.xznext.report.Report">
		<div id="divTab" class="xwf_tab_divContainer" style="width:877px;">
			<table id="tbForm" class="tbForm" style="width:877px;">
				<tr class="trH">
					<th style="width:120px;"></th>
					<th style="width:170px;"></th>
					<th style="width:120px;"></th>
					<th style="width:170px;"></th>
					<th style="width:120px;"></th>
					<th style="width:170px;"></th>
				</tr>
				<tr>
					<td>报表标识：</td>
					<td><input id="_cREPORT_KEY" type="text" value="" /></td>
					<td>数据库标识：</td>
					<td><input id="_cDatabase_Key" type="text" controlType="dropdown" fieldValue="database_key" fieldText="database_text" visibleSearch="false" /></td>
					<td>默认纸张：</td>
					<td><input id="_cReport_Paper_Type" type="text" controlType="dropdown" fieldValue="paperType" fieldText="paperName" dataSource="[['paperType','paperName'],['A4','A4'],['A4-','A4横向'],['A3','A3'],['A3-','A3横向']]" visibleSearch="false" /></td>
				</tr>
				<tr>
					<td>报表标题：</td>
					<td colspan="3"><input id="_cReport_Title" type="text" value="" /></td>
					<td>报表脚注：</td>
					<td><input id="_cReport_Bottom" type="text" value="" /></td>							
				</tr>
				<tr>
					<td>子系统：</td>
					<td><input id="_cSystem_Key" type="text" controlType="dropdown" fieldValue="system_key" fieldText="system_text" visibleSearch="false" /></td>
					<!--
						<td>数据源类型：</td>
						<td><select id="_cReport_Data_Source_Type">
							<option value="sql">SQL语句</option>
							<option value="st_view">数据视图</option>
						</select></td>
					-->
					<td>报表类型：</td>
					<td><input id="_cReport_Type" type="text" controlType="dropdown" fieldValue="reportType" fieldText="reportTypeName" dataSource="[['reportType','reportTypeName'],[1,'汇总报表'],[2,'图表'],[3,'报表简单']]" visibleSearch="false" /></td>
					<td>合计层数：</td>
					<td><input id="_cReport_Sum_Count" type="text" controlType="dropdown" fieldValue="sumCount" fieldText="sumCountName" dataSource="[['sumCount','sumCountName'],[-1,'无合计'],[0,'仅总计'],[1,'一层合计'],[2,'二层合计'],[3,'三层合计']]" visibleSearch="false" /></td>
				</tr>
				<tr>
					<td>数据源：</td>
					<td colspan="5"><textarea id="_cReport_Data_Source" rows=10 cols="0"></textarea></td>
				</tr>
				<tr>
					<td>图表X轴SQL：</td>
					<td colspan="5"><textarea id="_cechart_xaxis" rows="5"  cols="0"  placeholder="类型为图表时必填"></textarea></td>
				</tr>
				<tr>
					<td>图表系列SQL：</td>
					<td colspan="5"><textarea id="_cechart_series_name" rows="5"  cols="0" placeholder="类型为图表时必填"></textarea></td>
				</tr>
				<tr>
					<td>备注：</td>
					<td colspan="5"><textarea id="_cReport_Remark" rows="5" cols="0"></textarea></td>
				</tr> 
			</table>
			<div id="divGridF" style="display:none"></div>
		</div>
	</form>
</body>
</html>

<!-- formLoad -->
<script type="text/javascript">
	var tabs = null;
	var gridviewF = null;	
	// ----------------------------------------------------
	function formLoad() {
		vf.addExtraButton({ key: "preview", text: "预览(P)" });
		vf.addExtraButton({ key: "xTFS", text: "xTFS" });
		vf.css(gId("tbForm"));

		tabs = new window.xwf_tab({ divContainer: gId("divTab"), tabClick: tab_click });
		tabs.addTab({ key: "tabB", text: "基本信息", control: gId("tbForm") });
		tabs.addTab({ key: "tabF", text: "报表字段", control: gId("divGridF") });
	}

	function tab_click(tab) {
		if (tab.key == "tabF") {
			if (gridviewF == null) {
				var prop = {
					divContainer: gId("divGridF"),
					viewKey: "fv_report_field",
					viewFilter: "report_key = '" + frm._cREPORT_KEY.value + "'",
					viewForm: "project/xpas/html/report/report_field.html"
				};
				gridviewF = new window.xwf_gridview(prop);
				gridviewF.beforeAddnew = function () {
					if (!vf.status.equals("view")) {
						showWarn("当前状态不允许添加明细记录。");
						return false;
					}
					return true;
				}
			}
			else {
				gridviewF.setViewFilter("report_key = '" + frm._cREPORT_KEY.value + "'");
			}
		}
		return true;
	}
</script>
<!-- uviewForm -->
<script type="text/javascript">
	vf.afterAddnew = function () {
		//frm._cReport_Data_Source_Type.value = "sql";
		frm._cReport_Type.setValue(1);
		frm._cReport_Sum_Count.value = "0";
		frm._cReport_Paper_Type.value = "A4";
		frm._cREPORT_KEY.focus();
	}

	vf.beforeSave = function () {
		// -- xTFS：判断是否已签出 ------------------------
		if (g.a.send("processType=com.xtfs.XtfsCore&actionType=getMDataStatus", { mdataType: "report", mdataKey: frm._cREPORT_KEY.value }, true)) {
			if (g.a.OK) {
				var cReturn = g.a.cReturn;
				if (!cReturn.newMData && !cReturn.myCheckout) {
					showWarn("主数据尚未签出，同步xTFS时修改会丢失，请谨慎操作。");
				}
			}
		}
		// ------------------------------------------------
		return true;
	}

	vf.afterMove = function () {
		tab_click(tabs.tabSelected);
	}

	vf.beforeClick = function (prop) {
		if (prop.buttonKey.equals("preview")) {
			var jsonProp = {
				url: g.appPath + "project/xpas/html/report/reportview.html",
				text: "报表预览",
				title: "报表预览 - " + gId("_cReport_Title").value
			};
			var jsonPara = {
				reportKey: gId("_cREPORT_KEY").value
			};
			topWin.openFullWindow(jsonProp, jsonPara);
		}
		else if (prop.buttonKey.equals("xTFS")) {
			var jsonPara = {
				mdataType: "report",
				mdataKeys: "'" + frm._cREPORT_KEY.value + "'",
				objDom: prop.button
			}
			xTFS.openMenu(jsonPara);
		}
		return false;
	}
</script>