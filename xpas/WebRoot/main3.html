<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>xPas (eXtensible programer assist system - xpas-next.com)</title>
    <script type="text/javascript">
        var cssStyle = "style3";
    </script>
    <link rel="stylesheet" href="res_plugin/zui-1.8.1-dist/css/zui.min.css" />
    <script src="res_plugin/zui-1.8.1-dist/lib/jquery/jquery.js"></script>
    <script src="res_plugin/zui-1.8.1-dist/js/zui.js"></script>
    <!-- <script src="res_plugin/zui-1.8.1-dist/js/zui.min.js"></script> -->
    <!-- 基础类 -->
    <script src="project/xpas/js/xwf.js"></script>
    <!-- <script src="res/jscript/xwf.js" type="text/javascript"></script> -->
    <script src="res/jscript/xwf.ajax.js" type="text/javascript"></script>
    <script src="res/jscript/xwf.const.js" type="text/javascript"></script>
    <!-- UI控件类 -->
    <script src="res/jscript/xwf.ui.js" type="text/javascript"></script>
    <script src="res/control/menu/xwf.menu.js" type="text/javascript"></script>
    <script src="res/control/window/xwf.window.js" type="text/javascript"></script>
    <script src="res/control/context/xwf.context.js" type="text/javascript"></script>
    <script src="res/control/taskbar/xwf.taskbar.js" type="text/javascript"></script>
    <script src="res/control/statusbar/xwf.statusbar.js" type="text/javascript"></script>
    <script src="res/control/dropgrid/xwf.dropgrid.js" type="text/javascript"></script>
    <script src="res/jscript/xwf.css.js" type="text/javascript"></script>
    <!-- 主界面js -->
    <script src="res/jscript/xwf.main.js" type="text/javascript"></script>
    <style>
        *,
         :after,
         :before {
            -webkit-box-sizing: content-box;
            -moz-box-sizing: content-box;
            box-sizing: content-box;
        }
        
        html,
        body {
            position: relative;
        }
        
        #tbLayout>tbody>tr {
            display: flex;
        }
        
        .preview-box {
            display: none;
            z-index: 99999;
            overflow: hidden;
        }
        
        .preview-box {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background: rgba(0, 0, 0, .5);
        }
        
        .carousel.slide,
        .carousel .carousel-inner,
        .carousel-inner>.item {
            height: 100%;
        }
        
        .carousel-indicators {
            margin-bottom: 0;
        }
        
        .carousel-indicators li,
        .carousel-indicators .active {
            margin-right: 8px;
        }
        
        .carousel-inner .item {
            overflow: auto;
            text-align: center;
            line-height: 70;
        }
        
        .carousel-inner>.item>img {
            display: inline-block;
            max-width: 75%;
            max-height: 80%;
        }
        
        .carousel-menu-box {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            height: 70px;
            background: #3280FC;
            text-align: right;
        }
        
        .carousel-menu-box .icon {
            display: inline-block;
            width: 50px;
            height: 50px;
            line-height: 50px;
            margin-top: 10px;
            color: #fff;
            font-size: 27px;
            cursor: pointer;
            text-align: center;
        }
        
        .carousel-menu-box .icon:hover {
            color: #E5E5E5;
        }
    </style>
</head>

<body onload="main();" scroll="no">
    <table id="tbTop">
        <tr>
            <td id="tdTopLeft"></td>
            <td id="tdProjectName"></td>
            <td id="tdTopRight">
                <table id="tbImages">
                    <tr>
                        <td><img id="imgSubSystem" src="res/images/frame/sub_system.png" onclick="showSubSystem(this);" alt="" title="切换子系统" /></td>
                        <td><img id="imgUser" src="res/images/frame/user.png" onclick="showUserCenter(this);" alt="" title="用户中心" /></td>
                        <td><img id="imgMessage" src="res/images/frame/msg0.png" onclick="showMessage('测试消息');" alt="" title="消息中心" /></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <table id="tbLayout">
        <tr>
            <td id="tdMenu" class="tdLayout">
                <div id="divMenu" style="width:200px;"></div>
            </td>
            <td class="tdLayout">
                <div id="divTaskbar" class="xwf_taskbarBG"></div>
                <div id="divContainer">
                    <iframe id="ifrBack" frameborder="0" style="border:0px"></iframe>
                </div>
                <div id="divStatus"></div>
            </td>
        </tr>
    </table>
    <!-- 图片预览模块 -->
    <div id="preview-box" class="preview-box"></div>
</body>

</html>

<!-- 模块变量定义 -->
<script type="text/javascript">
    var lastSystemIndex = 0; // -- 末次选中的子系统下标 --

    var tbTop = gId("tbTop");
    var divTaskbar = gId("divTaskbar");
    var divContainer = gId("divContainer");
    var ifrBack = gId("ifrBack");
    var tbStatus = gId("tbStatus");
    var divStatus = gId("divStatus");

    var dtbSystem = new window.xwf_datatable();
    var dtbMenu = new window.xwf_datatable();

    var cMenu = null;
    var taskbar = new window.xwf_taskbar();
</script>
<!-- Form_Load() -->
<script type="text/javascript">
    // ------------------------------------------------------------------------
    function main() {
        if (window.opener != null) {
            try {
                var openerWindow = window.opener.window;
                openerWindow.opener = null;
                if (g.b.ie) {
                    openerWindow.open("", "_self");
                }
                else {
                    openerWindow.open("about:blank", "_self");
                }
                openerWindow.close();
            } catch (e) {
                // -- debug(e.message);
            }
        }
        //-- 初始化任务栏 ---------------------------------
        var jsonProp = {
            divContainer: gId("divTaskbar"),
            barSelect: barSelect,
            barClose: barClose
        };
        taskbar = new window.xwf_taskbar(jsonProp);
        initStatusBar();
        //-- 初始化背景 -----------------------------------
        formResize();
        //-- 初始化窗口类 ---------------------------------
        var jsonProp = {
            zIndex: 30000,
            taskbar: taskbar,
            rangeContainer: ifrBack
        };
        topWin.cWin = new window.xwf_window(jsonProp);

        topWin.dropgrid = new window.xwf_dropgrid({
            topDoc: document
        });
        topWin.context = new window.xwf_context({
            menuClick: null
        });

        //-------------------------------------------------
        if (!initSystem()) return;

        topWin.cStatusBar.setValue("user", topWin.userKey);
        topWin.cStatusBar.tbLayout.style.width = ifrBack.clientWidth + 'px';

        adjustImageSizeByMouseWheel();
    }

    function formResize() {
        var nHeight = document.documentElement.clientHeight - tbTop.offsetHeight - divContainer.offsetTop;
        if (divStatus.style.display.equals("")) {
            nHeight = nHeight - divStatus.offsetHeight;
        }
        divContainer.style.height = nHeight + "px";

        ifrBack.style.height = (divContainer.clientHeight - 0) + "px";
        ifrBack.style.width = (document.documentElement.clientWidth - gId('tdMenu').clientWidth) + "px";
        // ifrBack.style.width = (divContainer.clientWidth - 0) + "px";
    }


    var transformOpt = {
        scaleSize: 1, // 图片初始化缩放比例
        xSize: 0, // 图片 x 轴移动距离
        ySize: 0, // 图片 y 轴移动距离
        rotateDegree: 0 // 旋转角度
    };

    // 图片预览鼠标滚轮调整图片大小 
    function adjustImageSizeByMouseWheel() {
        var scrollFunc = function(e) {
            e = e || window.event; // e 代表事件（event）对象，即所谓的事件驱动源
            var display = gId('preview-box').style.display;
            if (display == 'block') {
                // 鼠标滚轮滚动时，判断图片预览是否显示，如果显示则缩放图片大小
                if (e.wheelDelta) { //判断浏览器IE，谷歌滑轮事件 
                    if (e.wheelDelta > 0) {
                        // 鼠标滚轮向上滚动
                        if (transformOpt.scaleSize >= 3) {
                            transformOpt.scaleSize = 3;
                        } else {
                            transformOpt.scaleSize += 0.1;
                        }

                    } else if (e.wheelDelta < 0) {
                        // 鼠标滚轮向下滚动
                        if (transformOpt.scaleSize <= 0.1) {
                            transformOpt.scaleSize = 0.1;
                        } else {
                            transformOpt.scaleSize -= 0.1;
                        }
                    }

                } else if (e.detail) { //Firefox滑轮事件
                    if (e.detail > 0) {
                        // 鼠标滚轮向下滚动
                        if (transformOpt.scaleSize <= 0.1) {
                            transformOpt.scaleSize = 0.1;
                        } else {
                            transformOpt.scaleSize -= 0.1;
                        }
                    } else if (e.detail < 0) {
                        // 鼠标滚轮向上滚动
                        if (transformOpt.scaleSize >= 3) {
                            transformOpt.scaleSize = 3;
                        } else {
                            transformOpt.scaleSize += 0.1;
                        }
                    }
                }
                $('.item.active').find('img').css({
                    'transform': 'matrix(' + transformOpt.scaleSize + ', 0, 0, ' + transformOpt.scaleSize + ',' + transformOpt.xSize + ',' + transformOpt.ySize + ') rotate(' + transformOpt.rotateDegree + 'deg)'
                });
            } else {
                return false;
            }
        };
        if (window.addEventListener) { // 检测 Firefox
            window.addEventListener('DOMMouseScroll', scrollFunc, false);
        }

        window.onmousewheel = scrollFunc;
    };

    // 图片预览时右移
    function removeRightCarousel() {
        transformOpt.xSize += 50;
        $('.item.active').find('img').css({
            'transform': 'matrix(' + transformOpt.scaleSize + ', 0, 0, ' + transformOpt.scaleSize + ',' + transformOpt.xSize + ',' + transformOpt.ySize + ') rotate(' + transformOpt.rotateDegree + 'deg)'
        });
    }

    // 图片预览时下移
    function removeDownCarousel() {
        transformOpt.ySize += 50;
        $('.item.active').find('img').css({
            'transform': 'matrix(' + transformOpt.scaleSize + ', 0, 0, ' + transformOpt.scaleSize + ',' + transformOpt.xSize + ',' + transformOpt.ySize + ') rotate(' + transformOpt.rotateDegree + 'deg)'
        });
    }

    // 图片预览时左移
    function removeLeftCarousel() {
        transformOpt.xSize -= 50;
        $('.item.active').find('img').css({
            'transform': 'matrix(' + transformOpt.scaleSize + ', 0, 0, ' + transformOpt.scaleSize + ',' + transformOpt.xSize + ',' + transformOpt.ySize + ') rotate(' + transformOpt.rotateDegree + 'deg)'
        });
    }

    // 图片预览时右移
    function removeUpCarousel() {
        transformOpt.ySize -= 50;
        $('.item.active').find('img').css({
            'transform': 'matrix(' + transformOpt.scaleSize + ', 0, 0, ' + transformOpt.scaleSize + ',' + transformOpt.xSize + ',' + transformOpt.ySize + ') rotate(' + transformOpt.rotateDegree + 'deg)'
        });
    }

    // 图片预览时旋转
    function rotateCarousel() {
        if (transformOpt.rotateDegree >= 360) {
            transformOpt.rotateDegree = 90;
        } else {
            transformOpt.rotateDegree += 90;
        }
        $('.item.active').find('img').css({
            'transform': 'matrix(' + transformOpt.scaleSize + ', 0, 0, ' + transformOpt.scaleSize + ',' + transformOpt.xSize + ',' + transformOpt.ySize + ') rotate(' + transformOpt.rotateDegree + 'deg)'
        });
    }

    // 图片预览下关闭预览页面
    function closeCarousel() {
        // 关闭图片预览时，重置样式
        gId('preview-box').style.display = 'none';
        gId('preview-box').innerHTML = '';
        transformOpt.scaleSize = 1;
        transformOpt.xSize = 0;
        transformOpt.ySize = 0;
        transformOpt.rotateDegree = 0;
    }

    // 图片切换时，重置图片样式和位置
    function resetCarousel() {
        transformOpt.scaleSize = 1;
        transformOpt.xSize = 0;
        transformOpt.ySize = 0;
        transformOpt.rotateDegree = 0;
        $('.item.active').find('img').css({
            'transform': 'matrix(' + transformOpt.scaleSize + ', 0, 0, ' + transformOpt.scaleSize + ',' + transformOpt.xSize + ',' + transformOpt.ySize + ') rotate(' + transformOpt.rotateDegree + 'deg)'
        });
    }
</script>

<!-- 子系统 -->
<script type="text/javascript">
    function initSystem() {
        var idx = 0;
        var arrNames = new Array();
        // ------------------------------------------------
        if (g.a.send("processType=com.xznext.Framework&actionType=getSystem", {}, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;
                dtbSystem = cReturn.dtbSystem;
                if (dtbSystem.rowCount == 0) {
                    alert("尚未为您分配系统访问权限，请与系统管理员联系。");
                    return false;
                }

                topWin.serverName = cReturn.serverName;

                topWin.eoId = cReturn.eoId;
                topWin.doId = cReturn.doId;
                topWin.office0Id = cReturn.office0Id;
                topWin.office0Name = cReturn.office0Name;
                topWin.office0Shortname = cReturn.office0Shortname;
                topWin.officeId = cReturn.officeId;
                topWin.officeName = cReturn.officeName;
                topWin.office1Id = cReturn.office1Id;
                topWin.office1Name = cReturn.office1Name;
                topWin.officeNodeKey = cReturn.officeNodeKey;
                topWin.officeLevel = cReturn.officeLevel;
                topWin.officeShortname = cReturn.officeShortname;

                topWin.userKey = cReturn.userKey;
                topWin.userName = cReturn.userName;
                topWin.nickname = cReturn.nickname;
                topWin.groupKeys = cReturn.groupKeys;
                topWin.isDeveloper = topWin.matchGroup("developers");
            } else {
                return false;
            }
        } else {
            return false;
        }
        // -- 初始化子系统 --------------------------------
        if (!getLocalItem("lastSystemIndex").equals("")) {
            lastSystemIndex = parseInt(getLocalItem("lastSystemIndex"));
            if (lastSystemIndex >= dtbSystem.rowCount) {
                lastSystemIndex = 0;
            }
        }
        systemClick(lastSystemIndex);
        // ------------------------------------------------
        return true;
    }

    function systemClick(subSystemIndex) {
        var systemKey = dtbSystem.rows[subSystemIndex]["system_key"].value;
        var systemName = dtbSystem.rows[subSystemIndex]["system_name"].value;

        //-- 关闭当前已打开的所有窗口及背景窗口 --
        while (topWin.cWin && topWin.cWin.arrWindows.length) {
            topWin.cWin.arrWindows[0].close();
        }
        //gId("divMessage").innerHTML = "";
        //gId("divMessage").onclick = null;

        //---------------------------------------------
        g.systemPath = g.appPath + "project/" + systemName + "/";
        initMenu(systemKey);

        if (systemName.equals("xpas")) {
            urlBackground = "./project/" + systemName + "/html/background.html";
        } else {
            if (urlPara.loginPath) {
                urlBackground = "./project/" + systemName + "/html/login/" + urlPara.loginPath + "/background.html";
            } else {
                urlBackground = "./project/" + systemName + "/html/background.html";
            }
        }
        ifrBack.src = urlBackground + "?rnd=" + Math.random();

        setLocalItem("lastSystemIndex", subSystemIndex);
        lastSystemIndex = subSystemIndex;
    }
</script>
<!-- 菜单 -->
<script type="text/javascript">
    function initMenu(systemKey) {
        // -- 1、初始化菜单控件 ---------------------------
        var cReturn = null;
        var prop = {
            zIndex: 60000,
            divContainer: divMenu,
            menuClick: menu_click
        };
        cMenu = new window.xwf_menu(prop);
        topWin.cMenu = cMenu;
        // -- 2、取菜单数据 -------------------------------
        if (g.a.send("processType=com.xznext.Framework&actionType=getMenu", {
                systemKey: systemKey,
                clientType: "PC"
            }, true)) {
            if (g.a.OK) {
                var cReturn = g.a.cReturn;

                dtbMenu = cReturn.dtbMenu;
                topWin.dtbMenu = dtbMenu;
                if (dtbMenu.rowCount == 0) {
                    //alert("尚未为您分配当前系统访问权限，请与系统管理员联系。");
                    return false;
                }
                // -- 获取子系统下传的数据 --
                for (var key in cReturn) {
                    if (key.equals("ok") || key.equals("dtbMenu")) continue;
                    topWin[key] = cReturn[key];
                }
            } else {
                return false;
            }
        } else {
            return false;
        }
        // -- 3、添加菜单 ---------------------------------
        for (var i = 0; i < dtbMenu.rowCount; i++) {
            var nodeKey = dtbMenu.rows[i]["node_key"].value;
            var nodeKeyParent = nodeKey.substring(0, nodeKey.length - 3);

            cMenu.addMenu({
                nodeKeyParent: nodeKeyParent,
                nodeKey: nodeKey,
                menuKey: dtbMenu.rows[i]["menu_key"].value,
                text: dtbMenu.rows[i]["menu_text"].value,
                icon: dtbMenu.rows[i]["menu_icon"].value,
                level: nodeKey.length / 3 - 1,
                drMenu: dtbMenu.rows[i]
            });
        }
    }

    var i = 0;

    function menu_click(jsonMenu, evt) {
        var drMenu = jsonMenu.drMenu;
        var menuType = drMenu["menu_type"].value;
        var menuLevel = drMenu["node_key"].value.length / 3 - 1;
        var windowState = (drMenu["menu_window_maximized"].value ? "maximized" : ""); // -- vf窗口是否全屏 --
        var vfAllowAddnew = drMenu["menu_uview_addnew"].value;
        // ------------------------------------------------
        if (evt.ctrlKey || evt.altKey) {
            menuRightClick(drMenu["menu_key"].value, drMenu["menu_text"].value, (evt.ctrlKey ? "ctrl" : "alt"));
            return false;
        }
        if (drMenu["menu_onlyone"].value == 1) {
            if (jsonMenu.opened && jsonMenu.win) {
                jsonMenu.win.bar.flashBar("");
                return;
            }
            jsonMenu.opened = true;
        }
        // ------------------------------------------------
        if (menuType.equals("uview")) {
            var prop = {
                menu: jsonMenu,
                text: drMenu["menu_text"].value,
                title: "视图窗口：" + drMenu["menu_text"].value
            };
            var para = {
                viewKey: drMenu["menu_type_value"].value,
                viewForm: g.appPath + "project/" + drMenu["menu_url"].value,
                viewFormTarget: drMenu["view_form_target"].value,
                viewFilter: drMenu.menu_parameter.value,
                filterFirst: drMenu["menu_filter_first"].value,
                filterMust: drMenu["menu_filter_must"].value,
                flowKey: drMenu["flow_key"].value,
                flowTextMenu: drMenu["flow_text_menu"].value,
                vfWindowState: windowState,
                vfAllowAddnew: (vfAllowAddnew == 0 ? undefined : (vfAllowAddnew == 1))
            };
            topWin.openTopView(prop, para);
        } else if (menuType.equals("report")) {
            var prop = {
                menu: jsonMenu,
                text: drMenu["menu_text"].value,
                title: "报表窗口：" + drMenu["menu_text"].value
            };
            var para = {
                reportKey: drMenu["menu_type_value"].value,
                reportFilter: drMenu.menu_parameter.value
            };
            topWin.openReport(prop, para);
        } else if (menuType.equals("window")) {
            var prop = {
                menu: jsonMenu,
                text: drMenu["menu_text"].value,
                url: g.appPath + "project/" + drMenu["menu_url"].value
            };
            var para = {};
            if (windowState.equals("maximized")) {
                prop.windowState = "maximized";
                prop.noTitle = true;
            }
            topWin.openWindow(prop, para);
        } else if (menuType.equals("single")) {
            var url = g.appPath + "project/" + drMenu["menu_url"].value;
            var properties = "channelmode=1,resizable=1";
            if (!g.b.ie) {
                properties = "channelmode=1,width=" + (screen.availWidth - 10) + ",height=" + (screen.availHeight - 52) + ",left=0,top=0,resizable=1";
            }
            window.open(url, "", properties);
        } else if (menuType.equals("click")) {
            alert("main3.html页面代码：\n菜单 " + drMenu["menu_key"].value + " (" + drMenu["menu_text"].value + ") Click.");
        } else {
            if (menuLevel == 3) {
                alert("unknown menu type [" + menuType + "].");
            }
        }
        return true;
    }

    function menuRightClick(menuKey, menuText, ctrlAlt) {
        if (g.debug || g.local || topWin.isDeveloper) {
            if (ctrlAlt.equals("ctrl")) {
                var prop = {
                    title: "菜单：" + menuText,
                    url: g.appPath + "project/xpas/html/frame/menu.html"
                };
                var para = {
                    flowKey: "",
                    viewKey: "fv_menu",
                    primaryKey: "menu_key," + menuKey,
                    allowModify: true
                };
                topWin.openWindow(prop, para);
            } else {
                topWin.openTopView({
                    text: "菜单管理"
                }, {
                    viewKey: "fv_menu",
                    flowKey: "",
                    viewForm: g.appPath + "project/xpas/html/frame/menu.html"
                });
            }
        }
    }
</script>
<!-- 任务栏 -->
<script type="text/javascript">
    function barSelect(bar) {
        return true;
    }

    function barClose(bar) {
        return true;
    }
</script>
<!-- 状态栏 -->
<script type="text/javascript">
    function initStatusBar() {
        var json = {
            domContainer: divStatus,
            height: "M",
            onclick: null
        };
        var statusBar = new window.xwf_statusbar(json);

        statusBar.addBar({
            type: "text",
            key: "user",
            width: 80
        });
        statusBar.addBar({
            type: "text",
            key: "date",
            width: 75,
            text: (new Date()).toString()
        });

        topWin.cStatusBar = statusBar;
    }

    var nTimes = 0;
    var statusText = "";

    function showStatus(strStatus, blFlash) {
        statusText = strStatus;
        divStatus.innerHTML = statusText;
        if (blFlash == undefined || blFlash) {
            setTimeout("statusFlash();", 100);
        }
    }

    function statusFlash() {
        if (nTimes++ > 10) {
            nTimes = 0;
            divStatus.className = "status";
            return;
        }
        divStatus.className = "status" + (nTimes % 2);
        setTimeout("statusFlash();", 100 * nTimes);
    }
</script>

<!-- 子系统、用户中心 -->
<script type="text/javascript">
    function showSubSystem(objDom) {
        var imgPath = "/xpas/res/control/context/" + top.cssStyle + "/";
        var arrMenus = new Array();
        // ------------------------------------------------
        for (var i = 0; i < dtbSystem.rowCount; i++) {
            var systemKey = dtbSystem.rows[i]["system_key"].value;
            var systemText = dtbSystem.rows[i]["system_text"].value;
            var systemImage = "";
            if (i == lastSystemIndex) {
                systemImage = imgPath + "check.png";
            }
            arrMenus.push({
                key: systemKey,
                text: systemText,
                image: systemImage,
                title: "单击切换子系统",
                subSystemIndex: i
            });
        }
        // ------------------------------------------------
        topWin.context.show({
            arrMenus: arrMenus,
            objDom: objDom,
            top: 14,
            left: 0,
            menuClick: function(jspnPara) {
                systemClick(jspnPara.subSystemIndex);
            }
        });
    }

    function showUserCenter(objDom) {
        var arrContext = new Array();
        arrContext.push({
            key: "changePassword",
            text: "修改密码",
            title: "重新设置新密码"
        });
        arrContext.push({
            key: "relogin",
            text: "重新登录",
            title: "注销当前用户，重新登录系统"
        });
        arrContext.push({
            key: "logout",
            text: "退出",
            title: "退出登录"
        });
        topWin.context.show({
            arrMenus: arrContext,
            menuClick: userCenterClick,
            objDom: objDom,
            top: 14,
            left: 0
        });
    }

    function userCenterClick(context) {
        if (context.key.equals("changePassword")) {
            var prop = {
                url: "./project/xpas/html/organization/change_password.html",
                modal: true
            };
            topWin.openWindow(prop, {
                invoker: "changePassword"
            });
        } else if (context.key.equals("relogin")) {
            window.document.location = topWin.loginUrl;
        } else if (context.key.equals("logout")) {
            if (g.a.send("processType=com.xznext.xpas.Login&actionType=logout", {}, true)) {
                if (g.a.OK) {} else {
                    return false;
                }
            }
            window.document.location = topWin.loginUrl;
        }
    }

    function showMessage(strMessage) {
        topWin.cStatusBar.showMessage(strMessage);
    }
</script>