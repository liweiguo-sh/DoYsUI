<!DOCTYPE html>
<html>
<head>
    <title>标签窗口</title>
    <script src="../../../core/doys.js?v=2"></script>
    <script>
        importFrameworkRes("d-label");
    </script>
    <style type="text/css">
        #divButtons input[type=button] {
            height: 36px;
            line-height: 36px;
            min-width: 100px;
            margin-bottom: 10px;
        }

        #tbProp {
            border: 1px dashed red;
            width: 100%;
        }

        .tdPropName {
            border: 1px dashed green;
            color: green;
        }

        .tdPropValue {
            border: 1px dashed blue;
            color: blue;
        }
    </style>
</head>
<body onload="winLoad();">
    <div id="divButtons">
        <input type="button" id="btnNewLabel" onclick="btnNewLabel_click();" value="新标签" />
        <input type="button" id="btnSaveLabel" onclick="btnSaveLabel_click();" value="保存标签" />
        &nbsp;&nbsp;&nbsp;&nbsp;
        <input type="button" id="btnAddElement" onclick="btnAddElement_click();" value="添加新元素" />
        <input type="button" id="btnDelElement" onclick="btnDelElement_click();" value="删除元素" />
        &nbsp;&nbsp;&nbsp;&nbsp;
        <input type="button" id="btnPrint" onclick="btnPrint_click();" value="打印" />
        <input type="button" id="btnClose" onclick="win.close();" value="关闭" style="color:red;font-weight:bold;" />
        &nbsp;&nbsp;&nbsp;&nbsp;

        <input type="button" id="btnDebug" onclick="btnDebug_click();" value="调试区" />
        <input type="button" id="btnLoadLabel" onclick="btnLoadLabel_click();" value="加载标签" />
        <input type="button" id="btnLabel1" onclick="btnLabel1_click();" value="标签1" />
        <input type="button" id="btnLabel2" onclick="btnLabel2_click();" value="标签2" />
        <span id="spanMessage">spanMessage</span>
    </div>
    <table id="tbMain" class="tbMain">
        <tr>
            <td id="tdMainLeft" class="tdMain" style="background-color:aquamarine;vertical-align:top">
                <table id="tbProp" style="display:none1">
                    <tr>
                        <td class="tdPropName">旋转角度</td>
                        <td class="tdPropValue"><input id="txtPropAngle" value="0" onblur="onAngleBlur();" onkeydown="onAngleKeydown(event);" /></td>
                    </tr>

                </table>
            </td>
            <td id="tdCanvas" class="tdMain" style="padding:15px;">
                <div id="divCanvas" class="doys_label_continer"></div>
            </td>
        </tr>
    </table>

    <div id="divDebug" style="margin-top:30px;display:none;">
        <div>以下测试区：</div>
        <textarea id="txtJson" rows="50" style="width:1000px;" spellcheck="false"></textarea>
    </div>
</body>
</html>

<!-- winLoad -->
<script>
    let tbMain = gId("tbMain");
    let tdMainLeft = gId("tdMainLeft");
    let tdCanvas = gId("tdCanvas");

    let divCanvas = gId("divCanvas");
    let txtJson = gId("txtJson");

    let labelId, labelContent;
    let lbl;
    // ------------------------------------------------------------------------
    function winLoad() {
        alert("winload");
        winResize();

        labelId = win.para.labelId || 0;
        labelContent = win.para.content || "";

        let dt1 = new Date();

        lbl = new Label({ container: divCanvas, env: "design" });
        lbl.loadLabel(labelContent, {
            labelId: labelId,
            imageBaseUrl: topWin.cfg.labelVariableImageBaseUrl,
            fields: win.para.fields || null,
            width: win.para.width || null,
            height: win.para.height || null,
            point: win.para.point || 600
        });
        lbl.compute(true);

        let dt2 = new Date();
        let interval = dt2.diffSecond(dt1);
        console.log("interval = " + interval);

    }

    function winResize() {
        let width = document.documentElement.clientWidth;
        let heigth = document.documentElement.clientHeight;

        tdCanvas.style.width = (width - 320) + "px";
        tdCanvas.style.height = (heigth - tbMain.offsetTop - 40) + "px";
    }
</script>
<!-- buttons -->
<script>
    function btnNewLabel_click() {
        lbl.loadLabel("", { width: 60, height: 40 });
    }
    function btnSaveLabel_click() {
        txtJson.value = lbl.toJson();

        if (win.para.callback) {
            win.para.callback({
                content: txtJson.value
            });
        }
    }

    function btnAddElement_click() {
        if (lbl) {
            lbl.addBlankTextElement();
        }
    }
    function btnDelElement_click() {
        if (lbl) {
            lbl.delElement();
        }
    }

    function btnPrint_click() {
        let page = 0, pages = 2;
        let datas = [], dataString;
        // ------------------------------------------------
        try {
            if (labelId) {
                datas.push(lbl.getData());
            }
            else {
                // -- 模拟数据 --
                if (false) {
                    if (page++ < pages) {
                        lbl.setValue("零售价", "$138.00");
                        lbl.setValue("会员价", "$110.40");
                        lbl.setValue("图片01", "https://cn.vuejs.org/images/imooc-sponsor2.png");
                        lbl.setValue("条码", "888-" + page);

                        lbl.computeElements();
                        datas.push(lbl.getData());
                    }
                    if (page++ < pages) {
                        lbl.setValue("零售价", "$138.00");
                        lbl.setValue("会员价", "$110.40");
                        lbl.setValue("图片01", "http://www.masocloud.com/DoYsUI/project/aprint/image/main/doys.png");
                        lbl.setValue("条码", "888-" + page);

                        lbl.computeElements();
                        datas.push(lbl.getData());
                    }
                    lbl.computeElements(true);
                }
                else {
                    datas.push(lbl.getData());
                }
            }
            dataString = JSON.stringify(datas, null, " ");

            // --------------------------------------------
            let para = {
                protocol: "2.0",
                action: "printDLabel",
                labelString: lbl.toJson(),
                dataString: dataString,
                copies: 1
            }

            top.invokeEdge(para);
        }
        catch (e) {
            topWin.alert(e, "error");
        }
    }
</script>

<!-- 属性区 -->
<script>
    function onAngleKeydown(evt) {
        if (evt.key.equals("Enter")) {
            onAngleBlur();
        }
    }
    function onAngleBlur() {
        let txt = gId("txtPropAngle");
        let angle = txt.value.toInt();

        txt.value = lbl.setAngle(angle);
        //txt.select();
        //txt.focus();
    }
</script>

<!-- debug and test -->
<script>
    function btnDebug_click() {
        txtJson.value = lbl.toJson();

        if (gId("divDebug").style.display.equals("")) {
            gId("divDebug").style.display = "none";
        }
        else {
            gId("divDebug").style.display = "";
            gId("txtJson").focus();
        }
    }
    function btnLoadLabel_click() {
        labelContent = txtJson.value;
        if (labelContent) {
            lbl.loadLabel(labelContent);
            lbl.compute(true);
        }
        else {
            btnNewLabel_click();
        }
    }

    function btnLabel1_click() {
        labelContent = getLabel1();
        lbl.loadLabel(labelContent);

        lbl.setValue("单价", "大熊猫面馆,大熊猫面馆");
        lbl.compute(true);
    }
    function btnLabel2_click() {
        labelContent = getLabel2();
        lbl.loadLabel(labelContent);

        lbl.setValue("单价", "￥222.22");
        lbl.compute();
        lbl.draw();
    }

    function getLabel1() {
        return `
{
  "head": {
    "width": 44,
    "height": 15,
    "point": 600
  },
  "fields": {
    "单价": "大熊猫面馆,大熊猫面馆"
  },
  "elements": [
    {
      "head": {
        "name": "doys_label_element_4",
        "elementType": "barcode",
        "barcodeType": "QR_CODE"
      },
      "sections": [
        {
          "pos": 0,
          "type": "fixed",
          "value": "123456",
          "format": ""
        },
        {
          "pos": 1,
          "type": "",
          "value": "",
          "format": ""
        }
      ],
      "font": {
        "lineHeight": 0,
        "size": 12,
        "name": "宋体"
      },
      "frame": {
        "type": "rectangle",
        "width": 0.035,
        "fillColor": "#FF0095",
        "color": "#006AFF"
      },
      "position": {
        "layer": 1,
        "top": "0.97",
        "left": 3.35,
        "width": "22.14",
        "height": "13.25",
        "angle": 0,
        "angleR": 0,
        "textAlign": "center",
        "verticalAlign": "bottom",
        "marginLeft": 0,
        "marginRight": 0,
        "marginTop": 0,
        "marginBottom": 0,
        "wC": 22.14,
        "hC": 13.25,
        "P1": {
          "x": 0,
          "y": 0
        },
        "P2": {
          "x": 22.14,
          "y": 0
        },
        "P3": {
          "x": 22.14,
          "y": 13.25
        },
        "P4": {
          "x": 0,
          "y": 13.25
        },
        "P15": {
          "x": 11.07,
          "y": 0
        },
        "P25": {
          "x": 22.14,
          "y": 6.625
        },
        "P35": {
          "x": 11.07,
          "y": 13.25
        },
        "P45": {
          "x": 0,
          "y": 6.625
        },
        "offsetX": 0,
        "offsetY": 0,
        "leftText": 11.07,
        "topText": 13.215,
        "heightBarcode": 8.946666666666667,
        "widthBarcode": 8.946666666666667,
        "leftBarcode": 6.596666666666667,
        "topBarcode": 0.035
      },
      "segments": [
        {
          "pos": 0,
          "type": "fixed",
          "value": "1234567890",
          "format": ""
        },
        {
          "pos": 1,
          "type": "",
          "value": "",
          "format": ""
        }
      ],
      "env": "design",
      "point": 600
    },
    {
      "head": {
        "name": "doys_label_element_2",
        "elementType": "shape"
      },
      "font": {
        "lineHeight": 0,
        "size": 12
      },
      "frame": {
        "type": "rectangle",
        "width": 0.035,
        "color": "#04FF00"
      },
      "position": {
        "layer": 1,
        "top": "5.06",
        "left": "18.88",
        "width": "9.18",
        "height": "5.59",
        "angle": 0,
        "angleR": 0,
        "textAlign": "left",
        "verticalAlign": "top",
        "marginLeft": 0,
        "marginRight": 0,
        "marginTop": 0,
        "marginBottom": 0,
        "wC": 9.18,
        "hC": 5.59,
        "P1": {
          "x": 0,
          "y": 0
        },
        "P2": {
          "x": 9.18,
          "y": 0
        },
        "P3": {
          "x": 9.18,
          "y": 5.59
        },
        "P4": {
          "x": 0,
          "y": 5.59
        },
        "P15": {
          "x": 4.59,
          "y": 0
        },
        "P25": {
          "x": 9.18,
          "y": 2.795
        },
        "P35": {
          "x": 4.59,
          "y": 5.59
        },
        "P45": {
          "x": 0,
          "y": 2.795
        },
        "offsetX": 0,
        "offsetY": 0,
        "leftText": 0.035,
        "topText": 0.035
      },
      "env": "design",
      "point": 600
    }
  ]
}
        `;
    }
    function getLabel2() {
        return `
{
  "head": {
    "width": 40,
    "height": 60,
    "imageBaseUrl": "http://127.0.0.1/DoYsUI/framework/control/label/image/"
  },
  "fields": {
    "单价": "123.45",
    "图片01": "01.png",
    "图片02": "02.png",
    "Img_user": "http://www.masocloud.com/DoYsUI/project/aprint/image/main/user.png",
    "img_doys": "http://www.masocloud.com/DoYsUI/project/aprint/image/main/doys.png"
  },
  "elements": [
    {
      "head": {
        "name": "1-单价",
        "elementType": "text"
      },
      "sections": [
        {
          "pos": 0,
          "type": "field",
          "value": "单价",
          "format": ""
        },
        {
          "pos": 1,
          "type": "",
          "value": "",
          "format": ""
        }
      ],
      "font": {
        "lineHeight": 0,
        "size": "12",
        "bold": true,
        "name": "Arial",
        "wordWrap": false
      },
      "frame": {
        "type": "rectangle",
        "width": 0.2,
        "color": "#F0F253"
      },
      "position": {
        "layer": 1,
        "top": "1.85",
        "left": "4.69",
        "width": 20,
        "height": 10,
        "textAlign": "center",
        "verticalAlign": "middle",
        "marginLeft": 0,
        "marginRight": 0,
        "marginTop": 0,
        "marginBottom": 0
      }
    }
  ]
}
        `;
    }

    var spanMessage = gId("spanMessage");
    function showInfo(message) {
        spanMessage.innerHTML = (new Date()).toTimeString("ss:ms") + "  " + message;
    }
</script>