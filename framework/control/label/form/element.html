<!DOCTYPE html>
<html>
<head>
    <title>标签元素定义</title>
    <script src="../../../core/doys.js"></script>

    <script src="../js/element.js"></script>
    <script src="../js/font.js"></script>

    <style type="text/css">
        body {
            overflow-x: hidden;
        }
        .el-col-base {
            padding-right: 20px;
        }
    </style>
</head>
<body>
    <div id="app" style="width:900px;height:500px;">
        <el-tabs v-model="activeTabName" type="card">
            <el-tab-pane label="基本信息" name="base">
                <el-form label-width="135px" label-position="right">
                    <el-row>
                        <el-col :span="12" class="el-col-base">
                            <el-form-item label="元素类型" required>
                                <el-select v-model="element.elementType" @change="elementTypeChange()" style="width:100%;">
                                    <el-option value="barcode" label="条形码"></el-option>
                                    <el-option value="text" label="文本"></el-option>
                                    <el-option value="image" label="图片"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12" class="el-col-base">
                            <el-form-item label="符号体系" required>
                                <el-select v-model="element.barcodeType" :disabled="element.elementType!='barcode'" filterable style="width:100%;">
                                    <el-option-group label="一维码">
                                        <el-option value="Code128" label="Code 128"></el-option>
                                        <el-option value="GS1_128" label="GS1-128" :disabled="true"></el-option>
                                    </el-option-group>
                                    <el-option-group label="二维码">
                                        <el-option value="GS1_QrCode" label="GS1 QR Code" :disabled="true"></el-option>
                                        <el-option value="GS1_DataMatrix" label="GS1 DataMatrix" :disabled="true"></el-option>
                                    </el-option-group>
                                </el-select>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
            </el-tab-pane>
            <el-tab-pane label="条码内容(机器识读)" name="segments" v-if="element.elementType=='barcode'">
                <el-row :gutter="8" style="margin-bottom:12px;">
                    <el-col :span="19">
                        <el-tag>{{element.segmentsText}}</el-tag>
                    </el-col>
                </el-row>
                <el-row v-for="segment in element.segments" :key="segment.pos" :gutter="8" style="margin-bottom:5px;">
                    <el-col :span="5">
                        <el-select v-model="segment.type" @change="segmentTypeChange(segment.pos)">
                            <el-option v-for="st in sectionTypes" :value="st.k" :label="st.v" :key="st.k" :segment="segment"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="9">
                        <el-input v-model="segment.value" v-if="segment.type=='fixed'" type="textarea" @change="segmentValueChange(segment.pos)" autosize></el-input>
                        <el-select v-model="segment.value" v-if="segment.type=='field'" @change="segmentValueChange(segment.pos)" style="width:100%">
                            <el-option v-for="f in fields" :value="f.k" :label="f.k" :key="f.k" :segment="segment"></el-option>
                        </el-select>
                        <el-select v-model="segment.value" v-if="segment.type=='symbol'" @change="segmentValueChange(segment.pos)" style="width:100%">
                            <el-option v-for="s in symbols" :value="s.k" :label="s.v" :key="s.k" :segment="segment"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="5">
                        <el-input v-model="segment.format" @change="segmentValueChange(segment.pos)"></el-input>
                    </el-col>
                    <el-col :span="5">
                        <el-button-group>
                            <el-button type="danger" v-if="segment.type!=''" @click="segmentDelete(segment.pos)" :segment="segment" title="删除" icon="el-icon-delete"></el-button>
                            <el-button type="primary" v-if="segment.pos<element.segments.length-1 && segment.pos>0" @click="segmentMoveUp(segment.pos)" :segment="segment" title="上移" icon="el-icon-arrow-up"></el-button>
                            <el-button type="primary" v-if="segment.pos<element.segments.length-2" @click="segmentMoveUp(segment.pos+1)" :segment="segment" title="下移" icon="el-icon-arrow-down"></el-button>
                        </el-button-group>
                    </el-col>
                </el-row>
            </el-tab-pane>
            <el-tab-pane label="文本内容" name="sections" v-if="element.elementType=='barcode' || element.elementType=='text'">
                <el-row :gutter="8" style="margin-bottom:12px;">
                    <el-col :span="19">
                        <el-tag>{{element.sectionsText}}</el-tag>
                    </el-col>
                </el-row>
                <el-row v-for="section in element.sections" :key="section.pos" :gutter="8" style="margin-bottom:5px;">
                    <el-col :span="5">
                        <el-select v-model="section.type" @change="sectionTypeChange(section.pos)">
                            <el-option v-for="st in sectionTypes" :value="st.k" :label="st.v" :key="st.k" :section="section"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="9">
                        <el-input v-model="section.value" v-if="section.type=='fixed'" type="textarea" @change="sectionValueChange(section.pos)" autosize></el-input>
                        <el-select v-model="section.value" v-if="section.type=='field'" @change="sectionValueChange(section.pos)" style="width:100%">
                            <el-option v-for="f in fields" :value="f.k" :label="f.k" :key="f.k" :section="section"></el-option>
                        </el-select>
                        <el-select v-model="section.value" v-if="section.type=='symbol'" @change="sectionValueChange(section.pos)" style="width:100%">
                            <el-option v-for="s in symbols" :value="s.k" :label="s.v" :key="s.k" :section="section"></el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="5">
                        <el-input v-model="section.format" @change="sectionValueChange(section.pos)"></el-input>
                    </el-col>
                    <el-col :span="5">
                        <el-button-group>
                            <el-button type="danger" v-if="section.type!=''" @click="sectionDelete(section.pos)" :section="section" title="删除" icon="el-icon-delete"></el-button>
                            <el-button type="primary" v-if="section.pos<element.sections.length-1 && section.pos>0" @click="sectionMoveUp(section.pos)" :section="section" title="上移" icon="el-icon-arrow-up"></el-button>
                            <el-button type="primary" v-if="section.pos<element.sections.length-2" @click="sectionMoveUp(section.pos+1)" :section="section" title="下移" icon="el-icon-arrow-down"></el-button>
                        </el-button-group>
                    </el-col>
                </el-row>
            </el-tab-pane>
            <el-tab-pane label="图片" name="image" v-if="element.elementType=='image'">
                <el-form label-width="135px" label-position="right">
                    <el-row>
                        <el-col :span="12" class="el-col-base">
                            <el-form-item label="图片" required>
                                <el-select v-model="element.image.img" @change="imgChange();" style="width:100%;">
                                    <el-option v-for="item in images" :value="item.k" :label="item.k" :key="item.k" :title="item.k + '  (' + item.v + ')'" style="height:52px;padding-top:2px;">
                                        <slot>
                                            <image :src="item.v" style="height:48px;" />
                                        </slot>
                                    </el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                        <el-col :span="12" class="el-col-base">
                            <el-form-item label="尺寸选项">
                                <el-select v-model="element.image.deformation" style="width:100%;">
                                    <el-option value="stretch" label="拉伸填充"></el-option>
                                    <el-option value="zoom" label="同比缩放"></el-option>
                                    <el-option value="none" label="图片原始大小"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
            </el-tab-pane>
            <el-tab-pane label="字体" name="font" v-if="element.elementType=='barcode' || element.elementType=='text'">
                <el-row>
                    <el-col :span="12" class="el-col-base">
                        <el-select v-model="element.font.name" @change="fontChange();" style="width:100%;" filterable>
                            <el-option v-for="name in fontNames" :value="name" :label="name" :key="name">
                                <slot>
                                    <span style="float:left">{{name}}</span>
                                    <span :style="'float:right;font-family:' + name">简体中文AaBbCc123</span>
                                </slot>
                            </el-option>
                        </el-select>
                    </el-col>
                    <el-col :span="6" class="el-col-base">
                        <el-select v-model="element.font.size" @change="fontChange();" style="width:100%;" placeholder="字体大小" filterable>
                            <el-option v-for="size in fontSizes" :value="size" :label="size" :key="size"></el-option>
                        </el-select>
                    </el-col>
                </el-row>
                <el-row style="margin-top:10px;">
                    <el-col :span="12" class="el-col-base" style="text-align:center;">
                        <el-checkbox v-model="element.font.bold">粗体</el-checkbox>
                        <el-checkbox v-model="element.font.italic">斜体</el-checkbox>
                    </el-col>
                </el-row>
            </el-tab-pane>
            <el-tab-pane label="位置" name="position">
                <el-form label-width="135px" label-position="right">
                    <el-row>
                        <el-col :span="8" class="el-col-base">
                            <el-form-item label="位置X" required>
                                <el-input v-model="element.position.left"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8" class="el-col-base">
                            <el-form-item label="宽度" required>
                                <el-input v-model="element.position.width"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8" class="el-col-base">
                            <el-form-item label="水平位置">
                                <el-select v-model="element.position.textAlign" @change="fontChange();" style="width:100%;" filterable>
                                    <el-option value="left" label="居左"></el-option>
                                    <el-option value="center" label="居中"></el-option>
                                    <el-option value="right" label="居右"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                    </el-row>
                    <el-row>
                        <el-col :span="8" class="el-col-base">
                            <el-form-item label="位置Y" required>
                                <el-input v-model="element.position.top"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8" class="el-col-base">
                            <el-form-item label="高度" required>
                                <el-input v-model="element.position.height"></el-input>
                            </el-form-item>
                        </el-col>
                        <el-col :span="8" class="el-col-base">
                            <el-form-item label="垂直位置">
                                <el-select v-model="element.position.verticalAlign" @change="fontChange();" style="width:100%;" filterable>
                                    <el-option value="top" label="居上"></el-option>
                                    <el-option value="middle" label="居中"></el-option>
                                    <el-option value="bottom" label="居下"></el-option>
                                </el-select>
                            </el-form-item>
                        </el-col>
                    </el-row>
                </el-form>
            </el-tab-pane>
        </el-tabs>
        <hr />
        <el-button @click="test1();">测试一</el-button>
    </div>
</body>
</html>

<!-- appInit -->
<script>
    var app = new Vue({
        el: '#app',
        data: {
            span: [24, 12, 12],
            activeTabName: "base",

            fields: [],
            images: [],
            element: {
                position: {},
                image: {}
            },
            symbols: UtilElement.getAI(),
            sectionTypes: UtilElement.getSectionTypes(),

            fontNames: UtilFont.getNames(),
            fontSizes: UtilFont.getSizes(),

            remark: ""
        },
        methods: {
            elementTypeChange() {
                if (this.element.elementType.equals("barcode")) {
                    if (!this.element.barcodeType || this.element.barcodeType.equals("")) {
                        this.element.barcodeType = "Code128";
                    }

                    if (!this.element.segments || this.element.segments.length == 0) {
                        this.element.segments = [
                            UtilElement.getFixedSegment({ pos: 0 }),
                            UtilElement.getBlankSegment({ pos: 1 })
                        ];
                    }
                }
                else {
                    if (this.element.barcodeType) delete this.element.barcodeType;
                    if (this.element.segments) delete this.element.segments;
                    if (this.element.segmentsText) delete this.element.segmentsText;
                }
                if (this.element.elementType.equals("barcode") || this.element.elementType.equals("text")) {
                    if (!this.element.sections || this.element.sections.length == 0) {
                        this.element.sections = [
                            UtilElement.getFixedSection({ pos: 0 }),
                            UtilElement.getBlankSection({ pos: 1 })
                        ];
                    }
                }
                else {
                    if (this.element.sections) delete this.element.sections;
                    if (this.element.sectionsText) delete this.element.sectionsText;
                }

                if (this.element.elementType.equals("image")) {
                }
                else {
                    if (this.element.img) delete this.element.img;
                    if (this.element.image) delete this.element.image;                
                }

                UtilElement.compute({ element: this.element, fields: this.fields, images: this.images });
            },

            sectionTypeChange(pos) {
                let section = this.element.sections[pos];
                if (section.type != "" && pos == this.element.sections.length - 1) {
                    let sectionBlank = UtilElement.getBlankSection({ pos: pos + 1 });
                    this.element.sections.push(sectionBlank);
                }

                UtilElement.compute({ element: this.element, fields: this.fields });
            },
            sectionValueChange(pos) {
                UtilElement.compute({ element: this.element, fields: this.fields });
            },
            sectionDelete(pos) {
                this.element.sections.splice(pos, 1);
                for (let i = 0; i < this.element.sections.length; i++) {
                    this.element.sections[i].pos = i;
                }

                UtilElement.compute({ element: this.element, fields: this.fields });
            },
            sectionMoveUp(pos) {
                let section0 = this.element.sections.slice(pos - 1, pos)[0];
                let section1 = this.element.sections.slice(pos, pos + 1)[0];

                section0.pos = pos;
                section1.pos = pos - 1;

                this.element.sections.splice(pos - 1, 2, section1, section0);

                UtilElement.compute({ element: this.element, fields: this.fields });
            },

            segmentTypeChange(pos) {
                let segment = this.element.segments[pos];
                if (segment.type != "" && pos == this.element.segments.length - 1) {
                    let segmentBlank = UtilElement.getBlankSegment({ pos: pos + 1 });
                    this.element.segments.push(segmentBlank);
                }

                UtilElement.compute({ element: this.element, fields: this.fields });
            },
            segmentValueChange(pos) {
                UtilElement.compute({ element: this.element, fields: this.fields });
            },
            segmentDelete(pos) {
                this.element.segments.splice(pos, 1);
                for (let i = 0; i < this.element.segments.length; i++) {
                    this.element.segments[i].pos = i;
                }

                UtilElement.compute({ element: this.element, fields: this.fields });
            },
            segmentMoveUp(pos) {
                let segment0 = this.element.segments.slice(pos - 1, pos)[0];
                let segment1 = this.element.segments.slice(pos, pos + 1)[0];

                segment0.pos = pos;
                segment1.pos = pos - 1;

                this.element.segments.splice(pos - 1, 2, segment1, segment0);

                UtilElement.compute({ element: this.element, fields: this.fields });
            },

            imgChange() {
                UtilElement.compute({ element: this.element, fields: this.fields, images: this.images });
            },
            fontChange() {

            },

            test1() {
                UtilElement.compute({ element: this.element, fields: this.fields, images: this.images });
                topWin.message("test1 执行完毕");
            },
            toString() {
                // -- --
            }
        }
    });
</script>

<!-- winLoad -->
<script>
    function winLoad() {
        app.fields = win.para.fields;
        app.images = win.para.images;
        app.element = win.para.element;

        if (app.element.elementType.equals("image")) {
            app.activeTabName = "image";
        }
        else if (app.element.elementType.equals("barcode")) {
            app.activeTabName = "segments";
        }
        else if (app.element.elementType.equals("text")) {
            app.activeTabName = "sections";
        }

        UtilElement.compute({ element: app.element, fields: app.fields, images: app.images });

        win.addEventListener("afterClose", () => {
            win.para.callback({ element: app.element });

            app.fields = null;
            app.images = null;
            app.element = null;
        });
    }
</script>